---
import type { RelatedProductInfo as OriginalRelatedProductInfo, FaqItemData as OriginalFaqItemData, ProductLayoutStrings as OriginalProductLayoutStrings } from '../../layouts/ProductLayout.astro'; // Path might need adjustment if ProductLayout is deleted
import productData from '../../../data/product.json';
import wwwData from '../../../data/www.json';
import commonData from '../../../data/common.json';
import articleDataJson from '../../../data/article.json';
import localeData from '../../../data/locale.json';

// Imports from ProductLayout.astro
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { actions, isInputError } from 'astro:actions';

// Get the product slug from the URL
const { productSlug } = Astro.params;

// Get the locale from the URL path (e.g., 'si' from /si/opozorilna-piramida/...)
const locale = Astro.url.pathname.split('/')[1];

// Find the matching product based on slug and locale
const product = productData.find(
  (entry) => 
    entry.PRODUCT_ASCII_SLUG === productSlug && 
    entry.M_SLUG === locale &&
    entry.PUBLISH_Y_N === "1"
);

// If product not found or not published, redirect to 404
if (!product) {
  return Astro.redirect('/404');
}

// Find the matching common data object based on M_SLUG
const common = commonData.find(item => item.M_SLUG === locale) || commonData[0];
const www = wwwData[0];

// Get language data from the product
const languageIso = product.M_LANGUAGE_ISO;
const countryCode = product.M_COUNTRY_CODE;

// Find matching content orientation from common.json
const contentOrientation = commonData.find(item =>
  item.M_LANGUAGE_ISO === languageIso &&
  item.M_COUNTRY_CODE === countryCode
)?.M_CONTENT_ORIENTATION || 'ltr';

// Helper function for absolute URLs with locale
const getAbsoluteUrl = (path: string): string => {
    const locale = Astro.url.pathname.split('/')[1];
    return new URL(`/${locale}${path}`, Astro.url.origin).toString();
};

// Helper function for base-level URLs (without locale)
const getBaseUrl = (path: string): string => {
    return new URL(path, Astro.url.origin).toString();
};

// Interfaces 
export interface ProductSpecification {
  dimensions: string; material: string; weight: string; visibility: string; windResistance: string; setupTime: string;
}
export interface RelatedProductInfo { 
  id: string; title: string; image: string; category: string; url: string;
}
export interface FaqItemData { 
  question: string; answer: string;
}
export interface ProductLayoutStrings { 
  techSpecTitle: string; techSpecDimensionsLabel: string; techSpecMaterialLabel: string; techSpecWeightLabel: string; techSpecVisibilityLabel: string; techSpecWindResistanceLabel: string; techSpecSetupTimeLabel: string;
  orderButtonText: string;
  orderFormTitle: string; orderFormSubtitleBase: string; orderFormNameLabel: string; orderFormNamePlaceholder: string; orderFormSurnameLabel: string; orderFormSurnamePlaceholder: string; orderFormCompanyLabel: string; orderFormCompanyPlaceholder: string; orderFormVatIdLabel: string; orderFormVatIdPlaceholder: string; orderFormStreetLabel: string; orderFormStreetPlaceholder: string; orderFormCityLabel: string; orderFormCityPlaceholder: string; orderFormZipLabel: string; orderFormZipPlaceholder: string; orderFormEmailLabel: string; orderFormEmailPlaceholder: string; orderFormPhoneLabel: string; orderFormPhonePlaceholder: string; orderFormQuantityLabel: string; orderFormQuantityDefaultOption: string; orderFormPaymentLabelBase: string; orderFormPaymentCod: string; orderFormPaymentPreInvoice: string; orderFormMessageLabel: string; orderFormMessagePlaceholder: string; orderFormTermsLabel: string; orderFormSubmitButtonText: string;
  faqSectionTitle: string; faqBackButtonText: string;
  relatedProductsTitle: string; relatedProductViewButtonText: string;
  customerSupportTitle: string; customerSupportEmail: string;
  validationNameRequired: string; validationSurnameRequired: string; validationStreetRequired: string; validationCityRequired: string; validationZipRequired: string; validationEmailRequired: string; validationEmailInvalid: string; validationPhoneRequired: string; validationQuantityRequired: string; validationPaymentRequired: string; validationTermsRequired: string;
  formSuccessMessage: string;
}

export interface RelatedArticleInfo { 
  title: string;
  url: string;
  date: string;
}

const productCoreData = {
  h1: product.PRODUCT_H1,
  seoTitle: `${product.PRODUCT_NAME} — ${product.PRODUCT_KEYWORD_1}`,
  subtitle: product.PRODUCT_SUBTITLE,
  description: product.PRODUCT_META_SEO,
  price: product.M_PRODUCT_PRICE,
  ogImage: product.PRODUCT_OG_IMAGE_PATH,
  image: product.PRODUCT_IMAGE_PATH_L,
  specifications: {
    dimensions: common.PRODUCT_SPECIFICATIONS_VALUE_1,
    material: common.PRODUCT_SPECIFICATIONS_VALUE_2,
    weight: common.PRODUCT_SPECIFICATIONS_VALUE_3,
    visibility: common.PRODUCT_SPECIFICATIONS_VALUE_4,
    windResistance: common.PRODUCT_SPECIFICATIONS_VALUE_5,
    setupTime: common.PRODUCT_SPECIFICATIONS_VALUE_6
  },
  category: product.PRODUCT_CATEGORY_1_SLUG,
  productId: product.PRODUCT_ID
};

const productFaqItems: FaqItemData[] = [
  { question: product.PRODUCT_Q1, answer: product.PRODUCT_A1 },
  { question: product.PRODUCT_Q2, answer: product.PRODUCT_A2 },
  { question: product.PRODUCT_Q3, answer: product.PRODUCT_A3 },
  { question: product.PRODUCT_Q4, answer: product.PRODUCT_A4 },
  { question: product.PRODUCT_Q5, answer: product.PRODUCT_A5 },
  { question: product.PRODUCT_Q6, answer: product.PRODUCT_A6 },
  { question: product.PRODUCT_Q7, answer: product.PRODUCT_A7 },
  { question: product.PRODUCT_Q8, answer: product.PRODUCT_A8 },
  { question: product.PRODUCT_Q9, answer: product.PRODUCT_A9 },
  { question: product.PRODUCT_Q10, answer: product.PRODUCT_A10 },
  { question: product.PRODUCT_Q11, answer: product.PRODUCT_A11 },
  { question: product.PRODUCT_Q12, answer: product.PRODUCT_A12 },
  { question: product.PRODUCT_Q13, answer: product.PRODUCT_A13 }
];

// Helper function to find product by ID
const findProductById = (productId: string) => {
  return productData.find(p => p.PRODUCT_ID === productId && p.PUBLISH_Y_N === "1");
};

// Helper function to find article by ID
const findArticleById = (articleId: string) => {
  return articleDataJson.find(entry => entry.PAGE_ID === articleId && entry.PUBLISH_Y_N === "1");
};

// Get related products with their IDs
const allAvailableProducts: RelatedProductInfo[] = [
  product.PRODUCT_RELATED_P1,
  product.PRODUCT_RELATED_P2,
  product.PRODUCT_RELATED_P3,
  product.PRODUCT_RELATED_P4,
  product.PRODUCT_RELATED_P5,
  product.PRODUCT_RELATED_P6
].map(id => {
  const relatedProduct = findProductById(id);
  if (!relatedProduct) return null;
  
  return {
    id: relatedProduct.PRODUCT_ID,
    title: `${relatedProduct.PRODUCT_CATEGORY_1} — ${relatedProduct.PRODUCT_NAME}`,
    image: getBaseUrl(relatedProduct.PRODUCT_IMAGE_PATH_L),
    category: relatedProduct.PRODUCT_CATEGORY_1_SLUG,
    url: getBaseUrl(`/${relatedProduct.M_SLUG}/${relatedProduct.PRODUCT_CATEGORY_1_SLUG}/${relatedProduct.PRODUCT_ASCII_SLUG}`)
  };
}).filter(Boolean) as RelatedProductInfo[];

// Filter and sort related products
const filteredRelatedProducts = allAvailableProducts
  .filter(p => p.id !== product.PRODUCT_ID) // Compare with full product ID including 'p' prefix
  .sort((a, b) => {
    if (a.category === productCoreData.category && b.category !== productCoreData.category) return -1;
    if (a.category !== productCoreData.category && b.category === productCoreData.category) return 1;
    return 0;
  })
  .slice(0, 3);

// Add this new section for related articles
const relatedArticleIds = [
  product.PRODUCT_RELATED_A1,
  product.PRODUCT_RELATED_A2,
  product.PRODUCT_RELATED_A3,
  product.PRODUCT_RELATED_A4,
  product.PRODUCT_RELATED_A5,
  product.PRODUCT_RELATED_A6,
  product.PRODUCT_RELATED_A7
].filter(Boolean);

const relatedArticles: RelatedArticleInfo[] = relatedArticleIds
  .map(id => {
    const relatedArticle = findArticleById(id);
    if (!relatedArticle) return null;
    
    return {
      title: relatedArticle.ARTICLE_H1,
      url: `/${relatedArticle.M_SLUG}/${relatedArticle.ARTICLE_LIST_SLUG}/${relatedArticle.ARTICLE_SLUG}`,
      date: relatedArticle.ARTICLE_PUBLISH_DATE
    };
  })
  .filter(Boolean) as RelatedArticleInfo[];

const pageKeywords = [
  product.PRODUCT_NAME,
  product.PRODUCT_KEYWORD_1,
  product.PRODUCT_KEYWORD_2,
  product.PRODUCT_KEYWORD_3,
  product.PRODUCT_KEYWORD_4,
  product.PRODUCT_KEYWORD_5,
  product.PRODUCT_KEYWORD_6,
  product.PRODUCT_KEYWORD_7,
  common.M_COUNTRY_NATIVE,
  www.PAGE_ORGANISATION_FULL_NAME
].join(', ');

const productQuantityOptions: number[] = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 14, 16, 18, 20, 22, 24, 30];

const productPageLayoutStrings: ProductLayoutStrings = {
  techSpecTitle: common.PRODUCT_SPECIFICATIONS_TITLE,
  techSpecDimensionsLabel: common.PRODUCT_SPECIFICATIONS_LABEL_1,
  techSpecMaterialLabel: common.PRODUCT_SPECIFICATIONS_LABEL_2,
  techSpecWeightLabel: common.PRODUCT_SPECIFICATIONS_LABEL_3,
  techSpecVisibilityLabel: common.PRODUCT_SPECIFICATIONS_LABEL_4,
  techSpecWindResistanceLabel: common.PRODUCT_SPECIFICATIONS_LABEL_5,
  techSpecSetupTimeLabel: common.PRODUCT_SPECIFICATIONS_LABEL_6,
  orderButtonText: common.PRODUCT_PAGE_ORDER_BUTTON_TEXT,
  orderFormTitle: common.PRODUCT_INQUIRY_LABEL,
  orderFormSubtitleBase: common.PRODUCT_PAGE_ORDER_FORM_SUBTITLE_BASE,
  orderFormNameLabel: common.PRODUCT_PAGE_ORDER_FORM_NAME_LABEL,
  orderFormNamePlaceholder: common.PRODUCT_PAGE_ORDER_FORM_NAME_PLACEHOLDER,
  orderFormSurnameLabel: common.PRODUCT_PAGE_ORDER_FORM_SURNAME_LABEL,
  orderFormSurnamePlaceholder: common.PRODUCT_PAGE_ORDER_FORM_SURNAME_PLACEHOLDER,
  orderFormCompanyLabel: common.PRODUCT_PAGE_ORDER_FORM_COMPANY_LABEL,
  orderFormCompanyPlaceholder: common.PRODUCT_PAGE_ORDER_FORM_COMPANY_PLACEHOLDER,
  orderFormVatIdLabel: common.PRODUCT_PAGE_ORDER_FORM_VAT_ID_LABEL,
  orderFormVatIdPlaceholder: common.PRODUCT_PAGE_ORDER_FORM_VAT_ID_PLACEHOLDER,
  orderFormStreetLabel: common.PRODUCT_PAGE_ORDER_FORM_STREET_LABEL,
  orderFormStreetPlaceholder: common.PRODUCT_PAGE_ORDER_FORM_STREET_PLACEHOLDER,
  orderFormCityLabel: common.PRODUCT_PAGE_ORDER_FORM_CITY_LABEL,
  orderFormCityPlaceholder: common.PRODUCT_PAGE_ORDER_FORM_CITY_PLACEHOLDER,
  orderFormZipLabel: common.PRODUCT_PAGE_ORDER_FORM_ZIP_LABEL,
  orderFormZipPlaceholder: common.PRODUCT_PAGE_ORDER_FORM_ZIP_PLACEHOLDER,
  orderFormEmailLabel: common.PRODUCT_PAGE_ORDER_FORM_EMAIL_LABEL,
  orderFormEmailPlaceholder: common.PRODUCT_PAGE_ORDER_FORM_EMAIL_PLACEHOLDER,
  orderFormPhoneLabel: common.PRODUCT_PAGE_ORDER_FORM_PHONE_LABEL,
  orderFormPhonePlaceholder: common.PRODUCT_PAGE_ORDER_FORM_PHONE_PLACEHOLDER,
  orderFormQuantityLabel: common.PRODUCT_PAGE_ORDER_FORM_QUANTITY_LABEL,
  orderFormQuantityDefaultOption: common.PRODUCT_PAGE_ORDER_FORM_QUANTITY_DEFAULT_OPTION,
  orderFormPaymentLabelBase: common.PRODUCT_PAGE_ORDER_FORM_PAYMENT_LABEL_BASE,
  orderFormPaymentCod: common.PRODUCT_PAGE_ORDER_FORM_PAYMENT_COD,
  orderFormPaymentPreInvoice: common.PRODUCT_PAGE_ORDER_FORM_PAYMENT_PRE_INVOICE,
  orderFormMessageLabel: common.PRODUCT_PAGE_ORDER_FORM_MESSAGE_LABEL,
  orderFormMessagePlaceholder: common.PRODUCT_PAGE_ORDER_FORM_MESSAGE_PLACEHOLDER,
  orderFormTermsLabel: common.PRODUCT_PAGE_ORDER_FORM_TERMS_LABEL,
  orderFormSubmitButtonText: common.PRODUCT_PAGE_ORDER_FORM_SUBMIT_BUTTON_TEXT,
  faqSectionTitle: common.PRODUCT_PAGE_FAQ_SECTION_TITLE,
  faqBackButtonText: common.PRODUCT_PAGE_FAQ_BACK_BUTTON_TEXT,
  relatedProductsTitle: common.PRODUCT_PAGE_RELATED_PRODUCTS_TITLE,
  relatedProductViewButtonText: common.PRODUCT_PAGE_RELATED_PRODUCT_VIEW_BUTTON_TEXT,
  customerSupportTitle: common.PRODUCT_PAGE_CUSTOMER_SUPPORT_SECTION_TITLE,
  customerSupportEmail: www.PAGE_INFO_EMAIL,

  validationNameRequired: common.PRODUCT_PAGE_VALIDATION_NAME_REQUIRED,
  validationSurnameRequired: common.PRODUCT_PAGE_VALIDATION_SURNAME_REQUIRED,
  validationStreetRequired: common.PRODUCT_PAGE_VALIDATION_STREET_REQUIRED,
  validationCityRequired: common.PRODUCT_PAGE_VALIDATION_CITY_REQUIRED,
  validationZipRequired: common.PRODUCT_PAGE_VALIDATION_ZIP_REQUIRED,
  validationEmailRequired: common.PRODUCT_PAGE_VALIDATION_EMAIL_REQUIRED,
  validationEmailInvalid: common.M_EMAIL_INVALID,
  validationPhoneRequired: common.PRODUCT_PAGE_VALIDATION_PHONE_REQUIRED,
  validationQuantityRequired: common.PRODUCT_PAGE_VALIDATION_QUANTITY_REQUIRED,
  validationPaymentRequired: common.PRODUCT_PAGE_VALIDATION_PAYMENT_REQUIRED,
  validationTermsRequired: common.PRODUCT_PAGE_VALIDATION_TERMS_REQUIRED,

  formSuccessMessage: common.M_CONFIRMATION_TEXT
};

const productSchema = {
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": product.PRODUCT_H1,
  "image": getBaseUrl(product.PRODUCT_IMAGE_PATH_L),
  "mpn": product.PRODUCT_MPN,
  "category": product.PRODUCT_CATEGORY_1,
  "weight": {
    "@type": "QuantitativeValue",
    "value": common.PRODUCT_SPECIFICATIONS_VALUE_3.replace(/[^0-9.]/g, ''),
    "unitCode": "KGM"
  },
  "keywords": [
    product.PRODUCT_NAME,
    common.M_LANGUAGE_NATIVE,
    product.PRODUCT_KEYWORD_1,
    product.PRODUCT_KEYWORD_2,
    product.PRODUCT_KEYWORD_3,
    product.PRODUCT_KEYWORD_4,
    product.PRODUCT_KEYWORD_5,
    product.PRODUCT_KEYWORD_6,
    product.PRODUCT_KEYWORD_7
  ],
  "description": product.PRODUCT_META_SEO,
  "brand": {
    "@type": "Brand",
    "name": www.PAGE_ORGANISATION_URL_NAME
  },
  "review": {
    "@type": "Review",
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": product.PRODUCT_RATING_VALUE,
      "bestRating": 5
    },
    "author": {
      "@type": "Person",
      "name": product.PRODUCT_TESTIMONIAL_PERSON_1
    }
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": product.PRODUCT_RATING_VALUE,
    "reviewCount": product.PRODUCT_REVIEW_COUNT
  },
  "offers": {
    "@type": "Offer",
    "url": Astro.url.href,
    "priceCurrency": product.M_CURRENCY_CODE,
    "price": product.M_PRODUCT_PRICE,
    "priceValidUntil": product.PRODUCT_EXPIRATION_DATE,
    "availability": "https://schema.org/InStock",
    "itemCondition": "https://schema.org/NewCondition"
  }
};

const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": productFaqItems.map(item => ({
    "@type": "Question",
    "name": item.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": item.answer
    }
  }))
};

// Organization Schema 
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": www.PAGE_ORGANISATION_FULL_NAME,
  "url": getBaseUrl('/'),
  "foundingDate": www.PAGE_FOUNDING_DATE,
  "logo": getBaseUrl(www.PAGE_LOGO_IMAGE_PATH_1),
  "keywords": [
    www.PAGE_ORGANISATION_FULL_NAME,
    common.M_COUNTRY_NATIVE,
    common.PAGE_KEYWORD_1,
    common.PAGE_KEYWORD_2,
    common.PAGE_KEYWORD_3,
    common.PAGE_KEYWORD_4,
    common.PAGE_KEYWORD_5,
    common.PAGE_KEYWORD_6
  ].filter(Boolean),
  "description": common.PAGE_DESCRIPTION,
  "numberOfEmployees": {
    "@type": "QuantitativeValue",
    "minValue": "1",
    "maxValue": "9"
  },
  "slogan": common.PAGE_SLOGAN,
  "contactPoint": {
    "@type": "ContactPoint",
    "email": www.PAGE_INFO_EMAIL,
    "contactType": common.M_CUSTOMER_SUPPORT
  },
  "sameAs": [
    www.PAGE_INSTAGRAM_URL,
    www.PAGE_FACEBOOK_URL,
    www.PAGE_TWITTER_URL,
    www.PAGE_LINKEDIN_URL,
    www.PAGE_YOUTUBE_URL,
    www.PAGE_PINTEREST_URL,
    www.PAGE_BLUESKY_URL
  ].filter(Boolean),
  "areaServed": {
    "@type": "Country",
    "name": common.M_COUNTRY,
    "identifier": common.M_COUNTRY_CODE
  },
  "potentialAction": [
    {
      "@type": "ViewAction",
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/sitemap.xml')
    },
    {
      "@type": "ViewAction",
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`)
    },
    {
      "@type": "ViewAction",
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/llms.txt'),
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ],
  "mainEntityOfPage": [
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/sitemap.xml'),
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a structured list of pages available on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`),
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a full and structured list of localized pages for ${languageIso} (${languageIso}-${countryCode}) locale on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/llms.txt'),
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ]
};

const combinedSchema = [productSchema, faqSchema, organizationSchema];

const currentPageUrl = Astro.url.href;

const submissionResult = await Astro.getActionResult(actions.submitOrder);

const formErrors: Record<string, string[] | undefined> = {};
let genericError: string | undefined = undefined;
let successMessage: string | undefined = undefined;

if (submissionResult) {
  if (submissionResult.error) {
    if (isInputError(submissionResult.error)) {
      for (const fieldName in submissionResult.error.fields) {
        formErrors[fieldName] = submissionResult.error.fields[fieldName];
      }
      if (formErrors.pageUrl) {
        console.warn("Page URL validation error:", formErrors.pageUrl);
      }
    } else {
      genericError = submissionResult.error.message || "Prišlo je do napake.";
    }
  } else if (submissionResult.data?.success) {
    successMessage = submissionResult.data.message || productPageLayoutStrings.formSuccessMessage;
  }
}

function getFieldError(fieldName: string): string | undefined {
  return formErrors[fieldName]?.[0];
}

// Build the language link map for the language picker
const languageLinksMap = {};
for (const localeObj of localeData.filter(l => l.M_LOCALE_PUBLISH_Y_N === "1")) {
  // Find any published product for this locale to get the correct PRODUCT_CATEGORY_1_SLUG
  const productForLocale = productData.find(p =>
    p.M_SLUG === localeObj.M_SLUG &&
    p.PUBLISH_Y_N === "1" &&
    p.PRODUCT_CATEGORY_1_SLUG && p.PRODUCT_CATEGORY_1_SLUG.trim()
  );
  if (productForLocale) {
    // Always use the slug from the product for that locale
    languageLinksMap[localeObj.M_SLUG] = `/${localeObj.M_SLUG}/${productForLocale.PRODUCT_CATEGORY_1_SLUG}`;
  } else {
    // Fallback to homepage if no product listing exists
    languageLinksMap[localeObj.M_SLUG] = `/${localeObj.M_SLUG}`;
  }
}

---

<BaseLayout
  languageIso={languageIso}
  countryCode={countryCode}
  contentOrientation={contentOrientation}
  title={productCoreData.seoTitle}
  description={productCoreData.description}
  ogImage={productCoreData.ogImage}
  keywords={pageKeywords}
  schema={combinedSchema}
  languageLinksMap={languageLinksMap}
>
  <div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <div class="lg:w-2/3">
        <h1 class="text-3xl font-bold text-signal-dark mb-6">{productCoreData.h1}</h1>
        <div class="product-gallery mb-8">
          <div class="border-2 border-signal-green rounded-lg p-2">
            <img
            src={productCoreData.image}
            alt={productCoreData.h1}
            class="w-full h-[350px] object-contain animate-fade-in"
            width="350"
            height="350"
            fetchpriority="high"
            />
          </div>
        </div>
        <p class="text-lg text-gray-600 mb-6">{productCoreData.subtitle}</p>

        <div class="lg:hidden mb-8">
          <div class="bg-black text-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold mb-4 text-white">{productPageLayoutStrings.techSpecTitle}</h3>
            <ul class="space-y-4">
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M3 5h11m-2 2l2-2l-2-2M5 3L3 5l2 2m14 3v11m-2-2l2 2l2-2m0-7l-2-2l-2 2M3 12a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /></svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecDimensionsLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.dimensions}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecMaterialLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.material}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 7q.425 0 .713-.288T13 6t-.288-.712T12 5t-.712.288T11 6t.288.713T12 7m2.825 0h1.75q.75 0 1.3.5t.675 1.225l1.425 10q.125.9-.462 1.588T18 21H6q-.925 0-1.513-.687t-.462-1.588l1.425-10Q5.575 8 6.125 7.5t1.3-.5h1.75q-.075-.25-.125-.487T9 6q0-1.25.875-2.125T12 3t2.125.875T15 6q0 .275-.05.513T14.825 7"/></svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecWeightLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.weight}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecVisibilityLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.visibility}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 512 512" aria-hidden="true">
                    <defs>
                      <symbol id="meteoconsWind_mobile" viewBox="0 0 342 234">
                        <path fill="none" stroke="currentColor" stroke-dasharray="148" stroke-linecap="round" stroke-miterlimit="10" stroke-width="18" d="M264.2 21.3A40 40 0 1 1 293 89H9">
                          <animate attributeName="stroke-dashoffset" dur="7.2s" repeatCount="indefinite" values="0; 2960"/>
                        </path>
                        <path fill="none" stroke="currentColor" stroke-dasharray="110" stroke-linecap="round" stroke-miterlimit="10" stroke-width="18" d="M148.2 212.7A40 40 0 1 0 177 145H9">
                          <animate attributeName="stroke-dashoffset" dur="7.2s" repeatCount="indefinite" values="0; 1540"/>
                        </path>
                      </symbol>
                    </defs>
                    <use width="342" height="234" href="#meteoconsWind_mobile" transform="translate(85 139)"/>
                  </svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecWindResistanceLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.windResistance}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,20a9,9,0,1,1,9-9A9,9,0,0,1,12,21Z"/>
                    <rect width="2" height="7" x="11" y="6" fill="currentColor" rx="1">
                      <animateTransform attributeName="transform" dur="10.8s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/>
                    </rect>
                    <rect width="2" height="9" x="11" y="11" fill="currentColor" rx="1">
                      <animateTransform attributeName="transform" dur="0.9s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/>
                    </rect>
                  </svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecSetupTimeLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.setupTime}</span></div>
              </li>
            </ul>
          </div>
        </div>

        <div class="product-details">
          <p class="text-2xl text-black font-semibold pl-4 pr-4 underline decoration-signal-green mb-4">{productCoreData.price}</p>
          <a href="#narocilnica" class="inline-block bg-black text-signal-green border border-signal-green font-semibold py-3 px-6 rounded-lg hover:bg-signal-green hover:text-black transition-colors mb-8">
            <span class="flex items-center">{productPageLayoutStrings.orderButtonText}<svg class="w-5 h-5 ml-2" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></span>
          </a>
          
          <!-- Content  -->
          <div class="prose max-w-none mb-8">
            <div class="product-description space-y-6">
              <section aria-labelledby="peer-pressure-heading" class="bg-signal-green/5 p-6 rounded-lg border-l-4 border-signal-green mb-8">
                <div class="flex items-center gap-4">
                  <svg class="w-12 h-12 text-signal-green" viewBox="0 0 16 16" aria-hidden="true">
                    <g fill="#000">
                      <path d="M12.5 16a3.5 3.5 0 1 0 0-7a3.5 3.5 0 0 0 0 7m1.679-4.493l-1.335 2.226a.75.75 0 0 1-1.174.144l-.774-.773a.5.5 0 0 1 .708-.708l.547.548l1.17-1.951a.5.5 0 1 1 .858.514M11 5a3 3 0 1 1-6 0a3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4a2 2 0 0 0 0 4"/>
                      <path d="M8.256 14a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z"/>
                    </g>
                  </svg>
                  <h2 id="peer-pressure-heading" class="text-xl font-semibold">{product.PRODUCT_PEER_PRESSURE_1}</h2>
                </div>
              </section>

              <section aria-labelledby="authority-proof-heading" class="bg-gray-50 p-6 rounded-lg">
                <h2 id="authority-proof-heading" class="text-xl font-semibold mb-4">{product.PRODUCT_AUTHORITY_PROOF_H2}</h2>
                <ul class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <li class="flex items-center gap-4">
                    <svg class="w-10 h-10 text-green-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                    <span class="text-lg">{product.PRODUCT_AUTHORITY_PROOF_1}</span>
                  </li>
                  <li class="flex items-center gap-4">
                    <svg class="w-10 h-10 text-green-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                    <span class="text-lg">{product.PRODUCT_AUTHORITY_PROOF_2}</span>
                  </li>
                  <li class="flex items-center gap-4">
                    <svg class="w-10 h-10 text-green-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                    <span class="text-lg">{product.PRODUCT_AUTHORITY_PROOF_3}</span>
                  </li>
                </ul>
              </section>
              
              <section aria-labelledby="fear-trigger-heading" class="bg-yellow-50 p-6 rounded-lg">
                <div class="flex flex-col space-y-4">
                  <div class="flex items-center gap-4">
                    <svg class="w-12 h-12 text-yellow-700" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2m0 2a8 8 0 1 0 0 16a8 8 0 0 0 0-16m0 11a1 1 0 1 1 0 2a1 1 0 0 1 0-2m0-9a1 1 0 0 1 1 1v6a1 1 0 1 1-2 0V7a1 1 0 0 1 1-1"/></svg>
                    <h2 id="fear-trigger-heading" class="text-xl font-semibold text-yellow-800">{product.PRODUCT_FEAR_TRIGGER_1}</h2>
                  </div>
                  <p class="text-yellow-700 ml-16">
                    {product.PRODUCT_FEAR_TRIGGER_2}
                  </p>
                </div>
              </section>

              <div class="space-y-4">
                <p>{product.PRODUCT_USE_CASES_COMPILED}</p>
                <ul class="list-disc pl-6 space-y-2">
                  <li>{product.PRODUCT_USE_CASE_1}</li>
                  <li>{product.PRODUCT_USE_CASE_2}</li>
                  <li>{product.PRODUCT_USE_CASE_3}</li>
                </ul>
              </div>

              <section aria-labelledby="push-trigger-heading" class="bg-signal-green/10 p-6 rounded-lg border-l-4 border-signal-green">
                <h2 id="push-trigger-heading" class="text-xl font-semibold">{product.PRODUCT_PUSH_TRIGGER_1}</h2>
              </section>
            </div>
          </div>

          <section id="narocilnica" class="scroll-mt-24 mb-8">
            <div class="bg-white rounded-lg shadow-sm p-8 border-2 border-signal-green">
              <h2 class="text-2xl font-bold mb-6 text-black">{productPageLayoutStrings.orderFormTitle}</h2>
              <p class="text-signal-gray mb-6">{productPageLayoutStrings.orderFormSubtitleBase} {productCoreData.h1}.</p>

              {successMessage && !submissionResult?.error && (
                <div class="p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
                  {successMessage}
                </div>
              )}

              {genericError && (
                <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                  {genericError}
                </div>
              )}

              <form id="productOrderForm" method="POST" action={actions.submitOrder} class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" name="productTitle" value={productCoreData.h1} />
                <input type="hidden" name="pageUrl" value={currentPageUrl} />

                <div>
                  <label for="form-name" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormNameLabel}</label>
                  <input id="form-name" type="text" name="Name" placeholder={productPageLayoutStrings.orderFormNamePlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('Name') }]} aria-invalid={getFieldError('Name') ? "true" : "false"} aria-describedby={getFieldError('Name') ? "name-error" : undefined} required />
                  {getFieldError('Name') && <div id="name-error" class="text-red-500 text-sm mt-1">{getFieldError('Name')}</div>}
                  {!getFieldError('Name') && <div class="empty-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationNameRequired}</div>}
                </div>
                <div>
                  <label for="form-surname" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormSurnameLabel}</label>
                  <input id="form-surname" type="text" name="Last Name" placeholder={productPageLayoutStrings.orderFormSurnamePlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('Last Name') }]} aria-invalid={getFieldError('Last Name') ? "true" : "false"} aria-describedby={getFieldError('Last Name') ? "surname-error" : undefined} required />
                  {getFieldError('Last Name') && <div id="surname-error" class="text-red-500 text-sm mt-1">{getFieldError('Last Name')}</div>}
                  {!getFieldError('Last Name') && <div class="empty-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationSurnameRequired}</div>}
                </div>
                <div>
                  <label for="form-company" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormCompanyLabel}</label>
                  <input id="form-company" type="text" name="Company" placeholder={productPageLayoutStrings.orderFormCompanyPlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('Company') }]} aria-invalid={getFieldError('Company') ? "true" : "false"} aria-describedby={getFieldError('Company') ? "company-error" : undefined} />
                  {getFieldError('Company') && <div id="company-error" class="text-red-500 text-sm mt-1">{getFieldError('Company')}</div>}
                </div>
                <div>
                  <label for="form-vatid" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormVatIdLabel}</label>
                  <input id="form-vatid" type="text" name="VAT ID" placeholder={productPageLayoutStrings.orderFormVatIdPlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('VAT ID') }]} aria-invalid={getFieldError('VAT ID') ? "true" : "false"} aria-describedby={getFieldError('VAT ID') ? "vatid-error" : undefined} />
                  {getFieldError('VAT ID') && <div id="vatid-error" class="text-red-500 text-sm mt-1">{getFieldError('VAT ID')}</div>}
                </div>
                <div>
                  <label for="form-street" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormStreetLabel}</label>
                  <input id="form-street" type="text" name="Street" placeholder={productPageLayoutStrings.orderFormStreetPlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('Street') }]} aria-invalid={getFieldError('Street') ? "true" : "false"} aria-describedby={getFieldError('Street') ? "street-error" : undefined} required />
                  {getFieldError('Street') && <div id="street-error" class="text-red-500 text-sm mt-1">{getFieldError('Street')}</div>}
                  {!getFieldError('Street') && <div class="empty-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationStreetRequired}</div>}
                </div>
                <div>
                  <label for="form-city" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormCityLabel}</label>
                  <input id="form-city" type="text" name="Location" placeholder={productPageLayoutStrings.orderFormCityPlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('Location') }]} aria-invalid={getFieldError('Location') ? "true" : "false"} aria-describedby={getFieldError('Location') ? "city-error" : undefined} required />
                  {getFieldError('Location') && <div id="city-error" class="text-red-500 text-sm mt-1">{getFieldError('Location')}</div>}
                  {!getFieldError('Location') && <div class="empty-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationCityRequired}</div>}
                </div>
                <div>
                  <label for="form-zip" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormZipLabel}</label>
                  <input id="form-zip" type="text" name="Postal Code" placeholder={productPageLayoutStrings.orderFormZipPlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('Postal Code') }]} aria-invalid={getFieldError('Postal Code') ? "true" : "false"} aria-describedby={getFieldError('Postal Code') ? "zip-error" : undefined} required />
                  {getFieldError('Postal Code') && <div id="zip-error" class="text-red-500 text-sm mt-1">{getFieldError('Postal Code')}</div>}
                  {!getFieldError('Postal Code') && <div class="empty-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationZipRequired}</div>}
                </div>
                <div>
                  <label for="form-email" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormEmailLabel}</label>
                  <input id="form-email" type="email" name="email" placeholder={productPageLayoutStrings.orderFormEmailPlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('email') }]} aria-invalid={getFieldError('email') ? "true" : "false"} aria-describedby={getFieldError('email') ? "email-error" : undefined} required />
                  {getFieldError('email') && <div id="email-error" class="text-red-500 text-sm mt-1">{getFieldError('email')}</div>}
                  {!getFieldError('email') && <> <div class="empty-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationEmailRequired}</div> <div class="invalid-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationEmailInvalid}</div> </>}
                </div>
                <div>
                  <label for="form-phone" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormPhoneLabel}</label>
                  <input id="form-phone" type="tel" name="Telephone Number" placeholder={productPageLayoutStrings.orderFormPhonePlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('Telephone Number') }]} aria-invalid={getFieldError('Telephone Number') ? "true" : "false"} aria-describedby={getFieldError('Telephone Number') ? "phone-error" : undefined} required />
                  {getFieldError('Telephone Number') && <div id="phone-error" class="text-red-500 text-sm mt-1">{getFieldError('Telephone Number')}</div>}
                  {!getFieldError('Telephone Number') && <div class="empty-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationPhoneRequired}</div>}
                </div>
                <div>
                  <label for="form-quantity" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormQuantityLabel}</label>
                  <select id="form-quantity" name="Quantity" class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('Quantity') }]} aria-invalid={getFieldError('Quantity') ? "true" : "false"} aria-describedby={getFieldError('Quantity') ? "quantity-error" : undefined} required>
                    <option value="">{productPageLayoutStrings.orderFormQuantityDefaultOption}</option>
                    {productQuantityOptions.map(qty => <option value={String(qty)}>{qty}</option>)}
                  </select>
                  {getFieldError('Quantity') && <div id="quantity-error" class="text-red-500 text-sm mt-1">{getFieldError('Quantity')}</div>}
                  {!getFieldError('Quantity') && <div class="empty-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationQuantityRequired}</div>}
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormPaymentLabelBase}{productCoreData.price} + DDV)*</label>
                  <div id="payment-group" role="radiogroup" aria-labelledby={getFieldError('Payment') ? "payment-error" : undefined}>
                    <label class="flex items-center">
                      <input id="payment-cod" type="radio" name="Payment" value="Cash on Delivery" class:list={["mr-2", { "border-red-500": getFieldError('Payment') }]} required />
                      <span>{productPageLayoutStrings.orderFormPaymentCod}</span>
                    </label>
                    <label class="flex items-center">
                      <input id="payment-preinvoice" type="radio" name="Payment" value="Proforma Invoice" class:list={["mr-2", { "border-red-500": getFieldError('Payment') }]} required />
                      <span>{productPageLayoutStrings.orderFormPaymentPreInvoice}</span>
                    </label>
                    {getFieldError('Payment') && <div id="payment-error" class="text-red-500 text-sm mt-1">{getFieldError('Payment')}</div>}
                    {!getFieldError('Payment') && <div class="empty-feedback text-red-400 text-sm mt-1" style="display:none;">{productPageLayoutStrings.validationPaymentRequired}</div>}
                  </div>
                </div>
                <div class="md:col-span-2">
                  <label for="form-message" class="block text-sm font-medium text-signal-gray mb-1">{productPageLayoutStrings.orderFormMessageLabel}</label>
                  <textarea id="form-message" name="Message" rows="4" placeholder={productPageLayoutStrings.orderFormMessagePlaceholder} class:list={["w-full px-3 py-2 border border-gray-300 rounded-md", { "border-red-500": getFieldError('Message') }]} aria-invalid={getFieldError('Message') ? "true" : "false"} aria-describedby={getFieldError('Message') ? "message-error" : undefined}></textarea>
                  {getFieldError('Message') && <div id="message-error" class="text-red-500 text-sm mt-1">{getFieldError('Message')}</div>}
                </div>

                <div class="md:col-span-2 terms-wrapper">
                  <label for="form-terms" class="flex items-center">
                    <input id="form-terms" type="checkbox" name="Conditions" class:list={["mr-2", { "border-red-500": getFieldError('Conditions') }]} aria-invalid={getFieldError('Conditions') ? "true" : "false"} aria-describedby={getFieldError('Conditions') ? "terms-error" : undefined} required />
                    <span class="text-sm">{productPageLayoutStrings.orderFormTermsLabel}</span>
                  </label>
                   {getFieldError('Conditions') && <div id="terms-error" class="text-red-500 text-sm mt-1">{getFieldError('Conditions')}</div>}
                   {!getFieldError('Conditions') && <div class="empty-feedback text-red-400 text-sm mt-1" data-for="form-terms" style="display:none;">{productPageLayoutStrings.validationTermsRequired}</div>}
                </div>

                <div class="md:col-span-2">
                  <button type="submit" class="w-full bg-black text-signal-green border border-signal-green font-semibold py-3 px-6 rounded-lg hover:bg-signal-green hover:text-black transition-colors flex items-center justify-center relative overflow-hidden">
                    <span class="relative z-10">{productPageLayoutStrings.orderFormSubmitButtonText}</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full animate-[shine_2s_infinite]" aria-hidden="true"></div>
                  </button>
                </div>
                <div id="productOrderFormResult" class="md:col-span-2 mt-3 text-center">
                  {/* This div is now handled by the messages above the form */}
                </div>
              </form>
            </div>
          </section>

          <section class="bg-signal-green rounded-xl p-8 mt-12">
             <h2 class="text-2xl font-bold mb-6 text-black">{productPageLayoutStrings.faqSectionTitle}</h2>
            <div class="space-y-4">
              {productFaqItems.map((item) => (
                <details class="bg-signal-green rounded-lg group">
                  <summary class="p-4 cursor-pointer font-medium text-black hover:bg-[#a5d429] flex items-center justify-between rounded-t-lg border border-black group-open:rounded-b-none">
                    {item.question}
                    <svg class="w-6 h-6 transform transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </summary>
                  <div class="p-4 text-white bg-black rounded-b-lg">{item.answer}</div>
                </details>
              ))}
            </div>
            <div class="text-center mt-8">
              <a href="#narocilnica" class="inline-flex items-center bg-white text-black border border-black font-medium py-3 px-6 rounded-lg hover:bg-black hover:text-white transition-colors">
                <svg class="w-5 h-5 mr-2 transition-colors" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                {productPageLayoutStrings.faqBackButtonText}
              </a>
            </div>
          </section>
        </div>

        {filteredRelatedProducts && filteredRelatedProducts.length > 0 && (
          <section aria-labelledby="related-products-heading" class="mt-16">
            <h2 id="related-products-heading" class="text-2xl font-bold mb-6">{productPageLayoutStrings.relatedProductsTitle}</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {filteredRelatedProducts.map(relatedP => (
                <div class="product-card bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                  <a href={relatedP.url} class="block relative overflow-hidden pb-[75%]">
                    <img
                      src={relatedP.image}
                      alt={relatedP.title}
                      loading="lazy"
                      class="absolute inset-0 w-full h-full object-cover object-center"
                      width="350"
                      height="350"
                      />
                  </a>
                  <div class="p-4">
                    <h3 class="font-medium text-lg mb-4"><a href={relatedP.url} class="text-signal-dark hover:text-signal-green transition-colors">{relatedP.title}</a></h3>
                    <a href={relatedP.url} class="inline-block bg-white border border-signal-gray hover:border-signal-green text-signal-dark font-medium py-2 px-4 rounded-md transition-colors w-full text-center">{productPageLayoutStrings.relatedProductViewButtonText}</a>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {/* Related Articles Section */}
        {relatedArticles && relatedArticles.length > 0 && (
          <section aria-labelledby="related-articles-heading" class="mt-16">
            <h2 id="related-articles-heading" class="text-2xl font-bold mb-6">{common.ARTICLE_RELATED_ARTICLES}</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              {relatedArticles.map(article => (
                <article class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                  <h3 class="font-semibold text-lg mb-2">
                    <a href={article.url} class="text-signal-dark hover:text-signal-green transition-colors">
                      {article.title}
                    </a>
                  </h3>
                  <p class="text-signal-gray text-sm">
                    {new Date(article.date).toLocaleDateString(`${languageIso}-${countryCode}`, { 
                      year: 'numeric', 
                      month: 'short', 
                      day: 'numeric' 
                    })}
                  </p>
                </article>
              ))}
            </div>
          </section>
        )}
      </div>

      <div class="hidden lg:block lg:w-1/3">
        <aside class="bg-black text-white rounded-lg shadow-sm p-6 sticky top-20">
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4 text-white">{productPageLayoutStrings.techSpecTitle}</h3>
            <ul class="space-y-4">
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M3 5h11m-2 2l2-2l-2-2M5 3L3 5l2 2m14 3v11m-2-2l2 2l2-2m0-7l-2-2l-2 2M3 12a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /></svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecDimensionsLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.dimensions}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecMaterialLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.material}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 7q.425 0 .713-.288T13 6t-.288-.712T12 5t-.712.288T11 6t.288.713T12 7m2.825 0h1.75q.75 0 1.3.5t.675 1.225l1.425 10q.125.9-.462 1.588T18 21H6q-.925 0-1.513-.687t-.462-1.588l1.425-10Q5.575 8 6.125 7.5t1.3-.5h1.75q-.075-.25-.125-.487T9 6q0-1.25.875-2.125T12 3t2.125.875T15 6q0 .275-.05.513T14.825 7"/></svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecWeightLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.weight}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecVisibilityLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.visibility}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 512 512" aria-hidden="true">
                    <defs>
                      <symbol id="meteoconsWind_desktop" viewBox="0 0 342 234"> {/* Unique ID for second instance */}
                        <path fill="none" stroke="currentColor" stroke-dasharray="148" stroke-linecap="round" stroke-miterlimit="10" stroke-width="18" d="M264.2 21.3A40 40 0 1 1 293 89H9">
                          <animate attributeName="stroke-dashoffset" dur="7.2s" repeatCount="indefinite" values="0; 2960"/>
                        </path>
                        <path fill="none" stroke="currentColor" stroke-dasharray="110" stroke-linecap="round" stroke-miterlimit="10" stroke-width="18" d="M148.2 212.7A40 40 0 1 0 177 145H9">
                          <animate attributeName="stroke-dashoffset" dur="7.2s" repeatCount="indefinite" values="0; 1540"/>
                        </path>
                      </symbol>
                    </defs>
                    <use width="342" height="234" href="#meteoconsWind_desktop" transform="translate(85 139)"/>
                  </svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecWindResistanceLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.windResistance}</span></div>
              </li>
              <li class="flex items-start">
                <span class="text-signal-green mr-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,20a9,9,0,1,1,9-9A9,9,0,0,1,12,21Z"/>
                    <rect width="2" height="7" x="11" y="6" fill="currentColor" rx="1">
                      <animateTransform attributeName="transform" dur="10.8s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/>
                    </rect>
                    <rect width="2" height="9" x="11" y="11" fill="currentColor" rx="1">
                      <animateTransform attributeName="transform" dur="0.9s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/>
                    </rect>
                  </svg>
                </span>
                <div><span class="block font-medium text-white">{productPageLayoutStrings.techSpecSetupTimeLabel}</span><span class="text-sm text-gray-300">{productCoreData.specifications.setupTime}</span></div>
              </li>
            </ul>
          </div>
          <div class="mb-6 border-t border-gray-700 pt-6">
            <h3 class="text-lg font-semibold mb-4 text-white">{productPageLayoutStrings.customerSupportTitle}</h3>
            <div class="flex items-center">
              <span class="text-signal-green mr-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" aria-hidden="true"><mask id="lineMdEmailArrowRightFilled_customerSupport"><g fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="64" stroke-dashoffset="64" d="M4 5h16c0.55 0 1 0.45 1 1v12c0 0.55 -0.45 1 -1 1h-16c-0.55 0 -1 -0.45 -1 -1v-12c0 -0.55 0.45 -1 1 -1Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.72s" values="64;0"/></path><path stroke-dasharray="24" stroke-dashoffset="24" d="M3 6.5l9 5.5l9 -5.5"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.72s" dur="0.24s" values="24;0"/></path><path fill="#fff" fill-opacity="0" stroke="none" d="M12 11l-8 -5h16l-8 5Z"><animate fill="freeze" attributeName="fill-opacity" begin="1.44s" dur="0.6s" values="0;1"/></path><path fill="#000" fill-opacity="0" stroke="none" d="M19 13c3.31 0 6 2.69 6 6c0 3.31 -2.69 6 -6 6c-3.31 0 -6 -2.69 -6 -6c0 -3.31 2.69 -6 6 -6Z"><set fill="freeze" attributeName="fill-opacity" begin="0.96s" to="1"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M16 19h5"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.96s" dur="0.24s" values="6;0"/></path><path stroke-dasharray="4" stroke-dashoffset="4" d="M21 19l-2 2M21 19l-2 -2"><animate fill="freeze" attributeName="stroke-dashoffset" begin="1.2s" dur="0.24s" values="4;0"/></path></g></mask><rect width="24" height="24" fill="currentColor" mask="url(#lineMdEmailArrowRightFilled_customerSupport)"/></svg></span>
              <a href={`mailto:${productPageLayoutStrings.customerSupportEmail}`} class="text-signal-green hover:underline">{productPageLayoutStrings.customerSupportEmail}</a>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  @keyframes shine { 100% { transform: translateX(100%); } }
  .animate-\[shine\_2s\_infinite\] { animation: shine 2s infinite; }
  details > summary { list-style: none; }
  details > summary::-webkit-details-marker { display: none; }

  .invalid-feedback,
  .empty-feedback {
    display: none;
  }

  input:user-invalid ~ .empty-feedback,
  input:user-invalid ~ .invalid-feedback,
  select:user-invalid ~ .empty-feedback,
  input[type="radio"]:user-invalid ~ .empty-feedback,
  input[type="checkbox"]:user-invalid ~ .empty-feedback {
    display: block;
  }

  input:invalid,
  select:invalid,
  textarea:invalid {
  }
  input:invalid:focus,
  select:invalid:focus,
  textarea:invalid:focus {
  }
  .border-red-500 {
      border-color: #ef4444;
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const detailsElements = document.querySelectorAll('details');
    detailsElements.forEach(detail => {
      detail.addEventListener('toggle', () => {
        const summary = detail.querySelector('summary');
        if (summary) {
        }
      });
    });
  });
</script>