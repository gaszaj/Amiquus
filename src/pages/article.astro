---
import ArticleLayout from '../layouts/ArticleLayout.astro';
import type { RelatedArticleInfo } from '../layouts/ArticleLayout.astro';
import articleData from '../data/article.json';
import wwwData from '../data/www.json';
import commonData from '../data/common.json';

// Get the first (and only) object from each JSON array
const article = articleData[0];
const www = wwwData[0];
const common = commonData[0];

// Helper function for absolute URLs
const getAbsoluteUrl = (path) => {
  return new URL(path, Astro.url.origin).toString();
};

// Get language data
const languageIso = article.M_LANGUAGE_ISO;
const countryCode = article.M_COUNTRY_CODE;

// Find matching content orientation from common.json
const contentOrientation = commonData.find(item => 
  item.M_LANGUAGE_ISO === languageIso && 
  item.M_COUNTRY_CODE === countryCode
)?.M_CONTENT_ORIENTATION || 'ltr'; // Default to 'ltr' if no match found

// --- Article Specific Metadata ---
const articleMetadata = {
  title: article.ARTICLE_TITLE,
  description: article.ARTICLE_DESCRIPTION,
  ogImage: article.ARTICLE_OG_IMAGE_PATH,
  publishDate: article.ARTICLE_PUBLISH_DATE,
  updateDate: article.ARTICLE_UPDATE_DATE,
  author: {
    name: article.ARTICLE_AUTHOR_NAME,
    profileUrl: article.ARTICLE_AUTHOR_PROFILE_URL,
    image: article.ARTICLE_AUTHOR_IMAGE
  },
  headings: [
    { depth: 2, slug: article.ARTICLE_H1_ID, text: article.ARTICLE_H1 },
    { depth: 3, slug: article.ARTICLE_H2_1_ID, text: article.ARTICLE_H2_1 },
    { depth: 2, slug: article.ARTICLE_H2_2_ID, text: article.ARTICLE_H2_2 },
    { depth: 3, slug: article.ARTICLE_H2_3_ID, text: article.ARTICLE_H2_3 },
    { depth: 2, slug: article.ARTICLE_H2_4_ID, text: article.ARTICLE_H2_4 },
    { depth: 2, slug: article.ARTICLE_H2_5_ID, text: article.ARTICLE_H2_5 },
    { depth: 3, slug: article.ARTICLE_H2_6_ID, text: article.ARTICLE_H2_6 }
  ]
};

// --- Content for Layout Sections & UI Text ---
const layoutContent = {
  authorLabelText: common.ARTICLE_AUTHOR_LABEL,
  publishedLabelText: common.ARTICLE_PUBLISHED_LABEL,
  updatedLabelText: common.ARTICLE_UPDATED_LABEL,
  mainDateLocale: article.PAGE_LOCALE,
  mainDateFormatOptions: { year: 'numeric', month: 'long', day: 'numeric' } as Intl.DateTimeFormatOptions,
  relatedDateLocale: article.PAGE_LOCALE,
  relatedDateFormatOptions: { year: 'numeric', month: 'short', day: 'numeric' } as Intl.DateTimeFormatOptions,
  tocContent: {
    title: common.ARTICLE_TOC_TITLE
  },
  editorialPolicyContent: {
    title: common.ARTICLE_EDITORIAL_POLICY_TITLE,
    description: common.ARTICLE_EDITORIAL_POLICY_DESC,
    ctaText: common.ARTICLE_EDITORIAL_POLICY_CTA,
    ctaLink: article.ARTICLE_EDITORIAL_INTERNAL_LINK
  },
  disclaimerContent: {
    text: common.ARTICLE_DISCLAIMER
  },
  helpBoxContent: {
    title: common.ARTICLE_HELP_BOX_TITLE,
    description: common.ARTICLE_HELP_BOX_DESC,
    ctaText: common.ARTICLE_HELP_BOX_CTA,
    ctaLink: `mailto:${www.PAGE_INFO_EMAIL}`
  }
};

// Define keywords for the page
const pageKeywords = [
  article.ARTICLE_H1,
  www.M_COUNTRY_NATIVE,
  www.PAGE_ORGANISATION_FULL_NAME
].join(', ');


// --- Related Articles Data and Logic ---
const allDomainArticles: RelatedArticleInfo[] = [ // Simulating a larger pool of articles
  { title: "Varnost, označevanje in opozarjanje pri tekaških dogodkih", url: "/articles/safety-signs-visibility-night", date: "2025-03-15" },
  { title: "Varnost, označevanje in opozarjanje pri športnih dogodkih", url: "/articles/eu-regulations-road-warning-systems", date: "2025-03-10" },
  { title: "Varnost, označevanje in opozarjanje pri kolesarskih dirkah", url: "/articles/maintain-triopan-warning-signs", date: "2025-03-05" },
  { title: "Varnost, označevanje in opozarjanje pri športnih turnirjih", url: "/articles/warning-signs-construction-sites", date: "2025-02-28" },
  { title: "Varnost, označevanje in opozarjanje pri športnih dnevih", url: "/articles/event-safety-warning-systems", date: "2025-02-20" },
  { title: "Varnost, označevanje in opozarjanje pri šolskih tekmovanjih", url: "/articles/highway-work-zone-safety", date: "2025-02-15" },
  { title: "Varnost, označevanje in opozarjanje pri javnih prireditvah", url: "/articles/emergency-response-warning-systems", date: "2025-02-10" },
  { title: "Varnost, označevanje in opozarjanje pri športnih objektih", url: "/articles/safety-sign-technology-innovation", date: "2025-02-05" }
];

const relatedArticlesForPage = {
  title: common.ARTICLE_RELATED_ARTICLES,
  articles: allDomainArticles
    .filter(article => article.title !== articleMetadata.title)
    .slice(0, 9)
};

// --- Product Data (specific to this article's content, stays in the page) ---
const basicSigns = [
  { name: article.ARTICLE_SIGN_1_NAME, image: article.ARTICLE_SIGN_1_IMAGE, url: article.ARTICLE_SIGN_1_URL },
  { name: article.ARTICLE_SIGN_2_NAME, image: article.ARTICLE_SIGN_2_IMAGE, url: article.ARTICLE_SIGN_2_URL },
  { name: article.ARTICLE_SIGN_3_NAME, image: article.ARTICLE_SIGN_3_IMAGE, url: article.ARTICLE_SIGN_3_URL }
];

const additionalSigns = [
  {
    image: article.ARTICLE_ADD_SIGN_1_IMAGE,
    name: article.ARTICLE_ADD_SIGN_1_NAME,
    url: article.ARTICLE_ADD_SIGN_1_URL
  },
  {
    image: "/productimg/triopan-pozor-viličar.webp",
    name: "Opozorilna piramida DELO NA CESTI 250m",
    url: "/si/opozorilna-piramida/delo-na-cesti-250m"
  },
  {
    image: "/productimg/triopan-delo-na-cesti.webp",
    name: "Opozorilna piramida DELO NA CESTI 500m",
    url: "/si/opozorilna-piramida/delo-na-cesti-500m"
  },
  {
    image: "/productimg/triopan-parkirni-prostor.webp",
    name: "Opozorilna piramida OBVOZ",
    url: "/si/opozorilna-piramida/obvoz"
  },
  {
    image: "/productimg/triopan-šolska-pot.webp",
    name: "Opozorilna piramida ŠOLSKA POT",
    url: "/si/opozorilna-piramida/šolska-pot"
  },
  {
    image: "/productimg/triopan-zoženje-z-desne.webp",
    name: "Opozorilna piramida ZOŽENJE Z DESNE",
    url: "/si/opozorilna-piramida/zozenje-z-desne"
  },
  {
    image: "/productimg/triopan-zoženje-z-leve.webp",
    name: "Opozorilna piramida ZOŽENJE Z LEVE",
    url: "/si/opozorilna-piramida/zozenje-z-leve"
  },
  {
    image: "/productimg/triopan-omejitev-hitrosti-10.webp",
    name: "Opozorilna piramida OMEJITEV HITROSTI",
    url: "/si/opozorilna-piramida/omejitev-hitrosti"
  }
];

// --- FAQ Data Structure ---
const faqSection = {
  title: article.ARTICLE_H2_5,
  items: [
    {
      question: article.ARTICLE_FAQ_Q1,
      answer: article.ARTICLE_FAQ_A1
    },
    {
      question: article.ARTICLE_FAQ_Q2,
      answer: article.ARTICLE_FAQ_A2
    },
    {
      question: article.ARTICLE_FAQ_Q3,
      answer: article.ARTICLE_FAQ_A3
    }
  ]
};

const productButtonText = common.ARTICLE_PRODUCT_BUTTON;
const tableLinkText = common.ARTICLE_TABLE_LINK;
const ogImage = article.ARTICLE_OG_IMAGE_PATH;

// --- Article Schema ---
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": articleMetadata.title,
  "url": Astro.url.href,
  "description": articleMetadata.description,
  "inLanguage": article.PAGE_LOCALE,
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": article.M_HOME_NAME,
        "item": Astro.url.origin
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": articleMetadata.title,
        "item": Astro.url.href
      }
    ]
  },
  "mainEntity": {
    "@type": "Article",
    "headline": articleMetadata.title,
    "description": articleMetadata.description,
    "image": getAbsoluteUrl(articleMetadata.ogImage),
    "author": {
      "@type": "Person",
      "name": articleMetadata.author.name,
      "image": getAbsoluteUrl(articleMetadata.author.image),
      "url": getAbsoluteUrl(articleMetadata.author.profileUrl)
    },
    "datePublished": articleMetadata.publishDate,
    "dateModified": articleMetadata.updateDate,
    "inLanguage": article.PAGE_LOCALE
  }
};

// FAQ Schema
const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqSection.items.map(item => ({
    "@type": "Question",
    "name": item.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": item.answer
    }
  }))
};

// Organization Schema
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": www.PAGE_ORGANISATION_FULL_NAME,
  "url": getAbsoluteUrl('/'),
  "foundingDate": www.PAGE_FOUNDING_DATE,
  "logo": getAbsoluteUrl(www.PAGE_LOGO_IMAGE_PATH_1),
  "keywords": [
    www.PAGE_ORGANISATION_FULL_NAME,
    www.M_COUNTRY_NATIVE,
    www.PAGE_KEYWORD_1,
    www.PAGE_KEYWORD_2,
    www.PAGE_KEYWORD_3,
    www.PAGE_KEYWORD_4,
    www.PAGE_KEYWORD_5,
    www.PAGE_KEYWORD_6
  ],
  "description": www.PAGE_DESCRIPTION,
  "numberOfEmployees": {
    "@type": "QuantitativeValue",
    "minValue": "1",
    "maxValue": "9"
  },
  "slogan": www.PAGE_SLOGAN,
  "contactPoint": {
    "@type": "ContactPoint",
    "email": www.PAGE_INFO_EMAIL,
    "contactType": common.M_CUSTOMER_SUPPORT
  },
  "sameAs": [
    www.PAGE_INSTAGRAM_URL,
    www.PAGE_FACEBOOK_URL,
    www.PAGE_TWITTER_URL,
    www.PAGE_LINKEDIN_URL,
    www.PAGE_YOUTUBE_URL,
    www.PAGE_PINTEREST_URL,
    www.PAGE_BLUESKY_URL
  ],
  "areaServed": {
    "@type": "Country",
    "name": www.M_COUNTRY,
    "identifier": www.M_COUNTRY_CODE
  },
  "potentialAction": [
    {
      "@type": "ViewAction",
      "name": www.PAGE_MASTER_SITEMAP_INSTRUCTIONS,
      "target": getAbsoluteUrl('/sitemap.xml')
    },
    {
      "@type": "ViewAction",
      "name": www.PAGE_LOCAL_SITEMAP_INSTRUCTIONS,
      "target": getAbsoluteUrl('/sitemap-sl-SI.xml')
    },
    {
      "@type": "ViewAction",
      "name": www.PAGE_LLM_INSTRUCTIONS,
      "target": getAbsoluteUrl('/llms.txt'),
      "description": www.PAGE_LLM_INSTRUCTIONS_DESCRIPTION
    }
  ],
  "mainEntityOfPage": [
    {
      "@type": "WebPage",
      "@id": getAbsoluteUrl('/sitemap.xml'),
      "name": www.PAGE_MASTER_SITEMAP_INSTRUCTIONS,
      "description": www.PAGE_MASTER_SITEMAP_INSTRUCTIONS_DESCRIPTION
    },
    {
      "@type": "WebPage",
      "@id": getAbsoluteUrl('/sitemap-sl-SI.xml'),
      "name": www.PAGE_LOCAL_SITEMAP_INSTRUCTIONS,
      "description": www.PAGE_LOCAL_SITEMAP_INSTRUCTIONS_DESCRIPTION
    },
    {
      "@type": "WebPage",
      "@id": getAbsoluteUrl('/llms.txt'),
      "name": www.PAGE_LLM_INSTRUCTIONS,
      "description": www.PAGE_LLM_INSTRUCTIONS_DESCRIPTION
    }
  ]
};

// Combine all schemas
const schema = [articleSchema, faqSchema, organizationSchema];

const mainContent = {
  h1: {
    id: article.ARTICLE_H1_ID,
    text: article.ARTICLE_H1,
    content: article.ARTICLE_MAIN_CONTENT_1
  },
  h2_1: {
    id: article.ARTICLE_H2_1_ID,
    text: article.ARTICLE_H2_1,
    content: article.ARTICLE_MAIN_CONTENT_2,
    conclusion: article.ARTICLE_MAIN_CONTENT_3
  },
  h2_2: {
    id: article.ARTICLE_H2_2_ID,
    text: article.ARTICLE_H2_2,
    content: article.ARTICLE_MAIN_CONTENT_4
  },
  h2_3: {
    id: article.ARTICLE_H2_3_ID,
    text: article.ARTICLE_H2_3,
    content: article.ARTICLE_MAIN_CONTENT_5
  },
  h2_4: {
    id: article.ARTICLE_H2_4_ID,
    text: article.ARTICLE_H2_4,
    content: article.ARTICLE_MAIN_CONTENT_6
  },
  h2_6: {
    id: article.ARTICLE_H2_6_ID,
    text: article.ARTICLE_H2_6,
    content: article.ARTICLE_MAIN_CONTENT_7
  }
};
---

<ArticleLayout
  languageIso={languageIso}
  countryCode={countryCode}
  contentOrientation={contentOrientation}
  title={articleMetadata.title}
  description={articleMetadata.description}
  ogImage={articleMetadata.ogImage}
  keywords={pageKeywords}
  publishDate={articleMetadata.publishDate}
  updateDate={articleMetadata.updateDate}
  author={articleMetadata.author}
  headings={articleMetadata.headings}
  mainDateLocale={layoutContent.mainDateLocale}
  mainDateFormatOptions={layoutContent.mainDateFormatOptions}
  relatedDateLocale={layoutContent.relatedDateLocale}
  relatedDateFormatOptions={layoutContent.relatedDateFormatOptions}
  authorLabelText={layoutContent.authorLabelText}
  publishedLabelText={layoutContent.publishedLabelText}
  updatedLabelText={layoutContent.updatedLabelText}
  tocContent={layoutContent.tocContent}
  editorialPolicyContent={layoutContent.editorialPolicyContent}
  disclaimerContent={layoutContent.disclaimerContent}
  relatedArticlesContent={relatedArticlesForPage}
  helpBoxContent={layoutContent.helpBoxContent}
  schema={schema}
  basicSigns={basicSigns}
  additionalSigns={additionalSigns}
  faqSection={faqSection}
  productButtonText={productButtonText}
  tableLinkText={tableLinkText}
  fearBannerText={article.ARTICLE_FEAR_BANNER}
  helpfulBannerText={article.ARTICLE_HELPFUL_BANNER}
  tableHeaders={{
    image: article.ARTICLE_TABLE_HEADER_IMAGE,
    name: article.ARTICLE_TABLE_HEADER_NAME,
    link: article.ARTICLE_TABLE_HEADER_LINK
  }}
  warningTrianglesText={article.ARTICLE_MAIN_CONTENT_5}
  checkOfferText={article.ARTICLE_MAIN_CONTENT_7}
  mainContent={mainContent}
>
  <!-- Main article content -->
  <h2 id={article.ARTICLE_H1_ID}>{article.ARTICLE_H1}</h2>
  <p>{article.ARTICLE_MAIN_CONTENT_1}</p>

  <div class="fear-banner">
    {article.ARTICLE_FEAR_BANNER}
  </div>

  <h3 id={article.ARTICLE_H2_1_ID}>{article.ARTICLE_H2_1}</h3>
  <p>{article.ARTICLE_MAIN_CONTENT_2}</p>

  <div class="basic-signs-grid">
    {basicSigns.map(sign => (
      <div class="product-card">
        <img 
          src={sign.image} 
          alt={sign.name}
          class="w-full h-48 object-contain p-4"
        />
        <div class="p-4 text-center product-card-content">
          <h4 class="font-medium text-signal-dark mb-4 product-title">{sign.name}</h4>
          <a 
            href={sign.url}
            class="block w-full bg-black text-signal-green border border-signal-green font-medium py-2 px-4 rounded-md hover:bg-signal-green hover:text-black transition-all text-center"
          >
            {productButtonText}
          </a>
        </div>
      </div>
    ))}
  </div>

  <p>{article.ARTICLE_MAIN_CONTENT_3}</p>

  <h2 id={article.ARTICLE_H2_2_ID}>{article.ARTICLE_H2_2}</h2>
  <p>{article.ARTICLE_MAIN_CONTENT_4}</p>

  <h3 id={article.ARTICLE_H2_3_ID}>{article.ARTICLE_H2_3}</h3>

  <div class="overflow-x-auto my-8">
    <table class="w-full bg-white rounded-lg shadow-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-4 text-left">{article.ARTICLE_TABLE_HEADER_IMAGE}</th>
          <th class="p-4 text-left">{article.ARTICLE_TABLE_HEADER_NAME}</th>
          <th class="p-4 text-left">{article.ARTICLE_TABLE_HEADER_LINK}</th>
        </tr>
      </thead>
      <tbody>
        {additionalSigns.map((sign, index) => (
          <tr class={index % 2 === 0 ? 'bg-gray-50' : ''}>
            <td class="p-4">
              <img 
                src={sign.image} 
                alt={sign.name}
                class="w-20 h-20 object-contain"
              />
            </td>
            <td class="p-4 font-medium text-signal-dark">{sign.name}</td>
            <td class="p-4">
              <a 
                href={sign.url}
                class="text-black underline decoration-signal-green hover:text-signal-green hover:decoration-black transition-colors"
              >
                {tableLinkText}
              </a>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  <p>{article.ARTICLE_MAIN_CONTENT_5}</p>

  <h2 id={article.ARTICLE_H2_4_ID}>{article.ARTICLE_H2_4}</h2>
  <p>{article.ARTICLE_MAIN_CONTENT_6}</p>

  <div class="helpful-banner">
    {article.ARTICLE_HELPFUL_BANNER}
  </div>

  <section class="faq-section" aria-labelledby="faq-heading">
    <h2 id="faq-heading" class="faq-title">{faqSection.title}</h2>
    <dl class="faq-list">
      {faqSection.items.map(item => (
        <div class="faq-item">
          <dt class="faq-question">
            <h3>{item.question}</h3>
          </dt>
          <dd class="faq-answer">
            <p>{item.answer}</p>
          </dd>
        </div>
      ))}
    </dl>
  </section>

  <h3 id={article.ARTICLE_H2_6_ID}>{article.ARTICLE_H2_6}</h3>
  <p>{article.ARTICLE_MAIN_CONTENT_7}</p>
  
  <div class="basic-signs-grid">
    {[...basicSigns, ...additionalSigns.slice(0, 3)].map(sign => (
      <div class="product-card">
        <img 
          src={sign.image} 
          alt={sign.name}
          class="w-full h-48 object-contain p-4"
          width={225}
          height={225}
        />
        <div class="p-4 text-center product-card-content">
          <h4 class="font-medium text-signal-dark mb-4 product-title">{sign.name}</h4>
          <a 
            href={sign.url}
            class="block w-full bg-black text-signal-green border border-signal-green font-medium py-2 px-4 rounded-md hover:bg-signal-green hover:text-black transition-all text-center"
          >
            {productButtonText}
          </a>
        </div>
      </div>
    ))}
  </div>
</ArticleLayout>