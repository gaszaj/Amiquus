---
// src/pages/404.astro
import BaseLayout from '../layouts/BaseLayout.astro';
import path from 'path';
import Database from 'better-sqlite3';

// --- LANGUAGE DETECTION LOGIC (Adapted from your old project) ---
const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true });

const { supportedSlugs, publishedLocales } = db.transaction(() => {
    const locales = db.prepare("SELECT M_SLUG FROM locale WHERE M_LOCALE_PUBLISH_Y_N = '1'").all() as any[];
    const slugs = locales.map(l => l.M_SLUG);
    return { supportedSlugs: slugs, publishedLocales: locales };
})();

const defaultSlug = 'en'; // Your primary fallback language
let determinedSlug = defaultSlug;

// Priority 1: Check for our 'last_lang' cookie.
const langCookie = Astro.cookies.get('last_lang');
if (langCookie && supportedSlugs.includes(langCookie.value)) {
  determinedSlug = langCookie.value;
} else {
  // Priority 2 (Fallback): Check the browser's language preference.
  const acceptLanguage = Astro.request.headers.get('accept-language');
  if (acceptLanguage) {
    const preferredLangs = acceptLanguage.split(',').map(lang => lang.split(';')[0].toLowerCase().split('-')[0]);
    const matchedSlug = preferredLangs.find(lang => supportedSlugs.includes(lang));
    if (matchedSlug) {
      determinedSlug = matchedSlug;
    }
  }
}

// --- HARDCODED CONTENT (with new additions) ---
const pageData = {
  title: "404 - Page Not Found",
  description: "The page you are looking for does not exist or has been moved.",
  headline: "Oops! Page Not Found",
  subtext: "It looks like the page you were searching for has wandered off. Don't worry, it happens to the best of us.",
  homeButtonText: "Return to Homepage",
  alertsButtonText: "Set Up Car Alerts",
  suggestionsTitle: "We suggest trying one of the following options:",
  contactText: "If you believe this page should exist and think this is our mistake, we would be very grateful if you let us know via our"
};
const requestedUrl = Astro.url.pathname;
---

<BaseLayout
  languageIso="en"
  countryCode="US"
  contentOrientation="ltr"
  title={pageData.title}
  description={pageData.description}
  languageLinksMap={{ 'en': '/en', 'de': '/de' }}
  currentSlug={determinedSlug}
>
  <main class="flex items-center justify-center min-h-[calc(100vh-200px)] py-16 px-4">
    <div class="max-w-2xl mx-auto text-center">
      <div class="inline-flex items-center justify-center text-primary mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <h1 class="text-4xl lg:text-5xl font-bold text-foreground mb-4">
        {pageData.headline}
      </h1>
      <p class="text-lg text-muted-foreground mb-8">
        We're sorry, but the page you were looking for at <code class="font-semibold text-primary">Amiquus.com</code> could not be found. It may have been moved, deleted, or you may have typed the address incorrectly.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href={`/${determinedSlug}/`} class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-semibold bg-primary text-primary-foreground shadow-lg hover:opacity-90 transition-transform hover:-translate-y-1">
          {pageData.homeButtonText}
        </a>
        <a href={`/${determinedSlug}/setup-alerts`} class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-semibold bg-transparent border-2 border-border text-foreground hover:bg-muted transition-colors">
          {pageData.alertsButtonText}
        </a>
      </div>

      <div class="mt-16 pt-8 border-t border-border text-start">
        <h2 class="text-lg font-semibold text-foreground mb-4">{pageData.suggestionsTitle}</h2>
        <ul class="space-y-3">
          <li class="flex items-start gap-3">
            <span class="text-primary mt-1 flex-shrink-0">→</span>
            <span>Return to the <a href={`/${determinedSlug}/`} class="font-semibold text-primary hover:underline">Homepage</a> and start over.</span>
          </li>
          <li class="flex items-start gap-3">
            <span class="text-primary mt-1 flex-shrink-0">→</span>
            <span>Explore how our <a href={`/${determinedSlug}/#how-it-works`} class="font-semibold text-primary hover:underline">alert setup process</a> works.</span>
          </li>
          <li class="flex items-start gap-3">
            <span class="text-primary mt-1 flex-shrink-0">→</span>
            <span>Learn more about our <a href={`/${determinedSlug}/#pricing`} class="font-semibold text-primary hover:underline">pricing and plans</a>.</span>
          </li>
          <li class="flex items-start gap-3">
            <span class="text-primary mt-1 flex-shrink-0">→</span>
            <span>Find out more <a href={`/${determinedSlug}/#features`} class="font-semibold text-primary hover:underline">about our features</a>.</span>
          </li>
        </ul>
        <p class="mt-8 text-sm text-muted-foreground">
          {pageData.contactText} <a href={`/${determinedSlug}/#contact`} class="font-semibold text-primary hover:underline">contact form</a>.
        </p>
      </div>
    </div>
  </main>
</BaseLayout>