---
// pages/404.astro

import BaseLayout from '../layouts/BaseLayout.astro';
import commonData from '../data/common.json';
import eeatData from '../data/eeat.json';
import localeData from '../data/locale.json';

const supportedSlugs = localeData.filter(l => l.M_LOCALE_PUBLISH_Y_N === "1").map(l => l.M_SLUG);
const defaultSlug = 'si'; // Your primary fallback language

let determinedSlug = defaultSlug;

// --- NEW, ROBUST LANGUAGE DETECTION ---

// Priority 1: Check for our 'last_lang' cookie. This is the most reliable source.
const langCookie = Astro.cookies.get('last_lang');
if (langCookie && supportedSlugs.includes(langCookie.value)) {
  determinedSlug = langCookie.value;
} else {
  // Priority 2 (Fallback): If no cookie, check the browser's language preference.
  // This handles first-time visitors who land directly on a broken link.
  const acceptLanguage = Astro.request.headers.get('accept-language');
  if (acceptLanguage) {
    const preferredLangs = acceptLanguage.split(',').map(lang => lang.split(';')[0].toLowerCase().split('-')[0]);
    const matchedSlug = preferredLangs.find(lang => supportedSlugs.includes(lang));
    if (matchedSlug) {
      determinedSlug = matchedSlug;
    }
  }
}

// --- DATA FETCHING AND RENDERING LOGIC (Remains the same as before) ---

const eeat = eeatData.find(entry => 
  entry.M_SLUG === determinedSlug && 
  entry.EEAT_FILTERING === "01"
);

const pageData = eeat || {
  EEAT_NAME: "404 Page Not Found",
  EEAT_H1: "404 - Page Not Found",
  EEAT_META_SEO: "The page you are looking for does not exist.",
  EEAT_CONTENT: `<p>We're sorry, we couldn't find the page you were looking for. Please use the main navigation to find your way or return to the homepage.</p><p>Please ensure your data/eeat.json file contains an entry for EEAT_FILTERING: "01" for the language: ${determinedSlug}.</p>`,
  M_LANGUAGE_ISO: "en",
  M_COUNTRY_CODE: "US",
};

const common = commonData.find(item => item.M_SLUG === determinedSlug);

// Fix TypeScript error by properly typing the languageLinksMap
const languageLinksMap: Record<string, string> = {};
for (const locale of localeData.filter(l => l.M_LOCALE_PUBLISH_Y_N === "1")) {
    languageLinksMap[locale.M_SLUG] = `/${locale.M_SLUG}/`;
}

const headline = pageData.EEAT_H1;
const pageContent = pageData.EEAT_CONTENT;
---

<BaseLayout
  title={pageData.EEAT_NAME}
  description={pageData.EEAT_META_SEO}
  languageIso={pageData.M_LANGUAGE_ISO}
  countryCode={pageData.M_COUNTRY_CODE}
  contentOrientation={common?.M_CONTENT_ORIENTATION || 'ltr'}
  languageLinksMap={languageLinksMap}
  currentSlug={determinedSlug}
>
  <div class="bg-black text-white py-16">
    <div class="container mx-auto ps-4 pe-4">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-6 animate-fade-in">{headline}</h1>
      </div>
    </div>
  </div>

  <div class="container mx-auto ps-4 pe-4 py-12">
    <div class="prose prose-lg max-w-4xl mx-auto">
      <Fragment set:html={pageContent} />
    </div>
  </div>
</BaseLayout>


<style>
  /* Base prose container */
  .prose {
    max-width: 65ch;
    margin-inline: auto; /* Use logical properties for RTL support */
  }

  /* Headings */
  .prose :global(h2) {
    color: black;
    font-size: 1.875rem; /* 30px */
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1.5rem;
  }

  .prose :global(h3) {
    color: black;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.5rem; /* 24px */
    font-weight: 600;
  }

  /* Paragraphs */
  .prose :global(p) {
    color: #374151; /* Tailwind gray-700 */
    margin-bottom: 1.25rem;
    line-height: 1.75;
  }

  /* Links */
  .prose :global(a) {
    color: black;
    text-decoration: underline;
    text-decoration-color: #BCEF2F; /* signal-green */
    text-underline-offset: 2px;
    transition: color 0.2s ease, text-decoration-color 0.2s ease;
  }

  .prose :global(a:hover) {
    color: #BCEF2F; /* signal-green */
    text-decoration-color: black;
  }

  /* Lists */
  .prose :global(ul) {
    list-style-type: none;
    margin-inline-start: 1.25rem; /* Use logical properties for RTL support */
    margin-bottom: 1.25rem;
  }

  .prose :global(ol) { 
    margin-inline-start: 1.25rem; /* Use logical properties for RTL support */
    margin-bottom: 1.25rem;
  }

  .prose :global(li) {
    position: relative;
    padding-inline-start: 1.5rem; /* Use logical properties for RTL support */
    margin-bottom: 0.75rem;
    line-height: 1.75;
  }

  .prose :global(ul li::before) {
    content: "";
    position: absolute;
    inset-inline-start: 0; /* Use logical properties for RTL support */
    top: 0.75rem;
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    background: #BCEF2F;
    border: 2px solid black;
  }
  
  /* Underline */
  .prose :global(u) {
    text-decoration: none;
    position: relative;
  }

  .prose :global(u::after) {
    content: "";
    position: absolute;
    inset-inline-start: 0; /* Use logical properties for RTL support */
    bottom: -2px;
    width: 100%;
    height: 2px;
    background: repeating-linear-gradient(
      45deg,
      #BCEF2F,
      #BCEF2F 2px,
      transparent 2px,
      transparent 4px
    );
  }

  /* Bold text */
  .prose :global(b) {
    font-weight: 700;
  }

  /* List items with links */
  .prose :global(li a) {
    display: inline-block;
  }

  /* Spacing between sections */
  .prose :global(h2 + p) {
    margin-top: 1rem;
  }

  .prose :global(p + ul) {
    margin-top: 0.5rem;
  }
  
  /* FAQ Section styling */
  .prose :global(.faq-section) {
    margin-top: 2rem;
  }

  .prose :global(.faq-section p) {
    margin-bottom: 1.5rem;
  }

  /* Animations */
  :global(.animate-fade-in) {
    animation: fadeIn 0.5s ease-in-out;
  }

  :global(.animate-slide-up) {
    animation: slideUp 0.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Add these new styles for author cards */
  .prose :global(.author-card) {
    text-decoration: none;
  }

  .prose :global(.author-card:hover) {
    text-decoration: none;
  }

  .prose :global(.author-card h3) {
    text-decoration: none;
  }

  .prose :global(.author-card:hover h3) {
    text-decoration: none;
  }

  /* Ensure images maintain aspect ratio during hover */
  .prose :global(.author-card img) {
    backface-visibility: hidden;
    transform: translateZ(0);
    -webkit-font-smoothing: subpixel-antialiased;
  }

  /* RTL-specific styles for better text rendering and alignment */
  :global([dir="rtl"]) .prose {
    text-align: right;
  }

  :global([dir="rtl"]) .prose :global(h2),
  :global([dir="rtl"]) .prose :global(h3) {
    text-align: right;
  }

  :global([dir="rtl"]) .prose :global(p) {
    text-align: right;
  }

  /* RTL-specific list styling */
  :global([dir="rtl"]) .prose :global(ul li::before) {
    inset-inline-end: 0;
    inset-inline-start: auto;
  }

  :global([dir="rtl"]) .prose :global(u::after) {
    inset-inline-end: 0;
    inset-inline-start: auto;
  }
</style>