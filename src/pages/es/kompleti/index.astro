---
// Path: /src/pages/si/kompleti/index.astro
// Purpose: Bundles listing page with dynamic RTL support
// Data: Database dependencies for bundles, products, common data, and locale data
// Dependencies: BaseLayout, infinite scroll, filtering

import path from 'path';
import Database from 'better-sqlite3';
import BaseLayout from '../../../layouts/BaseLayout.astro';

// --- Database Connection ---
const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true });

// --- DATA FETCHING & INITIAL FILTERING ---
const parentSlug = Astro.url.pathname.split('/')[1];
const currentFolder = Astro.url.pathname.split('/')[2];

const { common, www, allBundles, publishedLocales, productMap } = db.transaction(() => {
    const commonData = db.prepare('SELECT * FROM common WHERE M_SLUG = ?').get(parentSlug) as any;
    const wwwData = db.prepare('SELECT * FROM www LIMIT 1').get() as any;
    const bundles = db.prepare("SELECT * FROM bundle WHERE M_SLUG = ? AND PUBLISH_Y_N = '1'").all(parentSlug) as any[];
    const locales = db.prepare("SELECT M_SLUG FROM locale WHERE M_LOCALE_PUBLISH_Y_N = '1'").all() as any[];
    
    // Fetch all products to create a lookup map with numeric prices
    const allProducts = db.prepare("SELECT PRODUCT_ID, PRODUCT_IMAGE_PATH_L, PRODUCT_ASCII_SLUG, PAGE_COLLECTION_1_LISTING_SLUG, M_PRODUCT_PRICE_NUMERIC, M_PRODUCT_PRICE, PRODUCT_BUNDLES_NUMBER FROM product WHERE PUBLISH_Y_N = '1'").all() as any[];
    const pMap = new Map(allProducts.map(p => [p.PRODUCT_ID, p]));

    // Calculate dynamic prices for each bundle
    const bundlesWithCalculatedPrices = bundles.map(bundle => {
        const bundleId = bundle.BUNDLE_ID;
        
        // Find all products that belong to this bundle
        const bundleProducts = allProducts.filter(product => {
            if (!product.PRODUCT_BUNDLES_NUMBER) return false;
            const bundleIds = product.PRODUCT_BUNDLES_NUMBER.split(',').map(id => id.trim());
            return bundleIds.includes(bundleId);
        });
        
        // Calculate total price (assuming quantity 1 for each product)
        const totalPrice = bundleProducts.reduce((sum, product) => {
            const price = parseFloat(product.M_PRODUCT_PRICE_NUMERIC) || 0;
            return sum + price;
        }, 0);
        
        // Calculate savings (7% discount when 2 or more products)
        const discount = bundleProducts.length >= 2 ? 0.07 : 0;
        const finalPrice = totalPrice * (1 - discount);
        const savings = totalPrice - finalPrice;
        
        // Format prices for display
        const formatCurrency = (value: number) => {
            const currencySymbol = commonData?.M_CURRENCY_SYMBOL || 'â‚¬';
            return `${currencySymbol}${value.toFixed(2).replace('.', ',')}`;
        };
        
        return {
            ...bundle,
            BUNDLE_PRICE_RECALC: finalPrice,
            BUNDLE_PRICE: formatCurrency(finalPrice),
            BUNDLE_ORIGINAL_PRICE: formatCurrency(totalPrice),
            BUNDLE_SAVINGS_AMOUNT: formatCurrency(savings),
            BUNDLE_PRODUCT_COUNT: bundleProducts.length,
            BUNDLE_PRODUCTS: bundleProducts
        };
    });

    // Sort bundles by importance rank (desc), then by name (A-Z)
    const sortedBundles = bundlesWithCalculatedPrices.sort((a, b) => {
        const rankA = parseInt(a.BUNDLE_IMPORTANCE_RANK, 10) || 0;
        const rankB = parseInt(b.BUNDLE_IMPORTANCE_RANK, 10) || 0;
        if (rankB !== rankA) return rankB - rankA;
        return a.BUNDLE_NAME.localeCompare(b.BUNDLE_NAME);
    });

    return {
        common: commonData || {},
        www: wwwData,
        allBundles: sortedBundles,
        publishedLocales: locales,
        productMap: pMap
    };
})();

// --- BATCHING FOR INITIAL LOAD ---
const BATCH_SIZE = 9;
const initialBundles = allBundles.slice(0, BATCH_SIZE);

// --- METADATA AND SEO ---
const languageIso = allBundles[0]?.M_LANGUAGE_ISO || 'sl';
const countryCode = allBundles[0]?.M_COUNTRY_CODE || 'SI';
const contentOrientation = common.M_CONTENT_ORIENTATION || 'ltr';

const pageTitle = common.PAGE_COLLECTION_3_LISTING_TITLE;
const pageDescription = common.PAGE_COLLECTION_3_LISTING_DESCRIPTION;
const pageOgImage = common.PAGE_COLLECTION_3_LISTING_OG_IMAGE_PATH;
const pageKeywords = [common.PAGE_COLLECTION_3_LISTING_TITLE, common.M_COUNTRY_NATIVE, www.PAGE_ORGANISATION_FULL_NAME].join(', ');
const getBaseUrl = (path: string) => new URL(path, Astro.url.origin).toString();

// --- SCHEMA.ORG ---
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": www.PAGE_ORGANISATION_FULL_NAME,
  "url": getBaseUrl('/'),
  "foundingDate": www.PAGE_FOUNDING_DATE,
  "logo": getBaseUrl(www.PAGE_LOGO_IMAGE_PATH_1),
  "keywords": [
    www.PAGE_ORGANISATION_FULL_NAME,
    common.M_COUNTRY_NATIVE,
    common.PAGE_KEYWORD_1,
    common.PAGE_KEYWORD_2,
    common.PAGE_KEYWORD_3,
    common.PAGE_KEYWORD_4,
    common.PAGE_KEYWORD_5,
    common.PAGE_KEYWORD_6
  ].filter(Boolean),
  "description": common.PAGE_DESCRIPTION,
  "numberOfEmployees": {
    "@type": "QuantitativeValue",
    "minValue": "1",
    "maxValue": "9"
  },
  "slogan": common.PAGE_SLOGAN,
  "contactPoint": {
    "@type": "ContactPoint",
    "email": www.PAGE_INFO_EMAIL,
    "contactType": common.M_CUSTOMER_SUPPORT
  },
  "sameAs": [
    www.PAGE_INSTAGRAM_URL,
    www.PAGE_FACEBOOK_URL,
    www.PAGE_TWITTER_URL,
    www.PAGE_LINKEDIN_URL,
    www.PAGE_YOUTUBE_URL,
    www.PAGE_PINTEREST_URL,
    www.PAGE_BLUESKY_URL
  ].filter(Boolean),
  "areaServed": {
    "@type": "Country",
    "name": common.M_COUNTRY,
    "identifier": common.M_COUNTRY_CODE
  },
  "potentialAction": [
    {
      "@type": "ViewAction",
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/sitemap.xml')
    },
    {
      "@type": "ViewAction",
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`)
    },
    {
      "@type": "ViewAction",
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/llms.txt'),
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ],
  "mainEntityOfPage": [
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/sitemap.xml'),
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a structured list of pages available on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`),
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a full and structured list of localized pages for ${languageIso} (${languageIso}-${countryCode}) locale on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/llms.txt'),
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ]
};

const collectionPageSchema = {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "@id": Astro.url.href,
    "name": pageTitle,
    "description": pageDescription,
    "mainEntity": {
        "@type": "ItemList",
        "itemListElement": allBundles.map((bundle, index) => ({
            "@type": "ListItem",
            "position": index + 1,
            "item": {
                "@type": "Product",
                "name": bundle.BUNDLE_NAME,
                "url": `${Astro.url.origin}/${parentSlug}/${currentFolder}/${bundle.BUNDLE_ASCII_SLUG}`,
                "image": `${Astro.url.origin}${bundle.BUNDLE_OG_IMAGE_PATH}`,
                "description": bundle.BUNDLE_META_SEO,
                "offers": {
                    "@type": "Offer",
                    "price": bundle.BUNDLE_PRICE_RECALC,
                    "priceCurrency": "EUR",
                    "availability": "https://schema.org/InStock"
                },
                "brand": { "@type": "Brand", "name": www.PAGE_ORGANISATION_FULL_NAME }
            }
        }))
    }
};
const schema = [collectionPageSchema, organizationSchema];

// --- LANGUAGE LINKS ---
const languageLinksMap: Record<string, string> = {};
for (const localeObj of publishedLocales) {
  const bundleForLocale = db.prepare("SELECT * FROM bundle WHERE M_SLUG = ? AND PUBLISH_Y_N = '1' AND PAGE_COLLECTION_3_LISTING_SLUG IS NOT NULL LIMIT 1").get(localeObj.M_SLUG) as any;
  languageLinksMap[localeObj.M_SLUG] = bundleForLocale ? `/${localeObj.M_SLUG}/${bundleForLocale.PAGE_COLLECTION_3_LISTING_SLUG}` : `/${localeObj.M_SLUG}`;
}
---
<BaseLayout
    languageIso={languageIso}
    countryCode={countryCode}
    contentOrientation={contentOrientation}
    title={pageTitle}
    description={pageDescription}
    ogImage={pageOgImage}
    keywords={pageKeywords}
    schema={schema}
    languageLinksMap={languageLinksMap}
>

    <div class="bg-black text-white py-16">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl md:text-5xl font-bold mb-6 animate-fade-in">{common.PAGE_COLLECTION_3_LISTING_SLUG_HELPER}</h1>
        </div>
    </div>

    <section class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <div class="bg-white p-4 rounded-lg shadow-sm mb-8 border border-gray-200">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap items-center gap-x-6 gap-y-4">
                        <label for="sort-select" class="block text-sm font-medium text-gray-700">{common.UI_SORT_BY}</label>
                        <select id="sort-select" class="rounded-md border-gray-300">
                            <option value="importance">{common.UI_SORT_IMPORTANCE}</option>
                            <option value="price-asc">{common.UI_SORT_PRICE_ASC}</option>
                            <option value="price-desc">{common.UI_SORT_PRICE_DESC}</option>
                            <option value="az">{common.UI_SORT_AZ}</option>
                            <option value="za">{common.UI_SORT_ZA}</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="bundle-count" class="text-sm text-gray-600"></span>
                        <button id="clear-filters-btn" class="text-sm font-medium text-signal-green hover:underline">{common.UI_BUTTON_CLEAR_FILTERS}</button>
                    </div>
                </div>
            </div>

            <div id="bundles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {initialBundles.map((bundle) => {
                    const bundleUrl = `/${parentSlug}/${currentFolder}/${bundle.BUNDLE_ASCII_SLUG}`;
                    // Use the calculated products from the bundle
                    const collageProducts = bundle.BUNDLE_PRODUCTS.slice(0, 3);
                    return (
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden group flex flex-col transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
                            <a href={bundleUrl} class="flex-grow flex flex-col">
                                <div class="relative h-56 bg-gray-100 p-2">
                                    {collageProducts.map((p, i) => (
                                        <img src={p.PRODUCT_IMAGE_PATH_L} alt="" class={`absolute w-1/2 h-1/2 object-contain transition-transform duration-300 group-hover:scale-105 ${i === 0 ? 'top-2 left-2' : i === 1 ? 'top-2 right-2' : 'bottom-2 left-1/4'}`} loading="lazy" decoding="async"/>
                                    ))}
                                </div>
                                <div class="p-5 border-t border-gray-100 flex-grow flex flex-col justify-between">
                                    <div>
                                        <h3 class="font-bold text-lg text-black group-hover:text-signal-green transition-colors mb-2">{bundle.BUNDLE_NAME}</h3>
                                        <div class="flex justify-between items-baseline mb-4">
                                            <span class="text-2xl font-bold text-black">{bundle.BUNDLE_PRICE}</span>
                                            {bundle.BUNDLE_PRODUCT_COUNT >= 2 && (
                                                <span class="text-green-600 font-semibold bg-green-100 px-2 py-1 rounded">{common.BUNDLE_SAVINGS_LABEL} {bundle.BUNDLE_SAVINGS_AMOUNT}</span>
                                            )}
                                        </div>
                                        {bundle.BUNDLE_PRODUCT_COUNT >= 2 && (
                                            <div class="text-sm text-gray-500 mb-2">
                                                <span class="line-through">{bundle.BUNDLE_ORIGINAL_PRICE}</span>
                                                <span class="text-green-600 font-semibold ms-2">{common.BUNDLE_DISCOUNT_TEXT}</span>
                                            </div>
                                        )}
                                    </div>
                                    <span class="block w-full mt-2 bg-black text-signal-green border border-signal-green py-2 px-4 rounded-md hover:bg-signal-green hover:text-black transition-all text-center font-semibold">{common.BUNDLE_VIEW_BUNDLE_BUTTON}</span>
                                </div>
                            </a>
                        </div>
                    );
                })}
            </div>

            <div id="grid-footer" class="text-center mt-12">
                <div id="no-results" class="hidden text-gray-500">{common.UI_NO_BUNDLES_FOUND}</div>
                <div id="infinite-scroll-trigger" class="h-10 text-gray-500 font-semibold">{common.UI_LOADING_MORE}</div>
            </div>
        </div>
    </section>
</BaseLayout>

<script define:vars={{ allBundles, productMap, parentSlug, currentFolder, common, BATCH_SIZE }}>
    // --- DOM ELEMENTS ---
    const grid = document.getElementById('bundles-grid');
    const trigger = document.getElementById('infinite-scroll-trigger');
    const noResultsMsg = document.getElementById('no-results');
    const bundleCountSpan = document.getElementById('bundle-count');
    const sortSelect = document.getElementById('sort-select');
    const clearBtn = document.getElementById('clear-filters-btn');

    // --- STATE MANAGEMENT ---
    let bundlesToDisplay = [...allBundles];
    let currentPage = 1;
    let observer;

    // --- HELPER FUNCTIONS ---
    const getPluralString = (count) => {
        if (common.M_LANGUAGE_ISO === 'sl') {
            if (count % 100 === 1) return common.UI_BUNDLE_COUNT_SINGLE;
            if (count % 100 === 2) return common.UI_BUNDLE_COUNT_DUAL;
            if (count % 100 >= 3 && count % 100 <= 4) return common.UI_BUNDLE_COUNT_FEW;
            return common.UI_BUNDLE_COUNT_PLURAL;
        }
        return (count === 1 ? common.UI_BUNDLE_COUNT_SINGLE : common.UI_BUNDLE_COUNT_PLURAL);
    };

    const updateBundleCount = (count) => {
        bundleCountSpan.textContent = getPluralString(count).replace('{count}', count);
    };

    const createBundleCardHTML = (bundle) => {
        const bundleUrl = `/${parentSlug}/${currentFolder}/${bundle.BUNDLE_ASCII_SLUG}`;
        const collageProducts = bundle.BUNDLE_PRODUCTS.slice(0, 3);
        
        const collageHTML = collageProducts.map((p, i) => {
            const posClass = i === 0 ? 'top-2 left-2' : i === 1 ? 'top-2 right-2' : 'bottom-2 left-1/4';
            return `<img src="${p.PRODUCT_IMAGE_PATH_L}" alt="" class="absolute w-1/2 h-1/2 object-contain transition-transform duration-300 group-hover:scale-105 ${posClass}" loading="lazy" decoding="async"/>`;
        }).join('');

        const savingsHTML = bundle.BUNDLE_PRODUCT_COUNT >= 2 ? 
            `<span class="text-green-600 font-semibold bg-green-100 px-2 py-1 rounded">${common.BUNDLE_SAVINGS_LABEL} ${bundle.BUNDLE_SAVINGS_AMOUNT}</span>` : '';
        
        const originalPriceHTML = bundle.BUNDLE_PRODUCT_COUNT >= 2 ? 
            `<div class="text-sm text-gray-500 mb-2">
                <span class="line-through">${bundle.BUNDLE_ORIGINAL_PRICE}</span>
                <span class="text-green-600 font-semibold ms-2">${common.BUNDLE_DISCOUNT_TEXT}</span>
            </div>` : '';

        return `
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden group flex flex-col transition-all duration-300 hover:shadow-xl hover:-translate-y-1 animate-fade-in">
                <a href="${bundleUrl}" class="flex-grow flex flex-col">
                    <div class="relative h-56 bg-gray-100 p-2">${collageHTML}</div>
                    <div class="p-5 border-t border-gray-100 flex-grow flex flex-col justify-between">
                        <div>
                            <h3 class="font-bold text-lg text-black group-hover:text-signal-green transition-colors mb-2">${bundle.BUNDLE_NAME}</h3>
                            <div class="flex justify-between items-baseline mb-4">
                                <span class="text-2xl font-bold text-black">${bundle.BUNDLE_PRICE}</span>
                                ${savingsHTML}
                            </div>
                            ${originalPriceHTML}
                        </div>
                        <span class="block w-full mt-2 bg-black text-signal-green border border-signal-green py-2 px-4 rounded-md hover:bg-signal-green hover:text-black transition-all text-center font-semibold">${common.BUNDLE_VIEW_BUNDLE_BUTTON}</span>
                    </div>
                </a>
            </div>
        `;
    };

    // --- CORE LOGIC ---
    const applyFiltersAndSort = () => {
        let processedBundles = [...allBundles];

        // Apply sorting
        const sortBy = sortSelect.value;
        processedBundles.sort((a, b) => {
            switch (sortBy) {
                case 'price-asc': 
                    return a.BUNDLE_PRICE_RECALC - b.BUNDLE_PRICE_RECALC;
                case 'price-desc': 
                    return b.BUNDLE_PRICE_RECALC - a.BUNDLE_PRICE_RECALC;
                case 'az': 
                    return a.BUNDLE_NAME.localeCompare(b.BUNDLE_NAME);
                case 'za': 
                    return b.BUNDLE_NAME.localeCompare(a.BUNDLE_NAME);
                case 'importance': 
                default: 
                    const rankA = parseInt(a.BUNDLE_IMPORTANCE_RANK, 10) || 0;
                    const rankB = parseInt(b.BUNDLE_IMPORTANCE_RANK, 10) || 0;
                    if (rankB !== rankA) return rankB - rankA;
                    return a.BUNDLE_NAME.localeCompare(b.BUNDLE_NAME);
            }
        });
        
        return processedBundles;
    };

    const renderGrid = (bundles, append = false) => {
        if (!append) grid.innerHTML = '';
        const batchHtml = bundles.map(createBundleCardHTML).join('');
        grid.insertAdjacentHTML('beforeend', batchHtml);
    };

    const updateDisplay = () => {
        bundlesToDisplay = applyFiltersAndSort();
        currentPage = 1;
        const initialBatch = bundlesToDisplay.slice(0, BATCH_SIZE);
        renderGrid(initialBatch);
        updateBundleCount(bundlesToDisplay.length);
        noResultsMsg.style.display = bundlesToDisplay.length === 0 ? 'block' : 'none';
        trigger.style.display = bundlesToDisplay.length > BATCH_SIZE ? 'block' : 'none';
        setupObserver();
    };
    
    const loadMoreBundles = () => {
        currentPage++;
        const startIndex = (currentPage - 1) * BATCH_SIZE;
        const endIndex = startIndex + BATCH_SIZE;
        const nextBatch = bundlesToDisplay.slice(startIndex, endIndex);

        if (nextBatch.length > 0) renderGrid(nextBatch, true);
        if (endIndex >= bundlesToDisplay.length) {
            trigger.style.display = 'none';
            if(observer) observer.disconnect();
        }
    };
    
    const setupObserver = () => {
        if(observer) observer.disconnect();
        if(bundlesToDisplay.length <= BATCH_SIZE) return;
        observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) loadMoreBundles();
        }, { rootMargin: '400px' });
        observer.observe(trigger);
    };

    // --- EVENT LISTENERS & INITIALIZATION ---
    sortSelect.addEventListener('change', updateDisplay);
    clearBtn.addEventListener('click', () => {
        sortSelect.value = 'importance';
        updateDisplay();
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        updateBundleCount(allBundles.length);
        setupObserver();
    });
</script>

<style>
    .animate-fade-in { 
        animation: fadeIn 0.5s ease-in-out forwards; 
    }
    
    @keyframes fadeIn {
        from { 
            opacity: 0; 
            transform: translateY(10px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }

    /* RTL-specific styles for better text rendering */
    [dir="rtl"] h1,
    [dir="rtl"] h2,
    [dir="rtl"] h3,
    [dir="rtl"] h4,
    [dir="rtl"] h5,
    [dir="rtl"] h6,
    [dir="rtl"] p,
    [dir="rtl"] span,
    [dir="rtl"] label {
        letter-spacing: 0;
    }

    /* Ensure proper text alignment in RTL */
    [dir="rtl"] .text-center {
        text-align: center;
    }
</style>