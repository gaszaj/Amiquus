---
// src/pages/[lang]/[EEATslug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import path from 'path';
import Database from 'better-sqlite3';

// --- DATABASE & DATA FETCHING (Adapted from your old project) ---
export const prerender = false;
const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true });

const { EEATslug, lang } = Astro.params;
const locale = lang;

const eeatEntry = db.prepare('SELECT * FROM eeat WHERE M_SLUG = ? AND EEAT_SLUG = ?').get(locale, EEATslug);

if (!eeatEntry) {
  return Astro.redirect(`/${locale}/404`);
}

const { www, common, authors, publishedLocales, altEeatEntries, eeatSlugMap } = db.transaction(() => {
    // ... (Your existing database transaction logic here, it is correct)
    const wwwData = db.prepare('SELECT * FROM www LIMIT 1').get();
    const commonData = db.prepare('SELECT * FROM common WHERE M_SLUG = ?').get(locale);
    const authorData = db.prepare("SELECT * FROM author WHERE M_SLUG = ? AND PUBLISH_Y_N = '1'").all(locale);
    const locales = db.prepare("SELECT M_SLUG FROM locale WHERE M_LOCALE_PUBLISH_Y_N = '1'").all();
    const alts = db.prepare("SELECT M_SLUG, EEAT_SLUG FROM eeat WHERE EEAT_FILTERING = ? AND PUBLISH_Y_N = '1'").all(eeatEntry.EEAT_FILTERING);
    const eeatSlugsForLocale = db.prepare("SELECT EEAT_FILTERING, EEAT_SLUG FROM eeat WHERE M_SLUG = ? AND PUBLISH_Y_N = '1'").all(locale);
    const slugMap = new Map(eeatSlugsForLocale.map(e => [e.EEAT_FILTERING, e.EEAT_SLUG]));
    return { www: wwwData, common: commonData || {}, authors: authorData, publishedLocales: locales, altEeatEntries: alts, eeatSlugMap: slugMap };
})();


// --- PAGE LOGIC (Adapted from your old project) ---
const eeat = eeatEntry;
const isContactPage = eeat.EEAT_FILTERING === "19"; // Simplified for clarity

const processDynamicLinks = (htmlContent, slugMap, currentLocale) => {
  // ... (Your existing processDynamicLinks function is correct)
  if (!htmlContent) return '';
  const linkRegex = /<a\s+(?:[^>]*?\s+)?data-eeat-link="([^"]+)"(?:\s+data-anchor-slug="([^"]+)")?([^>]*)>(.*?)<\/a>/g;
  return htmlContent.replace(linkRegex, (match, linkId, anchorSlug, otherAttributes, anchorText) => {
    let resolvedUrl = '#'; 
    if (linkId === 'home') {
      resolvedUrl = `/${currentLocale}`;
    } else {
      const slug = slugMap.get(linkId);
      if (slug) {
        resolvedUrl = `/${currentLocale}/${slug}`;
      }
    }
    if (anchorSlug) resolvedUrl += `#${anchorSlug}`;
    return `<a href="${resolvedUrl}"${otherAttributes}>${anchorText}</a>`;
  });
};

const pageContent = processDynamicLinks(eeat.EEAT_CONTENT, eeatSlugMap, locale);
const languageIso = eeat.M_LANGUAGE_ISO;
const countryCode = eeat.M_COUNTRY_CODE;
const contentOrientation = common.M_CONTENT_ORIENTATION || 'ltr';

// --- LANGUAGE LINKS (Adapted from your old project) ---
const altEeatMap = new Map(altEeatEntries.map(e => [e.M_SLUG, e.EEAT_SLUG]));
const languageLinksMap: Record<string, string> = {};
for (const l of publishedLocales) {
  const altSlug = altEeatMap.get(l.M_SLUG);
  if (altSlug) {
    languageLinksMap[l.M_SLUG] = `/${l.M_SLUG}/${altSlug}`;
  }
}
---

<BaseLayout
  languageIso={languageIso}
  countryCode={countryCode}
  contentOrientation={contentOrientation}
  title={eeat.EEAT_NAME}
  description={eeat.EEAT_META_SEO}
  languageLinksMap={languageLinksMap}
  currentSlug={locale}
>
  <!-- Page Header -->
  <header class="bg-gradient-to-br from-muted to-background py-16 sm:py-20 text-center">
    <div class="max-w-screen-xl mx-auto px-4">
      <h1 class="text-4xl lg:text-5xl font-bold text-foreground mb-4 animate-on-scroll">
        {eeat.EEAT_H1}
      </h1>
      {eeat.EEAT_DATE_PUBLISHED && (
        <p class="text-muted-foreground animate-on-scroll" data-delay="100">
          Published on {new Date(eeat.EEAT_DATE_PUBLISHED).toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' })}
        </p>
      )}
    </div>
  </header>

  <!-- Main Content Area -->
  <article class="py-12 sm:py-16">
    <div class="max-w-4xl mx-auto px-4">
      <!-- 
        The `prose` class from @tailwindcss/typography styles the HTML from your database.
        It's theme-aware and supports RTL out of the box.
      -->
      <div class="prose prose-lg dark:prose-invert max-w-none">
        <Fragment set:html={pageContent} />
      </div>

      <!-- Contact Form (only shown if it's the contact page) -->
      {isContactPage && (
        <div class="mt-16 pt-12 border-t border-border">
          <div id="contact-form-container" class="max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-foreground text-center mb-2">Contact Us</h2>
            <p class="text-muted-foreground text-center mb-8">We'll get back to you as soon as possible.</p>
            
            <div id="contact-success-message" class="bg-success/10 border border-success/20 text-success p-4 rounded-xl text-center hidden mb-6">
              <h3 class="font-semibold">Message Sent!</h3>
              <p>Thank you for reaching out. We'll be in touch shortly.</p>
            </div>
            
            <form id="contact-form" class="bg-card border border-border rounded-xl p-8 shadow-lg space-y-4">
              <div class="text-start">
                <label for="contact-name" class="block text-sm font-medium text-foreground mb-1">Full Name</label>
                <input type="text" id="contact-name" name="name" class="w-full px-3 py-2 rounded-md border border-input bg-background focus:border-primary focus:ring-1 focus:ring-primary" placeholder="Your Name" required>
              </div>
              <div class="text-start">
                <label for="contact-email" class="block text-sm font-medium text-foreground mb-1">Email Address</label>
                <input type="email" id="contact-email" name="email" class="w-full px-3 py-2 rounded-md border border-input bg-background focus:border-primary focus:ring-1 focus:ring-primary" placeholder="you@example.com" required>
              </div>
              <div class="text-start">
                <label for="contact-message" class="block text-sm font-medium text-foreground mb-1">Message</label>
                <textarea id="contact-message" name="message" rows="4" class="w-full px-3 py-2 rounded-md border border-input bg-background focus:border-primary focus:ring-1 focus:ring-primary" placeholder="How can we help?" required></textarea>
              </div>
              <button type="submit" id="contact-submit-btn" class="w-full flex items-center justify-center px-6 py-3 rounded-lg font-semibold bg-primary text-primary-foreground hover:opacity-90 transition disabled:opacity-50">
                <span id="contact-submit-text">Send Message</span>
                <span id="contact-submit-loading" class="hidden"><div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin ms-2"></div></span>
              </button>
            </form>
          </div>
        </div>
      )}
    </div>
  </article>
</BaseLayout>