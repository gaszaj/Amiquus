---
import AuthorLayout from '../layouts/AuthorLayout.astro';
import { SI, GB, DE, HR, RS } from 'country-flag-icons/string/3x2';
import authorData from '../data/author.json';
import wwwData from '../data/www.json';
import commonData from '../data/common.json';

const author = authorData[0];
const www = wwwData[0];
const common = commonData[0];

// Helper function to create absolute URLs
const getAbsoluteUrl = (path) => {
  return new URL(path, Astro.url.origin).toString();
};

// Helper function to generate random date within a range
function getRandomDate(startDaysAgo, endDaysAgo) {
  const today = new Date();
  const startDate = new Date(today);
  startDate.setDate(today.getDate() - endDaysAgo);
  const endDate = new Date(today);
  endDate.setDate(today.getDate() - startDaysAgo);
  
  const randomTime = startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime());
  return new Date(randomTime);
}

// Helper function to generate random time between 8 AM and 3 PM
function getRandomTime() {
  const hours = Math.floor(Math.random() * 8) + 8; // 8-15
  const minutes = Math.floor(Math.random() * 60);
  const seconds = Math.floor(Math.random() * 60);
  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Generate published and updated dates
const publishedDate = getRandomDate(3, 10);
const updatedDate = new Date(publishedDate);
updatedDate.setDate(publishedDate.getDate() + Math.floor(Math.random() * 9) + 1);

// Format dates for schema
const formatDateForSchema = (date) => {
  return date.toISOString().split('T')[0];
};

// --- Author's Core Data ---
const authorProfileData = {
  name: author.WWW_AUTHOR,
  description: author.WWW_AUTHOR_BIO,
  image: getAbsoluteUrl(`/authors/${author.AUTHOR_IMAGE_NAME_ASCII}`),
  socialLinks: {
    linkedin: author.WWW_AUTHOR_LINKEDIN,
    twitter: author.WWW_AUTHOR_X,
    website: author.WWW_AUTHOR_WEBSITE,
    instagram: author.WWW_AUTHOR_INSTAGRAM,
    youtube: author.WWW_AUTHOR_YOUTUBE,
    quora: author.WWW_AUTHOR_QUORA_OR_TIKTOK,
    email: author.WWW_AUTHOR_EMAIL
  },
  jobTitle: author.WWW_AUTHOR_OCCUPATION,
  company: author.AUTHOR_WORKS_FOR,
};

// --- Data for Layout Sections & UI Text ---
const languagesData = [
  { name: "Slovenian", flag: SI },
  { name: "English", flag: GB },
  { name: "German", flag: DE },
  { name: "Croatian", flag: HR },
  { name: "Serbian", flag: RS }
];

// --- Data for Layout Sections & UI Text ---
const layoutStringsData = {
  // Using author data for personalized strings
  baseLayoutDescriptionPrefix: common.AUTHOR_TITLE_EXTENSION,
  authorImageAltText: `${author.WWW_AUTHOR} â€” ${author.EEAT_NAME_20} | ${www.PAGE_ORGANISATION_FULL_NAME}`,
  
  // Using common data for social media labels
  socialLinkLabelLinkedIn: common.AUTHOR_LINKEDIN_LABEL,
  socialLinkLabelTwitter: author.WWW_AUTHOR_X.includes('facebook') ? common.AUTHOR_FACEBOOK_LABEL : common.AUTHOR_TWITTER_LABEL,
  socialLinkLabelWebsite: common.AUTHOR_WEBSITE_LABEL,
  socialLinkLabelEmail: www.M_EMAIL,
  jobTitleAtCompanySeparator: " â€” ",
  
  // Using common data for section titles and icons
  languagesSectionTitle: common.AUTHOR_LANGUAGE_LABEL,
  languagesSectionIcon: "ðŸŒ",
  
  // Using author data for footer links
  footerLinkAllAuthorsText: common.AUTHOR_OTHER_AUTHORS,
  footerLinkAllAuthorsUrl: getAbsoluteUrl(`/${author.EEAT_URL_20}`),
  footerLinkEditorialPolicyText: common.AUTHOR_READ_MORE,
  footerLinkEditorialPolicyUrl: getAbsoluteUrl(`/${author.EEAT_SLUG_13}`),
};

// --- Schema Definition ---
// WebPage and Article Schema
const webpageSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": author.WWW_AUTHOR,
  "url": getAbsoluteUrl(author.AUTHOR_FULL_SLUG),
  "description": author.AUTHOR_META_SEO,
  "inLanguage": author.PAGE_LOCALE,
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": author.M_HOME_NAME,
        "item": Astro.url.origin
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": author.EEAT_NAME_20,
        "item": getAbsoluteUrl(`/${author.EEAT_URL_20}`)
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": author.WWW_AUTHOR,
        "item": getAbsoluteUrl(author.AUTHOR_FULL_SLUG)
      }
    ]
  },
  "mainEntity": {
    "@type": "Article",
    "headline": author.WWW_AUTHOR,
    "description": author.AUTHOR_META_SEO,
    "image": getAbsoluteUrl(author.AUTHOR_OG_IMAGE_PATH),
    "author": {
      "@type": "Organization",
      "name": www.PAGE_ORGANISATION_URL_NAME
    },
    "datePublished": `${formatDateForSchema(publishedDate)}T${getRandomTime()}+02:00`,
    "dateModified": `${formatDateForSchema(updatedDate)}T${getRandomTime()}+02:00`,
    "inLanguage": author.PAGE_LOCALE
  }
};

// Person Schema
const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": author.WWW_AUTHOR,
  "url": getAbsoluteUrl(author.AUTHOR_FULL_SLUG),
  "description": `${author.WWW_AUTHOR} â€” ${author.EEAT_NAME_20}: ${www.PAGE_ORGANISATION_FULL_NAME}. Preberite veÄ o tej osebi in kakÅ¡na je njegova vloga v podjetju.`,
  "sameAs": [
    author.WWW_AUTHOR_WEBSITE,
    author.WWW_AUTHOR_LINKEDIN,
    author.WWW_AUTHOR_X,
    author.WWW_AUTHOR_INSTAGRAM,
    author.WWW_AUTHOR_YOUTUBE,
    author.WWW_AUTHOR_QUORA_OR_TIKTOK,
    `mailto:${author.WWW_AUTHOR_EMAIL}`
  ],
  "email": author.WWW_AUTHOR_EMAIL,
  "jobTitle": author.WWW_AUTHOR_OCCUPATION,
  "worksFor": {
    "@type": "Organization",
    "name": www.PAGE_ORGANISATION_URL_NAME,
    "url": getAbsoluteUrl(www.PAGE_LOGO_IMAGE_PATH_1)
  },
  "image": getAbsoluteUrl(author.AUTHOR_PROFILE_IMAGE_PATH),
  "nationality": {
    "@type": "Country",
    "name": author.WWW_AUTHOR_NATIONALITY
  },
  "knowsLanguage": [
    { "@type": "Language", "name": author.WWW_AUTHOR_LANGUAGE1 },
    { "@type": "Language", "name": author.WWW_AUTHOR_LANGUAGE2 },
    { "@type": "Language", "name": author.WWW_AUTHOR_LANGUAGE3 },
    { "@type": "Language", "name": author.WWW_AUTHOR_LANGUAGE4 },
    { "@type": "Language", "name": author.WWW_AUTHOR_LANGUAGE5 }
  ].filter(lang => lang.name.trim()),
  "disambiguatingDescription": author.WWW_AUTHOR_BIO
};

// Organization Schema
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": www.PAGE_ORGANISATION_URL_NAME,
  "foundingDate": www.PAGE_FOUNDING_DATE,
  "logo": getAbsoluteUrl(www.PAGE_LOGO_IMAGE_PATH_1),
  "keywords": [
    www.PAGE_ORGANISATION_FULL_NAME,
    author.WWW_AUTHOR_ASCII,
    author.WWW_AUTHOR
  ],
  "numberOfEmployees": {
    "@type": "QuantitativeValue",
    "minValue": "1",
    "maxValue": "9"
  },
  "slogan": www.PAGE_SLOGAN,
  "contactPoint": {
    "@type": "ContactPoint",
    "email": www.PAGE_INFO_EMAIL,
    "contactType": www.M_CUSTOMER_SUPPORT
  },
  "sameAs": [
    www.PAGE_INSTAGRAM_URL,
    www.PAGE_FACEBOOK_URL,
    www.PAGE_TWITTER_URL,
    www.PAGE_LINKEDIN_URL,
    www.PAGE_YOUTUBE_URL,
    www.PAGE_PINTEREST_URL,
    www.PAGE_BLUESKY_URL
  ],
  "areaServed": {
    "@type": "Country",
    "name": author.M_COUNTRY,
    "identifier": author.M_COUNTRY_CODE
  }
};

// Combine all schemas
const schema = [webpageSchema, personSchema, organizationSchema];
---

<AuthorLayout
  name={authorProfileData.name}
  description={authorProfileData.description}
  image={authorProfileData.image}
  socialLinks={authorProfileData.socialLinks}
  jobTitle={authorProfileData.jobTitle}
  company={authorProfileData.company}
  languages={languagesData}
  layoutStrings={layoutStringsData}
  schema={schema}
/>