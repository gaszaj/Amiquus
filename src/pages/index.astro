---
// src/pages/index.astro
// This page acts as a language router and a fallback selection screen.
import path from 'path';
import Database from 'better-sqlite3';
import { 
  AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ, 
  CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG, 
  ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT, 
  HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV, 
  LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ, 
  OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL, 
  SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA 
} from 'country-flag-icons/string/3x2';

// --- Database Connection ---
const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true });

// --- Data Fetching ---
const { publishedLocales, www } = db.transaction(() => {
    const locales = db.prepare("SELECT * FROM locale WHERE M_LOCALE_PUBLISH_Y_N = '1'").all() as any[];
    const wwwData = db.prepare('SELECT * FROM www LIMIT 1').get() as any;
    return { publishedLocales: locales, www: wwwData || {} };
})();

// --- Language Detection & Redirect Logic ---
const acceptLanguage = Astro.request.headers.get('accept-language');
let redirectSlug = null;

if (acceptLanguage) {
  const userPreferredLangs = acceptLanguage.toLowerCase().split(',').map(part => part.split(';')[0]);
  for (const userLang of userPreferredLangs) {
    let match = publishedLocales.find((loc) => loc.M_HREFLANG_CODE.toLowerCase() === userLang);
    if (!match) {
      const langPart = userLang.split('-')[0];
      match = publishedLocales.find((loc) => loc.M_LANGUAGE_ISO === langPart);
    }
    if (match) {
      redirectSlug = match.M_SLUG;
      break; 
    }
  }
}

if (redirectSlug) {
  return Astro.redirect(`/${redirectSlug}/`, 302);
}

// --- Fallback Page Content (if no redirect happens) ---
const flagMap: Record<string, string> = { AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ, CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG, ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT, HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV, LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ, OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL, SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA };
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language & Region Selection</title>
    <meta name="robots" content="noindex, nofollow">
    {/* We use BaseLayout's CSS by importing it, even though we don't use the layout itself */}
    <link rel="stylesheet" href="/src/styles/global.css">
    <script is:inline>
      // Apply theme immediately to prevent flash
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.classList.toggle('dark', theme === 'dark');
    </script>
</head>
<body class="bg-muted flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-2xl bg-card border border-border rounded-xl shadow-lg p-6 sm:p-8 text-center">
        <img src={www.PAGE_LOGO_IMAGE_PATH_1?.replace('public', '')} alt="Amiquus Logo" class="w-48 mx-auto mb-6" />
        <h1 class="text-2xl sm:text-3xl font-bold text-foreground mb-2">Welcome!</h1>
        <p class="text-muted-foreground mb-8">
            Your browser language is not currently supported, but you can choose from any of our available sites below to continue.
        </p>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {publishedLocales.map(locale => (
                <a href={`/${locale.M_SLUG}/`} class="flex items-center w-full p-3 text-start font-semibold border border-border rounded-lg text-foreground hover:bg-muted hover:border-primary transition-all duration-200 hover:-translate-y-1 hover:shadow-md">
                    {flagMap[locale.M_COUNTRY_CODE] && (
                        <div class="w-8 h-6 me-3 flex-shrink-0" set:html={flagMap[locale.M_COUNTRY_CODE]} />
                    )}
                    <span class="flex-grow">{locale.M_LANGUAGE_NATIVE}</span>
                    <span class="text-xs text-muted-foreground">({locale.M_COUNTRY_NATIVE})</span>
                </a>
            ))}
        </div>
    </div>
</body>
</html>