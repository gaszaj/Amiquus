---
// Path: /src/layouts/BaseLayout.astro
import path from 'path';
import Database from 'better-sqlite3';
import manifestData from '../data/site.webmanifest.json';

import '@fontsource-variable/inter';
import '../styles/fonts.css';
import '../styles/global.css'; 
import Cookie from '../components/Cookie.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Schema from '../components/Schema.astro';

export interface Props {
  languageIso: string;
  countryCode: string;
  contentOrientation: string;
  title: string;
  description?: string;
  ogImage?: string;
  keywords?: string;
  locale?: string;
  schema?: object | null;
  alternativeLinks?: Array<{
    code: string;
    country: string;
    name: string;
    languageIso: string;
    hreflang: string;
    href: string;
  }> | null;
  languageLinksMap: Record<string, string>;
  currentSlug?: string;
}

const {
  languageIso,
  countryCode,
  contentOrientation,
  title,
  description,
  ogImage,
  keywords,
  locale = "sl-SI",
  schema = null,
  alternativeLinks = null,
  languageLinksMap,
  currentSlug
} = Astro.props;

const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true });

const { www, allLocaleData } = db.transaction(() => {
    const wwwData = db.prepare('SELECT * FROM www LIMIT 1').get() as any;
    const commonEntries = db.prepare('SELECT * FROM common').all() as any[];
    return { www: wwwData, allLocaleData: commonEntries };
})();

let socialSharingTitle = "Send this link to a friend";
let socialSharingCopyLabel = "Copy URL";
let socialSharingCopySuccess = "Copied!";
let socialSharingCopyFailure = "Error!";
let socialSharingCopyLoading = "Loading URL...";
let socialSharingAlternative = "Or share here:";
let ariaLabelFacebook = "Share on Facebook Messenger";
let ariaLabelWhatsapp = "Share on WhatsApp";
let ariaLabelTelegram = "Share on Telegram";
let ariaLabelEmail = "Share via Email";
let ariaLabelMoveToTop = "Move to top";

const currentLocaleData = allLocaleData.find(locData => 
  locData.M_LANGUAGE_ISO === languageIso && 
  locData.M_COUNTRY_CODE === countryCode
);

if (currentLocaleData) {
  const slug = currentLocaleData.M_SLUG;
  Astro.cookies.set('last_lang', slug, {
    path: '/',
    maxAge: 31536000, // 1 year
  });
  socialSharingTitle = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_TITLE || socialSharingTitle;
  socialSharingCopyLabel = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_LABEL || socialSharingCopyLabel;
  socialSharingCopySuccess = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_SUCCESS || socialSharingCopySuccess;
  socialSharingCopyFailure = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_FAILURE || socialSharingCopyFailure;
  socialSharingCopyLoading = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_LOADING || socialSharingCopyLoading;
  socialSharingAlternative = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_ALTERNATIVE || socialSharingAlternative;
  ariaLabelFacebook = currentLocaleData.PAGE_ARIA_LABEL_FACEBOOK || ariaLabelFacebook;
  ariaLabelWhatsapp = currentLocaleData.PAGE_ARIA_LABEL_WHATSAPP || ariaLabelWhatsapp;
  ariaLabelTelegram = currentLocaleData.PAGE_ARIA_LABEL_TELEGRAM || ariaLabelTelegram;
  ariaLabelEmail = currentLocaleData.PAGE_ARIA_LABEL_EMAIL || ariaLabelEmail;
  ariaLabelMoveToTop = currentLocaleData.M_MOVE_TO_TOP || ariaLabelMoveToTop;
}

const fullLocale = `${languageIso}-${countryCode}`;
const getAbsoluteOgImageUrl = (imagePath) => imagePath ? `${Astro.url.origin}${imagePath}` : '';
---

<!DOCTYPE html>
<html lang={languageIso} dir={contentOrientation}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />

    <title>{title} | {www.PAGE_ORGANISATION_FULL_NAME}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />

    <link rel="canonical" href={Astro.url.href} />
    
    {schema && <Schema schema={schema} />}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
  </head>

  <body class="bg-background text-foreground flex flex-col min-h-screen">
    <Header alternativeLinks={alternativeLinks || undefined} languageLinksMap={languageLinksMap} locale={currentSlug} />
    <main class="flex-grow">
      <slot />
    </main>    
    
    <section class="py-12 bg-muted">
      <div class="max-w-xl mx-auto px-4">
        <h2 class="text-2xl font-bold mb-6 text-center">{socialSharingTitle}</h2>
        <div class="bg-card rounded-lg shadow-sm p-4 border border-border mb-6">
          <div id="copy-url-button" class="flex items-center gap-3 p-3 bg-muted rounded-lg cursor-pointer hover:bg-border transition-colors group">
            <span id="copy-url-text" class="px-2 py-1 bg-primary text-primary-foreground rounded text-xs font-medium">{socialSharingCopyLabel}</span>
            <span id="current-url-display" class="flex-1 text-sm text-muted-foreground truncate">{socialSharingCopyLoading}</span>
            <svg class="w-4 h-4 text-muted-foreground group-hover:text-foreground transition-colors rtl:scale-x-[-1]" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
          </div>
        </div>
        <div class="bg-card rounded-lg shadow-sm p-4 border border-border">
          <h3 class="text-base font-semibold text-center mb-4">{socialSharingAlternative}</h3>
          <div class="flex justify-center gap-3">
             <!-- Social Share Links here -->
          </div>
        </div>
      </div>
    </section>

    <!-- CAR ANIMATION SECTION -->
    <section class="car-animation-section w-full overflow-hidden py-16 bg-muted">
      <div
        id="road"
        class="relative max-w-screen-xl mx-auto h-24 flex items-end border-b-4 border-dashed border-foreground/30 overflow-hidden"
      >
        <!-- Search Icon (centered and pulsing) -->
        <div
          id="search-icon"
          class="absolute bottom-3 left-1/2 -translate-x-1/2 w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 text-primary"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </div>

        <!-- Cars lane -->
        <div id="cars-lane" class="relative w-full h-full"></div>

        <!-- Telegram Icon (appears when red car meets search icon) -->
        <div
          id="telegram-icon"
          class="absolute z-30 w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 
                bg-[#0088cc] rounded-full flex items-center justify-center
                text-white dark:text-white opacity-0 pointer-events-none shadow-lg"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            class="w-3/4 h-3/4"
            viewBox="0 0 16 16"
          >
            <path
              d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.287 5.906q-1.168.486-4.666 2.01-.567.225-.595.442c-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294q.39.01.868-.32 3.269-2.206 3.374-2.23c.05-.012.12-.026.166.016s.042.12.037.141c-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8 8 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629q.14.092.27.187c.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.4 1.4 0 0 0-.013-.315.34.34 0 0 0-.114-.217.53.53 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09"
            />
          </svg>
        </div>
      </div>
    </section>
    
    <Footer />
    <Cookie />

    <!-- Scroll To Top Button HTML -->
    <div id="moveToTopContainer" class="fixed bottom-6 end-6 w-10 h-10 rounded-lg shadow-lg flex items-center justify-center opacity-0 invisible transition-all duration-300 z-50" style="background: conic-gradient(rgb(var(--primary)) var(--scroll-progress, 0%), transparent var(--scroll-progress, 0%));">
      <button id="moveToTopButton" aria-label={ariaLabelMoveToTop} class="w-[calc(100%-4px)] h-[calc(100%-4px)] bg-background rounded-[6px] flex items-center justify-center text-primary transition-colors hover:bg-muted focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
      </button>
    </div>

    <!-- SCRIPT FOR ALL PAGE INTERACTIONS -->
    <script is:inline>
      const applyTheme = (theme) => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
      };
      applyTheme(localStorage.getItem('theme') || 'light');

      function initializePageScripts() {
        
        // --- 1. THEME TOGGLE SETUP ---
        try {
          const themeToggle = document.getElementById('theme-toggle');
          if (!themeToggle) throw new Error("Theme toggle button not found");
          const themeIcon = document.getElementById('theme-icon');
          const sunIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8-9h1M3 12H2m15.364-6.364l.707.707M6.343 17.657l-.707.707m12.021 0l-.707-.707M6.343 6.343l.707-.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`;
          const moonIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />`;
          const updateThemeIcon = (theme) => {
            if (themeIcon) themeIcon.innerHTML = theme === 'dark' ? moonIcon : sunIcon;
          };
          updateThemeIcon(localStorage.getItem('theme') || 'light');
          themeToggle.onclick = () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
            updateThemeIcon(newTheme);
          };
        } catch (e) {
          console.error("Failed to initialize theme toggle:", e);
        }
        
        // --- 2. HEADER MENUS SETUP --- 
        try {
          const menus = [
            { btn: document.getElementById('user-btn'), menu: document.getElementById('user-dropdown') },
            { btn: document.getElementById('mobile-menu-btn'), menu: document.getElementById('mobile-nav') },
            { btn: document.getElementById('desktop-lang-button'), menu: document.getElementById('desktop-lang-dropdown') },
            { btn: document.getElementById('mobile-lang-button'), menu: document.getElementById('mobile-lang-dropdown') }
          ];
          menus.forEach(({ btn, menu }) => {
            if (btn && menu) {
              btn.onclick = (event) => {
                event.stopPropagation();
                const isHidden = menu.classList.contains('hidden');
                menus.forEach(m => m.menu?.classList.add('hidden'));
                if (isHidden) menu.classList.remove('hidden');
              };
            }
          });
          document.onclick = () => {
            menus.forEach(({ menu }) => menu?.classList.add('hidden'));
          };
        } catch (e) {
          console.error("Failed to initialize header menus:", e);
        }

        // --- 3. MOVE TO TOP BUTTON LOGIC --- 
        try {
            const container = document.getElementById('moveToTopContainer');
            const button = document.getElementById('moveToTopButton');
            
            if (container && button) {
                const handleScroll = () => {
                    const isVisible = window.scrollY > 400;
                    container.classList.toggle('opacity-0', !isVisible);
                    container.classList.toggle('invisible', !isVisible);

                    const main = document.querySelector('main');
                    if (main) {
                        const scrollableDist = main.offsetHeight - window.innerHeight;
                        const progress = (window.scrollY - main.offsetTop) / scrollableDist * 100;
                        container.style.setProperty('--scroll-progress', `${Math.max(0, Math.min(progress, 100))}%`);
                    }
                };
                
                window.addEventListener('scroll', handleScroll, { passive: true });
                button.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });

                handleScroll();
            }

        } catch(e) {
            console.error("Failed to initialize Move To Top button:", e);
        }

        // --- 4. COOKIE BANNER LOGIC --- 
        try {
            const settingsTrigger = document.getElementById('cookie-settings-trigger');
            const banner = document.getElementById('cookie-consent-banner');
            const initialView = document.getElementById('cookie-initial-view');
            const detailsView = document.getElementById('cookie-details-view');
            const acceptBtn = document.getElementById('cookie-accept-btn');
            const customizeBtn = document.getElementById('cookie-customize-btn');
            const declineBtn = document.getElementById('cookie-decline-btn');
            const closeDetailsBtn = document.getElementById('cookie-close-details-btn');
            const savePrefsBtn = document.getElementById('cookie-save-prefs-btn');
            const acceptAllDetailsBtn = document.getElementById('cookie-accept-all-details-btn');
            const analyticsCheckbox = document.getElementById('cookie-analytics');
            const marketingCheckbox = document.getElementById('cookie-marketing');

            if (banner && analyticsCheckbox && marketingCheckbox) {
                const CONSENT_GIVEN_KEY = 'cookie_consent_given';
                const PREFS_KEY = 'cookie_consent_prefs';

                const showBanner = () => {
                    banner.style.transform = 'translateY(0)';
                    if (settingsTrigger) setTimeout(() => settingsTrigger.style.transform = 'scale(0)', 10);
                };

                const hideBanner = () => {
                    banner.style.transform = 'translateY(100%)';
                    if (settingsTrigger) settingsTrigger.style.transform = 'scale(1)';
                };

                const recordConsent = (preferences) => {
                    localStorage.setItem(CONSENT_GIVEN_KEY, 'true');
                    localStorage.setItem(PREFS_KEY, JSON.stringify(preferences));
                    hideBanner();
                };

                acceptBtn.onclick = () => recordConsent({ analytics: true, marketing: true });
                acceptAllDetailsBtn.onclick = () => recordConsent({ analytics: true, marketing: true });
                declineBtn.onclick = () => recordConsent({ analytics: false, marketing: false });
                savePrefsBtn.onclick = () => recordConsent({
                    analytics: analyticsCheckbox.checked,
                    marketing: marketingCheckbox.checked,
                });

                customizeBtn.onclick = () => {
                    initialView.classList.add('hidden');
                    detailsView.classList.remove('hidden');
                };
                closeDetailsBtn.onclick = () => {
                    detailsView.classList.add('hidden');
                    initialView.classList.remove('hidden');
                };

                settingsTrigger.onclick = showBanner;
                
                const consentGiven = localStorage.getItem(CONSENT_GIVEN_KEY) === 'true';
                if (consentGiven) {
                    settingsTrigger.classList.remove('hidden');
                } else {
                    setTimeout(showBanner, 1500);
                }
            }
        } catch (e) {
            console.error("Failed to initialize cookie banner:", e);
        }

        // --- 5. WAITING LIST FORM LOGIC --- 
        try {
            const waitlistForm = document.getElementById('waitlist-form');
            if (waitlistForm) {
                const submitBtn = document.getElementById('submit-btn');
                const submitText = document.getElementById('submit-text');
                const submitLoading = document.getElementById('submit-loading');
                const errorMessage = document.getElementById('error-message');
                const successMessage = document.getElementById('success-message');
                const formContainer = document.getElementById('waitlist-form-container');
                const progressBar = document.getElementById('capacity-progress');

                const inputs = ['first-name', 'last-name', 'email', 'phone'];

                const showFieldError = (fieldId, message) => {
                    const errorEl = document.getElementById(`${fieldId}-error`);
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.classList.remove('hidden');
                        document.getElementById(fieldId)?.classList.add('border-destructive');
                    }
                };

                const hideFieldError = (fieldId) => {
                    const errorEl = document.getElementById(`${fieldId}-error`);
                    if (errorEl) {
                        errorEl.classList.add('hidden');
                        document.getElementById(fieldId)?.classList.remove('border-destructive');
                    }
                };

                const setLoading = (loading) => {
                    submitBtn.disabled = loading;
                    submitText.textContent = loading ? 'Joining...' : 'Join Waiting List';
                    submitLoading.classList.toggle('hidden', !loading);
                };

                waitlistForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    let isValid = true;
                    inputs.forEach(hideFieldError);
                    
                    const firstName = document.getElementById('first-name').value.trim();
                    const lastName = document.getElementById('last-name').value.trim();
                    const email = document.getElementById('email').value.trim();

                    if (!firstName) { showFieldError('first-name', 'First name is required.'); isValid = false; }
                    if (!lastName) { showFieldError('last-name', 'Last name is required.'); isValid = false; }
                    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        showFieldError('email', 'Please enter a valid email.');
                        isValid = false;
                    }
                    if (!isValid) return;

                    setLoading(true);
                    errorMessage.classList.add('hidden');
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    formContainer.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    setLoading(false);
                });

                if (progressBar) {
                    setTimeout(() => { progressBar.style.width = '100%'; }, 500);
                }
            }
        } catch(e) {
            console.error("Failed to initialize waitlist form:", e);
        }

        // --- 6. CONTACT FORM LOGIC --- 
        try {
            const contactForm = document.getElementById('contact-form');
            if (contactForm) {
                const submitBtn = document.getElementById('contact-submit-btn');
                const submitText = document.getElementById('contact-submit-text');
                const submitLoading = document.getElementById('contact-submit-loading');
                const successMessage = document.getElementById('contact-success-message');
                
                const setLoading = (loading) => {
                    submitBtn.disabled = loading;
                    submitText.textContent = loading ? 'Sending...' : 'Send Message';
                    submitLoading.classList.toggle('hidden', !loading);
                };

                contactForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const emailInput = document.getElementById('contact-email');
                    const messageInput = document.getElementById('contact-message');
                    let isValid = true;
                    
                    if (!emailInput.value.trim() || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
                        emailInput.classList.add('border-destructive');
                        isValid = false;
                    } else {
                        emailInput.classList.remove('border-destructive');
                    }

                    if (!messageInput.value.trim()) {
                        messageInput.classList.add('border-destructive');
                        isValid = false;
                    } else {
                        messageInput.classList.remove('border-destructive');
                    }

                    if (!isValid) return;

                    setLoading(true);

                    await new Promise(resolve => setTimeout(resolve, 1500));

                    contactForm.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    setLoading(false);
                });
            }
        } catch(e) {
            console.error("Failed to initialize contact form:", e);
        }

        // --- 7. CAR ANIMATION SCRIPT --- 
        try {
          console.log("Car animation script starting...");

          const waitForGSAP = () => {
            return new Promise((resolve) => {
              if (typeof gsap !== "undefined") {
                resolve();
              } else {
                const checkGSAP = setInterval(() => {
                  if (typeof gsap !== "undefined") {
                    clearInterval(checkGSAP);
                    resolve();
                  }
                }, 100);

                setTimeout(() => {
                  clearInterval(checkGSAP);
                  console.error("GSAP failed to load after 5 seconds");
                }, 5000);
              }
            });
          };

          waitForGSAP()
            .then(() => {
              console.log("GSAP loaded, starting animation...");

              const road = document.getElementById("road");
              const carsLane = document.getElementById("cars-lane");
              const search = document.getElementById("search-icon");
              const telegram = document.getElementById("telegram-icon");

              if (!road || !carsLane || !search || !telegram) {
                console.error("Car animation: missing elements", {
                  road: !!road,
                  carsLane: !!carsLane,
                  search: !!search,
                  telegram: !!telegram,
                });
                return;
              }

              // Use your car SVG, color via currentColor; wheels are handled separately via CSS
              const createCarElement = (isFeatured = false) => {
                const wrapper = document.createElement("div");
                wrapper.className =
                  "car-instance absolute bottom-0 w-20 h-10 sm:w-24 sm:h-12 md:w-28 md:h-14 flex items-end justify-center " +
                  (isFeatured
                    ? "text-red-500 dark:text-red-400"
                    : "text-foreground/80 dark:text-foreground/70");

                wrapper.innerHTML = `
                  <svg class="car-svg w-full h-full" width="102" height="40" viewBox="0 0 102 40" xmlns="http://www.w3.org/2000/svg">
                    <g transform="translate(2 1)" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round">
                      <path class="car__body" d="M47.293 2.375C52.927.792 54.017.805 54.017.805c2.613-.445 6.838-.337 9.42.237l8.381 1.863c2.59.576 6.164 2.606 7.98 4.531l6.348 6.732 6.245 1.877c3.098.508 5.609 3.431 5.609 6.507v4.206c0 .29-2.536 4.189-5.687 4.189H36.808c-2.655 0-4.34-2.1-3.688-4.67 0 0 3.71-19.944 14.173-23.902zM36.5 15.5h54.01" stroke-width="3"/>
                      <ellipse class="car__wheel--left" stroke-width="3.2" fill="#FFF" cx="83.493" cy="30.25" rx="6.922" ry="6.808"/>
                      <ellipse class="car__wheel--right" stroke-width="3.2" fill="#FFF" cx="46.511" cy="30.25" rx="6.922" ry="6.808"/>
                      <path class="car__line car__line--top" d="M22.5 16.5H2.475" stroke-width="3"/>
                      <path class="car__line car__line--middle" d="M20.5 23.5H.4755" stroke-width="3"/>
                      <path class="car__line car__line--bottom" d="M25.5 9.5h-19" stroke-width="3"/>
                    </g>
                  </svg>
                `;
                return wrapper;
              };

              let cycleTimeouts = [];
              let activeCarTweens = [];
              let tickerCallback = null;

              const clearCycle = () => {
                cycleTimeouts.forEach((id) => clearTimeout(id));
                cycleTimeouts = [];
                activeCarTweens.forEach((tw) => tw.kill());
                activeCarTweens = [];
                if (tickerCallback) {
                  gsap.ticker.remove(tickerCallback);
                  tickerCallback = null;
                }
                if (carsLane) carsLane.innerHTML = "";
              };

              const setupCarCycle = () => {
                clearCycle();

                const roadWidth = road.clientWidth || carsLane.clientWidth || 800;

                // Reset icons
                gsap.set(search, { autoAlpha: 1, scale: 1 });
                gsap.set(telegram, { autoAlpha: 0, scale: 0.6, y: -6, x: 0 });

                // Search icon pulse in place
                const pulseTl = gsap.to(search, {
                  scale: 1.08,
                  duration: 0.8,
                  yoyo: true,
                  repeat: -1,
                  ease: "sine.inOut",
                });

                const NUM_CARS = 5;
                const DRIVE_DURATION = 7; // seconds for full crossing
                const BASE_START_X = -180; // off-screen left
                const SPACING = 110;       // equal spacing between cars

                const featuredIndex = Math.floor(Math.random() * NUM_CARS);
                const cars = [];

                for (let i = 0; i < NUM_CARS; i++) {
                  const isFeatured = i === featuredIndex;
                  const carEl = createCarElement(isFeatured);
                  carsLane.appendChild(carEl);
                  cars.push(carEl);
                }

                const featuredCar = cars[featuredIndex];
                if (!featuredCar) return;

                // Initial positions: all cars are locked in equal spacing around the featured car
                const initialFeaturedX = BASE_START_X - featuredIndex * SPACING;
                cars.forEach((car, index) => {
                  const offsetIndex = index - featuredIndex;
                  gsap.set(car, {
                    x: initialFeaturedX - offsetIndex * SPACING,
                    y: 0,
                    autoAlpha: 1,
                  });
                  // subtle bobbing for each so they feel alive
                  gsap.to(car, {
                    y: -3,
                    repeat: -1,
                    yoyo: true,
                    duration: 1.1 + index * 0.1,
                    ease: "sine.inOut",
                  });
                });

                const endX = roadWidth + 220;

                // The red car (featured) is the ONLY one that actually animates in X
                const featuredTween = gsap.to(featuredCar, {
                  x: endX,
                  duration: DRIVE_DURATION,
                  ease: "none",
                });
                activeCarTweens.push(featuredTween);

                // All other cars "follow" the red one with fixed spacing
                tickerCallback = () => {
                  const featuredX = gsap.getProperty(featuredCar, "x");
                  cars.forEach((car, index) => {
                    if (car === featuredCar) return;
                    const offsetIndex = index - featuredIndex;
                    gsap.set(car, {
                      x: featuredX - offsetIndex * SPACING,
                    });
                  });
                };
                gsap.ticker.add(tickerCallback);

                // Compute where the red car should "meet" the search icon
                const roadRect = road.getBoundingClientRect();
                const searchRect = search.getBoundingClientRect();
                const searchCenterX =
                  searchRect.left - roadRect.left + searchRect.width / 2;

                let triggered = false;

                const triggerTelegram = () => {
                  if (triggered) return;
                  triggered = true;

                  // Stop the driving motion and spacing updates
                  activeCarTweens.forEach((tw) => tw.pause());
                  if (tickerCallback) {
                    gsap.ticker.remove(tickerCallback);
                    tickerCallback = null;
                  }
                  pulseTl.pause();

                  // Fade out search icon
                  gsap.to(search, {
                    autoAlpha: 0,
                    scale: 0.9,
                    duration: 0.25,
                    ease: "power1.inOut",
                  });

                  // Position telegram exactly where the search icon is
                  const roadRect2 = road.getBoundingClientRect();
                  const searchRect2 = search.getBoundingClientRect();
                  const centerX =
                    searchRect2.left -
                    roadRect2.left +
                    searchRect2.width / 2 -
                    (telegram.clientWidth || 0) / 2;

                  gsap.set(telegram, { x: centerX });

                  // Show telegram + pulse and slight grow
                  gsap.to(telegram, {
                    autoAlpha: 1,
                    scale: 1.12,
                    duration: 0.3,
                    ease: "back.out(1.7)",
                  });

                  const teleTl = gsap.timeline();
                  teleTl
                    .to(telegram, {
                      y: -14,
                      duration: 0.35,
                      repeat: 3,
                      yoyo: true,
                      ease: "sine.inOut",
                    })
                    .to(
                      telegram,
                      {
                        scale: 1.0,
                        duration: 0.4,
                        ease: "sine.inOut",
                      },
                      0
                    );

                  // After a short hold, restart a fresh cycle
                  const restartTimeout = setTimeout(() => {
                    setupCarCycle();
                  }, 2600);

                  cycleTimeouts.push(restartTimeout);
                };

                // Collision detection: when red car reaches search icon center, trigger
                featuredTween.eventCallback("onUpdate", () => {
                  if (triggered) return;
                  const carRect = featuredCar.getBoundingClientRect();
                  const carCenterX =
                    carRect.left - roadRect.left + carRect.width / 2;

                  // Small threshold so it's visually "on top"
                  if (Math.abs(carCenterX - searchCenterX) < 6) {
                    triggerTelegram();
                  }
                });

                // Safety fallback in case something goes off (still keeps loop)
                featuredTween.eventCallback("onComplete", () => {
                  if (!triggered) {
                    triggerTelegram();
                  }
                });
              };

              setupCarCycle();
              console.log("Car animation cycle started.");
            })
            .catch((error) => {
              console.error("Failed to load GSAP:", error);
            });
        } catch (e) {
          console.error("Failed to initialize car animation:", e);
        }

        // --- 8. LOGIN FORM LOGIC --- 
        try {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                const loginBtn = document.getElementById('login-btn');
                const loginText = document.getElementById('login-text');
                const loginLoading = document.getElementById('login-loading');
                const errorMessage = document.getElementById('error-message');
                const googleLoginBtn = document.getElementById('google-login-btn');
                const emailInput = document.getElementById('email');
                const passwordInput = document.getElementById('password');

                const setLoading = (loading) => {
                    loginBtn.disabled = loading;
                    loginText.style.display = loading ? 'none' : 'inline';
                    loginLoading.classList.toggle('hidden', !loading);
                };
                
                const showError = (message) => {
                    errorMessage.textContent = message;
                    errorMessage.classList.remove('hidden');
                };

                const hideError = () => errorMessage.classList.add('hidden');

                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    hideError();
                    setLoading(true);
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    if (passwordInput.value === 'fail') {
                        showError('Invalid email or password. Please try again.');
                    } else {
                        alert('Login successful! (This is a demo)');
                    }
                    
                    setLoading(false);
                });
                
                googleLoginBtn.onclick = () => alert('Google login would be initiated here.');

                emailInput.oninput = hideError;
                passwordInput.oninput = hideError;
            }
        } catch (e) {
            console.error("Failed to initialize login form:", e);
        }

        // --- 9. REGISTRATION FORM LOGIC --- 
        try {
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                const registerBtn = document.getElementById('register-btn');
                const registerText = document.getElementById('register-text');
                const registerLoading = document.getElementById('register-loading');
                const errorMessage = document.getElementById('error-message');
                const googleRegisterBtn = document.getElementById('google-register-btn');
                const passwordInput = document.getElementById('password');
                const confirmPasswordInput = document.getElementById('confirmPassword');
                const termsCheckbox = document.getElementById('terms');
                const strengthFill = document.getElementById('strength-fill');
                const strengthText = document.getElementById('strength-text');

                const fieldIds = ['firstName', 'lastName', 'email', 'password', 'confirmPassword'];

                const showFieldError = (fieldId, message) => {
                    const errorEl = document.getElementById(`${fieldId}-error`);
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.classList.remove('hidden');
                        document.getElementById(fieldId)?.classList.add('border-destructive');
                    }
                };

                const hideFieldError = (fieldId) => {
                    const errorEl = document.getElementById(`${fieldId}-error`);
                    if (errorEl) {
                        errorEl.classList.add('hidden');
                        document.getElementById(fieldId)?.classList.remove('border-destructive');
                    }
                };
                
                const setLoading = (loading) => {
                    registerBtn.disabled = loading;
                    registerText.style.display = loading ? 'none' : 'inline';
                    registerLoading.classList.toggle('hidden', !loading);
                };
                
                const showError = (message) => {
                    errorMessage.textContent = message;
                    errorMessage.classList.remove('hidden');
                };

                const checkPasswordStrength = (password) => {
                    let score = 0;
                    if (password.length >= 8) score++;
                    if (/[A-Z]/.test(password)) score++;
                    if (/[0-9]/.test(password)) score++;
                    if (/[^A-Za-z0-9]/.test(password)) score++;

                    strengthFill.className = 'h-full transition-all duration-300 rounded-full';
                    let text = 'Password strength';
                    
                    switch (score) {
                        case 1: strengthFill.classList.add('bg-destructive', 'w-1/4'); text = 'Weak'; break;
                        case 2: strengthFill.classList.add('bg-orange-500', 'w-2/4'); text = 'Fair'; break;
                        case 3: strengthFill.classList.add('bg-yellow-500', 'w-3/4'); text = 'Good'; break;
                        case 4: strengthFill.classList.add('bg-success', 'w-full'); text = 'Strong'; break;
                        default: strengthFill.classList.add('bg-transparent', 'w-0'); break;
                    }
                    strengthText.textContent = text;
                    return score;
                };

                passwordInput.addEventListener('input', () => checkPasswordStrength(passwordInput.value));

                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    let isValid = true;
                    fieldIds.forEach(hideFieldError);
                    errorMessage.classList.add('hidden');

                    if (!document.getElementById('firstName').value.trim()) { isValid = false; showFieldError('firstName', 'First name is required.'); }
                    if (!document.getElementById('lastName').value.trim()) { isValid = false; showFieldError('lastName', 'Last name is required.'); }
                    if (!document.getElementById('email').value.trim() || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(document.getElementById('email').value)) { isValid = false; showFieldError('email', 'A valid email is required.'); }
                    if (passwordInput.value.length < 8) { isValid = false; showFieldError('password', 'Password must be at least 8 characters.'); }
                    if (passwordInput.value !== confirmPasswordInput.value) { isValid = false; showFieldError('confirmPassword', 'Passwords do not match.'); }
                    if (!termsCheckbox.checked) { isValid = false; showError('You must agree to the Terms of Service and Privacy Policy.'); }
                    
                    if (!isValid) return;

                    setLoading(true);
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    alert('Account created successfully! (This is a demo)');
                    setLoading(false);
                    registerForm.reset();
                    checkPasswordStrength('');
                });
                
                googleRegisterBtn.onclick = () => alert('Google registration would be initiated here.');
            }
        } catch (e) {
            console.error("Failed to initialize registration form:", e);
        }

        // --- 10. SETUP ALERTS FORM LOGIC --- 
        try {
            const setupForm = document.getElementById('setup-alerts-form');
            if (setupForm) {
                const carBrandSelect = document.getElementById('car-brand');
                const carModelSelect = document.getElementById('car-model');
                const fuelTypeSelect = document.getElementById('fuel-type');
                const websitesContainer = document.getElementById('websites-container');
                const facebookInstructions = document.getElementById('facebook-instructions');
                const frequencySelect = document.getElementById('update-frequency');
                const checkoutBtn = document.getElementById('checkout-btn');
                const hasContactedBotCheckbox = document.getElementById('has-contacted-bot');
                const termsAgreedCheckbox = document.getElementById('terms-agreed');

                const priceBaseLabel = document.getElementById('price-base-label');
                const priceBaseValue = document.getElementById('price-base-value');
                const priceWebsitesLabel = document.getElementById('price-websites-label');
                const priceWebsitesValue = document.getElementById('price-websites-value');
                const priceFrequencyLabel = document.getElementById('price-frequency-label');
                const priceFrequencyValue = document.getElementById('price-frequency-value');
                const priceTotalValue = document.getElementById('price-total-value');
                
                const newcomerData = {
                    websites: ["avto.net", "mobile.de", "autoscout24", "facebook"],
                    fuel_types: ["Petrol", "Diesel", "Electric", "Hybrid", "LPG"],
                    brands_and_models: {
                        "Audi": ["A3", "A4", "A6", "Q5", "Q7"],
                        "BMW": ["Series 3", "Series 5", "X3", "X5"],
                        "Mercedes-Benz": ["C-Class", "E-Class", "GLC"],
                        "Volkswagen": ["Golf", "Passat", "Tiguan"],
                    },
                };
                const FREQUENCY_OPTIONS = [
                    { id: "hourly", label: "Hourly", price: 0 },
                    { id: "30min", label: "Every 30 minutes", price: 2.99 },
                    { id: "15min", label: "Every 15 minutes", price: 5.99 },
                    { id: "5min", label: "Every 5 minutes", price: 9.99 },
                    { id: "1min", label: "Every 1 minute", price: 14.99 },
                ];

                const calculatePrice = () => {
                    const selectedWebsites = Array.from(document.querySelectorAll('#websites-container input:checked'));
                    const websitesCount = selectedWebsites.length;
                    const frequencyValue = frequencySelect.value;
                    
                    let basePrice = 9.99;
                    let websitesPrice = websitesCount > 1 ? (websitesCount - 1) * 4.99 : 0;
                    let frequencyPrice = FREQUENCY_OPTIONS.find(opt => opt.id === frequencyValue)?.price || 0;
                    let total = basePrice + websitesPrice + frequencyPrice;

                    priceWebsitesLabel.textContent = `Additional Websites (${websitesCount > 0 ? websitesCount - 1 : 0})`;
                    priceWebsitesValue.textContent = `$${websitesPrice.toFixed(2)}`;
                    priceFrequencyLabel.textContent = `Frequency (${FREQUENCY_OPTIONS.find(opt => opt.id === frequencyValue)?.label || 'Hourly'})`;
                    priceFrequencyValue.textContent = `$${frequencyPrice.toFixed(2)}`;
                    priceTotalValue.textContent = `$${total.toFixed(2)}`;
                };
                
                const populateDropdown = (selectElement, items) => {
                    items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.toLowerCase().replace(/ /g, '-');
                        option.textContent = item;
                        selectElement.appendChild(option);
                    });
                };
                
                populateDropdown(carBrandSelect, Object.keys(newcomerData.brands_and_models));
                populateDropdown(fuelTypeSelect, newcomerData.fuel_types);
                
                FREQUENCY_OPTIONS.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.id;
                    option.textContent = `${opt.label} ${opt.price > 0 ? `(+$${opt.price.toFixed(2)})` : '(Included)'}`;
                    frequencySelect.appendChild(option);
                });
                
                newcomerData.websites.forEach((site, index) => {
                    const isFirst = index === 0;
                    const siteId = `site-${site}`;
                    const label = document.createElement('label');
                    label.htmlFor = siteId;
                    label.className = "flex items-start gap-3 p-3 border border-border rounded-lg cursor-pointer hover:bg-muted transition-colors";
                    label.innerHTML = `
                        <input type="checkbox" id="${siteId}" value="${site}" name="websites" class="mt-1 h-4 w-4 rounded border-border text-primary focus:ring-primary" ${isFirst ? 'checked disabled' : ''}>
                        <div class="text-sm">
                            <p class="font-semibold text-foreground">${site.charAt(0).toUpperCase() + site.slice(1)}</p>
                            <p class="text-muted-foreground">${isFirst ? 'Base plan' : '+$4.99/mo'}</p>
                        </div>
                    `;
                    websitesContainer.appendChild(label);
                });

                carBrandSelect.addEventListener('change', () => {
                    const selectedBrand = carBrandSelect.value;
                    const models = newcomerData.brands_and_models[Object.keys(newcomerData.brands_and_models).find(b => b.toLowerCase().replace(/ /g, '-') === selectedBrand)] || [];
                    carModelSelect.innerHTML = '<option value="">Select Model</option>';
                    populateDropdown(carModelSelect, models);
                    carModelSelect.disabled = models.length === 0;
                });

                websitesContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const isFacebook = e.target.value === 'facebook';
                        facebookInstructions.classList.toggle('hidden', !(isFacebook && e.target.checked));
                        calculatePrice();
                    }
                });
                
                frequencySelect.addEventListener('change', calculatePrice);
                
                checkoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const isTermsAgreed = termsAgreedCheckbox.checked;
                    const hasContactedBot = hasContactedBotCheckbox.checked;
                    if (!isTermsAgreed || !hasContactedBot) {
                        alert('Please agree to the terms and confirm you have contacted the bot.');
                        return;
                    }
                    alert('Proceeding to checkout (demo)');
                });
                
                calculatePrice();
            }
        } catch (e) {
            console.error("Failed to initialize setup-alerts form:", e);
        }

        // --- 11. USER PROFILE LOGIC --- 
        try {
          const profilePage = document.querySelector('.profile-layout-grid');
          if (profilePage) {
              const sidebarButtons = document.querySelectorAll('.sidebar-btn');
              const tabPanels = document.querySelectorAll('.tab-panel');
              
              const toast = document.getElementById('toast-notification');
              const toastMessage = document.getElementById('toast-message');
              let toastTimeout;

              const showToast = (message, isError = false) => {
                  clearTimeout(toastTimeout);
                  toastMessage.textContent = message;
                  toast.classList.toggle('border-destructive', isError);
                  toast.classList.toggle('text-destructive', isError);
                  toast.style.transform = 'translateX(0)';
                  toastTimeout = setTimeout(() => {
                      toast.style.transform = 'translateX(calc(100% + 2.5rem))';
                  }, 4000);
              };

              const switchTab = (tabId) => {
                  tabPanels.forEach(panel => {
                      panel.classList.toggle('hidden', panel.id !== `${tabId}-tab`);
                      panel.classList.toggle('active', panel.id === `${tabId}-tab`);
                  });
                  sidebarButtons.forEach(btn => {
                      if (btn.dataset.tab) {
                          const isTarget = btn.dataset.tab === tabId;
                          btn.classList.toggle('active', isTarget);
                          btn.classList.toggle('bg-primary/10', isTarget);
                          btn.classList.toggle('text-primary', isTarget);
                          btn.classList.toggle('text-muted-foreground', !isTarget);
                      }
                  });
              };

              const openModal = (modalId) => {
                  const modal = document.getElementById(modalId);
                  if (modal) modal.classList.remove('hidden');
              };

              const closeModal = (modal) => {
                  if(modal) modal.classList.add('hidden');
              };

              document.querySelectorAll('[data-modal]').forEach(trigger => {
                  trigger.addEventListener('click', (e) => {
                      e.preventDefault();
                      openModal(trigger.dataset.modal);
                  });
              });
              
              document.querySelectorAll('.modal-close').forEach(btn => {
                  btn.addEventListener('click', () => closeModal(btn.closest('.modal')));
              });
              
              sidebarButtons.forEach(btn => {
                  if(btn.dataset.tab) {
                      btn.addEventListener('click', (e) => {
                          e.preventDefault();
                          switchTab(btn.dataset.tab);
                      });
                  }
              });
              
              window.addEventListener('keydown', (e) => {
                  if (e.key === 'Escape') {
                      document.querySelectorAll('.modal').forEach(closeModal);
                  }
              });

              const handleFormSubmit = async (form, button) => {
                  const originalText = button.textContent;
                  button.disabled = true;
                  button.innerHTML = `<div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>`;
                  await new Promise(resolve => setTimeout(resolve, 1500));
                  showToast('Changes saved successfully!');
                  button.disabled = false;
                  button.innerHTML = originalText;
                  const modal = form.closest('.modal');
                  if (modal) closeModal(modal);
              };
              
              document.getElementById('profile-info-form')?.addEventListener('submit', (e) => {
                  e.preventDefault();
                  handleFormSubmit(e.target, e.target.querySelector('button[type="submit"]'));
              });

              document.getElementById('change-password-form')?.addEventListener('submit', (e) => {
                  e.preventDefault();
                  handleFormSubmit(e.target, e.target.querySelector('button[type="submit"]'));
              });

              document.getElementById('telegram-update-form')?.addEventListener('submit', (e) => {
                  e.preventDefault();
                  handleFormSubmit(e.target, e.target.querySelector('button[type="submit"]'));
              });

              switchTab('account');
          }
        } catch (e) {
          console.error("Failed to initialize user profile scripts:", e);
        }

        // --- 12. CHECKOUT PAGE LOGIC --- 
        try {
          const paymentForm = document.getElementById('payment-form');
          if (paymentForm) {
              const orderDetailsContainer = document.getElementById('order-details');
              const subtotalEl = document.getElementById('subtotal-amount');
              const vatEl = document.getElementById('vat-amount');
              const totalEl = document.getElementById('total-amount');
              const payButton = document.getElementById('pay-button');
              const payText = document.getElementById('pay-text');
              const payLoading = document.getElementById('pay-loading');
              const errorMessage = document.getElementById('error-message');

              const showError = (message) => {
                  errorMessage.textContent = message;
                  errorMessage.classList.remove('hidden');
                  window.scrollTo({ top: 0, behavior: 'smooth' });
              };

              const loadOrderData = () => {
                  const dataString = localStorage.getItem('setupFormData');
                  if (!dataString) {
                      showError("Could not load your setup details. Please start over.");
                      payButton.disabled = true;
                      return;
                  }

                  const data = JSON.parse(dataString);
                  const { basePrice, websitesPrice, frequencyPrice, total } = data.prices;
                  const vat = total * 0.22;
                  
                  orderDetailsContainer.innerHTML = `
                      <div class="flex justify-between items-center text-sm">
                          <span class="text-muted-foreground">Car Alert: ${data.carBrand || 'Any'}</span>
                          <span class="font-semibold text-foreground">$${basePrice.toFixed(2)}</span>
                      </div>
                      <div class="flex justify-between items-center text-sm">
                          <span class="text-muted-foreground">Websites (${data.websites.length})</span>
                          <span class="font-semibold text-foreground">$${websitesPrice.toFixed(2)}</span>
                      </div>
                      <div class="flex justify-between items-center text-sm">
                          <span class="text-muted-foreground">Frequency Upgrade</span>
                          <span class="font-semibold text-foreground">$${frequencyPrice.toFixed(2)}</span>
                  `;
                  
                  subtotalEl.textContent = `$${total.toFixed(2)}`;
                  vatEl.textContent = `$${vat.toFixed(2)}`;
                  totalEl.textContent = `$${(total + vat).toFixed(2)}`;
              };

              paymentForm.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  if (!document.getElementById('card-name').value.trim() || !document.getElementById('card-number').value.trim()) {
                      showError('Please fill in all required payment details.');
                      return;
                  }

                  payButton.disabled = true;
                  payText.style.display = 'none';
                  payLoading.classList.remove('hidden');

                  await new Promise(res => setTimeout(res, 2000));
                  alert('Payment successful! (This is a demo)');
                  window.location.href = '/user-profile?tab=subscriptions';
              });

              loadOrderData();
          }
        } catch (e) {
          console.error("Failed to initialize checkout page scripts:", e);
        }

        // --- 13. THANK YOU PAGE LOGIC --- 
        try {
          const confettiContainer = document.getElementById('confetti-container');
          if (confettiContainer) {
              const createConfetti = () => {
                  const colors = ['#3B82F6', '#22C55E', '#FFFF00'];
                  for (let i = 0; i < 50; i++) {
                      const piece = document.createElement('div');
                      piece.className = 'absolute w-2 h-2 rounded-full';
                      piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                      piece.style.left = `${Math.random() * 100}%`;
                      piece.style.animation = `confetti-fall ${Math.random() * 3 + 2}s ${Math.random() * 3}s linear infinite`;
                      confettiContainer.appendChild(piece);
                  }
              };

              const successIcon = document.getElementById('success-icon');
              if (successIcon && typeof gsap !== 'undefined') {
                  gsap.fromTo(successIcon, 
                      { scale: 0.5, opacity: 0 }, 
                      { scale: 1, opacity: 1, duration: 0.5, ease: 'back.out(1.7)', delay: 0.2 }
                  );
              }

              setTimeout(createConfetti, 500);

              const userName = "Valued Customer";
              const personalMessage = document.getElementById('personal-message');
              if (personalMessage) {
                  personalMessage.innerHTML = `<strong>Welcome to Amiquus, ${userName}!</strong> You'll start receiving instant notifications when cars matching your criteria are listed.`;
              }
              
              setTimeout(() => {
                  localStorage.removeItem('setupFormData');
              }, 1000);
          }
        } catch (e) {
          console.error("Failed to initialize thank-you page scripts:", e);
        }
        
      }

      initializePageScripts();
      document.addEventListener('astro:page-load', initializePageScripts);
    </script>
  </body>
</html>

<style is:global>
  :root {
    --font-size-base: clamp(1rem, 0.34vw + 0.91rem, 1.19rem);
    --font-size-lg: clamp(1.2rem, 0.7vw + 1.2rem, 1.5rem); 
    --font-size-xl: clamp(2.44rem, 2.38vw + 1.85rem, 3.75rem);
  }
  html {
    font-family: 'Inter Variable', system-ui, sans-serif;
    scroll-behavior: smooth;
  }
  body {
    font-size: var(--font-size-base);
  }

  /* Car animation styling from your snippet (flattened from SCSS) */
  .car__body {
    animation: shake 0.2s ease-in-out infinite alternate;
  }

  .car__line {
    transform-origin: center right;
    stroke-dasharray: 22;
    animation: line 0.8s ease-in-out infinite;
    animation-fill-mode: both;
  }

  .car__line--top {
    animation-delay: 0s;
  }

  .car__line--middle {
    animation-delay: 0.2s;
  }

  .car__line--bottom {
    animation-delay: 0.4s;
  }

  /* Slightly softer wheels in dark mode */
  .dark .car__wheel--left,
  .dark .car__wheel--right {
    fill: #e5e7eb; /* softer than pure white */
  }

  @keyframes shake {
    0% {
      transform: translateY(-1%);
    }
    100% {
      transform: translateY(3%);
    }
  }

  @keyframes line {
    0% {
      stroke-dashoffset: 22;
    }
    25% {
      stroke-dashoffset: 22;
    }
    50% {
      stroke-dashoffset: 0;
    }
    51% {
      stroke-dashoffset: 0;
    }
    80% {
      stroke-dashoffset: -22;
    }
    100% {
      stroke-dashoffset: -22;
    }
  }
</style>
