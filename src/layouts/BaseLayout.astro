---
// Path: /src/layouts/BaseLayout.astro
import path from 'path';
import Database from 'better-sqlite3';
import manifestData from '../data/site.webmanifest.json';

import '@fontsource-variable/inter';
import '../styles/fonts.css';
import '../styles/global.css'; 
import Cookie from '../components/Cookie.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Schema from '../components/Schema.astro';

export interface Props {
  languageIso: string;
  countryCode: string;
  contentOrientation: string;
  title: string;
  description?: string;
  ogImage?: string;
  keywords?: string;
  locale?: string;
  schema?: object | null;
  alternativeLinks?: Array<{
    code: string;
    country: string;
    name: string;
    languageIso: string;
    hreflang: string;
    href: string;
  }> | null;
  languageLinksMap: Record<string, string>;
  currentSlug?: string;
}

const {
  languageIso,
  countryCode,
  contentOrientation,
  title,
  description,
  ogImage,
  keywords,
  locale = "sl-SI",
  schema = null,
  alternativeLinks = null,
  languageLinksMap,
  currentSlug
} = Astro.props;

const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true });

const { www, allLocaleData } = db.transaction(() => {
    const wwwData = db.prepare('SELECT * FROM www LIMIT 1').get() as any;
    const commonEntries = db.prepare('SELECT * FROM common').all() as any[];
    return { www: wwwData, allLocaleData: commonEntries };
})();

let socialSharingTitle = "Send this link to a friend";
let socialSharingCopyLabel = "Copy URL";
let socialSharingCopySuccess = "Copied!";
let socialSharingCopyFailure = "Error!";
let socialSharingCopyLoading = "Loading URL...";
let socialSharingAlternative = "Or share here:";
let ariaLabelFacebook = "Share on Facebook Messenger";
let ariaLabelWhatsapp = "Share on WhatsApp";
let ariaLabelTelegram = "Share on Telegram";
let ariaLabelEmail = "Share via Email";
let ariaLabelMoveToTop = "Move to top";

const currentLocaleData = allLocaleData.find(locData => 
  locData.M_LANGUAGE_ISO === languageIso && 
  locData.M_COUNTRY_CODE === countryCode
);

if (currentLocaleData) {
  const slug = currentLocaleData.M_SLUG;
  Astro.cookies.set('last_lang', slug, {
    path: '/',
    maxAge: 31536000, // 1 year
  });
  socialSharingTitle = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_TITLE || socialSharingTitle;
  socialSharingCopyLabel = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_LABEL || socialSharingCopyLabel;
  socialSharingCopySuccess = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_SUCCESS || socialSharingCopySuccess;
  socialSharingCopyFailure = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_FAILURE || socialSharingCopyFailure;
  socialSharingCopyLoading = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_LOADING || socialSharingCopyLoading;
  socialSharingAlternative = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_ALTERNATIVE || socialSharingAlternative;
  ariaLabelFacebook = currentLocaleData.PAGE_ARIA_LABEL_FACEBOOK || ariaLabelFacebook;
  ariaLabelWhatsapp = currentLocaleData.PAGE_ARIA_LABEL_WHATSAPP || ariaLabelWhatsapp;
  ariaLabelTelegram = currentLocaleData.PAGE_ARIA_LABEL_TELEGRAM || ariaLabelTelegram;
  ariaLabelEmail = currentLocaleData.PAGE_ARIA_LABEL_EMAIL || ariaLabelEmail;
  ariaLabelMoveToTop = currentLocaleData.M_MOVE_TO_TOP || ariaLabelMoveToTop;
}

const fullLocale = `${languageIso}-${countryCode}`;
const getAbsoluteOgImageUrl = (imagePath) => imagePath ? `${Astro.url.origin}${imagePath}` : '';
---

<!DOCTYPE html>
<html lang={languageIso} dir={contentOrientation}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />

    
    <title>{title} | {www.PAGE_ORGANISATION_FULL_NAME}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />

    <link rel="canonical" href={Astro.url.href} />
    {/* Your meta tags, links, etc. go here */}
    
    {schema && <Schema schema={schema} />}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
  </head>

  <body class="bg-background text-foreground flex flex-col min-h-screen">
    <Header alternativeLinks={alternativeLinks || undefined} languageLinksMap={languageLinksMap} locale={currentSlug} />
    <main class="flex-grow">
      <slot />
    </main>    
    
    <section class="py-12 bg-muted">
      <div class="max-w-xl mx-auto px-4">
        <h2 class="text-2xl font-bold mb-6 text-center">{socialSharingTitle}</h2>
        <div class="bg-card rounded-lg shadow-sm p-4 border border-border mb-6">
          <div id="copy-url-button" class="flex items-center gap-3 p-3 bg-muted rounded-lg cursor-pointer hover:bg-border transition-colors group">
            <span id="copy-url-text" class="px-2 py-1 bg-primary text-primary-foreground rounded text-xs font-medium">{socialSharingCopyLabel}</span>
            <span id="current-url-display" class="flex-1 text-sm text-muted-foreground truncate">{socialSharingCopyLoading}</span>
            <svg class="w-4 h-4 text-muted-foreground group-hover:text-foreground transition-colors rtl:scale-x-[-1]" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
          </div>
        </div>
        <div class="bg-card rounded-lg shadow-sm p-4 border border-border">
          <h3 class="text-base font-semibold text-center mb-4">{socialSharingAlternative}</h3>
          <div class="flex justify-center gap-3">
             <!-- Social Share Links here -->
          </div>
        </div>
      </div>
    </section>

    <!-- CAR ANIMATION SECTION -->
     
    <section class="car-animation-section w-full overflow-hidden py-16 bg-muted">
      <div id="road" class="relative max-w-screen-xl mx-auto h-24 flex items-end border-b-4 border-dashed border-foreground/30">
        <!-- Search Icon -->
        <div
          id="search-icon"
          class="absolute bottom-0 w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 text-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </div>
        
        <!-- Car Icon -->
        <div
          id="car-icon"
          class="absolute bottom-0 w-28 h-12 sm:w-28 sm:h-14 md:w-32 md:h-16 lg:w-36 lg:h-18 xl:w-40 xl:h-20 text-foreground dark:text-white"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 158.7" class="w-full h-full">
            <path fill="currentColor" d="M80.1,129.2c0,15.2-12.3,27.5-27.5,27.5c-15.2,0-27.5-12.3-27.5-27.5s12.3-27.5,27.5-27.5C67.8,101.7,80.1,114,80.1,129.2z
              M66.1,129.2c0-7.4-6.1-13.5-13.5-13.5c-7.4,0-13.5,6.1-13.5,13.5c0,7.4,6.1,13.5,13.5,13.5S66.1,136.6,66.1,129.2z M231.2,129.2
              c0,15.2-12.3,27.5-27.5,27.5s-27.5-12.3-27.5-27.5s12.3-27.5,27.5-27.5S231.2,114,231.2,129.2z M217.2,129.2
              c0-7.4-6.1-13.5-13.5-13.5c-7.4,0-13.5,6.1-13.5,13.5c0,7.4,6.1,13.5,13.5,13.5S217.2,136.6,217.2,129.2z M253.8,104.7H248v0l0-28.1
              c0-8.8-7.1-15.9-16-15.9h-39c-0.6,0-1.2-0.3-1.6-0.7l-44.5-48c-2-2-4.8-3.2-7.7-3.3l-86.5,0c-7.5,0-13.9,5.1-15.6,12.4l-8.7,37.9
              c-0.2,1-1.1,1.7-2.2,1.7h0C16.2,60.7,8,68.8,8,78.9v23.5c0,1.2-1,2.2-2.2,2.2H2.2c-1.2,0-2.2,1-2.2,2.2v7.5
              c0,5.6,4.6,10.2,10.2,10.2h4.1c1.1,0,2-0.8,2.2-1.8c3-17.2,18.1-30.4,36.2-30.4c18.1,0,33.1,13.1,36.1,30.3c0.2,1.1,1.1,1.8,2.2,1.8
              h74.4c1.1,0,2-0.8,2.2-1.8c3-17.2,18-30.3,36.1-30.3s33.1,13.1,36.1,30.3c0.2,1.1,1.1,1.8,2.2,1.8h3.8c5.7,0,10.2-4.6,10.2-10.2
              v-7.4C256,105.7,255,104.7,253.8,104.7z M92,58.4c0,1.2-1,2.2-2.2,2.2h-47c-1.4,0-2.5-1.3-2.2-2.7l7.7-34.2c0.4-1.8,1.8-3.1,3.7-3.1
              h37.8c1.2,0,2.2,1,2.2,2.2V58.4z M170,60.7h-63.8c-1.2,0-2.2-1-2.2-2.2V22.9c0-1.2,1-2.2,2.2-2.2h31.6c0.6,0,1.2,0.3,1.7,0.7
              l32.2,35.5C172.9,58.4,171.9,60.7,170,60.7z M130,54.8c7.8,0,14.1-6.3,14.1-14.1s-6.3-14.1-14.1-14.1s-14.1,6.3-14.1,14.1
              S122.2,54.8,130,54.8z"/>
          </svg>
        </div>

        
        <!-- Telegram Icon -->
        <div
          id="telegram-icon"
          class="absolute z-30 w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 text-[#0088cc] dark:text-[#0088cc] opacity-0 pointer-events-none"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-full h-full" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.287 5.906q-1.168.486-4.666 2.01-.567.225-.595.442c-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294q.39.01.868-.32 3.269-2.206 3.374-2.23c.05-.012.12-.026.166.016s.042.12.037.141c-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8 8 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629q.14.092.27.187c.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.4 1.4 0 0 0-.013-.315.34.34 0 0 0-.114-.217.53.53 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09"/>
          </svg>
        </div>
      </div>
    </section>
    
    <Footer />
    <Cookie />

    <!-- Scroll To Top Button HTML -->
    <div id="moveToTopContainer" class="fixed bottom-6 end-6 w-10 h-10 rounded-lg shadow-lg flex items-center justify-center opacity-0 invisible transition-all duration-300 z-50" style="background: conic-gradient(rgb(var(--primary)) var(--scroll-progress, 0%), transparent var(--scroll-progress, 0%));">
      <button id="moveToTopButton" aria-label={ariaLabelMoveToTop} class="w-[calc(100%-4px)] h-[calc(100%-4px)] bg-background rounded-[6px] flex items-center justify-center text-primary transition-colors hover:bg-muted focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
      </button>
    </div>

    <!-- SCRIPT FOR ALL PAGE INTERACTIONS -->
    <script is:inline>
      const applyTheme = (theme) => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
      };
      applyTheme(localStorage.getItem('theme') || 'light');

      function initializePageScripts() {
        
        // --- 1. THEME TOGGLE SETUP ---
        try {
          const themeToggle = document.getElementById('theme-toggle');
          if (!themeToggle) throw new Error("Theme toggle button not found");
          const themeIcon = document.getElementById('theme-icon');
          const sunIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8-9h1M3 12H2m15.364-6.364l.707.707M6.343 17.657l-.707.707m12.021 0l-.707-.707M6.343 6.343l.707-.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`;
          const moonIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />`;
          const updateThemeIcon = (theme) => {
            if (themeIcon) themeIcon.innerHTML = theme === 'dark' ? moonIcon : sunIcon;
          };
          updateThemeIcon(localStorage.getItem('theme') || 'light');
          themeToggle.onclick = () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
            updateThemeIcon(newTheme);
          };
        } catch (e) {
          console.error("Failed to initialize theme toggle:", e);
        }
        
        // --- 2. HEADER MENUS SETUP ---
        try {
          const menus = [
            { btn: document.getElementById('user-btn'), menu: document.getElementById('user-dropdown') },
            { btn: document.getElementById('mobile-menu-btn'), menu: document.getElementById('mobile-nav') },
            { btn: document.getElementById('desktop-lang-button'), menu: document.getElementById('desktop-lang-dropdown') },
            { btn: document.getElementById('mobile-lang-button'), menu: document.getElementById('mobile-lang-dropdown') }
          ];
          menus.forEach(({ btn, menu }) => {
            if (btn && menu) {
              btn.onclick = (event) => {
                event.stopPropagation();
                const isHidden = menu.classList.contains('hidden');
                menus.forEach(m => m.menu?.classList.add('hidden'));
                if (isHidden) menu.classList.remove('hidden');
              };
            }
          });
          document.onclick = () => {
            menus.forEach(({ menu }) => menu?.classList.add('hidden'));
          };
        } catch (e) {
          console.error("Failed to initialize header menus:", e);
        }

        // --- 3. MOVE TO TOP BUTTON LOGIC ---
        // This is the missing piece.
        try {
            const container = document.getElementById('moveToTopContainer');
            const button = document.getElementById('moveToTopButton');
            
            if (container && button) {
                const handleScroll = () => {
                    const isVisible = window.scrollY > 400;
                    container.classList.toggle('opacity-0', !isVisible);
                    container.classList.toggle('invisible', !isVisible);

                    // Optional: Scroll progress logic
                    const main = document.querySelector('main');
                    if (main) {
                        const scrollableDist = main.offsetHeight - window.innerHeight;
                        const progress = (window.scrollY - main.offsetTop) / scrollableDist * 100;
                        container.style.setProperty('--scroll-progress', `${Math.max(0, Math.min(progress, 100))}%`);
                    }
                };
                
                window.addEventListener('scroll', handleScroll, { passive: true });
                button.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });

                // Run once on load to set initial state
                handleScroll();
            }

        } catch(e) {
            console.error("Failed to initialize Move To Top button:", e);
        }
        // --- 4. COOKIE BANNER LOGIC ---
        try {
            const settingsTrigger = document.getElementById('cookie-settings-trigger');
            const banner = document.getElementById('cookie-consent-banner');
            const initialView = document.getElementById('cookie-initial-view');
            const detailsView = document.getElementById('cookie-details-view');
            const acceptBtn = document.getElementById('cookie-accept-btn');
            const customizeBtn = document.getElementById('cookie-customize-btn');
            const declineBtn = document.getElementById('cookie-decline-btn');
            const closeDetailsBtn = document.getElementById('cookie-close-details-btn');
            const savePrefsBtn = document.getElementById('cookie-save-prefs-btn');
            const acceptAllDetailsBtn = document.getElementById('cookie-accept-all-details-btn');
            const analyticsCheckbox = document.getElementById('cookie-analytics');
            const marketingCheckbox = document.getElementById('cookie-marketing');

            if (banner && analyticsCheckbox && marketingCheckbox) {
                const CONSENT_GIVEN_KEY = 'cookie_consent_given';
                const PREFS_KEY = 'cookie_consent_prefs';

                const showBanner = () => {
                    banner.style.transform = 'translateY(0)';
                    if (settingsTrigger) setTimeout(() => settingsTrigger.style.transform = 'scale(0)', 10);
                };

                const hideBanner = () => {
                    banner.style.transform = 'translateY(100%)';
                    if (settingsTrigger) settingsTrigger.style.transform = 'scale(1)';
                };

                const recordConsent = (preferences) => {
                    localStorage.setItem(CONSENT_GIVEN_KEY, 'true');
                    localStorage.setItem(PREFS_KEY, JSON.stringify(preferences));
                    hideBanner();
                };

                acceptBtn.onclick = () => recordConsent({ analytics: true, marketing: true });
                acceptAllDetailsBtn.onclick = () => recordConsent({ analytics: true, marketing: true });
                declineBtn.onclick = () => recordConsent({ analytics: false, marketing: false });
                savePrefsBtn.onclick = () => recordConsent({
                    analytics: analyticsCheckbox.checked,
                    marketing: marketingCheckbox.checked,
                });

                customizeBtn.onclick = () => {
                    initialView.classList.add('hidden');
                    detailsView.classList.remove('hidden');
                };
                closeDetailsBtn.onclick = () => {
                    detailsView.classList.add('hidden');
                    initialView.classList.remove('hidden');
                };

                settingsTrigger.onclick = showBanner;
                
                // Initial check
                const consentGiven = localStorage.getItem(CONSENT_GIVEN_KEY) === 'true';
                if (consentGiven) {
                    settingsTrigger.classList.remove('hidden');
                } else {
                    setTimeout(showBanner, 1500);
                }
            }
        } catch (e) {
            console.error("Failed to initialize cookie banner:", e);
        }

        // --- 5. WAITING LIST FORM LOGIC ---
        try {
            const waitlistForm = document.getElementById('waitlist-form');
            if (waitlistForm) {
                const submitBtn = document.getElementById('submit-btn');
                const submitText = document.getElementById('submit-text');
                const submitLoading = document.getElementById('submit-loading');
                const errorMessage = document.getElementById('error-message');
                const successMessage = document.getElementById('success-message');
                const formContainer = document.getElementById('waitlist-form-container');
                const progressBar = document.getElementById('capacity-progress');

                const inputs = ['first-name', 'last-name', 'email', 'phone'];

                const showFieldError = (fieldId, message) => {
                    const errorEl = document.getElementById(`${fieldId}-error`);
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.classList.remove('hidden');
                        document.getElementById(fieldId)?.classList.add('border-destructive');
                    }
                };

                const hideFieldError = (fieldId) => {
                    const errorEl = document.getElementById(`${fieldId}-error`);
                    if (errorEl) {
                        errorEl.classList.add('hidden');
                        document.getElementById(fieldId)?.classList.remove('border-destructive');
                    }
                };

                const setLoading = (loading) => {
                    submitBtn.disabled = loading;
                    submitText.textContent = loading ? 'Joining...' : 'Join Waiting List';
                    submitLoading.classList.toggle('hidden', !loading);
                };

                waitlistForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    let isValid = true;
                    inputs.forEach(hideFieldError); // Clear previous errors
                    
                    const firstName = document.getElementById('first-name').value.trim();
                    const lastName = document.getElementById('last-name').value.trim();
                    const email = document.getElementById('email').value.trim();

                    if (!firstName) { showFieldError('first-name', 'First name is required.'); isValid = false; }
                    if (!lastName) { showFieldError('last-name', 'Last name is required.'); isValid = false; }
                    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        showFieldError('email', 'Please enter a valid email.');
                        isValid = false;
                    }
                    if (!isValid) return;

                    setLoading(true);
                    errorMessage.classList.add('hidden');
                    
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    formContainer.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    setLoading(false);
                });

                // Animate progress bar into view
                if (progressBar) {
                    setTimeout(() => { progressBar.style.width = '100%'; }, 500);
                }
            }
        } catch(e) {
            console.error("Failed to initialize waitlist form:", e);
        }

        // --- 6. CONTACT FORM LOGIC ---
        try {
            const contactForm = document.getElementById('contact-form');
            if (contactForm) {
                const submitBtn = document.getElementById('contact-submit-btn');
                const submitText = document.getElementById('contact-submit-text');
                const submitLoading = document.getElementById('contact-submit-loading');
                const successMessage = document.getElementById('contact-success-message');
                
                const setLoading = (loading) => {
                    submitBtn.disabled = loading;
                    submitText.textContent = loading ? 'Sending...' : 'Send Message';
                    submitLoading.classList.toggle('hidden', !loading);
                };

                contactForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const emailInput = document.getElementById('contact-email');
                    const messageInput = document.getElementById('contact-message');
                    let isValid = true;
                    
                    // Basic validation
                    if (!emailInput.value.trim() || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
                        emailInput.classList.add('border-destructive');
                        isValid = false;
                    } else {
                        emailInput.classList.remove('border-destructive');
                    }

                    if (!messageInput.value.trim()) {
                        messageInput.classList.add('border-destructive');
                        isValid = false;
                    } else {
                        messageInput.classList.remove('border-destructive');
                    }

                    if (!isValid) return;

                    setLoading(true);

                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    contactForm.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    setLoading(false);
                });
            }
        } catch(e) {
            console.error("Failed to initialize contact form:", e);
        }



        // --- 7. CAR ANIMATION SCRIPT ---
        try {
          console.log("Car animation script starting...");
          
          // Wait for GSAP to load
          const waitForGSAP = () => {
            return new Promise((resolve) => {
              if (typeof gsap !== 'undefined') {
                resolve();
              } else {
                // Check every 100ms for GSAP
                const checkGSAP = setInterval(() => {
                  if (typeof gsap !== 'undefined') {
                    clearInterval(checkGSAP);
                    resolve();
                  }
                }, 100);
                
                // Timeout after 5 seconds
                setTimeout(() => {
                  clearInterval(checkGSAP);
                  console.error("GSAP failed to load after 5 seconds");
                }, 5000);
              }
            });
          };

          waitForGSAP().then(() => {
            console.log("GSAP loaded, starting animation...");
            
            const car = document.getElementById("car-icon");
            const search = document.getElementById("search-icon");
            const telegram = document.getElementById("telegram-icon");
            const road = document.getElementById("road");

            console.log("Elements found:", { car: !!car, search: !!search, telegram: !!telegram, road: !!road });

            if (car && search && telegram && road) {
              console.log("All elements found, starting animation...");
              
              // Kill any existing animations
              gsap.killTweensOf([car, search, telegram]);

              const roadWidth = road.clientWidth;
              const carWidth = car.clientWidth;
              const isRtl = document.documentElement.dir === 'rtl';
              const meetingPoint = roadWidth * 0.5;

              console.log("Animation parameters:", { roadWidth, carWidth, isRtl, meetingPoint });

              // Set initial positions
              gsap.set(car, { 
                x: isRtl ? roadWidth : -carWidth, 
                scaleX: isRtl ? -1 : 1, 
                autoAlpha: 1 
              });
              
              gsap.set(search, { 
                x: isRtl ? -search.offsetWidth : roadWidth, 
                scaleX: isRtl ? 1 : -1, 
                autoAlpha: 1 
              });

              gsap.set(telegram, { autoAlpha: 0, scale: 0.5 });

              const masterTimeline = gsap.timeline({ repeat: -1, repeatDelay: 2 });
              
              // Phase 1: Car drives to the middle
              masterTimeline.to(car, { 
                x: meetingPoint - (carWidth / 2), 
                duration: 3, 
                ease: "power1.inOut" 
              });

              // Phase 1.2: Search icon scans back and forth
              masterTimeline.to(search, { 
                x: meetingPoint - (search.clientWidth / 2), 
                duration: 3, 
                ease: "power1.inOut" 
              }, 0); // Start at time 0 (in parallel with car)

              // Phase 2: At meeting point, car and search icon fade out
              masterTimeline.to(car, { autoAlpha: 0, duration: 0.01 }, ">");
              masterTimeline.to(search, { autoAlpha: 0, duration: 0.01 }, ">");

              // Phase 3: Telegram icon appears and pulsates
              masterTimeline.set(telegram, { 
                x: meetingPoint - (telegram.clientWidth / 2),
                y: -10,
                autoAlpha: 0,
                scale: 0.5
              });
              masterTimeline.to(telegram, { autoAlpha: 1, scale: 1, duration: 0.3 });
              masterTimeline.to(telegram, { scale: 1.2, repeat: 3, yoyo: true, duration: 0.25, ease: 'power1.inOut' });
              masterTimeline.to(telegram, { autoAlpha: 0, scale: 0.5, duration: 0.3 });

              console.log("Animation started successfully!");
            } else {
              console.error("Some elements not found:", { car: !!car, search: !!search, telegram: !!telegram, road: !!road });
            }
          }).catch((error) => {
            console.error("Failed to load GSAP:", error);
          });
          
        } catch(e) {
            console.error("Failed to initialize car animation:", e);
        }
      }

      initializePageScripts();
      document.addEventListener('astro:page-load', initializePageScripts);
    </script>
  </body>
</html>

<style is:global>
  :root {
    --font-size-base: clamp(1rem, 0.34vw + 0.91rem, 1.19rem);
    --font-size-lg: clamp(1.2rem, 0.7vw + 1.2rem, 1.5rem); 
    --font-size-xl: clamp(2.44rem, 2.38vw + 1.85rem, 3.75rem);
  }
  html {
    font-family: 'Inter Variable', system-ui, sans-serif;
    scroll-behavior: smooth;
  }
  body {
    font-size: var(--font-size-base);
  }
</style>