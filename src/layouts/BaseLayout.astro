---
// Import JSON data
import wwwData from '../data/www.json';
const www = wwwData[0]; // Get the first (and only) object from wwwData array

import manifestData from '../data/site.webmanifest.json';
import allLocaleData from '../data/common.json'; // common.json is an array of locale objects

import '@fontsource-variable/inter';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Schema from '../components/Schema.astro';

export interface Props {
  languageIso: string;
  countryCode: string;
  contentOrientation: string;
  title: string;
  description?: string;
  ogImage?: string;
  keywords?: string;
  locale?: string;
  schema?: object | null;
  alternativeLinks?: Array<{
    code: string;
    country: string;
    name: string;
    languageIso: string;
    hreflang: string;
    href: string;
  }>;
  languageLinksMap: Record<string, string>;
  currentSlug?: string;
}

const {
  languageIso,
  countryCode,
  contentOrientation,
  title,
  description = `${www.PAGE_ORGANISATION_FULL_NAME} - Premium safety signs and triopan warning systems manufactured in Slovenia and distributed across Europe.`,
  ogImage = "/images/og-image.jpg",
  keywords = "safety signs, warning signs, triopan, road safety, construction safety, event safety",
  locale = "sl-SI", // Default locale // This prop seems to be 'locale' not 'fullLocale'
  schema = null,
  alternativeLinks = null,
  languageLinksMap,
  currentSlug
} = Astro.props;

// Define default English texts (these will be used if common.json doesn't provide specific translations)
let socialSharingTitle = "Send this link to a friend";
let socialSharingCopyLabel = "Copy URL";
let socialSharingCopySuccess = "Copied!";
let socialSharingCopyFailure = "Error!";
let socialSharingCopyLoading = "Loading URL...";
let socialSharingAlternative = "Or share here:";

// Find the matching locale object from the imported array
const currentLocaleData = allLocaleData.find(locData => 
  locData.M_LANGUAGE_ISO === languageIso && 
  locData.M_COUNTRY_CODE === countryCode
);

if (currentLocaleData) {
  const currentSlug = currentLocaleData.M_SLUG;
  
  // Set a cookie with the user's last-known language slug.
  // This will be available on subsequent requests, including to the 404 page.
  Astro.cookies.set('last_lang', currentSlug, {
    path: '/', // Make the cookie available on the entire site
    maxAge: 60 * 60 * 24 * 365, // Store it for one year
  });
}

// If a matching locale object is found, use its translations, otherwise stick to English defaults
if (currentLocaleData) {
  socialSharingTitle = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_TITLE || socialSharingTitle;
  socialSharingCopyLabel = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_LABEL || socialSharingCopyLabel;
  socialSharingCopySuccess = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_SUCCESS || socialSharingCopySuccess;
  socialSharingCopyFailure = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_FAILURE || socialSharingCopyFailure;
  socialSharingCopyLoading = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_LOADING || socialSharingCopyLoading;
  socialSharingAlternative = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_ALTERNATIVE || socialSharingAlternative;
}

// Create the full locale string from language and country code for meta tags
const fullLocale = `${languageIso}-${countryCode}`;

// Helper to ensure icon paths are relative to the public directory root
const publicPath = (src: string) => `/${src.startsWith('/') ? src.substring(1) : src}`;

// Helper to create absolute URL for OG images
const getAbsoluteOgImageUrl = (imagePath: string) => {
  return `${Astro.url.origin}${imagePath}`;
};
---

<!DOCTYPE html>
<html lang={languageIso} dir={contentOrientation}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href={new URL('/logos/eusignal-favicon.ico', Astro.url)} type="image/x-icon" sizes="any" />
    <link rel="icon" href={new URL('/logos/EUSIGNAL-SVG_Logo_File_Horizontal_Light.svg', Astro.url)} type="image/svg+xml" />
    <link href={new URL('/logos/eusignal-favicon.ico', Astro.url)} type="image/x-icon" sizes="any" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{title} | {www.PAGE_ORGANISATION_FULL_NAME}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />

    <!-- Canonical URL -->
    <link rel="canonical" href={Astro.url.href} />

    <!-- Alternate Language Links -->
    {languageLinksMap && Object.entries(languageLinksMap).map(([localeCode, url]) => {
      if (!url) return null;
      const normalizedUrl = url.replace(/\/$/, '');
      if (normalizedUrl === Astro.url.pathname.replace(/\/$/, '')) return null;

      // Find the locale data for this locale
      const localeData = allLocaleData.find(l => l.M_SLUG === localeCode);

      // Always use 4-letter code: try M_HREFLANG_CODE, else build from M_LANGUAGE_ISO and M_COUNTRY_CODE
      let hreflang = localeData?.M_HREFLANG_CODE;
      if (!hreflang || !/^[a-z]{2}-[A-Z]{2}$/.test(hreflang)) {
        // fallback: build from language and country code
        const lang = localeData?.M_LANGUAGE_ISO || localeCode;
        const country = localeData?.M_COUNTRY_CODE || localeCode.toUpperCase();
        hreflang = `${lang}-${country}`;
      }

      // Generate absolute URL
      const absoluteUrl = new URL(url, Astro.url.origin).toString();

      return (
        <link rel="alternate" hrefLang={hreflang} href={absoluteUrl} />
      );
    })}
    {(() => {
      // You can set your default locale here
      const defaultLocale = "si";
      const defaultUrl = languageLinksMap?.[defaultLocale] 
        ? new URL(languageLinksMap[defaultLocale], Astro.url.origin).toString()
        : new URL(`/${defaultLocale}`, Astro.url.origin).toString();
      return <link rel="alternate" hrefLang="x-default" href={defaultUrl} />;
    })()}

    <!-- Robots Meta Tag -->
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={`${title} | ${www.PAGE_ORGANISATION_FULL_NAME}`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={getAbsoluteOgImageUrl(ogImage)} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content={www.PAGE_ORGANISATION_SHORT_NAME || www.PAGE_ORGANISATION_FULL_NAME} /> 
    <meta property="og:locale" content={fullLocale} />

    <!-- Twitter / X -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={Astro.url} />
    <meta name="twitter:title" content={`${title} | ${www.PAGE_ORGANISATION_FULL_NAME}`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={getAbsoluteOgImageUrl(ogImage)} />
    <meta name="twitter:creator" content={www.PAGE_TWITTER_USERNAME} />

    <!-- Mobile/Web App Metadata -->
    <meta name="application-name" content={www.PAGE_ORGANISATION_FULL_NAME} />
    <meta name="apple-mobile-web-app-title" content={www.PAGE_ORGANISATION_FULL_NAME} />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="format-detection" content="telephone=no" />
    {manifestData.theme_color && <meta name="theme-color" content={manifestData.theme_color} />}
    <meta name="msapplication-TileColor" content={manifestData.theme_color} />

    <!-- Favicon and Icons from imported Manifest Data -->
    {manifestData.icons && manifestData.icons.map(icon => {
      const href = new URL(publicPath(icon.src), Astro.url);
      if (icon.src.includes('apple-touch-icon')) {
        return <link rel="apple-touch-icon" sizes={icon.sizes} href={href.pathname} type={icon.type} />;
      }
      return <link rel="icon" type={icon.type} sizes={icon.sizes} href={href.pathname} />;
    })}
    <link rel="manifest" href={new URL('/site.webmanifest', Astro.url).pathname} crossorigin="anonymous" />
    <link rel="mask-icon" href={new URL('/logos/EUSIGNAL-SVG_Logo_File_Horizontal_Light.svg', Astro.url).pathname} color={manifestData.theme_color} />

    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <meta name="referrer" content="strict-origin-when-cross-origin" />

    <!-- Google Tag Manager -->
    {www.PAGE_GOOGLE_ANALYTICS_ID && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${www.PAGE_GOOGLE_ANALYTICS_ID}`}></script>
        <script is:inline define:vars={{ gtagId: www.PAGE_GOOGLE_ANALYTICS_ID }}>
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', gtagId);
        </script>
      </>
    )}

    <!-- Microsoft Clarity -->
    {www.PAGE_MICROSOFT_CLARITY && (
      <script is:inline define:vars={{ clarityId: www.PAGE_MICROSOFT_CLARITY }}>
        (function (c, l, a, r, i, t, y) {
          c[a] =
            c[a] ||
            function () {
              (c[a].q = c[a].q || []).push(arguments);
            };
          t = l.createElement(r);
          t.async = 1;
          t.src = 'https://www.clarity.ms/tag/' + i;
          y = l.getElementsByTagName(r)[0];
          y.parentNode.insertBefore(t, y);
        })(window, document, 'clarity', 'script', clarityId);
      </script>
    )}

    <!-- Bing Webmasters Tools -->
    {www.PAGE_BING_VALIDATE && (
      <meta name="msvalidate.01" content={www.PAGE_BING_VALIDATE} />
    )}

    <!-- Yandex Webmasters Tools -->
    {www.PAGE_YANDEX_VALIDATE && (
      <meta name="yandex-verification" content={www.PAGE_YANDEX_VALIDATE} />
    )}
    
    <!-- Pinterest Verify-->
    <meta name="p:domain_verify" content="e0ada8b9b555717ad94989fbaec7a340"/>
    
    {schema && <Schema schema={schema} />}
  </head>
  <body class="min-h-screen bg-signal-light flex flex-col">
    <Header alternativeLinks={alternativeLinks} languageLinksMap={languageLinksMap} locale={currentSlug} />
    <main class="flex-grow">
      <slot />
    </main>
    
    <!-- Social Sharing Section -->
    <section class="py-12 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="max-w-xl mx-auto">
          <h2 class="text-2xl font-bold text-black mb-6 text-center">{socialSharingTitle}</h2>
          
          <!-- Copy URL Section -->
          <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100 mb-6">
            <div 
              id="copy-url-button"
              class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors group"
            >
              <span 
                id="copy-url-text" 
                class="px-2 py-1 bg-black text-signal-green rounded text-xs font-medium"
              >
                {socialSharingCopyLabel}
              </span>
              <span id="current-url-display" class="flex-1 text-xs text-gray-600 truncate">
                {socialSharingCopyLoading}
              </span>
              <svg class="w-4 h-4 text-gray-500 group-hover:text-gray-700 transition-colors" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
              </svg>
            </div>
          </div>

          <!-- Social Share Links -->
          <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
            <h3 class="text-base font-semibold text-black mb-4 text-center">{socialSharingAlternative}</h3>
            <div class="flex justify-center gap-3">
              <a
                id="facebook-share-link"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="p-3 rounded-lg bg-[#0084ff] hover:bg-[#0070e6] transition-colors"
                aria-label="Deli na Facebook Messenger"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                  <path fill="#fff" d="M11.772 2.013A9.7 9.7 0 0 0 4.774 4.89a9.62 9.62 0 0 0-2.77 7.019a9.38 9.38 0 0 0 3.12 6.96a.84.84 0 0 1 .291.65v1.45c0 .487.21 1.032.827 1.032a.9.9 0 0 0 .384-.104l1.863-.824a.9.9 0 0 1 .652 0c5.204 1.415 11.049-1.31 12.469-6.67a9.65 9.65 0 0 0-1.708-8.726a9.7 9.7 0 0 0-3.618-2.816a9.75 9.75 0 0 0-4.512-.847m4.494 9.187c-2.55 4.49-2.561 3.48-5.763 1.346c-.373 0-.559.278-1.805 1.16s-1.455 1.253-1.828.858c-.372-.394.78-1.705 2.329-4.234c1.35-2.227 3.213.859 4.4 1.044a11.3 11.3 0 0 0 2.096-1.508c.816-.626 1.048-.87 1.374-.614c.326.255.047.614-.803 1.948"/>
                </svg>
              </a>
              <a
                id="whatsapp-share-link"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="p-3 rounded-lg bg-[#128C7E] hover:bg-[#0e7a6e] transition-colors"
                aria-label="Deli na WhatsApp"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                  <path fill="#fff" d="M19.05 4.91A9.82 9.82 0 0 0 12.04 2c-5.46 0-9.91 4.45-9.91 9.91c0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21c5.46 0 9.91-4.45 9.91-9.91c0-2.65-1.03-5.14-2.9-7.01m-7.01 15.24c-1.48 0-2.93-.4-4.2-1.15l-.3-.18l-3.12.82l.83-3.04l-.2-.31a8.26 8.26 0 0 1-1.26-4.38c0-4.54 3.7-8.24 8.24-8.24c2.2 0 4.27.86 5.82 2.42a8.18 8.18 0 0 1 2.41 5.83c.02 4.54-3.68 8.23-8.22 8.23m4.52-6.16c-.25-.12-1.47-.72-1.69-.81c-.23-.08-.39-.12-.56.12c-.17.25-.64.81-.78.97c-.14.17-.29.19-.54.06c-.25-.12-1.05-.39-1.99-1.23c-.74-.66-1.23-1.47-1.38-1.72c-.14-.25-.02-.38.11-.51c.11-.11.25-.29.37-.43s.17-.25.25-.41c.08-.17.04-.31-.02-.43s-.56-1.34-.76-1.84c-.2-.48-.41-.42-.56-.43h-.48c-.17 0-.43.06-.66.31c-.22.25-.86.85-.86 2.07s.89 2.4 1.01 2.56c.12.17 1.75 2.67 4.23 3.74c.59.26 1.05.41 1.41.52c.59.19 1.13.16 1.56.1c.48-.07 1.47-.6 1.67-1.18c.21-.58.21-1.07.14-1.18s-.22-.16-.47-.28"/>
                </svg>
              </a>
              <a
                id="telegram-share-link"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="p-3 rounded-lg bg-[#24A1DE] hover:bg-[#1e91c7] transition-colors"
                aria-label="Deli na Telegram"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                  <path fill="#fff" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19c-.14.75-.42 1-.68 1.03c-.58.05-1.02-.38-1.58-.75c-.88-.58-1.38-.94-2.23-1.5c-.99-.65-.35-1.01.22-1.59c.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02c-.09.02-1.49.95-4.22 2.79c-.4.27-.76.41-1.08.4c-.36-.01-1.04-.2-1.55-.37c-.63-.2-1.12-.31-1.08-.66c.02-.18.27-.36.74-.55c2.92-1.27 4.86-2.11 5.83-2.51c2.78-1.16 3.35-1.36 3.73-1.36c.08 0 .27.02.39.12c.1.08.13.19.14.27c-.01.06.01.24 0 .38"/>
                </svg>
              </a>
              <a
                id="mail-share-link"
                href="#"
                class="p-3 rounded-lg bg-[#BCEF2F] hover:bg-[#a5d429] transition-colors"
                aria-label="Deli preko E-poÅ¡te"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                  <mask id="emailIcon">
                    <g fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                      <path stroke-dasharray="64" stroke-dashoffset="64" d="M4 5h16c0.55 0 1 0.45 1 1v12c0 0.55 -0.45 1 -1 1h-16c-0.55 0 -1 -0.45 -1 -1v-12c0 -0.55 0.45 -1 1 -1Z">
                        <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.72s" values="64;0"/>
                      </path>
                      <path stroke-dasharray="24" stroke-dashoffset="24" d="M3 6.5l9 5.5l9 -5.5">
                        <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.72s" dur="0.24s" values="24;0"/>
                      </path>
                      <path fill="#fff" fill-opacity="0" stroke="none" d="M12 11l-8 -5h16l-8 5Z">
                        <animate fill="freeze" attributeName="fill-opacity" begin="1.44s" dur="0.6s" values="0;1"/>
                      </path>
                      <path fill="#000" fill-opacity="0" stroke="none" d="M19 13c3.31 0 6 2.69 6 6c0 3.31 -2.69 6 -6 6c-3.31 0 -6 -2.69 -6 -6c0 -3.31 2.69 -6 6 -6Z">
                        <set fill="freeze" attributeName="fill-opacity" begin="0.96s" to="1"/>
                      </path>
                      <path stroke-dasharray="6" stroke-dashoffset="6" d="M16 19h5">
                        <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.96s" dur="0.24s" values="6;0"/>
                      </path>
                      <path stroke-dasharray="4" stroke-dashoffset="4" d="M21 19l-2 2M21 19l-2 -2">
                        <animate fill="freeze" attributeName="stroke-dashoffset" begin="1.2s" dur="0.24s" values="4;0"/>
                      </path>
                    </g>
                  </mask>
                  <rect width="24" height="24" fill="#000" mask="url(#emailIcon)"/>
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <Footer />

    <!-- Move to Top Button -->
    <button
      id="moveToTop"
      class="fixed bottom-[25px] right-[25px] w-10 h-10 bg-[#BCEF2F] rounded-lg shadow-lg flex items-center justify-center opacity-0 invisible transition-all duration-300 hover:bg-[#a5d429] focus:outline-none focus:ring-2 focus:ring-[#BCEF2F] focus:ring-opacity-50"
      aria-label="Move to top"
    >
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke-dasharray="20" stroke-dashoffset="20" d="M12 21l0 -17.5">
        <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.24s" values="20;0"/>
      </path>
      <path stroke-dasharray="12" stroke-dashoffset="12" d="M12 3l7 7M12 3l-7 7">
        <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.24s" dur="0.24s" values="12;0"/>
      </path>
    </svg>
    </button>
  </body>
</html>

<style is:global>
  :root {
    --font-size-base: clamp(1rem, 0.34vw + 0.91rem, 1.19rem);
    --font-size-lg: clamp(1.2rem, 0.7vw + 1.2rem, 1.5rem); 
    --font-size-xl: clamp(2.44rem, 2.38vw + 1.85rem, 3.75rem);
    --line-height-body: 1.5;
    --line-height-heading: 1.2;
  }

  html {
    font-family: 'Inter Variable', system-ui, sans-serif;
    scroll-behavior: smooth;
  }

  body {
    font-size: var(--font-size-base);
    line-height: var(--line-height-body);
    color: #111827;
  }

  h1, h2, h3, h4, h5, h6 {
    line-height: var(--line-height-heading);
    font-weight: 700;
  }

  h1 {
    font-size: var(--font-size-xl);
    margin-top: 1.5rem;
    margin-bottom: 1rem;
  }

  h2 {
    font-size: var(--font-size-lg);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  p {
    margin-bottom: 1rem;
  }

  .animate-on-scroll {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }

  .animate-on-scroll.visible {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script define:vars={{ 
  textCopySuccess: socialSharingCopySuccess,
  textCopyFailure: socialSharingCopyFailure,
  textCopyDefaultLabel: socialSharingCopyLabel
}}>
  // Animation observer for scroll animations
  document.addEventListener('DOMContentLoaded', () => {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
        }
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.animate-on-scroll').forEach(element => {
      observer.observe(element);
    });

    // Move to Top Button functionality
    const moveToTopButton = document.getElementById('moveToTop');
    
    if (moveToTopButton) {
      // Show/hide button based on scroll position
      window.addEventListener('scroll', () => {
        if (window.scrollY > 750) {
          moveToTopButton.classList.remove('opacity-0', 'invisible');
          moveToTopButton.classList.add('opacity-100', 'visible');
        } else {
          moveToTopButton.classList.add('opacity-0', 'invisible');
          moveToTopButton.classList.remove('opacity-100', 'visible');
        }
      });

      // Scroll to top when clicked
      moveToTopButton.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    }

    // Social Sharing functionality
    function initSocialSharing() {
      const currentUrlDisplay = document.getElementById('current-url-display');
      const copyUrlButton = document.getElementById('copy-url-button');
      const copyUrlText = document.getElementById('copy-url-text');
      
      const facebookLink = document.getElementById('facebook-share-link');
      const whatsappLink = document.getElementById('whatsapp-share-link');
      const telegramLink = document.getElementById('telegram-share-link');
      const mailLink = document.getElementById('mail-share-link');

      if (!currentUrlDisplay || !copyUrlButton || !copyUrlText) return;

      let pageUrl = '';

      function updateContent() {
        if (typeof window === 'undefined') return;
        
        const currentLoc = window.location;
        pageUrl = currentLoc.href;

        // Construct URL for display: domain.com/path?query#hash
        let displayableUrl = currentLoc.hostname + currentLoc.pathname;
        if (currentLoc.search) {
          displayableUrl += currentLoc.search;
        }
        if (currentLoc.hash) {
          displayableUrl += currentLoc.hash;
        }
        currentUrlDisplay.textContent = displayableUrl;
        currentUrlDisplay.title = displayableUrl;
        
        const encodedUrl = encodeURIComponent(pageUrl);
        const encodedTitle = encodeURIComponent(document.title);

        if (facebookLink) {
          facebookLink.href = `https://m.me/?link=${encodedUrl}`;
        }
        if (whatsappLink) {
          whatsappLink.href = `https://wa.me/?text=${encodedTitle}%20-%20${encodedUrl}`;
        }
        if (telegramLink) {
          telegramLink.href = `https://t.me/share/url?url=${encodedUrl}&text=${encodedTitle}`;
        }
        if (mailLink) {
          mailLink.href = `mailto:?subject=${encodedTitle}&body=Poglej%20to%20stran:%20${encodedUrl}`;
        }
      }
      
      async function copyUrl() {
        if (!pageUrl || !navigator.clipboard) return;

        try {
          await navigator.clipboard.writeText(pageUrl);
          copyUrlText.textContent = textCopySuccess; 
          copyUrlText.className = 'px-2 py-1 bg-signal-green text-black rounded text-xs font-medium';
          
          setTimeout(() => {
            copyUrlText.textContent = textCopyDefaultLabel; 
            copyUrlText.className = 'px-2 py-1 bg-black text-signal-green rounded text-xs font-medium';
          }, 2000);
        } catch (err) {
          console.error('Copy failed:', err);
          copyUrlText.textContent = textCopyFailure; 
          setTimeout(() => {
            copyUrlText.textContent = textCopyDefaultLabel; 
            copyUrlText.className = 'px-2 py-1 bg-black text-signal-green rounded text-xs font-medium';
          }, 2000);
        }
      }

      copyUrlButton.addEventListener('click', copyUrl);
      updateContent(); 
      
      // Handle Astro view transitions for SPA-like navigations
      document.addEventListener('astro:page-load', updateContent);
    }

    // Initialize social sharing
    initSocialSharing();
  });
</script>