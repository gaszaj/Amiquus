---
// Path: /src/layouts/BaseLayout.astro
import path from 'path';
import Database from 'better-sqlite3';
import manifestData from '../data/site.webmanifest.json';

import '@fontsource-variable/inter';
import '../styles/fonts.css';
import '../styles/global.css'; 
import Cookie from '../components/Cookie.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Schema from '../components/Schema.astro';

export interface Props {
  languageIso: string;
  countryCode: string;
  contentOrientation: string;
  title: string;
  description?: string;
  ogImage?: string;
  keywords?: string;
  locale?: string;
  schema?: object | null;
  alternativeLinks?: Array<{
    code: string;
    country: string;
    name: string;
    languageIso: string;
    hreflang: string;
    href: string;
  }> | null;
  languageLinksMap: Record<string, string>;
  currentSlug?: string;
}

const {
  languageIso,
  countryCode,
  contentOrientation,
  title,
  description,
  ogImage,
  keywords,
  locale = "sl-SI",
  schema = null,
  alternativeLinks = null,
  languageLinksMap,
  currentSlug
} = Astro.props;

const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true });

const { www, allLocaleData } = db.transaction(() => {
    const wwwData = db.prepare('SELECT * FROM www LIMIT 1').get() as any;
    const commonEntries = db.prepare('SELECT * FROM common').all() as any[];
    return { www: wwwData, allLocaleData: commonEntries };
})();

let socialSharingTitle = "Send this link to a friend";
let socialSharingCopyLabel = "Copy URL";
let socialSharingCopySuccess = "Copied!";
let socialSharingCopyFailure = "Error!";
let socialSharingCopyLoading = "Loading URL...";
let socialSharingAlternative = "Or share here:";
let ariaLabelFacebook = "Share on Facebook Messenger";
let ariaLabelWhatsapp = "Share on WhatsApp";
let ariaLabelTelegram = "Share on Telegram";
let ariaLabelEmail = "Share via Email";
let ariaLabelMoveToTop = "Move to top";

const currentLocaleData = allLocaleData.find(locData => 
  locData.M_LANGUAGE_ISO === languageIso && 
  locData.M_COUNTRY_CODE === countryCode
);

if (currentLocaleData) {
  const slug = currentLocaleData.M_SLUG;
  Astro.cookies.set('last_lang', slug, {
    path: '/',
    maxAge: 31536000, // 1 year
  });
  socialSharingTitle = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_TITLE || socialSharingTitle;
  socialSharingCopyLabel = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_LABEL || socialSharingCopyLabel;
  socialSharingCopySuccess = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_SUCCESS || socialSharingCopySuccess;
  socialSharingCopyFailure = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_FAILURE || socialSharingCopyFailure;
  socialSharingCopyLoading = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_COPY_LOADING || socialSharingCopyLoading;
  socialSharingAlternative = currentLocaleData.M_SOCIAL_SHARING_COMPONENT_ALTERNATIVE || socialSharingAlternative;
  ariaLabelFacebook = currentLocaleData.PAGE_ARIA_LABEL_FACEBOOK || ariaLabelFacebook;
  ariaLabelWhatsapp = currentLocaleData.PAGE_ARIA_LABEL_WHATSAPP || ariaLabelWhatsapp;
  ariaLabelTelegram = currentLocaleData.PAGE_ARIA_LABEL_TELEGRAM || ariaLabelTelegram;
  ariaLabelEmail = currentLocaleData.PAGE_ARIA_LABEL_EMAIL || ariaLabelEmail;
  ariaLabelMoveToTop = currentLocaleData.M_MOVE_TO_TOP || ariaLabelMoveToTop;
}

const fullLocale = `${languageIso}-${countryCode}`;
const getAbsoluteOgImageUrl = (imagePath) => imagePath ? `${Astro.url.origin}${imagePath}` : '';
---

<!DOCTYPE html>
<html lang={languageIso} dir={contentOrientation}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />

    <title>{title} | {www.PAGE_ORGANISATION_FULL_NAME}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />

    <link rel="canonical" href={Astro.url.href} />
    {/* Your meta tags, links, etc. go here */}
    
    {schema && <Schema schema={schema} />}
  </head>

  <body class="bg-background text-foreground flex flex-col min-h-screen">
    <Header alternativeLinks={alternativeLinks || undefined} languageLinksMap={languageLinksMap} locale={currentSlug} />
    <main class="flex-grow">
      <slot />
    </main>    
    
    <section class="py-12 bg-muted">
      <div class="max-w-xl mx-auto px-4">
        <h2 class="text-2xl font-bold mb-6 text-center">{socialSharingTitle}</h2>
        <div class="bg-card rounded-lg shadow-sm p-4 border border-border mb-6">
          <div id="copy-url-button" class="flex items-center gap-3 p-3 bg-muted rounded-lg cursor-pointer hover:bg-border transition-colors group">
            <span id="copy-url-text" class="px-2 py-1 bg-primary text-primary-foreground rounded text-xs font-medium">{socialSharingCopyLabel}</span>
            <span id="current-url-display" class="flex-1 text-sm text-muted-foreground truncate">{socialSharingCopyLoading}</span>
            <svg class="w-4 h-4 text-muted-foreground group-hover:text-foreground transition-colors rtl:scale-x-[-1]" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
          </div>
        </div>
        <div class="bg-card rounded-lg shadow-sm p-4 border border-border">
          <h3 class="text-base font-semibold text-center mb-4">{socialSharingAlternative}</h3>
          <div class="flex justify-center gap-3">
             <!-- Social Share Links here -->
          </div>
        </div>
      </div>
    </section>
    
    <Footer />
    <Cookie />

    <!-- Scroll To Top Button HTML -->
    <div id="moveToTopContainer" class="fixed bottom-6 end-6 w-10 h-10 rounded-lg shadow-lg flex items-center justify-center opacity-0 invisible transition-all duration-300 z-50" style="background: conic-gradient(rgb(var(--primary)) var(--scroll-progress, 0%), transparent var(--scroll-progress, 0%));">
      <button id="moveToTopButton" aria-label={ariaLabelMoveToTop} class="w-[calc(100%-4px)] h-[calc(100%-4px)] bg-background rounded-[6px] flex items-center justify-center text-primary transition-colors hover:bg-muted focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
      </button>
    </div>

    <!-- SCRIPT FOR ALL PAGE INTERACTIONS -->
    <script>
      const applyTheme = (theme) => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
      };
      applyTheme(localStorage.getItem('theme') || 'light');

      function initializePageScripts() {
        
        // --- 1. THEME TOGGLE SETUP ---
        try {
          const themeToggle = document.getElementById('theme-toggle');
          if (!themeToggle) throw new Error("Theme toggle button not found");
          const themeIcon = document.getElementById('theme-icon');
          const sunIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8-9h1M3 12H2m15.364-6.364l.707.707M6.343 17.657l-.707.707m12.021 0l-.707-.707M6.343 6.343l.707-.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`;
          const moonIcon = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />`;
          const updateThemeIcon = (theme) => {
            if (themeIcon) themeIcon.innerHTML = theme === 'dark' ? moonIcon : sunIcon;
          };
          updateThemeIcon(localStorage.getItem('theme') || 'light');
          themeToggle.onclick = () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
            updateThemeIcon(newTheme);
          };
        } catch (e) {
          console.error("Failed to initialize theme toggle:", e);
        }
        
        // --- 2. HEADER MENUS SETUP ---
        try {
          const menus = [
            { btn: document.getElementById('user-btn'), menu: document.getElementById('user-dropdown') },
            { btn: document.getElementById('mobile-menu-btn'), menu: document.getElementById('mobile-nav') },
            { btn: document.getElementById('desktop-lang-button'), menu: document.getElementById('desktop-lang-dropdown') },
            { btn: document.getElementById('mobile-lang-button'), menu: document.getElementById('mobile-lang-dropdown') }
          ];
          menus.forEach(({ btn, menu }) => {
            if (btn && menu) {
              btn.onclick = (event) => {
                event.stopPropagation();
                const isHidden = menu.classList.contains('hidden');
                menus.forEach(m => m.menu?.classList.add('hidden'));
                if (isHidden) menu.classList.remove('hidden');
              };
            }
          });
          document.onclick = () => {
            menus.forEach(({ menu }) => menu?.classList.add('hidden'));
          };
        } catch (e) {
          console.error("Failed to initialize header menus:", e);
        }

        // --- 3. MOVE TO TOP BUTTON LOGIC ---
        // This is the missing piece.
        try {
            const container = document.getElementById('moveToTopContainer');
            const button = document.getElementById('moveToTopButton');
            
            if (container && button) {
                const handleScroll = () => {
                    const isVisible = window.scrollY > 400;
                    container.classList.toggle('opacity-0', !isVisible);
                    container.classList.toggle('invisible', !isVisible);

                    // Optional: Scroll progress logic
                    const main = document.querySelector('main');
                    if (main) {
                        const scrollableDist = main.offsetHeight - window.innerHeight;
                        const progress = (window.scrollY - main.offsetTop) / scrollableDist * 100;
                        container.style.setProperty('--scroll-progress', `${Math.max(0, Math.min(progress, 100))}%`);
                    }
                };
                
                window.addEventListener('scroll', handleScroll, { passive: true });
                button.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });

                // Run once on load to set initial state
                handleScroll();
            }

        } catch(e) {
            console.error("Failed to initialize Move To Top button:", e);
        }
        // --- 4. COOKIE BANNER LOGIC ---
        try {
            const settingsTrigger = document.getElementById('cookie-settings-trigger');
            const banner = document.getElementById('cookie-consent-banner');
            const initialView = document.getElementById('cookie-initial-view');
            const detailsView = document.getElementById('cookie-details-view');
            const acceptBtn = document.getElementById('cookie-accept-btn');
            const customizeBtn = document.getElementById('cookie-customize-btn');
            const declineBtn = document.getElementById('cookie-decline-btn');
            const closeDetailsBtn = document.getElementById('cookie-close-details-btn');
            const savePrefsBtn = document.getElementById('cookie-save-prefs-btn');
            const acceptAllDetailsBtn = document.getElementById('cookie-accept-all-details-btn');
            const analyticsCheckbox = document.getElementById('cookie-analytics');
            const marketingCheckbox = document.getElementById('cookie-marketing');

            if (banner && analyticsCheckbox && marketingCheckbox) {
                const CONSENT_GIVEN_KEY = 'cookie_consent_given';
                const PREFS_KEY = 'cookie_consent_prefs';

                const showBanner = () => {
                    banner.style.transform = 'translateY(0)';
                    if (settingsTrigger) setTimeout(() => settingsTrigger.style.transform = 'scale(0)', 10);
                };

                const hideBanner = () => {
                    banner.style.transform = 'translateY(100%)';
                    if (settingsTrigger) settingsTrigger.style.transform = 'scale(1)';
                };

                const recordConsent = (preferences) => {
                    localStorage.setItem(CONSENT_GIVEN_KEY, 'true');
                    localStorage.setItem(PREFS_KEY, JSON.stringify(preferences));
                    hideBanner();
                };

                acceptBtn.onclick = () => recordConsent({ analytics: true, marketing: true });
                acceptAllDetailsBtn.onclick = () => recordConsent({ analytics: true, marketing: true });
                declineBtn.onclick = () => recordConsent({ analytics: false, marketing: false });
                savePrefsBtn.onclick = () => recordConsent({
                    analytics: analyticsCheckbox.checked,
                    marketing: marketingCheckbox.checked,
                });

                customizeBtn.onclick = () => {
                    initialView.classList.add('hidden');
                    detailsView.classList.remove('hidden');
                };
                closeDetailsBtn.onclick = () => {
                    detailsView.classList.add('hidden');
                    initialView.classList.remove('hidden');
                };

                settingsTrigger.onclick = showBanner;
                
                // Initial check
                const consentGiven = localStorage.getItem(CONSENT_GIVEN_KEY) === 'true';
                if (consentGiven) {
                    settingsTrigger.classList.remove('hidden');
                } else {
                    setTimeout(showBanner, 1500);
                }
            }
        } catch (e) {
            console.error("Failed to initialize cookie banner:", e);
        }
      }

      initializePageScripts();
      document.addEventListener('astro:page-load', initializePageScripts);
    </script>
  </body>
</html>

<style is:global>
  :root {
    --font-size-base: clamp(1rem, 0.34vw + 0.91rem, 1.19rem);
    --font-size-lg: clamp(1.2rem, 0.7vw + 1.2rem, 1.5rem); 
    --font-size-xl: clamp(2.44rem, 2.38vw + 1.85rem, 3.75rem);
  }
  html {
    font-family: 'Inter Variable', system-ui, sans-serif;
    scroll-behavior: smooth;
  }
  body {
    font-size: var(--font-size-base);
  }
</style>