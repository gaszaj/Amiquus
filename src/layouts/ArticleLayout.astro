---
import BaseLayout from './BaseLayout.astro';

// --- Type Definitions for Props ---
export interface AuthorInfo {
  name: string;
  profileUrl: string;
  image: string;
}

export interface HeadingInfo {
  depth: number;
  slug: string;
  text: string;
}

export interface RelatedArticleInfo {
  title: string;
  url: string;
  date: string; // Date string, formatting will be handled by props
}

// --- Content Props for Sections ---
export interface TocContent {
  title: string;
}

export interface EditorialPolicyContent {
  title: string;
  description: string;
  ctaText: string;
  ctaLink: string;
}

export interface DisclaimerContent {
  text: string;
}

export interface RelatedArticlesContent {
  title: string;
  articles: RelatedArticleInfo[];
}

export interface HelpBoxContent {
  title: string;
  description: string;
  ctaText: string;
  ctaLink: string;
}

export interface BasicSign {
  name: string;
  image: string;
  url: string;
}

export interface AdditionalSign {
  image: string;
  name: string;
  url: string;
}

export interface FaqItem {
  question: string;
  answer: string;
}

export interface FaqSection {
  title: string;
  items: FaqItem[];
}

// --- Main Props Interface ---
export interface Props {
  // Base Layout Props
  title: string;
  description?: string;

  // Article Metadata (passed through)
  publishDate: string;
  updateDate?: string;
  author: AuthorInfo;
  headings: HeadingInfo[];
  // category: string; // Removed as it wasn't used in the layout structure directly

  // Date Formatting Props
  mainDateFormatOptions: Intl.DateTimeFormatOptions;
  mainDateLocale: string;
  relatedDateFormatOptions: Intl.DateTimeFormatOptions;
  relatedDateLocale: string;

  // UI Text Labels
  authorLabelText: string;
  publishedLabelText: string;
  updatedLabelText?: string;

  // Section Content Props
  tocContent: TocContent;
  editorialPolicyContent: EditorialPolicyContent;
  disclaimerContent: DisclaimerContent;
  relatedArticlesContent: RelatedArticlesContent;
  helpBoxContent: HelpBoxContent;
  schema: object | null;

  // Content sections
  basicSigns: BasicSign[];
  additionalSigns: AdditionalSign[];
  faqSection: FaqSection;
  productButtonText: string;
  tableLinkText: string;
  fearBannerText: string;
  helpfulBannerText: string;

  // Content sections
  mainContent: {
    h1: {
      id: string;
      text: string;
      content: string;
    };
    h2_1: {
      id: string;
      text: string;
      content: string;
      conclusion: string;
    };
    h2_2: {
      id: string;
      text: string;
      content: string;
    };
    h2_3: {
      id: string;
      text: string;
      content: string;
      conclusion: string;
    };
    h2_4: {
      id: string;
      text: string;
      content: string;
    };
    h2_6: {
      id: string;
      text: string;
      content: string;
    };
  };

  // Table headers
  tableHeaders: {
    image: string;
    name: string;
    link: string;
  };

  // Additional content
  warningTrianglesText: string;
  checkOfferText: string;
}

const {
  title,
  description,
  publishDate,
  updateDate,
  author,
  headings = [],
  mainDateFormatOptions,
  mainDateLocale,
  relatedDateFormatOptions,
  relatedDateLocale,
  authorLabelText,
  publishedLabelText,
  updatedLabelText,
  tocContent,
  editorialPolicyContent,
  disclaimerContent,
  relatedArticlesContent,
  helpBoxContent,
  schema,
  basicSigns,
  additionalSigns,
  faqSection,
  productButtonText,
  tableLinkText,
  fearBannerText,
  helpfulBannerText,
  mainContent,
  tableHeaders,
  warningTrianglesText,
  checkOfferText
} = Astro.props;

// Generic Date Formatter
const formatDate = (dateString: string, locale: string, options: Intl.DateTimeFormatOptions) => {
  return new Date(dateString).toLocaleDateString(locale, options);
};

// Filter headings for TOC (presentation logic, can stay)
const tocHeadings = headings.filter(heading => heading.depth >= 2 && heading.depth <= 3);
---

<BaseLayout title={title} description={description} schema={schema}>
  <!-- Hero Section with Dark Background -->
  <div class="bg-black text-white py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl animate-fade-in">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">{title}</h1>
        
        {description && (
          <p class="text-xl text-gray-300 mb-6">{description}</p>
        )}
        
        <div class="flex flex-col sm:flex-row flex-wrap gap-2 sm:items-center">
          <div class="flex items-center">
            <span class="text-gray-300 mr-2">{authorLabelText}</span>
            <a href={author.profileUrl} class="flex items-center group">
              <img 
                src={author.image} 
                alt={author.name} 
                class="w-10 h-10 rounded-full mr-3"
                width={200}
                height={200}
                fetchpriority="high" 
              />
              <span class="text-white group-hover:text-signal-green transition-colors">
                {author.name}
              </span>
            </a>
          </div>
          <div class="flex items-center">
            <span class="hidden sm:inline mx-2 text-gray-300">‚Ä¢</span>
            <span class="text-gray-300">{publishedLabelText} {formatDate(publishDate, mainDateLocale, mainDateFormatOptions)}</span>
          </div>
          {updateDate && updatedLabelText && (
            <div class="flex items-center">
              <span class="hidden sm:inline mx-2 text-gray-300">‚Ä¢</span>
              <span class="text-gray-300">
                {updatedLabelText} {formatDate(updateDate, mainDateLocale, mainDateFormatOptions)}
              </span>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Left Sidebar - Table of Contents -->
      <aside class="lg:w-1/5">
        <div class="sticky top-24">
          {tocHeadings.length > 0 && (
            <nav class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
              <h2 class="text-lg font-semibold text-signal-dark mb-2 pb-2 border-b">{tocContent.title}</h2>
              <ul class="space-y-1">
                {tocHeadings.map(heading => (
                  <li class={`${heading.depth === 2 ? 'mt-2 first:mt-0' : 'ml-3'}`}>
                    <a 
                      href={`#${heading.slug}`}
                      class={`toc-link block py-1.5 px-2 rounded transition-colors text-sm
                        ${heading.depth === 2 
                          ? 'text-signal-dark font-medium hover:bg-gray-50 border-l-2 border-transparent' 
                          : 'text-signal-gray hover:text-signal-green'}`}
                    >
                      {heading.text}
                    </a>
                  </li>
                ))}
              </ul>
            </nav>
          )}
        </div>
      </aside>

      <!-- In ArticleLayout.astro, inside the main content div -->
<div class="lg:w-3/5">
  <div class="prose prose-lg max-w-none">
    <!-- Main article content -->
    <h2 id={mainContent.h1.id}>{mainContent.h1.text}</h2>
    <p>{mainContent.h1.content}</p>

    <div class="fear-banner">
      {fearBannerText}
    </div>

    <h3 id={mainContent.h2_1.id}>{mainContent.h2_1.text}</h3>
    <p>{mainContent.h2_1.content}</p>

    <div class="basic-signs-grid">
      {basicSigns.map(sign => (
        <div class="product-card">
          <img 
            src={sign.image} 
            alt={sign.name}
            class="w-full h-48 object-contain p-4"
          />
          <div class="p-4 text-center product-card-content">
            <h4 class="font-medium text-signal-dark mb-4 product-title">{sign.name}</h4>
            <a 
              href={sign.url}
              class="block w-full bg-black text-signal-green border border-signal-green font-medium py-2 px-4 rounded-md hover:bg-signal-green hover:text-black transition-all text-center"
            >
              {productButtonText}
            </a>
          </div>
        </div>
      ))}
    </div>

    <p>{mainContent.h2_1.conclusion}</p>

    <h2 id={mainContent.h2_2.id}>{mainContent.h2_2.text}</h2>
    <p>{mainContent.h2_2.content}</p>

    <h3 id={mainContent.h2_3.id}>{mainContent.h2_3.text}</h3>

    <div class="overflow-x-auto my-8">
      <table class="w-full bg-white rounded-lg shadow-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-4 text-left">{tableHeaders.image}</th>
            <th class="p-4 text-left">{tableHeaders.name}</th>
            <th class="p-4 text-left">{tableHeaders.link}</th>
          </tr>
        </thead>
        <tbody>
          {additionalSigns.map((sign, index) => (
            <tr class={index % 2 === 0 ? 'bg-gray-50' : ''}>
              <td class="p-4">
                <img 
                  src={sign.image} 
                  alt={sign.name}
                  class="w-20 h-20 object-contain"
                />
              </td>
              <td class="p-4 font-medium text-signal-dark">{sign.name}</td>
              <td class="p-4">
                <a 
                  href={sign.url}
                  class="text-black underline decoration-signal-green hover:text-signal-green hover:decoration-black transition-colors"
                >
                  {tableLinkText}
                </a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <p>{mainContent.h2_3.conclusion}</p>

    <p>{warningTrianglesText}</p>

    <h2 id={mainContent.h2_4.id}>{mainContent.h2_4.text}</h2>
    <p>{mainContent.h2_4.content}</p>

    <div class="helpful-banner">
      {helpfulBannerText}
    </div>

    <section class="faq-section" aria-labelledby="faq-heading">
      <h2 id="faq-heading" class="faq-title">{faqSection.title}</h2>
      <dl class="faq-list">
        {faqSection.items.map(item => (
          <div class="faq-item">
            <dt class="faq-question">
              <h3>{item.question}</h3>
            </dt>
            <dd class="faq-answer">
              <p>{item.answer}</p>
            </dd>
          </div>
        ))}
      </dl>
    </section>

    <h3 id={mainContent.h2_6.id}>{mainContent.h2_6.text}</h3>
    <p>{checkOfferText}</p>
    
    <div class="basic-signs-grid">
      {[...basicSigns, ...additionalSigns.slice(0, 3)].map(sign => (
        <div class="product-card">
          <img 
            src={sign.image} 
            alt={sign.name}
            class="w-full h-48 object-contain p-4"
            width={225}
            height={225}
          />
          <div class="p-4 text-center product-card-content">
            <h4 class="font-medium text-signal-dark mb-4 product-title">{sign.name}</h4>
            <a 
              href={sign.url}
              class="block w-full bg-black text-signal-green border border-signal-green font-medium py-2 px-4 rounded-md hover:bg-signal-green hover:text-black transition-all text-center"
            >
              {productButtonText}
            </a>
          </div>
        </div>
      ))}
    </div>
  </div>

        <!-- Editorial Policy Section -->
        <div class="bg-black text-white rounded-xl p-8 my-12">
          <h3 class="text-2xl font-bold mb-4">{editorialPolicyContent.title}</h3>
          <p class="text-gray-300 mb-6">
            {editorialPolicyContent.description}
          </p>
          <a 
            href={editorialPolicyContent.ctaLink} 
            class="inline-block bg-signal-green text-black font-semibold px-6 py-3 rounded-lg hover:bg-[#a5d429] transition-colors"
          >
            {editorialPolicyContent.ctaText}
          </a>
        </div>

        <!-- Disclaimer Section -->
        <div class="bg-red-50 border border-red-100 rounded-xl p-6 mt-6">
          <p class="text-red-800 text-sm">
            {disclaimerContent.text}
          </p>
        </div>

        <!-- Related Articles Section -->
        {relatedArticlesContent.articles && relatedArticlesContent.articles.length > 0 && (
           <div class="border-t border-gray-200 pt-12 mt-12">
            <h2 class="text-2xl font-bold mb-8">{relatedArticlesContent.title}</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              {relatedArticlesContent.articles.map(article => (
                <article class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                  <h3 class="font-semibold text-lg mb-2">
                    <a href={article.url} class="text-signal-dark hover:text-signal-green transition-colors">
                      {article.title}
                    </a>
                  </h3>
                  <p class="text-signal-gray text-sm">
                    {formatDate(article.date, relatedDateLocale, relatedDateFormatOptions)}
                  </p>
                </article>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Right Sidebar -->
      <aside class="lg:w-1/5">
        <div class="sticky top-24 space-y-6">
          <!-- Need Help Box -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <h3 class="text-xl font-semibold text-signal-dark mb-3">{helpBoxContent.title}</h3>
            <p class="text-signal-gray mb-4">
              {helpBoxContent.description}
            </p>
            <a 
              href={helpBoxContent.ctaLink} 
              class="block bg-black text-signal-green border border-signal-green text-center font-medium py-3 px-4 rounded-lg hover:bg-signal-green hover:text-black transition-all"
            >
              {helpBoxContent.ctaText}
            </a>
          </div>
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>

<style>
  .toc-link.active {
    color: var(--signal-green);
    background-color: #f0f9ff;
    font-weight: 600;
  }

  .toc-link.active:where([class*="border-l-4"]) { /* Original selector */
    border-left-color: var(--signal-green);
  }

  /* Custom styles for banners */
  :global(.fear-banner) {
    @apply bg-red-50 border border-red-100 rounded-xl p-6 my-8 flex items-center;
  }

  :global(.fear-banner::before) {
    content: "‚ö†Ô∏è";
    @apply text-2xl mr-4;
  }

  :global(.helpful-banner) {
    @apply bg-green-50 border border-green-100 rounded-xl p-6 my-8 flex items-center;
  }

  :global(.helpful-banner::before) {
    content: "üí°";
    @apply text-2xl mr-4;
  }

  /* FAQ section styles */
  :global(.faq-section) {
    @apply bg-gray-50 rounded-xl p-6 my-8;
  }

  :global(.faq-section h2) {
    @apply text-2xl font-bold mb-6;
  }

  :global(.faq-item) {
    @apply mb-4;
  }

  :global(.faq-question) {
    @apply font-semibold text-lg mb-2;
  }

  :global(.faq-answer) {
    @apply text-signal-gray;
  }

  /* Product grid styles */
  :global(.product-grid) {
    @apply grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 my-8;
  }

  :global(.product-card) {
    @apply bg-white rounded-lg shadow-md overflow-hidden border border-gray-200;
  }

  :global(.product-card img) {
    @apply w-full h-48 object-contain p-4;
  }

  :global(.product-card-content) {
    @apply p-4;
  }

  :global(.product-title) {
    @apply font-medium text-lg mb-4;
  }

  :global(.product-button) {
    @apply inline-block w-full bg-black text-signal-green border border-signal-green font-medium py-2 px-4 rounded-md hover:bg-signal-green hover:text-black transition-all text-center;
  }

  /* Basic Signs Grid */
  :global(.basic-signs-grid) {
    @apply grid grid-cols-1 md:grid-cols-3 gap-6 my-8;
  }

  :global(.basic-signs-grid .product-card) {
    @apply bg-white rounded-lg shadow-md overflow-hidden border border-gray-200;
  }

  :global(.basic-signs-grid a) {
    @apply block w-full bg-black text-signal-green border border-signal-green font-medium py-2 px-4 rounded-md hover:bg-signal-green hover:text-black transition-all text-center;
  }

  /* Flag icon styles */
  .flag-icon {
    width: 1.5em;
    height: 1em;
    object-fit: cover;
  }

  /* Ensure SVG flags maintain aspect ratio */
  svg {
    width: 100%;
    height: 100%;
  }
</style>

<script>
  // Highlight TOC items when scrolling to section
  document.addEventListener('DOMContentLoaded', () => {
    const headings = Array.from(document.querySelectorAll('h2[id], h3[id], h4[id]'));
    const tocLinks = Array.from(document.querySelectorAll('.toc-link'));
    
    if (headings.length > 0 && tocLinks.length > 0) { 
      const observerOptions = {
        rootMargin: '-100px 0px -60% 0px',
        threshold: 0
      };
      
      const headingObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          const id = entry.target.getAttribute('id');
          const tocLink = document.querySelector(`.toc-link[href="#${id}"]`);
          
          if (tocLink) {
            if (entry.isIntersecting && entry.intersectionRatio > 0) { 
              tocLinks.forEach(link => link.classList.remove('active'));
              tocLink.classList.add('active');
            }
          }
        });
      }, observerOptions);
      
      headings.forEach(heading => {
        if (heading.id) { 
            headingObserver.observe(heading);
        }
      });
    }
  });
</script>