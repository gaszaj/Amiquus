---
// Import JSON data
import headerFooterData from '../data/headerfooter.json';
import commonData from '../data/common.json';
import eeatData from '../data/eeat.json';
import products from '../data/product.json';
import * as flags from 'country-flag-icons/string/3x2';

const currentYear = new Date().getFullYear();

// Get current locale from URL path
const currentPath = Astro.url.pathname;
const localeMatch = currentPath.match(/^\/([a-z]{2}(?:-[a-z]{2})?)/);
const currentLocale = localeMatch ? localeMatch[1] : 'si';

// Get country code from locale (handle cases like 'de-ch' -> 'ch')
const getCountryCode = (locale: string) => {
  const parts = locale.split('-');
  return parts.length > 1 ? parts[1].toUpperCase() : locale.toUpperCase();
};

// Find matching data for current locale
const headerFooter = headerFooterData.find(data => data.M_SLUG === currentLocale) || headerFooterData[0];
const common = commonData.find(data => data.M_SLUG === currentLocale) || commonData[0];

// Get current country flag
const currentCountryCode = getCountryCode(currentLocale);
const currentCountryFlag = flags[currentCountryCode as keyof typeof flags];

// Helper function to get EEAT pages by filtering number
const getEeatPages = (filteringNumbers: string[]) => {
  return eeatData
    .filter(page => filteringNumbers.includes(page.EEAT_FILTERING))
    .map(page => ({
      text: page.EEAT_NAME,
      href: `/${currentLocale}/${page.EEAT_SLUG}`
    }));
};

// Helper function to get product by ID
const getProductById = (productId: string) => {
  return products.find(product => 
    product.PRODUCT_ID === productId && 
    product.M_SLUG === currentLocale
  );
};

// Debug logging
console.log('Current Locale:', currentLocale);
console.log('Product IDs:', {
  id1: headerFooter.FOOTER_BESTSELLER_ID_1,
  id2: headerFooter.FOOTER_BESTSELLER_ID_2,
  id3: headerFooter.FOOTER_BESTSELLER_ID_3,
  id4: headerFooter.FOOTER_BESTSELLER_ID_4,
  id5: headerFooter.FOOTER_BESTSELLER_ID_5,
  id6: headerFooter.FOOTER_BESTSELLER_ID_6
});

// Filter and sort bestsellers based on criteria for specific locale
const bestSellers = products
  .filter(product => 
    product.PUBLISH_Y_N === "1" && 
    product.PRODUCT_IS_BESTSELLER === "1" &&
    product.M_SLUG === currentLocale
  )
  .sort((a, b) => {
    // First sort by importance rank (descending)
    const rankDiff = parseInt(b.PRODUCT_IMPORTANCE_RANK) - parseInt(a.PRODUCT_IMPORTANCE_RANK);
    if (rankDiff !== 0) return rankDiff;
    // If ranks are equal, randomize
    return Math.random() - 0.5;
  })
  .slice(0, 6) // Get top 6 bestsellers for footer
  .map(product => ({
    text: product.PRODUCT_NAME,
    href: `/${product.M_SLUG}/${product.PRODUCT_CATEGORY_1_SLUG}/${product.PRODUCT_ASCII_SLUG}`
  }));

// Debug logging
console.log('Final bestSellers array:', bestSellers);

// Define footer navigation groups with exact EEAT page mapping
const footerNavGroups = [
  {
    title: headerFooter.FOOTER_EEAT_GROUP_1, // Podjetje
    links: getEeatPages(['18', '21', '14', '22', '20', '19'])
  },
  {
    title: headerFooter.FOOTER_EEAT_GROUP_2, // Podpora
    links: getEeatPages(['16', '15', '17', '26', '11', '08'])
  },
  {
    title: headerFooter.FOOTER_EEAT_GROUP_3, // Sodelovanja
    links: getEeatPages(['24', '25', '23', '09', '10'])
  },
  {
    title: headerFooter.FOOTER_EEAT_GROUP_4, // Pravilniki
    links: getEeatPages(['03', '04', '05', '06', '07', '12', '13'])
  }
];

// Social media links (now includes TikTok, YouTube, Pinterest, Bluesky)
const socialLinks = [
  { name: 'LinkedIn', url: common.PAGE_LINKEDIN_URL, icon: 'linkedin' },
  { name: 'Facebook', url: common.PAGE_FACEBOOK_URL, icon: 'facebook' },
  { name: 'Twitter', url: common.PAGE_TWITTER_URL, icon: 'twitter' },
  { name: 'Instagram', url: common.PAGE_INSTAGRAM_URL, icon: 'instagram' },
  { name: 'TikTok', url: common.PAGE_TIKTOK_URL, icon: 'tiktok' },
  { name: 'YouTube', url: common.PAGE_YOUTUBE_URL, icon: 'youtube' },
  { name: 'Pinterest', url: common.PAGE_PINTEREST_URL, icon: 'pinterest' },
  { name: 'Bluesky', url: common.PAGE_BLUESKY_URL, icon: 'bluesky' }
];

// Bundles
const bundles = [
  { text: headerFooter.FOOTER_BUNDLES_NAME_1, href: headerFooter.FOOTER_BUNDLES_PATH_1 },
  { text: headerFooter.FOOTER_BUNDLES_NAME_2, href: headerFooter.FOOTER_BUNDLES_PATH_2 },
  { text: headerFooter.FOOTER_BUNDLES_NAME_3, href: headerFooter.FOOTER_BUNDLES_PATH_3 },
  { text: headerFooter.FOOTER_BUNDLES_NAME_4, href: headerFooter.FOOTER_BUNDLES_PATH_4 },
  { text: headerFooter.FOOTER_BUNDLES_NAME_5, href: headerFooter.FOOTER_BUNDLES_PATH_5 },
  { text: headerFooter.FOOTER_BUNDLES_NAME_6, href: headerFooter.FOOTER_BUNDLES_PATH_6 }
];
---

<footer class="bg-black text-white pt-12 pb-6">
  <div class="container mx-auto px-4">
    <!-- Top Footer Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
      <!-- Company Info -->
      <div class="lg:col-span-2">
        <img 
        src="/logos/EUSIGNAL-SVG-File_Horizontal-Light.svg" 
        alt={headerFooter.HEADER_LOGO_ALT}
        class="h-6 w-auto"
        style="max-height: 50px; height: auto; width: auto;"
        width="939"
        height="161"
        loading="lazy"
      />
        <p class="mb-4 text-signal-green">{common.PAGE_SLOGAN}</p>
        <!-- Social Links -->
        <div class="flex space-x-4 mt-6">
          {socialLinks.map(social => (
            <a href={social.url} target="_blank" rel="noopener" class="text-gray-300 hover:text-signal-green transition-colors" aria-label={social.name}>
  {social.icon === 'linkedin' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
      <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
    </svg>
  )}
  {social.icon === 'facebook' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
      <path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/>
    </svg>
  )}
  {social.icon === 'twitter' && ( // X icon
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
      <path d="M8.5 2h2.5L11 2h-2.5zM13 2h2.5L15.5 2h-2.5zM10.5 2h5v0h-5zM8.5 2h5v0h-5zM10 2h3.5L13.5 2h-3.5z">
        <animate fill="freeze" attributeName="d" dur="0.96s" keyTimes="0;0.3;0.5;1" values="M8.5 2h2.5L11 2h-2.5zM13 2h2.5L15.5 2h-2.5zM10.5 2h5v0h-5zM8.5 2h5v0h-5zM10 2h3.5L13.5 2h-3.5z;M8.5 2h2.5L11 22h-2.5zM13 2h2.5L15.5 22h-2.5zM10.5 2h5v2h-5zM8.5 20h5v2h-5zM10 2h3.5L13.5 22h-3.5z;M8.5 2h2.5L11 22h-2.5zM13 2h2.5L15.5 22h-2.5zM10.5 2h5v2h-5zM8.5 20h5v2h-5zM10 2h3.5L13.5 22h-3.5z;M1 2h2.5L18.5 22h-2.5zM5.5 2h2.5L23 22h-2.5zM3 2h5v2h-5zM16 20h5v2h-5zM18.5 2h3.5L5 22h-3.5z"/>
      </path>
    </svg>
  )}
  {social.icon === 'instagram' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
      <circle cx="17" cy="7" r="1.5" fill="currentColor" fill-opacity="0">
        <animate fill="freeze" attributeName="fill-opacity" begin="1.56s" dur="0.18s" values="0;1"/>
      </circle>
      <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
        <path stroke-dasharray="72" stroke-dashoffset="72" d="M16 3c2.76 0 5 2.24 5 5v8c0 2.76 -2.24 5 -5 5h-8c-2.76 0 -5 -2.24 -5 -5v-8c0 -2.76 2.24 -5 5 -5h4Z">
          <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.72s" values="72;0"/>
        </path>
        <path stroke-dasharray="28" stroke-dashoffset="28" d="M12 8c2.21 0 4 1.79 4 4c0 2.21 -1.79 4 -4 4c-2.21 0 -4 -1.79 -4 -4c0 -2.21 1.79 -4 4 -4">
          <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.84s" dur="0.72s" values="28;0"/>
        </path>
      </g>
    </svg>
  )}
  {social.icon === 'tiktok' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
      <mask id="lineMdTiktok0">
        <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
          <path fill="currentColor" stroke="none" d="M16.6 5.82c-0.68 -0.78 -1.06 -1.78 -1.06 -2.82h-3.09v12.4c-0.02 0.67 -0.31 1.31 -0.79 1.77c-0.48 0.47 -1.13 0.73 -1.8 0.73c-1.42 0 -2.6 -1.16 -2.6 -2.6c0 -1.72 1.66 -3.01 3.37 -2.48v-3.16c-3.45 -0.46 -6.47 2.22 -6.47 5.64c0 3.33 2.76 5.7 5.69 5.7c3.14 0 5.69 -2.55 5.69 -5.7v-6.29c1.25 0.9 2.76 1.38 4.3 1.38v-3.09c0 0 -1.88 0.09 -3.24 -1.48Z"/>
          <path stroke="#000" stroke-dasharray="36" stroke-dashoffset="72" stroke-width="4" d="M11 11h-1c-2.21 0 -4.5 1.79 -4.5 4c0 2.21 1.5 4.5 4.5 4.5c2.21 0 4 -2.29 4 -4.5v-12.5">
            <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.72s" values="72;36"/>
          </path>
          <path stroke="#000" stroke-dasharray="10" stroke-dashoffset="20" stroke-width="4" d="M18 2.5v8">
            <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.12s" values="20;10"/>
          </path>
        </g>
      </mask>
      <rect width="24" height="24" fill="currentColor" mask="url(#lineMdTiktok0)"/>
    </svg>
  )}
  {social.icon === 'youtube' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
      <mask id="lineMdYoutubeFilled0">
        <g fill="none" fill-opacity="0" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
          <path fill="currentColor" stroke-dasharray="64" stroke-dashoffset="64" d="M12 5c9 0 9 0 9 7c0 7 0 7 -9 7c-9 0 -9 0 -9 -7c0 -7 0 -7 9 -7Z">
            <animate fill="freeze" attributeName="fill-opacity" begin="0.72s" dur="0.6s" values="0;1"/>
            <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.72s" values="64;0"/>
          </path>
          <path fill="#000" stroke="none" d="M12 11L12 12L12 13z">
            <animate fill="freeze" attributeName="d" begin="1.32s" dur="0.24s" values="M12 11L12 12L12 13z;M10 8.5L16 12L10 15.5z"/>
            <set fill="freeze" attributeName="fill-opacity" begin="1.32s" to="1"/>
          </path>
        </g>
      </mask>
      <rect width="24" height="24" fill="currentColor" mask="url(#lineMdYoutubeFilled0)"/>
    </svg>
  )}
  {social.icon === 'pinterest' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
      <path d="M9.04 21.54c.96.29 1.93.46 2.96.46a10 10 0 0 0 10-10A10 10 0 0 0 12 2A10 10 0 0 0 2 12c0 4.25 2.67 7.9 6.44 9.34c-.09-.78-.18-2.07 0-2.96l1.15-4.94s-.29-.58-.29-1.5c0-1.38.86-2.41 1.84-2.41c.86 0 1.26.63 1.26 1.44c0 .86-.57 2.09-.86 3.27c-.17.98.52 1.84 1.52 1.84c1.78 0 3.16-1.9 3.16-4.58c0-2.4-1.72-4.04-4.19-4.04c-2.82 0-4.48 2.1-4.48 4.31c0 .86.28 1.73.74 2.3c.09.06.09.14.06.29l-.29 1.09c0 .17-.11.23-.28.11c-1.28-.56-2.02-2.38-2.02-3.85c0-3.16 2.24-6.03 6.56-6.03c3.44 0 6.12 2.47 6.12 5.75c0 3.44-2.13 6.2-5.18 6.2c-.97 0-1.92-.52-2.26-1.13l-.67 2.37c-.23.86-.86 2.01-1.29 2.7z"/>
    </svg>
  )}
  {social.icon === 'bluesky' && (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 11.388c-.906-1.761-3.372-5.044-5.665-6.662c-2.197-1.55-3.034-1.283-3.583-1.033C2.116 3.978 2 4.955 2 5.528c0 .575.315 4.709.52 5.4c.68 2.28 3.094 3.05 5.32 2.803c-3.26.483-6.157 1.67-2.36 5.898c4.178 4.325 5.726-.927 6.52-3.59c.794 2.663 1.708 7.726 6.444 3.59c3.556-3.59.977-5.415-2.283-5.898c2.225.247 4.64-.523 5.319-2.803c.205-.69.52-4.825.52-5.399c0-.575-.116-1.55-.752-1.838c-.549-.248-1.386-.517-3.583 1.033c-2.293 1.621-4.76 4.904-5.665 6.664"/>
    </svg>
  )}
</a>
          ))}
        </div>
      </div>

      <!-- Bestsellers -->
      <div>
        <h4 class="text-lg font-medium mb-4 text-signal-green">{headerFooter.FOOTER_BESTSELLERS_GROUP}</h4>
        <ul class="space-y-2">
          {bestSellers.map(link => (
            <li>
              <a 
                href={link.href} 
                class="text-gray-300 hover:text-signal-green transition-colors"
              >
                {link.text}
              </a>
            </li>
          ))}
        </ul>
      </div>

      <!-- Bundles -->
      <div>
        <h4 class="text-lg font-medium mb-4 text-signal-green">{headerFooter.FOOTER_BUNDLES_GROUP}</h4>
        <ul class="space-y-2">
          {bundles.map(link => (
            <li>
              <a 
                href={link.href} 
                class="text-gray-300 hover:text-signal-green transition-colors"
              >
                {link.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </div>

    <!-- Divider -->
    <div class="border-t border-gray-800 my-8"></div>

    <!-- Bottom Footer Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
      <!-- Navigation Groups -->
      {footerNavGroups.map(group => (
        <div>
          <h4 class="text-lg font-medium mb-4 text-signal-green">{group.title}</h4>
          <ul class="space-y-2">
            {group.links.map(link => (
              <li>
                <a 
                  href={link.href} 
                  class="text-gray-300 hover:text-signal-green transition-colors"
                >
                  {link.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>

    <!-- Contact Info -->
    <div class="border-t border-gray-800 mt-8 pt-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="flex items-start">
          <div class="flex-shrink-0 mr-3 text-signal-green">
            <!-- Map Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
              <circle cx="12" cy="9" r="2.5" fill="currentColor" fill-opacity="0">
                <animate fill="freeze" attributeName="fill-opacity" begin="0.84s" dur="0.18s" values="0;1"/>
              </circle>
              <path fill="none" stroke="currentColor" stroke-dasharray="48" stroke-dashoffset="48" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 20.5c0 0 -6 -7 -6 -11.5c0 -3.31 2.69 -6 6 -6c3.31 0 6 2.69 6 6c0 4.5 -6 11.5 -6 11.5Z">
                <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.72s" values="48;0"/>
                <animateTransform attributeName="transform" dur="3.6s" keyTimes="0;0.3;0.4;0.54;0.6;0.68;0.7;1" repeatCount="indefinite" type="rotate" values="0 12 20.5;0 12 20.5;-8 12 20.5;0 12 20.5;5 12 20.5;-2 12 20.5;0 12 20.5;0 12 20.5"/>
              </path>
            </svg>
          </div>
          <div>
            <h5 class="font-medium mb-1">{common.M_ADDRESS}</h5>
            <address class="text-gray-300 not-italic">
              Elsav Veržej d.o.o.<br>
              Narcisna ulica 11<br>
              9241 Veržej, Slovenia
            </address>
          </div>
        </div>

        <div class="flex items-start">
          <div class="flex-shrink-0 mr-3 text-signal-green">
            <!-- Email Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
              <path stroke-dasharray="64" stroke-dashoffset="64" d="M4 5h16c0.55 0 1 0.45 1 1v12c0 0.55 -0.45 1 -1 1h-16c-0.55 0 -1 -0.45 -1 -1v-12c0 -0.55 0.45 -1 1 -1Z">
                <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.72s" values="64;0"/>
              </path>
              <path stroke-dasharray="24" stroke-dashoffset="24" d="M3 6.5l9 5.5l9 -5.5">
                <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.72s" dur="0.24s" values="24;0"/>
              </path>
            </svg>
          </div>
          <div>
            <h5 class="font-medium mb-1">{common.M_EMAIL}</h5>
            <p class="text-gray-300">
              <a href={`mailto:${common.PAGE_INFO_EMAIL}`} class="hover:text-signal-green transition-colors">
                {common.PAGE_INFO_EMAIL}
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- DMCA Badge -->
    <div class="flex justify-center mt-8 mb-4">
      <a href="//www.dmca.com/Protection/Status.aspx?id=d16a2101-9f06-4e74-8c8d-df2cc670a14d" title="DMCA.com Protection Status" class="dmca-badge">
        <img 
          src="//images.dmca.com/Badges/dmca-badge-w150-5x1-01.png?ID=ffc6513c-d641-46db-a978-452d6279c143" 
          alt="DMCA.com Protection Status"
          width="150"  
          height="30"
          loading="lazy" 
        />
      </a>
      <script is:inline src="//images.dmca.com/Badges/DMCABadgeHelper.min.js"></script>
    </div>

    <!-- Copyright -->
    <div class="border-t border-gray-800 mt-8 pt-6">
      <div class="flex flex-col items-center text-center">
        <p class="text-gray-400 text-sm">
          <span class="block md:inline">&copy; {currentYear} <span class="text-signal-green">{common.PAGE_ORGANISATION_FULL_NAME} BRAND</span></span>
          <span class="hidden md:inline mx-2">|</span>
          <span class="block md:inline mt-2 md:mt-0">{common.M_COPYRIGHT}</span>
        </p>
        
        <!-- New row for country flags with proper mobile breakpoint -->
        <div class="text-gray-400 text-sm mt-4">
          <p class="block md:inline">
            {common.M_PROUD_1}
            <span class="inline-block ml-2 w-6 h-4" set:html={flags.SI}></span>
          </p>
          <p class="block md:inline mt-2 md:mt-0">
            {common.M_PROUD_2}
            <span class="inline-block ml-2 w-6 h-4" set:html={currentCountryFlag}></span>
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>