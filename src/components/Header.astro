---
// Import JSON data
import headerFooterData from '../data/headerfooter.json';
import { 
  AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ, 
  CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG, 
  ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT, 
  HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV, 
  LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ, 
  OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL, 
  SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA 
} from 'country-flag-icons/string/3x2';
import commonData from '../data/common.json';
import localeData from '../data/locale.json';

export interface Props {
  alternativeLinks?: Array<{
    code: string;
    country: string;
    name: string;
    languageIso: string;
    hreflang: string;
    href: string;
  }>;
  languageLinksMap?: Record<string, string>;
}

const { alternativeLinks, languageLinksMap = {} } = Astro.props;

// Get the locale from the URL path (e.g., 'si' from /si/...)
const locale = Astro.url.pathname.split('/')[1];

// Find the matching headerFooter and common data objects based on M_SLUG
const headerFooter = headerFooterData.find(item => item.M_SLUG === locale) || headerFooterData[0];
const common = commonData.find(item => item.M_SLUG === locale) || commonData[0];

// Header component for the EU Signal website
const navigation = [
  { name: common.M_HOME_NAME, href: `/${locale}` },
  { name: headerFooter.HEADER_LINK_NAME_1, href: `/${locale}${headerFooter.HEADER_LINK_PATH_1}` },
  { name: headerFooter.HEADER_LINK_NAME_2, href: `/${locale}${headerFooter.HEADER_LINK_PATH_2}` },
  { name: headerFooter.HEADER_LINK_NAME_3, href: `/${locale}${headerFooter.HEADER_LINK_PATH_3}` },
];

// --- Language Switcher Logic ---
// If we have alternative links from the page, use those
// Otherwise, use the default language switcher logic
const supportedLocales = localeData.filter(l => l.M_LOCALE_PUBLISH_Y_N === "1");

// Map country codes to their corresponding flag components
const flagMap = {
  AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ, 
  CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG, 
  ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT, 
  HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV, 
  LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ, 
  OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL, 
  SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA
};

// Create the final supported languages array with flags
const languageLinks = supportedLocales.map(locale => ({
  code: locale.M_SLUG,
  name: locale.M_LANGUAGE_NATIVE,
  flag: flagMap[locale.M_COUNTRY_CODE],
  href: languageLinksMap[locale.M_SLUG] || `/${locale.M_SLUG}`,
  isActive: locale.M_SLUG === locale
}));

const currentLanguageObject = languageLinks.find(lang => lang.code === locale) ||
                            languageLinks[0]; // Fallback
// --- End Language Switcher Logic ---
---

<header class="header-transparent">
  <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
    {/* Logo */}
    <a
      href={`/${locale}`}
      class="flex items-center"
      id="header-logo-link"
    >
      <img
        src="/logos/EUSIGNAL-SVG-File_Horizontal-Light.svg"
        alt={headerFooter.HEADER_LOGO_ALT}
        class="h-6 w-auto"
        style="max-height: 25px; height: auto; width: auto;"
        fetchpriority="high"
        width="939"
        height="161"
      />
      <span class="sr-only">{common.M_HOME_NAME}</span>
    </a>

    {/* Desktop Navigation & Language Switcher */}
    <div class="hidden md:flex items-center space-x-8">
      {navigation.map(item => (
        <a
          href={item.href}
          class="text-gray-300 hover:text-white transition-colors"
        >
          {item.name}
        </a>
      ))}
      <a
        href={headerFooter.HEADER_NAME_CTA_PATH}
        class="bg-black text-signal-green border border-signal-green px-6 py-2 hover:bg-signal-green hover:text-black transition-all duration-200"
      >
        {headerFooter.HEADER_NAME_CTA}
      </a>

      {/* Desktop Language Dropdown Switcher */}
      <div class="relative ml-6 pl-6 border-l border-gray-600" id="desktop-lang-switcher-container">
        <button
          type="button"
          id="desktop-lang-button"
          class="flex items-center text-sm font-medium text-gray-300 hover:text-white focus:outline-none"
          aria-expanded="false"
          aria-haspopup="true"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 512 512">
            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="38" d="M48 112h288M192 64v48m80 336l96-224l96 224m-162.5-64h133M281.3 112S257 206 199 277S80 384 80 384"/>
            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="38" d="M256 336s-35-27-72-75s-56-85-56-85"/>
          </svg>
          <span class="flex items-center">
            {currentLanguageObject.flag && <span class="mr-1 w-6 h-4" set:html={currentLanguageObject.flag} />}
            <span>{currentLanguageObject.name}</span>
          </span>
          <svg class="ml-1 -mr-1 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </button>
        <div
          id="desktop-lang-dropdown"
          class="absolute right-0 mt-2 w-48 origin-top-right rounded-md shadow-lg bg-gray-800/80 backdrop-blur-md ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-20"
          role="menu"
          aria-orientation="vertical"
          aria-labelledby="desktop-lang-button"
        >
          <div class="py-1 max-h-60 overflow-y-auto" role="none">
            {languageLinks.map(lang => (
              <a
                href={lang.href}
                class:list={[
                  "block px-4 py-2 text-sm transition-colors",
                  lang.isActive
                    ? "bg-gray-700 text-white font-semibold cursor-default"
                    : "text-gray-300 hover:bg-gray-600 hover:text-white"
                ]}
                role="menuitem"
                title={lang.name}
              >
                <span class="flex items-center">
                  {lang.flag && <span class="mr-2 w-6 h-4" set:html={lang.flag} />} {lang.name}
                </span>
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>

    {/* Mobile Menu Button */}
    <button
      type="button"
      class="md:hidden text-gray-300 hover:text-white"
      aria-label="Toggle menu"
      id="mobile-menu-button"
    >
      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
  </nav>

  {/* Mobile Navigation */}
  <div class="md:hidden hidden" id="mobile-menu">
    <div class="px-2 pt-2 pb-3 space-y-1">
      {navigation.map(item => (
        <a
          href={item.href}
          class="block px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-colors"
        >
          {item.name}
        </a>
      ))}

      {/* Mobile Language Dropdown Switcher */}
      <div class="pt-4 pb-2 border-t border-gray-700 mt-2">
        <button
          type="button"
          id="mobile-lang-button"
          class="flex justify-between items-center w-full px-3 py-2 text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors"
          aria-expanded="false"
          aria-controls="mobile-lang-dropdown-list"
        >
          <span class="flex items-center">
            {currentLanguageObject.flag && <span class="mr-1 w-6 h-4" set:html={currentLanguageObject.flag} />}
            {currentLanguageObject.name}
          </span>
          <svg class="ml-1 h-5 w-5 transform transition-transform duration-150" id="mobile-lang-chevron" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
        </button>
        <div id="mobile-lang-dropdown-list" class="mt-1 space-y-1 pl-3 hidden max-h-52 overflow-y-auto">
          {languageLinks.map(lang => (
            <a
              href={lang.href}
              class:list={[
                "block pl-3 pr-4 py-2 border-l-4 text-base font-medium transition-colors rounded-r-md",
                lang.isActive
                  ? "bg-gray-600 border-signal-green text-white cursor-default"
                  : "border-transparent text-gray-400 hover:bg-gray-700 hover:border-gray-500 hover:text-white"
              ]}
              title={lang.name}
            >
              <span class="flex items-center">
                {lang.flag && <span class="mr-2 w-6 h-4" set:html={lang.flag} />} {lang.name}
              </span>
            </a>
          ))}
        </div>
      </div>

      <a
        href={headerFooter.HEADER_NAME_CTA_PATH}
        class="block mt-4 mx-1 px-3 py-2 bg-black text-signal-green border border-signal-green hover:bg-signal-green hover:text-black transition-all duration-200 text-center rounded-md"
      >
        {headerFooter.HEADER_NAME_CTA}
      </a>
    </div>
  </div>
</header>

<script is:inline>
  // --- Mobile Menu Toggle ---
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  if (mobileMenuButton && mobileMenu) {
    mobileMenuButton.addEventListener('click', () => {
      const isExpanded = mobileMenu.classList.toggle('hidden');
      mobileMenuButton.setAttribute('aria-expanded', !isExpanded);
    });
  }

  // --- Desktop Language Dropdown ---
  const desktopLangButton = document.getElementById('desktop-lang-button');
  const desktopLangDropdown = document.getElementById('desktop-lang-dropdown');
  const desktopLangSwitcherContainer = document.getElementById('desktop-lang-switcher-container');

  if (desktopLangButton && desktopLangDropdown && desktopLangSwitcherContainer) {
    desktopLangButton.addEventListener('click', (event) => {
      event.stopPropagation();
      const isExpanded = desktopLangButton.getAttribute('aria-expanded') === 'true';
      desktopLangButton.setAttribute('aria-expanded', String(!isExpanded));
      desktopLangDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', (event) => {
      if (!desktopLangSwitcherContainer.contains(event.target) && desktopLangButton.getAttribute('aria-expanded') === 'true') {
        desktopLangButton.setAttribute('aria-expanded', 'false');
        desktopLangDropdown.classList.add('hidden');
      }
    });
  }

  // --- Mobile Language Dropdown ---
  const mobileLangButton = document.getElementById('mobile-lang-button');
  const mobileLangDropdownList = document.getElementById('mobile-lang-dropdown-list');
  const mobileLangChevron = document.getElementById('mobile-lang-chevron');

  if (mobileLangButton && mobileLangDropdownList && mobileLangChevron) {
    mobileLangButton.addEventListener('click', () => {
      const isExpanded = mobileLangButton.getAttribute('aria-expanded') === 'true';
      mobileLangButton.setAttribute('aria-expanded', String(!isExpanded));
      mobileLangDropdownList.classList.toggle('hidden');
      mobileLangChevron.classList.toggle('rotate-180');
    });
  }

  // --- Scroll Handler for Header Background ---
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('.header-transparent');

    const updateHeaderBackground = () => {
      if (window.scrollY > 0) {
        header.classList.add('header-scrolled');
      } else {
        header.classList.remove('header-scrolled');
      }
    };

    window.addEventListener('scroll', updateHeaderBackground);
    updateHeaderBackground(); // Initial check
  });
</script>

<style>
  .header-transparent {
    position: sticky;
    top: 0;
    z-index: 50;
    background: rgb(0, 0, 0);
    transition: background-color 0.3s ease;
  }

  .header-scrolled {
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .rotate-180 {
    transform: rotate(180deg);
  }

  /* Styling for scrollbars in dropdowns if content overflows */
  .max-h-60::-webkit-scrollbar,
  .max-h-52::-webkit-scrollbar {
    width: 8px;
  }

  .max-h-60::-webkit-scrollbar-track,
  .max-h-52::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
  }

  .max-h-60::-webkit-scrollbar-thumb,
  .max-h-52::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }

  .max-h-60::-webkit-scrollbar-thumb:hover,
  .max-h-52::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }
</style>