---
// src/components/Header.astro
import path from 'path';
import Database from 'better-sqlite3';
import {
  AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ,
  CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG,
  ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT,
  HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV,
  LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ,
  OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL,
  SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA
} from 'country-flag-icons/string/3x2';

const { alternativeLinks, languageLinksMap = {}, locale: propLocale } = Astro.props;
const locale = propLocale || Astro.url.pathname.split('/')[1] || 'si';

const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true });

const { www, headerFooter, allLocaleData } = db.transaction(() => {
    const wwwData = db.prepare('SELECT * FROM www LIMIT 1').get() as any;
    const headerFooterData = db.prepare('SELECT * FROM headerfooter WHERE M_SLUG = ?').get(locale) as any;
    const locales = db.prepare('SELECT * FROM locale').all() as any[];
    return { www: wwwData || {}, headerFooter: headerFooterData || {}, allLocaleData: locales };
})();

const flagMap = {
  AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ,
  CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG,
  ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT,
  HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV,
  LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ,
  OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL,
  SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA
};

const supportedLocales = allLocaleData.filter(l => l.M_LOCALE_PUBLISH_Y_N === "1");

const languageLinks = supportedLocales.map(langLocale => ({
  code: langLocale.M_SLUG,
  name: langLocale.M_LANGUAGE_NATIVE,
  flag: flagMap[langLocale.M_COUNTRY_CODE],
  href: languageLinksMap[langLocale.M_SLUG] || `/${langLocale.M_SLUG}`,
  isActive: langLocale.M_SLUG === locale
}));

const currentLanguageObject = languageLinks.find(l => l.code === locale) || languageLinks.find(l => l.code === 'si') || languageLinks[0];
const isLoggedIn = Astro.cookies.has('session_id'); 
---

<header class="header-transparent border-b border-border backdrop-blur supports-[backdrop-filter]:bg-background/95 py-4 px-4 md:px-6 lg:px-8 z-50">
  <div class="max-w-screen-xl mx-auto flex flex-col">
    
    <!-- TOP ROW: Contains logo and main controls -->
    <nav class="flex items-center justify-between">
      <a href={`/${locale}`} class="flex items-center gap-2 text-foreground hover:opacity-80 transition-opacity">
        <img
            src={www.PAGE_LOGO_IMAGE_PATH_1?.replace('public', '')}
            alt={headerFooter.HEADER_LOGO_ALT}
            class="h-8 w-auto"
            fetchpriority="high"
            width="939"
            height="161"
        />
      </a>

      <!-- Main Navigation Links - Appear on Large Screens -->
      <!-- FINAL CHANGE: Breakpoint changed from xl to lg -->
      <div class="hidden lg:flex items-center gap-8">
        <ul class="flex items-center gap-8 rtl:gap-reverse">
          <li><a href={`/${locale}/#how-it-works`} class="text-muted-foreground font-medium hover:text-primary transition-colors">How It Works</a></li>
          <li><a href={`/${locale}/setup-alerts`} class="text-muted-foreground font-medium hover:text-primary transition-colors">Setup Alerts</a></li>
          <li><a href={`/${locale}/#pricing`} class="text-muted-foreground font-medium hover:text-primary transition-colors">Pricing</a></li>
          <li><a href={`/${locale}/waitlist`} class="text-muted-foreground font-medium hover:text-primary transition-colors">Waiting List</a></li>
          <li><a href={`/${locale}/#contact`} class="text-muted-foreground font-medium hover:text-primary transition-colors">Contact</a></li>
        </ul>
      </div>

      <!-- Right Side Controls -->
      <div class="flex items-center gap-3">
        <!-- Desktop Language Switcher -->
        <!-- FINAL CHANGE: Breakpoint changed from xl to lg -->
        <div class="hidden lg:block">
          <div class="relative" id="desktop-lang-switcher-container">
            <button type="button" id="desktop-lang-button" class="flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground" aria-expanded="false" aria-haspopup="true">
              {currentLanguageObject.flag && <span class="w-6 h-4" set:html={currentLanguageObject.flag} />}
              <span>{currentLanguageObject.name}</span>
              <svg class="h-4 w-4 text-gray-400 rtl:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
            </button>
            <div id="desktop-lang-dropdown" class="absolute end-0 mt-2 w-48 rounded-md shadow-lg bg-popover ring-1 ring-border hidden z-50">
              <div class="py-1 max-h-60 overflow-y-auto text-sm">
                {languageLinks.map(lang => ( <a href={lang.href} class:list={['flex items-center px-4 py-2 gap-2 transition-colors text-start', lang.isActive ? 'bg-primary/20 text-primary font-semibold' : 'text-muted-foreground hover:bg-primary/10 hover:text-primary']}>{lang.flag && <span class="w-6 h-4" set:html={lang.flag} />} {lang.name}</a> ))}
              </div>
            </div>
          </div>
        </div>

        <button id="theme-toggle" aria-label="Toggle theme" class="p-2 rounded-md border border-border text-foreground hover:text-primary transition-colors">
          <svg id="theme-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"></svg>
        </button>

        <div class="relative">
          <button id="user-btn" class="p-2 rounded-md border border-border text-foreground hover:text-primary transition-colors" aria-haspopup="true" aria-expanded="false">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/></svg>
          </button>
          <div id="user-dropdown" class="absolute end-0 mt-2 w-48 bg-popover border border-border rounded-md shadow-lg hidden z-50 py-1">
            {isLoggedIn ? ( <> <a href="/user-profile" class="block text-start px-4 py-2 text-sm text-muted-foreground hover:bg-primary/10 hover:text-primary transition-colors">Profile</a> <a href="/logout" class="block text-start px-4 py-2 text-sm text-muted-foreground hover:bg-primary/10 hover:text-primary transition-colors">Log Out</a> </> ) : ( <> <a href={`/${locale}/login`} class="block text-start px-4 py-2 text-sm text-muted-foreground hover:bg-primary/10 hover:text-primary transition-colors">Login</a> <a href={`/${locale}/registration`}" class="block text-start px-4 py-2 text-sm text-muted-foreground hover:bg-primary/10 hover:text-primary transition-colors">Register</a> </> )}
          </div>
        </div>

        <!-- Mobile Menu (Hamburger) Button -->
        <!-- FINAL CHANGE: Breakpoint changed from xl to lg -->
        <button class="lg:hidden p-2 text-foreground hover:text-primary" id="mobile-menu-btn" aria-label="Toggle menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
      </div>
    </nav>

    <!-- MOBILE-ONLY SECOND ROW: For Language Switcher -->
    <!-- FINAL CHANGE: Breakpoint changed from xl to lg -->
    <div class="lg:hidden flex justify-end w-full pt-2">
       <div class="relative" id="mobile-lang-switcher-container">
        <button type="button" id="mobile-lang-button" class="flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground" aria-expanded="false" aria-haspopup="true">
          {currentLanguageObject.flag && <span class="w-6 h-4" set:html={currentLanguageObject.flag} />}
          <span>{currentLanguageObject.name}</span>
          <svg class="h-4 w-4 text-gray-400 rtl:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
        </button>
        <div id="mobile-lang-dropdown" class="absolute end-0 mt-2 w-48 rounded-md shadow-lg bg-popover ring-1 ring-border hidden z-50">
          <div class="py-1 max-h-60 overflow-y-auto text-sm">
            {languageLinks.map(lang => ( <a href={lang.href} class:list={['flex items-center px-4 py-2 gap-2 transition-colors text-start', lang.isActive ? 'bg-primary/20 text-primary font-semibold' : 'text-muted-foreground hover:bg-primary/10 hover:text-primary']}>{lang.flag && <span class="w-6 h-4" set:html={lang.flag} />} {lang.name}</a> ))}
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Navigation Panel -->
    <!-- FINAL CHANGE: Breakpoint changed from xl to lg -->
    <div id="mobile-nav" class="lg:hidden hidden mt-4">
      <ul class="flex flex-col gap-3 text-sm">
        <li><a href={`/${locale}/#how-it-works`} class="block text-start py-2 text-muted-foreground hover:text-primary">How It Works</a></li>
        <li><a href={`/${locale}/setup-alerts`} class="block text-start py-2 text-muted-foreground hover:text-primary">Setup Alerts</a></li>
        <li><a href={`/${locale}/#pricing`} class="block text-start py-2 text-muted-foreground hover:text-primary">Pricing</a></li>
        <li><a href={`/${locale}/waitlist`} class="block text-start py-2 text-muted-foreground hover:text-primary">Waiting List</a></li>
        <li><a href={`/${locale}/#contact`} class="block text-start py-2 text-muted-foreground hover:text-primary">Contact</a></li>
      </ul>
    </div>
  </div>
</header>