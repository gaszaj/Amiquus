---
// Import JSON data
import headerFooterData from '../data/headerfooter.json';
import { SI, DE, PT, BA, LT, HR, ES, FR, IT, NL, SE, DK, CH, AT, LU, BY, GR, LI, MC, SM, NO, RU, TR, CZ, PL, SK, AL, AZ, BE, BG, CY, EE, GE, HU, LV, MD, ME, MK, RO, RS, UA, FI } from 'country-flag-icons/string/3x2';
import commonData from '../data/common.json';

// Get the locale from the URL path (e.g., 'si' from /si/...)
const locale = Astro.url.pathname.split('/')[1];

// Find the matching headerFooter and common data objects based on M_SLUG
const headerFooter = headerFooterData.find(item => item.M_SLUG === locale) || headerFooterData[0];
const common = commonData.find(item => item.M_SLUG === locale) || commonData[0];

// Header component for the EU Signal website
const navigation = [
  { name: common.M_HOME_NAME, href: `/${locale}` },
  { name: headerFooter.HEADER_LINK_NAME_1, href: `/${locale}${headerFooter.HEADER_LINK_PATH_1}` },
  { name: headerFooter.HEADER_LINK_NAME_2, href: `/${locale}${headerFooter.HEADER_LINK_PATH_2}` },
  { name: headerFooter.HEADER_LINK_NAME_3, href: `/${locale}${headerFooter.HEADER_LINK_PATH_3}` },
];

// --- Language Switcher Logic ---
// Define supported locales with their corresponding data
const supportedLocales = [
  { code: 'si', country: 'SI', name: headerFooter.HEADER_LANGUAGE_SLOVENIA_SLOVENIAN },
  { code: 'hr', country: 'HR', name: headerFooter.HEADER_LANGUAGE_CROATIA_CROATIAN },
  { code: 'es', country: 'ES', name: headerFooter.HEADER_LANGUAGE_SPAIN_SPANISH },
  { code: 'fr', country: 'FR', name: headerFooter.HEADER_LANGUAGE_FRANCE_FRENCH },
  { code: 'de', country: 'DE', name: headerFooter.HEADER_LANGUAGE_GERMANY_GERMAN },
  { code: 'pt', country: 'PT', name: headerFooter.HEADER_LANGUAGE_PORTUGAL_PORTUGUESE },
  { code: 'it', country: 'IT', name: headerFooter.HEADER_LANGUAGE_ITALY_ITALIAN },
  { code: 'nl', country: 'NL', name: headerFooter.HEADER_LANGUAGE_NETHERLANDS_DUTCH },
  { code: 'se', country: 'SE', name: headerFooter.HEADER_LANGUAGE_SWEDEN_SWEDISH },
  { code: 'ch', country: 'CH', name: headerFooter.HEADER_LANGUAGE_SWITZERLAND_GERMAN },
  { code: 'ch', country: 'CH', name: headerFooter.HEADER_LANGUAGE_SWITZERLAND_FRENCH },
  { code: 'ch', country: 'CH', name: headerFooter.HEADER_LANGUAGE_SWITZERLAND_ITALIAN },
  { code: 'dk', country: 'DK', name: headerFooter.HEADER_LANGUAGE_DENMARK_DANISH },
  { code: 'no', country: 'NO', name: headerFooter.HEADER_LANGUAGE_NORWAY_NORWEGIAN },
  { code: 'be', country: 'BE', name: headerFooter.HEADER_LANGUAGE_BELGIUM_DUTCH },
  { code: 'be', country: 'BE', name: headerFooter.HEADER_LANGUAGE_BELGIUM_FRENCH },
  { code: 'be', country: 'BE', name: headerFooter.HEADER_LANGUAGE_BELGIUM_GERMAN },
  { code: 'at', country: 'AT', name: headerFooter.HEADER_LANGUAGE_AUSTRIA_GERMAN },
  { code: 'fi', country: 'FI', name: headerFooter.HEADER_LANGUAGE_FINLAND_FINNISH },
  { code: 'lu', country: 'LU', name: headerFooter.HEADER_LANGUAGE_LUXEMBOURG_FRENCH },
  { code: 'lu', country: 'LU', name: headerFooter.HEADER_LANGUAGE_LUXEMBOURG_GERMAN },
  { code: 'ru', country: 'RU', name: headerFooter.HEADER_LANGUAGE_RUSSIA_RUSSIAN },
  { code: 'tr', country: 'TR', name: headerFooter.HEADER_LANGUAGE_TURKEY_TURKISH },
  { code: 'cz', country: 'CZ', name: headerFooter.HEADER_LANGUAGE_CZECHIA_CZECH },
  { code: 'pl', country: 'PL', name: headerFooter.HEADER_LANGUAGE_POLAND_POLISH },
  { code: 'sk', country: 'SK', name: headerFooter.HEADER_LANGUAGE_SLOVAKIA_SLOVAK },
  { code: 'al', country: 'AL', name: headerFooter.HEADER_LANGUAGE_ALBANIA_ALBANIAN },
  { code: 'az', country: 'AZ', name: headerFooter.HEADER_LANGUAGE_AZERBAIJAN_AZERBAIJANI },
  { code: 'by', country: 'BY', name: headerFooter.HEADER_LANGUAGE_BELARUS_BELARUSIAN },
  { code: 'ba', country: 'BA', name: headerFooter.HEADER_LANGUAGE_BOSNIA_AND_HERZEGOVINA_BOSNIAN },
  { code: 'bg', country: 'BG', name: headerFooter.HEADER_LANGUAGE_BULGARIA_BULGARIAN },
  { code: 'cy', country: 'CY', name: headerFooter.HEADER_LANGUAGE_CYPRUS_GREEK },
  { code: 'ee', country: 'EE', name: headerFooter.HEADER_LANGUAGE_ESTONIA_ESTONIAN },
  { code: 'ge', country: 'GE', name: headerFooter.HEADER_LANGUAGE_GEORGIA_GEORGIAN },
  { code: 'gr', country: 'GR', name: headerFooter.HEADER_LANGUAGE_GREECE_GREEK },
  { code: 'hu', country: 'HU', name: headerFooter.HEADER_LANGUAGE_HUNGARY_HUNGARIAN },
  { code: 'lv', country: 'LV', name: headerFooter.HEADER_LANGUAGE_LATVIA_LATVIAN },
  { code: 'li', country: 'LI', name: headerFooter.HEADER_LANGUAGE_LIECHTENSTEIN_GERMAN },
  { code: 'lt', country: 'LT', name: headerFooter.HEADER_LANGUAGE_LITHUANIA_LITHUANIAN },
  { code: 'md', country: 'MD', name: headerFooter.HEADER_LANGUAGE_MOLDOVA_ROMANIAN },
  { code: 'mc', country: 'MC', name: headerFooter.HEADER_LANGUAGE_MONACO_FRENCH },
  { code: 'me', country: 'ME', name: headerFooter.HEADER_LANGUAGE_MONTENEGRO_SERBIAN },
  { code: 'mk', country: 'MK', name: headerFooter.HEADER_LANGUAGE_NORTH_MACEDONIA_MACEDONIAN },
  { code: 'ro', country: 'RO', name: headerFooter.HEADER_LANGUAGE_ROMANIA_ROMANIAN },
  { code: 'sm', country: 'SM', name: headerFooter.HEADER_LANGUAGE_SAN_MARINO_ITALIAN },
  { code: 'rs', country: 'RS', name: headerFooter.HEADER_LANGUAGE_SERBIA_SERBIAN },
  { code: 'ua', country: 'UA', name: headerFooter.HEADER_LANGUAGE_UKRAINE_UKRAINIAN }
];

// Map country codes to their corresponding flag components
const flagMap = {
  SI, HR, ES, FR, DE, PT, IT, NL, SE, CH, DK, NO, BE, AT, FI, LU, RU, TR, CZ, PL, SK,
  AL, AZ, BY, BA, BG, CY, EE, GE, GR, HU, LV, LI, LT, MD, MC, ME, MK, RO, SM, RS, UA
};

// Create the final supported languages array with flags
const supportedLanguages = supportedLocales.map(locale => ({
  code: locale.code,
  name: locale.name,
  flag: flagMap[locale.country]
}));

const defaultLangCode = 'si'; // Your site's default language code

const currentPathname = Astro.url.pathname;
const pathParts = currentPathname.split('/').filter(p => p !== '');

let currentDetectedLang = defaultLangCode;
let slugParts = [...pathParts];

if (pathParts.length > 0 && supportedLanguages.some(lang => lang.code === pathParts[0])) {
  currentDetectedLang = pathParts[0];
  slugParts.shift();
} else {
  currentDetectedLang = defaultLangCode;
}

const baseSlug = slugParts.join('/') || '';

const languageLinks = supportedLanguages.map(lang => {
  let newPath;
  if (lang.code === defaultLangCode) {
    newPath = baseSlug ? `/${baseSlug}` : '/';
  } else {
    newPath = `/${lang.code}${baseSlug ? `/${baseSlug}` : ''}`;
  }
  if (!baseSlug && lang.code !== defaultLangCode && !newPath.endsWith('/')) {
    newPath += '/';
  }
  if (newPath === `/${defaultLangCode}/` && defaultLangCode) {
    newPath = '/';
  }

  return { ...lang, href: newPath, isActive: lang.code === currentDetectedLang };
});

const currentLanguageObject = supportedLanguages.find(lang => lang.code === currentDetectedLang) ||
                            supportedLanguages.find(lang => lang.code === defaultLangCode) ||
                            supportedLanguages[0]; // Fallback
// --- End Language Switcher Logic ---
---

<header class="header-transparent">
  <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
    {/* Logo */}
    <a
      href={`/${locale}`}
      class="flex items-center"
      id="header-logo-link"
    >
      <img
        src="/logos/EUSIGNAL-SVG-File_Horizontal-Light.svg"
        alt={headerFooter.HEADER_LOGO_ALT}
        class="h-6 w-auto"
        style="max-height: 25px; height: auto; width: auto;"
        fetchpriority="high"
        width="939"
        height="161"
      />
      <span class="sr-only">{common.M_HOME_NAME}</span>
    </a>

    {/* Desktop Navigation & Language Switcher */}
    <div class="hidden md:flex items-center space-x-8">
      {navigation.map(item => (
        <a
          href={item.href}
          class="text-gray-300 hover:text-white transition-colors"
        >
          {item.name}
        </a>
      ))}
      <a
        href={headerFooter.HEADER_NAME_CTA_PATH}
        class="bg-black text-signal-green border border-signal-green px-6 py-2 hover:bg-signal-green hover:text-black transition-all duration-200"
      >
        {headerFooter.HEADER_NAME_CTA}
      </a>

      {/* Desktop Language Dropdown Switcher */}
      <div class="relative ml-6 pl-6 border-l border-gray-600" id="desktop-lang-switcher-container">
        <button
          type="button"
          id="desktop-lang-button"
          class="flex items-center text-sm font-medium text-gray-300 hover:text-white focus:outline-none"
          aria-expanded="false"
          aria-haspopup="true"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 512 512">
            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="38" d="M48 112h288M192 64v48m80 336l96-224l96 224m-162.5-64h133M281.3 112S257 206 199 277S80 384 80 384"/>
            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="38" d="M256 336s-35-27-72-75s-56-85-56-85"/>
          </svg>
          <span class="flex items-center">
            {currentLanguageObject.flag && <span class="mr-1 w-6 h-4" set:html={currentLanguageObject.flag} />}
            <span>{currentLanguageObject.name}</span>
          </span>
          <svg class="ml-1 -mr-1 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </button>
        <div
          id="desktop-lang-dropdown"
          class="absolute right-0 mt-2 w-48 origin-top-right rounded-md shadow-lg bg-gray-800/80 backdrop-blur-md ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-20"
          role="menu"
          aria-orientation="vertical"
          aria-labelledby="desktop-lang-button"
        >
          <div class="py-1 max-h-60 overflow-y-auto" role="none">
            {languageLinks.map(lang => (
              <a
                href={lang.href}
                class:list={[
                  "block px-4 py-2 text-sm transition-colors",
                  lang.isActive
                    ? "bg-gray-700 text-white font-semibold cursor-default"
                    : "text-gray-300 hover:bg-gray-600 hover:text-white"
                ]}
                role="menuitem"
                title={lang.name}
              >
                <span class="flex items-center">
                  {lang.flag && <span class="mr-2 w-6 h-4" set:html={lang.flag} />} {lang.name}
                </span>
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>

    {/* Mobile Menu Button */}
    <button
      type="button"
      class="md:hidden text-gray-300 hover:text-white"
      aria-label="Toggle menu"
      id="mobile-menu-button"
    >
      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
  </nav>

  {/* Mobile Navigation */}
  <div class="md:hidden hidden" id="mobile-menu">
    <div class="px-2 pt-2 pb-3 space-y-1">
      {navigation.map(item => (
        <a
          href={item.href}
          class="block px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-colors"
        >
          {item.name}
        </a>
      ))}

      {/* Mobile Language Dropdown Switcher */}
      <div class="pt-4 pb-2 border-t border-gray-700 mt-2">
        <button
          type="button"
          id="mobile-lang-button"
          class="flex justify-between items-center w-full px-3 py-2 text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors"
          aria-expanded="false"
          aria-controls="mobile-lang-dropdown-list"
        >
          <span class="flex items-center">
            {currentLanguageObject.flag && <span class="mr-1 w-6 h-4" set:html={currentLanguageObject.flag} />}
            {currentLanguageObject.name}
          </span>
          <svg class="ml-1 h-5 w-5 transform transition-transform duration-150" id="mobile-lang-chevron" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
        </button>
        <div id="mobile-lang-dropdown-list" class="mt-1 space-y-1 pl-3 hidden max-h-52 overflow-y-auto">
          {languageLinks.map(lang => (
            <a
              href={lang.href}
              class:list={[
                "block pl-3 pr-4 py-2 border-l-4 text-base font-medium transition-colors rounded-r-md",
                lang.isActive
                  ? "bg-gray-600 border-signal-green text-white cursor-default"
                  : "border-transparent text-gray-400 hover:bg-gray-700 hover:border-gray-500 hover:text-white"
              ]}
              title={lang.name}
            >
              <span class="flex items-center">
                {lang.flag && <span class="mr-2 w-6 h-4" set:html={lang.flag} />} {lang.name}
              </span>
            </a>
          ))}
        </div>
      </div>

      <a
        href={headerFooter.HEADER_NAME_CTA_PATH}
        class="block mt-4 mx-1 px-3 py-2 bg-black text-signal-green border border-signal-green hover:bg-signal-green hover:text-black transition-all duration-200 text-center rounded-md"
      >
        {headerFooter.HEADER_NAME_CTA}
      </a>
    </div>
  </div>
</header>

<script is:inline>
  // --- Mobile Menu Toggle ---
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  if (mobileMenuButton && mobileMenu) {
    mobileMenuButton.addEventListener('click', () => {
      const isExpanded = mobileMenu.classList.toggle('hidden');
      mobileMenuButton.setAttribute('aria-expanded', !isExpanded);
    });
  }

  // --- Desktop Language Dropdown ---
  const desktopLangButton = document.getElementById('desktop-lang-button');
  const desktopLangDropdown = document.getElementById('desktop-lang-dropdown');
  const desktopLangSwitcherContainer = document.getElementById('desktop-lang-switcher-container');

  if (desktopLangButton && desktopLangDropdown && desktopLangSwitcherContainer) {
    desktopLangButton.addEventListener('click', (event) => {
      event.stopPropagation();
      const isExpanded = desktopLangButton.getAttribute('aria-expanded') === 'true';
      desktopLangButton.setAttribute('aria-expanded', String(!isExpanded));
      desktopLangDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', (event) => {
      if (!desktopLangSwitcherContainer.contains(event.target) && desktopLangButton.getAttribute('aria-expanded') === 'true') {
        desktopLangButton.setAttribute('aria-expanded', 'false');
        desktopLangDropdown.classList.add('hidden');
      }
    });
  }

  // --- Mobile Language Dropdown ---
  const mobileLangButton = document.getElementById('mobile-lang-button');
  const mobileLangDropdownList = document.getElementById('mobile-lang-dropdown-list');
  const mobileLangChevron = document.getElementById('mobile-lang-chevron');

  if (mobileLangButton && mobileLangDropdownList && mobileLangChevron) {
    mobileLangButton.addEventListener('click', () => {
      const isExpanded = mobileLangButton.getAttribute('aria-expanded') === 'true';
      mobileLangButton.setAttribute('aria-expanded', String(!isExpanded));
      mobileLangDropdownList.classList.toggle('hidden');
      mobileLangChevron.classList.toggle('rotate-180');
    });
  }

  // --- Scroll Handler for Header Background ---
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('.header-transparent');

    const updateHeaderBackground = () => {
      if (window.scrollY > 0) {
        header.classList.add('header-scrolled');
      } else {
        header.classList.remove('header-scrolled');
      }
    };

    window.addEventListener('scroll', updateHeaderBackground);
    updateHeaderBackground(); // Initial check
  });
</script>

<style>
  .header-transparent {
    position: sticky;
    top: 0;
    z-index: 50;
    background: rgb(0, 0, 0);
    transition: background-color 0.3s ease;
  }

  .header-scrolled {
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .rotate-180 {
    transform: rotate(180deg);
  }

  /* Styling for scrollbars in dropdowns if content overflows */
  .max-h-60::-webkit-scrollbar,
  .max-h-52::-webkit-scrollbar {
    width: 8px;
  }

  .max-h-60::-webkit-scrollbar-track,
  .max-h-52::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
  }

  .max-h-60::-webkit-scrollbar-thumb,
  .max-h-52::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }

  .max-h-60::-webkit-scrollbar-thumb:hover,
  .max-h-52::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }
</style>