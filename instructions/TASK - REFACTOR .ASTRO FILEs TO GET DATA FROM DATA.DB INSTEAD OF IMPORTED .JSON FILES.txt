TASK: REFACTOR .ASTRO FILES TO GET DATA FROM DATA.DB INSTEAD OF IMPORTED .JSON FILES
So as you will see, my site is very programmatic. In my .astro file almost everything is dynamic and nothing is hardcoded. Even aria labels come from .json files. So here's my OLD [EEATSlug].astro file setup (I am pasting you the entire file, which is located here: src\pages\si\[EEATslug].astro) - note that this code is my "OLD" way of doing data imports:
###
---
// import { getEntry } from 'astro:content'; // Removed as it's not used; data comes from JSON
import { actions, isInputError } from 'astro:actions';
import BaseLayout from '../../layouts/BaseLayout.astro';
import wwwData from '../../data/www.json';
import commonData from '../../data/common.json';
import eeatData from '../../data/eeat.json';
import authorData from '../../data/author.json';
import localeData from '../../data/locale.json';

export const prerender = false;

// Get the locale from the URL path (e.g., 'si' from /si/)
const locale = Astro.url.pathname.split('/')[1];

// Get the slug from the URL
const { EEATslug } = Astro.params;  

// Filter eeatData to only include entries matching the current locale
const localeEeatData = eeatData.filter(entry => entry.M_SLUG === locale);

// Find the matching EEAT entry from the filtered data
const eeatEntry = localeEeatData.find(entry => entry.EEAT_SLUG === EEATslug);

// Check if entry exists
if (!eeatEntry) {
  return Astro.redirect('/404');
}

const filteringNumber = parseInt(eeatEntry.EEAT_FILTERING);

// Get authors for the current locale when EEAT_FILTERING is 20 or 13
const authors = (filteringNumber === 20 || filteringNumber === 13)
  ? authorData.filter(author => author.M_SLUG === locale && author.PUBLISH_Y_N === "1")
  : [];

// Check if entry is published and has a valid filtering number (1-28)
const isValidPage = eeatEntry.PUBLISH_Y_N === "1" &&
  filteringNumber >= 1 && filteringNumber <= 28;

if (!isValidPage) {
  return Astro.redirect('/404');
}

// Determine if the page should display a contact form
const isContactPage = filteringNumber === 24 || filteringNumber === 25;

const eeat = eeatEntry;

// Get the first object from www data (keeping as is)
const www = wwwData[0];

// Find the matching common data object based on M_SLUG
const common = commonData.find(item => item.M_SLUG === locale) || commonData[0];

// Helper function for absolute URLs with locale
const getAbsoluteUrl = (path: string) => {
    // Get the locale from the URL path (e.g., 'si' from '/si/')
    const locale = Astro.url.pathname.split('/')[1];
    return new URL(`/${locale}${path}`, Astro.url.origin).toString();
};

// Helper function for base-level URLs (without locale)
const getBaseUrl = (path: string) => {
    return new URL(path, Astro.url.origin).toString();
};

// Get language data
const languageIso = eeat.M_LANGUAGE_ISO;
const countryCode = eeat.M_COUNTRY_CODE;

// Find matching content orientation from commonData (already refined above)
const contentOrientation = common.M_CONTENT_ORIENTATION || 'ltr';

// Define content for the page
const seoTitle = eeat.EEAT_NAME;
const headline = eeat.EEAT_H1;
const pageDescription = eeat.EEAT_META_SEO;
const pageContent = eeat.EEAT_CONTENT;
const pageContent2 = eeat.EEAT_CONTENT_2;
const pageogImage = eeat.EEAT_OG_IMAGE_PATH;
const articlePublishDate = eeat.EEAT_DATE_PUBLISHED;
const articleUpdateDate = eeat.EEAT_DATE_UPDATED;
const publishedTextLabel = common.M_PUBLISHED;
const updatedTextLabel = common.M_UPDATED;
const articleDateLocale = `${eeat.M_LANGUAGE_ISO}-${eeat.M_COUNTRY_CODE}`;

// Define keywords for the page
const pageKeywords = [
  eeat.EEAT_NAME,
  eeat.M_COUNTRY_NATIVE,
  www.PAGE_ORGANISATION_FULL_NAME
].join(', ');

// --- FORM HANDLING ---
const submissionResult = await Astro.getActionResult(actions.submitContactForm);
const formErrors: Record<string, string[] | undefined> = {};
let genericError: string | undefined = undefined;
let successMessage: string | undefined = undefined;

if (submissionResult) {
  if (submissionResult.error) {
    if (isInputError(submissionResult.error)) {
      Object.assign(formErrors, submissionResult.error.fields);
  } else {
      genericError = submissionResult.error.message;
    }
  } else if (submissionResult.data?.success) {
    // The success message now comes directly from the server action, already translated.
    successMessage = submissionResult.data.message;
  }
}

const getFieldError = (fieldName: string): string | undefined => formErrors[fieldName]?.[0];

// Build the language link map for the language picker
const languageLinksMap: Record<string, string> = {};
for (const locale of localeData.filter(l => l.M_LOCALE_PUBLISH_Y_N === "1")) {
  // Find alternate EEAT entry for this locale by EEAT_FILTERING
  const altEeat = eeatData.find(e =>
    e.EEAT_FILTERING === eeatEntry.EEAT_FILTERING &&
    e.M_SLUG === locale.M_SLUG &&
    e.PUBLISH_Y_N === "1"
  );
  if (altEeat) {
    languageLinksMap[locale.M_SLUG] = `/${altEeat.M_SLUG}/${altEeat.EEAT_SLUG}`;
  } else {
    languageLinksMap[locale.M_SLUG] = `/${locale.M_SLUG}`;
  }
}

// WebPage and Article Schema
const webpageSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": eeat.EEAT_H1,
  "url": Astro.url.href,
  "description": pageDescription,
  "inLanguage": articleDateLocale,
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": common.M_HOME_NAME,
        "item": getAbsoluteUrl("/")
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": seoTitle,
        "item": Astro.url.href
      }
    ]
  },
  "mainEntity": {
    "@type": "Article",
    "headline": headline,
    "description": pageDescription,
    "image": getBaseUrl(pageogImage),
    "author": {
      "@type": "Organization",
      "name": www.PAGE_ORGANISATION_FULL_NAME
    },
    // Assuming EEAT_HOUR_PUBLISHED and _UPDATED are in HH:MM format
    "datePublished": `${articlePublishDate}T${eeat.EEAT_HOUR_PUBLISHED || '00:00'}:00+02:00`, // Added :00 for seconds, ensure format
    "dateModified": `${articleUpdateDate}T${eeat.EEAT_HOUR_UPDATED || '00:00'}:00+02:00`,   // Added :00 for seconds
    "inLanguage": articleDateLocale
  }
};

// Organization Schema 
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": www.PAGE_ORGANISATION_FULL_NAME,
  "url": getBaseUrl('/'),
  "foundingDate": www.PAGE_FOUNDING_DATE,
  "logo": getBaseUrl(www.PAGE_LOGO_IMAGE_PATH_1),
  "keywords": [
    www.PAGE_ORGANISATION_FULL_NAME,
    common.M_COUNTRY_NATIVE,
    common.PAGE_KEYWORD_1,
    common.PAGE_KEYWORD_2,
    common.PAGE_KEYWORD_3,
    common.PAGE_KEYWORD_4,
    common.PAGE_KEYWORD_5,
    common.PAGE_KEYWORD_6
  ].filter(Boolean),
  "description": common.PAGE_DESCRIPTION || common.PAGE_SLOGAN,
  "numberOfEmployees": {
    "@type": "QuantitativeValue",
    "minValue": "1",
    "maxValue": "9"
  },
  "slogan": common.PAGE_SLOGAN,
  "contactPoint": {
    "@type": "ContactPoint",
    "email": www.PAGE_INFO_EMAIL,
    "contactType": common.M_CUSTOMER_SUPPORT
  },
  "sameAs": [
    www.PAGE_INSTAGRAM_URL,
    www.PAGE_FACEBOOK_URL,
    www.PAGE_TWITTER_URL,
    www.PAGE_LINKEDIN_URL,
    www.PAGE_YOUTUBE_URL,
    www.PAGE_PINTEREST_URL,
    www.PAGE_BLUESKY_URL
  ].filter(Boolean),
  "areaServed": {
    "@type": "Country",
    "name": common.M_COUNTRY,
    "identifier": common.M_COUNTRY_CODE
  },
  "potentialAction": [
    {
      "@type": "ViewAction",
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/sitemap.xml')
    },
    {
      "@type": "ViewAction",
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`)
    },
    {
      "@type": "ViewAction",
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/llms.txt'),
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ],
  "mainEntityOfPage": [
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/sitemap.xml'),
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a structured list of pages available on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`),
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a full and structured list of localized pages for ${languageIso} (${languageIso}-${countryCode}) locale on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/llms.txt'),
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ]
};

// Combine schemas into an array
const combinedSchema = [webpageSchema, organizationSchema];

// Format dates
const formatDate = (dateString: string, locale: string) => {
  if (!dateString) return '';
  return new Date(dateString).toLocaleDateString(locale, {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};
---

<BaseLayout
  languageIso={languageIso}
  countryCode={countryCode}
  contentOrientation={contentOrientation}
  title={seoTitle}
  description={pageDescription}
  ogImage={pageogImage}
  keywords={pageKeywords}
  schema={combinedSchema}
  languageLinksMap={languageLinksMap}
>
  <!-- Dark Header Section -->
  <div class="bg-black text-white py-16">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl md:text-5xl font-bold mb-6 animate-fade-in">{headline}</h1>
        <div class="flex flex-wrap items-center gap-2 text-lg animate-slide-up">
          <span class="text-signal-green">{publishedTextLabel} {formatDate(articlePublishDate, articleDateLocale)}</span>
          {articleUpdateDate && updatedTextLabel && (
            <>
              <span class="text-gray-400">â€¢</span>
              <span class="text-signal-green">{updatedTextLabel} {formatDate(articleUpdateDate, articleDateLocale)}</span>
            </>
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Part 1 (eeat.EEAT_CONTENT) -->
  <div class={`container mx-auto px-4 ${isContactPage ? 'pt-12' : 'py-12'}`}>
    <div class="prose prose-lg max-w-4xl mx-auto">
      <Fragment set:html={pageContent} />
      
      <!-- Add Author Grid when EEAT_FILTERING is 20 or 13 -->
      {(filteringNumber === 20 || filteringNumber === 13) && authors.length > 0 && (
        <section class="py-16 bg-gray-50">
          <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold mb-8 text-center">
              {common.ARTICLE_AUTHORS_TITLE}
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {authors.map((author) => (
                <a 
                  href={getAbsoluteUrl(`/${author.EEAT_URL_20}/${author.WWW_AUTHOR_SLUG}`)}
                  class="group block bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300"
                >
                  <div class="aspect-w-1 aspect-h-1">
                    <img 
                      src={author.AUTHOR_PROFILE_IMAGE_PATH} 
                      alt={author.AUTHOR_IMAGE_ALT}
                      class="w-full h-64 object-cover object-center"
                    />
                  </div>
                  <div class="p-6">
                    <h3 class="text-xl font-semibold mb-2 group-hover:text-signal-green transition-colors duration-300">
                      {author.WWW_AUTHOR}
                    </h3>
                    <p class="text-gray-600 text-sm mb-2">{author.WWW_AUTHOR_OCCUPATION}</p>
                    <p class="text-gray-500 text-sm line-clamp-3">{author.AUTHOR_FULL_BIO}</p>
                  </div>
                </a>
              ))}
            </div>
          </div>
        </section>
      )}

      <!-- If NOT a contact page, and pageContent2 exists, render it here -->
      {!isContactPage && pageContent2 && (
        <Fragment set:html={pageContent2} />
      )}
    </div>
  </div>

  <!-- If Contact Page: Form + Main Content Part 2 (eeat.EEAT_CONTENT_2) -->
  {isContactPage && (
    <>
      <!-- Contact Form Section -->
      <section class="pt-3 pb-8 bg-gray-50">
        <div class="container mx-auto px-4">
          <div class="max-w-2xl mx-auto">
            {/* Display Success/Error Messages */}
            {successMessage && !submissionResult?.error && (
              <div class="p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
                {successMessage}
              </div>
            )}
            {genericError && (
              <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                {genericError}
              </div>
            )}

            <form method="POST" action={actions.submitContactForm} class="space-y-4">
              <input type="hidden" name="pageUrl" value={Astro.url.href} />
              <input type="hidden" name="pageTitle" value={seoTitle} />
              <input type="hidden" name="locale" value={locale} />

              <div>
                <label for="fullName" class="block text-sm font-medium text-gray-600 mb-1">{common.FORM_LABEL_FULLNAME}</label>
                <input
                  type="text"
                  id="fullName"
                  name="fullName"
                  placeholder={common.FORM_PLACEHOLDER_FULLNAME}
                  class:list={[
                    "w-full ps-4 pe-4 py-2 rounded-lg border focus:ring-1 focus:ring-signal-green",
                    getFieldError('fullName') ? "border-red-500" : "border-gray-300 focus:border-signal-green"
                  ]}
                  required
                />
                {getFieldError('fullName') && <p class="text-red-500 text-xs mt-1">{common.FORM_VALIDATION_FULLNAME_REQUIRED}</p>}
              </div>
              <div>
                <label for="email" class="block text-sm font-medium text-gray-600 mb-1">{common.FORM_LABEL_EMAIL}</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder={common.FORM_PLACEHOLDER_EMAIL}
                  class:list={[
                    "w-full ps-4 pe-4 py-2 rounded-lg border focus:ring-1 focus:ring-signal-green",
                    getFieldError('email') ? "border-red-500" : "border-gray-300 focus:border-signal-green"
                  ]}
                  required
                />
                {getFieldError('email') && <p class="text-red-500 text-xs mt-1">{common.FORM_VALIDATION_EMAIL_INVALID}</p>}
              </div>
              <div>
                <label for="message" class="block text-sm font-medium text-gray-600 mb-1">{common.FORM_LABEL_MESSAGE}</label>
                <textarea
                  id="message"
                  name="message"
                  rows="4"
                  placeholder={common.FORM_PLACEHOLDER_MESSAGE_ORDER}
                  class:list={[
                    "w-full ps-4 pe-4 py-2 rounded-lg border focus:ring-1 focus:ring-signal-green",
                    getFieldError('message') ? "border-red-500" : "border-gray-300 focus:border-signal-green"
                  ]}
                  required
                ></textarea>
                {getFieldError('message') && <p class="text-red-500 text-xs mt-1">{common.FORM_VALIDATION_MESSAGE_REQUIRED}</p>}
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="terms" name="terms" required 
                  class:list={[getFieldError('terms') ? "border-red-500" : ""]}/>
                <label for="terms" class="text-sm text-gray-600">
                  {common.FORM_LABEL_TERMS}
                </label>
              </div>
              {getFieldError('terms') && <p class="text-red-500 text-xs mt-1">{common.FORM_VALIDATION_TERMS_REQUIRED}</p>}
              <button
                type="submit"
                class="w-full bg-black text-signal-green border border-signal-green py-3 rounded-lg hover:bg-signal-green hover:text-black transition-all"
              >
                {common.FORM_BUTTON_SUBMIT_CONTACT}
              </button>
            </form>
          </div>
        </div>
      </section>

      <!-- Main Content Part 2 (eeat.EEAT_CONTENT_2) for contact pages -->
      {pageContent2 && (
        <div class="container mx-auto px-4 py-12">
          <div class="prose prose-lg max-w-4xl mx-auto">
            <div class="space-y-6">
              <Fragment set:html={pageContent2} />
            </div>
          </div>
        </div>
      )}
    </>
  )}
</BaseLayout>

<style>
  /* Base prose container */
  .prose {
    max-width: 65ch;
    margin-left: auto;
    margin-right: auto;
  }

  /* Headings */
  .prose :global(h2) {
    color: black;
    font-size: 1.875rem; /* 30px */
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1.5rem;
  }

  .prose :global(h3) {
    color: black;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.5rem; /* 24px */
    font-weight: 600;
  }

  /* Paragraphs */
  .prose :global(p) {
    color: #374151; /* Tailwind gray-700 */
    margin-bottom: 1.25rem;
    line-height: 1.75;
  }

  /* Links */
  .prose :global(a) {
    color: black;
    text-decoration: underline;
    text-decoration-color: #BCEF2F; /* signal-green */
    text-underline-offset: 2px;
    transition: color 0.2s ease, text-decoration-color 0.2s ease;
  }

  .prose :global(a:hover) {
    color: #BCEF2F; /* signal-green */
    text-decoration-color: black;
  }

  /* Lists */
  .prose :global(ul) {
    list-style-type: none;
    margin-inline-start: 1.25rem;
    margin-bottom: 1.25rem;
  }

  .prose :global(ol) { 
    margin-inline-start: 1.25rem;
    margin-bottom: 1.25rem;
  }

  .prose :global(li) {
    position: relative;
    padding-inline-start: 1.5rem;
    margin-bottom: 0.75rem;
    line-height: 1.75;
  }

  .prose :global(ul li::before) {
    content: "";
    position: absolute;
    inset-inline-start: 0;
    top: 0.75rem; /* Adjusted for line-height */
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    background: #BCEF2F; /* signal-green */
    border: 2px solid black;
  }
  
  /* Underline */
  .prose :global(u) {
    text-decoration: none;
    position: relative;
  }

  .prose :global(u::after) {
    content: "";
    position: absolute;
    inset-inline-start: 0;
    bottom: -2px;
    width: 100%;
    height: 2px;
    background: repeating-linear-gradient(
      45deg,
      #BCEF2F,
      #BCEF2F 2px,
      transparent 2px,
      transparent 4px
    );
  }

  /* Bold text */
  .prose :global(b) {
    font-weight: 700;
  }

  /* List items with links */
  .prose :global(li a) {
    display: inline-block;
  }

  /* Spacing between sections */
  .prose :global(h2 + p) {
    margin-top: 1rem;
  }

  .prose :global(p + ul) {
    margin-top: 0.5rem;
  }
  
  /* FAQ Section styling */
  .prose :global(.faq-section) {
    margin-top: 2rem;
  }

  .prose :global(.faq-section p) {
    margin-bottom: 1.5rem;
  }

  /* Animations */
  :global(.animate-fade-in) {
    animation: fadeIn 0.5s ease-in-out;
  }

  :global(.animate-slide-up) {
    animation: slideUp 0.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Add these new styles for author cards */
  .prose :global(.author-card) {
    text-decoration: none;
  }

  .prose :global(.author-card:hover) {
    text-decoration: none;
  }

  .prose :global(.author-card h3) {
    text-decoration: none;
  }

  .prose :global(.author-card:hover h3) {
    text-decoration: none;
  }

  /* Ensure images maintain aspect ratio during hover */
  .prose :global(.author-card img) {
    backface-visibility: hidden;
    transform: translateZ(0);
    -webkit-font-smoothing: subpixel-antialiased;
  }

  /* Client side validation styles for modern browsers */
  :where(input, select, textarea):user-invalid {
      border-color: #ef4444; /* red-500 */
  }

  /* RTL-specific styles for better text rendering */
  [dir="rtl"] .prose :global(p) {
    letter-spacing: 0;
  }

  [dir="rtl"] .prose :global(h1),
  [dir="rtl"] .prose :global(h2),
  [dir="rtl"] .prose :global(h3),
  [dir="rtl"] .prose :global(h4),
  [dir="rtl"] .prose :global(h5),
  [dir="rtl"] .prose :global(h6) {
    letter-spacing: 0;
  }

  /* Ensure proper text truncation in RTL */
  [dir="rtl"] .prose :global(.line-clamp-3) {
    text-align: start;
  }
</style>
###

Here's the CORECTLY refactored [EEATSlug].astro file:
####
---
import path from 'path';
import Database from 'better-sqlite3';
import { actions, isInputError } from 'astro:actions';
import BaseLayout from '../../layouts/BaseLayout.astro';

// --- Database Connection ---
// Establish a connection to the SQLite database.
// This is more efficient than loading multiple large JSON files into memory.
const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true }); // Open in read-only mode for safety

export const prerender = false;

// --- Data Fetching from Database ---

// Get the locale and slug from the URL parameters
const { EEATslug } = Astro.params;
const locale = Astro.url.pathname.split('/')[1];

// 1. Fetch the primary EEAT page data for the current locale and slug.
// Uses .get() as we expect only one record.
const eeatEntry = db.prepare('SELECT * FROM eeat WHERE M_SLUG = ? AND EEAT_SLUG = ?').get(locale, EEATslug);

// If no entry is found, redirect to 404.
if (!eeatEntry) {
  return Astro.redirect('/404');
}

// 2. Perform validation checks based on the fetched data.
const filteringNumber = parseInt(eeatEntry.EEAT_FILTERING);
const isValidPage = eeatEntry.PUBLISH_Y_N === "1" && filteringNumber >= 1 && filteringNumber <= 28;

if (!isValidPage) {
  return Astro.redirect('/404');
}

// 3. Fetch all other required data in a single transaction for efficiency.
// This is much faster than running multiple separate queries.
const { www, common, authors, publishedLocales, altEeatEntries } = db.transaction(() => {
    // Fetch global site data (www table)
    const wwwData = db.prepare('SELECT * FROM www LIMIT 1').get();

    // Fetch common translations and settings for the current locale.
    // If a locale-specific entry doesn't exist, it will be null. The template should handle this gracefully or have a fallback.
    const commonData = db.prepare('SELECT * FROM common WHERE M_SLUG = ?').get(locale);

    // Conditionally fetch authors only if the page requires them (e.g., "About Us" or "Editorial Policy").
    // Uses .all() as we expect multiple authors.
    const authorData = (filteringNumber === 20 || filteringNumber === 13)
      ? db.prepare("SELECT * FROM author WHERE M_SLUG = ? AND PUBLISH_Y_N = '1'").all(locale)
      : [];
    
    // Fetch all published locales for the language switcher.
    const locales = db.prepare("SELECT M_SLUG FROM locale WHERE M_LOCALE_PUBLISH_Y_N = '1'").all();
    
    // Fetch all alternate EEAT page slugs for the current page type across all locales.
    // This is more efficient than querying inside a loop.
    const alts = db.prepare("SELECT M_SLUG, EEAT_SLUG FROM eeat WHERE EEAT_FILTERING = ? AND PUBLISH_Y_N = '1'").all(eeatEntry.EEAT_FILTERING);

    return { 
        www: wwwData, 
        common: commonData || {}, // Fallback to an empty object if no common data is found
        authors: authorData,
        publishedLocales: locales,
        altEeatEntries: alts
    };
})();

// --- Page Logic and Variable Definitions ---

// Assign the main entry to a simpler variable name.
const eeat = eeatEntry;

// Determine if the page should display a contact form.
const isContactPage = filteringNumber === 24 || filteringNumber === 25;

// Helper functions for URL generation (unchanged).
const getAbsoluteUrl = (path: string) => {
    return new URL(`/${locale}${path}`, Astro.url.origin).toString();
};
const getBaseUrl = (path: string) => {
    return new URL(path, Astro.url.origin).toString();
};

// Define content variables for the template (unchanged).
const languageIso = eeat.M_LANGUAGE_ISO;
const countryCode = eeat.M_COUNTRY_CODE;
const contentOrientation = common.M_CONTENT_ORIENTATION || 'ltr';
const seoTitle = eeat.EEAT_NAME;
const headline = eeat.EEAT_H1;
const pageDescription = eeat.EEAT_META_SEO;
const pageContent = eeat.EEAT_CONTENT;
const pageContent2 = eeat.EEAT_CONTENT_2;
const pageogImage = eeat.EEAT_OG_IMAGE_PATH;
const articlePublishDate = eeat.EEAT_DATE_PUBLISHED;
const articleUpdateDate = eeat.EEAT_DATE_UPDATED;
const publishedTextLabel = common.M_PUBLISHED;
const updatedTextLabel = common.M_UPDATED;
const articleDateLocale = `${eeat.M_LANGUAGE_ISO}-${eeat.M_COUNTRY_CODE}`;
const pageKeywords = [
  eeat.EEAT_NAME,
  eeat.M_COUNTRY_NATIVE,
  www.PAGE_ORGANISATION_FULL_NAME
].join(', ');

// --- FORM HANDLING (Unchanged) ---
const submissionResult = await Astro.getActionResult(actions.submitContactForm);
const formErrors: Record<string, string[] | undefined> = {};
let genericError: string | undefined = undefined;
let successMessage: string | undefined = undefined;

if (submissionResult) {
  if (submissionResult.error) {
    if (isInputError(submissionResult.error)) {
      Object.assign(formErrors, submissionResult.error.fields);
  } else {
      genericError = submissionResult.error.message;
    }
  } else if (submissionResult.data?.success) {
    successMessage = submissionResult.data.message;
  }
}

const getFieldError = (fieldName: string): string | undefined => formErrors[fieldName]?.[0];

// --- Language Link Generation (Refactored for Performance) ---
// Create a lookup map from the pre-fetched alternate entries.
const altEeatMap = new Map(altEeatEntries.map(e => [e.M_SLUG, e.EEAT_SLUG]));

// Build the language link map for the language picker.
const languageLinksMap: Record<string, string> = {};
for (const l of publishedLocales) {
  const altSlug = altEeatMap.get(l.M_SLUG);
  if (altSlug) {
    languageLinksMap[l.M_SLUG] = `/${l.M_SLUG}/${altSlug}`;
  } else {
    // Fallback to the locale's homepage if no direct equivalent page exists.
    languageLinksMap[l.M_SLUG] = `/${l.M_SLUG}`;
  }
}

// --- Schema Definitions (Unchanged) ---
const webpageSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": eeat.EEAT_H1,
  "url": Astro.url.href,
  "description": pageDescription,
  "inLanguage": articleDateLocale,
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": common.M_HOME_NAME,
        "item": getAbsoluteUrl("/")
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": seoTitle,
        "item": Astro.url.href
      }
    ]
  },
  "mainEntity": {
    "@type": "Article",
    "headline": headline,
    "description": pageDescription,
    "image": getBaseUrl(pageogImage),
    "author": {
      "@type": "Organization",
      "name": www.PAGE_ORGANISATION_FULL_NAME
    },
    "datePublished": `${articlePublishDate}T${eeat.EEAT_HOUR_PUBLISHED || '00:00:00'}+02:00`,
    "dateModified": `${articleUpdateDate}T${eeat.EEAT_HOUR_UPDATED || '00:00:00'}+02:00`,
    "inLanguage": articleDateLocale
  }
};

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": www.PAGE_ORGANISATION_FULL_NAME,
  "url": getBaseUrl('/'),
  "foundingDate": www.PAGE_FOUNDING_DATE,
  "logo": getBaseUrl(www.PAGE_LOGO_IMAGE_PATH_1),
  "keywords": [
    www.PAGE_ORGANISATION_FULL_NAME,
    common.M_COUNTRY_NATIVE,
    common.PAGE_KEYWORD_1,
    common.PAGE_KEYWORD_2,
    common.PAGE_KEYWORD_3,
    common.PAGE_KEYWORD_4,
    common.PAGE_KEYWORD_5,
    common.PAGE_KEYWORD_6
  ].filter(Boolean),
  "description": common.PAGE_DESCRIPTION || common.PAGE_SLOGAN,
  "numberOfEmployees": {
    "@type": "QuantitativeValue",
    "minValue": "1",
    "maxValue": "9"
  },
  "slogan": common.PAGE_SLOGAN,
  "contactPoint": {
    "@type": "ContactPoint",
    "email": www.PAGE_INFO_EMAIL,
    "contactType": common.M_CUSTOMER_SUPPORT
  },
  "sameAs": [
    www.PAGE_INSTAGRAM_URL,
    www.PAGE_FACEBOOK_URL,
    www.PAGE_TWITTER_URL,
    www.PAGE_LINKEDIN_URL,
    www.PAGE_YOUTUBE_URL,
    www.PAGE_PINTEREST_URL,
    www.PAGE_BLUESKY_URL
  ].filter(Boolean),
  "areaServed": {
    "@type": "Country",
    "name": common.M_COUNTRY,
    "identifier": common.M_COUNTRY_CODE
  },
  "potentialAction": [
    {
      "@type": "ViewAction",
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/sitemap.xml')
    },
    {
      "@type": "ViewAction",
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`)
    },
    {
      "@type": "ViewAction",
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/llms.txt'),
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ],
  "mainEntityOfPage": [
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/sitemap.xml'),
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a structured list of pages available on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`),
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a full and structured list of localized pages for ${languageIso} (${languageIso}-${countryCode}) locale on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/llms.txt'),
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ]
};

const combinedSchema = [webpageSchema, organizationSchema];

// --- Helper Functions (Unchanged) ---
const formatDate = (dateString: string, locale: string) => {
  if (!dateString) return '';
  return new Date(dateString).toLocaleDateString(locale, {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};
---

<BaseLayout
  languageIso={languageIso}
  countryCode={countryCode}
  contentOrientation={contentOrientation}
  title={seoTitle}
  description={pageDescription}
  ogImage={pageogImage}
  keywords={pageKeywords}
  schema={combinedSchema}
  languageLinksMap={languageLinksMap}
>
  <!-- Dark Header Section -->
  <div class="bg-black text-white py-16">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl md:text-5xl font-bold mb-6 animate-fade-in">{headline}</h1>
        <div class="flex flex-wrap items-center gap-2 text-lg animate-slide-up">
          <span class="text-signal-green">{publishedTextLabel} {formatDate(articlePublishDate, articleDateLocale)}</span>
          {articleUpdateDate && updatedTextLabel && (
            <>
              <span class="text-gray-400">â€¢</span>
              <span class="text-signal-green">{updatedTextLabel} {formatDate(articleUpdateDate, articleDateLocale)}</span>
            </>
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Part 1 (eeat.EEAT_CONTENT) -->
  <div class={`container mx-auto px-4 ${isContactPage ? 'pt-12' : 'py-12'}`}>
    <div class="prose prose-lg max-w-4xl mx-auto">
      <Fragment set:html={pageContent} />
      
      <!-- Add Author Grid when EEAT_FILTERING is 20 or 13 -->
      {(filteringNumber === 20 || filteringNumber === 13) && authors.length > 0 && (
        <section class="py-16 bg-gray-50">
          <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold mb-8 text-center">
              {common.ARTICLE_AUTHORS_TITLE}
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {authors.map((author) => (
                <a 
                  href={getAbsoluteUrl(`/${author.EEAT_URL_20}/${author.WWW_AUTHOR_SLUG}`)}
                  class="group block bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300"
                >
                  <div class="aspect-w-1 aspect-h-1">
                    <img 
                      src={author.AUTHOR_PROFILE_IMAGE_PATH} 
                      alt={author.AUTHOR_IMAGE_ALT}
                      class="w-full h-64 object-cover object-center"
                    />
                  </div>
                  <div class="p-6">
                    <h3 class="text-xl font-semibold mb-2 group-hover:text-signal-green transition-colors duration-300">
                      {author.WWW_AUTHOR}
                    </h3>
                    <p class="text-gray-600 text-sm mb-2">{author.WWW_AUTHOR_OCCUPATION}</p>
                    <p class="text-gray-500 text-sm line-clamp-3">{author.AUTHOR_FULL_BIO}</p>
                  </div>
                </a>
              ))}
            </div>
          </div>
        </section>
      )}

      <!-- If NOT a contact page, and pageContent2 exists, render it here -->
      {!isContactPage && pageContent2 && (
        <Fragment set:html={pageContent2} />
      )}
    </div>
  </div>

  <!-- If Contact Page: Form + Main Content Part 2 (eeat.EEAT_CONTENT_2) -->
  {isContactPage && (
    <>
      <!-- Contact Form Section -->
      <section class="pt-3 pb-8 bg-gray-50">
        <div class="container mx-auto px-4">
          <div class="max-w-2xl mx-auto">
            {/* Display Success/Error Messages */}
            {successMessage && !submissionResult?.error && (
              <div class="p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
                {successMessage}
              </div>
            )}
            {genericError && (
              <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                {genericError}
              </div>
            )}

            <form method="POST" action={actions.submitContactForm} class="space-y-4">
              <input type="hidden" name="pageUrl" value={Astro.url.href} />
              <input type="hidden" name="pageTitle" value={seoTitle} />
              <input type="hidden" name="locale" value={locale} />

              <div>
                <label for="fullName" class="block text-sm font-medium text-gray-600 mb-1">{common.FORM_LABEL_FULLNAME}</label>
                <input
                  type="text"
                  id="fullName"
                  name="fullName"
                  placeholder={common.FORM_PLACEHOLDER_FULLNAME}
                  class:list={[
                    "w-full ps-4 pe-4 py-2 rounded-lg border focus:ring-1 focus:ring-signal-green",
                    getFieldError('fullName') ? "border-red-500" : "border-gray-300 focus:border-signal-green"
                  ]}
                  required
                />
                {getFieldError('fullName') && <p class="text-red-500 text-xs mt-1">{common.FORM_VALIDATION_FULLNAME_REQUIRED}</p>}
              </div>
              <div>
                <label for="email" class="block text-sm font-medium text-gray-600 mb-1">{common.FORM_LABEL_EMAIL}</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder={common.FORM_PLACEHOLDER_EMAIL}
                  class:list={[
                    "w-full ps-4 pe-4 py-2 rounded-lg border focus:ring-1 focus:ring-signal-green",
                    getFieldError('email') ? "border-red-500" : "border-gray-300 focus:border-signal-green"
                  ]}
                  required
                />
                {getFieldError('email') && <p class="text-red-500 text-xs mt-1">{common.FORM_VALIDATION_EMAIL_INVALID}</p>}
              </div>
              <div>
                <label for="message" class="block text-sm font-medium text-gray-600 mb-1">{common.FORM_LABEL_MESSAGE}</label>
                <textarea
                  id="message"
                  name="message"
                  rows="4"
                  placeholder={common.FORM_PLACEHOLDER_MESSAGE_ORDER}
                  class:list={[
                    "w-full ps-4 pe-4 py-2 rounded-lg border focus:ring-1 focus:ring-signal-green",
                    getFieldError('message') ? "border-red-500" : "border-gray-300 focus:border-signal-green"
                  ]}
                  required
                ></textarea>
                {getFieldError('message') && <p class="text-red-500 text-xs mt-1">{common.FORM_VALIDATION_MESSAGE_REQUIRED}</p>}
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="terms" name="terms" required 
                  class:list={[getFieldError('terms') ? "border-red-500" : ""]}/>
                <label for="terms" class="text-sm text-gray-600">
                  {common.FORM_LABEL_TERMS}
                </label>
              </div>
              {getFieldError('terms') && <p class="text-red-500 text-xs mt-1">{common.FORM_VALIDATION_TERMS_REQUIRED}</p>}
              <button
                type="submit"
                class="w-full bg-black text-signal-green border border-signal-green py-3 rounded-lg hover:bg-signal-green hover:text-black transition-all"
              >
                {common.FORM_BUTTON_SUBMIT_CONTACT}
              </button>
            </form>
          </div>
        </div>
      </section>

      <!-- Main Content Part 2 (eeat.EEAT_CONTENT_2) for contact pages -->
      {pageContent2 && (
        <div class="container mx-auto px-4 py-12">
          <div class="prose prose-lg max-w-4xl mx-auto">
            <div class="space-y-6">
              <Fragment set:html={pageContent2} />
            </div>
          </div>
        </div>
      )}
    </>
  )}
</BaseLayout>

<style>
  /* Base prose container */
  .prose {
    max-width: 65ch;
    margin-left: auto;
    margin-right: auto;
  }

  /* Headings */
  .prose :global(h2) {
    color: black;
    font-size: 1.875rem; /* 30px */
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1.5rem;
  }

  .prose :global(h3) {
    color: black;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.5rem; /* 24px */
    font-weight: 600;
  }

  /* Paragraphs */
  .prose :global(p) {
    color: #374151; /* Tailwind gray-700 */
    margin-bottom: 1.25rem;
    line-height: 1.75;
  }

  /* Links */
  .prose :global(a) {
    color: black;
    text-decoration: underline;
    text-decoration-color: #BCEF2F; /* signal-green */
    text-underline-offset: 2px;
    transition: color 0.2s ease, text-decoration-color 0.2s ease;
  }

  .prose :global(a:hover) {
    color: #BCEF2F; /* signal-green */
    text-decoration-color: black;
  }

  /* Lists */
  .prose :global(ul) {
    list-style-type: none;
    margin-inline-start: 1.25rem;
    margin-bottom: 1.25rem;
  }

  .prose :global(ol) { 
    margin-inline-start: 1.25rem;
    margin-bottom: 1.25rem;
  }

  .prose :global(li) {
    position: relative;
    padding-inline-start: 1.5rem;
    margin-bottom: 0.75rem;
    line-height: 1.75;
  }

  .prose :global(ul li::before) {
    content: "";
    position: absolute;
    inset-inline-start: 0;
    top: 0.75rem; /* Adjusted for line-height */
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    background: #BCEF2F; /* signal-green */
    border: 2px solid black;
  }
  
  /* Underline */
  .prose :global(u) {
    text-decoration: none;
    position: relative;
  }

  .prose :global(u::after) {
    content: "";
    position: absolute;
    inset-inline-start: 0;
    bottom: -2px;
    width: 100%;
    height: 2px;
    background: repeating-linear-gradient(
      45deg,
      #BCEF2F,
      #BCEF2F 2px,
      transparent 2px,
      transparent 4px
    );
  }

  /* Bold text */
  .prose :global(b) {
    font-weight: 700;
  }

  /* List items with links */
  .prose :global(li a) {
    display: inline-block;
  }

  /* Spacing between sections */
  .prose :global(h2 + p) {
    margin-top: 1rem;
  }

  .prose :global(p + ul) {
    margin-top: 0.5rem;
  }
  
  /* FAQ Section styling */
  .prose :global(.faq-section) {
    margin-top: 2rem;
  }

  .prose :global(.faq-section p) {
    margin-bottom: 1.5rem;
  }

  /* Animations */
  :global(.animate-fade-in) {
    animation: fadeIn 0.5s ease-in-out;
  }

  :global(.animate-slide-up) {
    animation: slideUp 0.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Add these new styles for author cards */
  .prose :global(.author-card) {
    text-decoration: none;
  }

  .prose :global(.author-card:hover) {
    text-decoration: none;
  }

  .prose :global(.author-card h3) {
    text-decoration: none;
  }

  .prose :global(.author-card:hover h3) {
    text-decoration: none;
  }

  /* Ensure images maintain aspect ratio during hover */
  .prose :global(.author-card img) {
    backface-visibility: hidden;
    transform: translateZ(0);
    -webkit-font-smoothing: subpixel-antialiased;
  }

  /* Client side validation styles for modern browsers */
  :where(input, select, textarea):user-invalid {
      border-color: #ef4444; /* red-500 */
  }

  /* RTL-specific styles for better text rendering */
  [dir="rtl"] .prose :global(p) {
    letter-spacing: 0;
  }

  [dir="rtl"] .prose :global(h1),
  [dir="rtl"] .prose :global(h2),
  [dir="rtl"] .prose :global(h3),
  [dir="rtl"] .prose :global(h4),
  [dir="rtl"] .prose :global(h5),
  [dir="rtl"] .prose :global(h6) {
    letter-spacing: 0;
  }

  /* Ensure proper text truncation in RTL */
  [dir="rtl"] .prose :global(.line-clamp-3) {
    text-align: start;
  }
</style>
####

Here's my old way of writing src\pages\si\index.astro:
#####
// Purpose: Homepage with dynamic RTL support
// Data: JSON dependencies for home content, products, and locale data
// Dependencies: BaseLayout, form validation

import BaseLayout from '../../layouts/BaseLayout.astro';
import homeData from '../../data/home.json';
import wwwData from '../../data/www.json';
import commonData from '../../data/common.json';
import products from '../../data/product.json';
import localeData from '../../data/locale.json';

// --- Interface Definitions  ---
interface HeroData {
  title: string;
  subtitle: string;
  ctaText: string;
  ctaLink: string;
  features: string[];
  socialProof: {
    text: string;
    rating: number; 
    userPhotos: string[];
  };
  ogImage?: string;
}

interface Product {
  title: string;
  image: string;
  url: string;
}

interface FeatureItem {
  icon: string;
  title: string;
  description: string;
}

interface FaqItem {
  question: string;
  answer: string;
}

interface MarqueeItem {
  url: string;
  image: string;
  alt: string;
}

interface FormAlerts {
  invalidEmail: string;
  termsNotAccepted: string;
  submissionSuccess: string;
  submissionError: string;
}

// Get the locale from the URL path (e.g., 'si' from /si/)
const locale = Astro.url.pathname.split('/')[1];

// Find the matching data objects based on M_SLUG, with fallbacks
const common = commonData.find(item => item.M_SLUG === locale) || commonData[0];
const home = homeData.find(item => item.M_SLUG === locale) || homeData[0];
const product = products.find(item => item.M_SLUG === locale) || products[0];

// If we're using fallback data, make sure it matches our locale
if (common.M_SLUG !== locale || home.M_SLUG !== locale || product.M_SLUG !== locale) {
  return Astro.redirect('/404');
}

const www = wwwData[0];

// Helper function for absolute URLs with locale
const getAbsoluteUrl = (path: string) => {
    return new URL(`/${locale}${path}`, Astro.url.origin).toString();
};

// Helper function for base-level URLs (without locale)
const getBaseUrl = (path: string) => {
    return new URL(path, Astro.url.origin).toString();
};

// Get language data
const languageIso: string = home.M_LANGUAGE_ISO;
const countryCode: string = home.M_COUNTRY_CODE;

// Find matching content orientation from common.json
const contentOrientation: string = common.M_CONTENT_ORIENTATION || 'ltr';

// --- Data for the Homepage ---

// Helper function to randomly shuffle and pick n items from an array
const getRandomItems = <T,>(array: T[], count: number): T[] => {
  const shuffled = [...array].sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
};

// Define all available social proof images
const allSocialProofImages = [
  '/socialproof/sp1.webp',
  '/socialproof/sp2.webp',
  '/socialproof/sp3.webp',
  '/socialproof/sp4.webp',
  '/socialproof/sp5.webp',
  '/socialproof/sp6.webp',
  '/socialproof/sp7.webp',
  '/socialproof/sp8.webp',
  '/socialproof/sp9.webp',
  '/socialproof/sp10.webp',
  '/socialproof/sp11.webp',
  '/socialproof/sp12.webp',
  '/socialproof/sp13.webp',
  '/socialproof/sp14.webp',
  '/socialproof/sp15.webp',
  '/socialproof/sp16.webp',
  '/socialproof/sp17.webp',
  '/socialproof/sp18.webp',
  '/socialproof/sp19.webp',
  '/socialproof/sp20.webp',
  '/socialproof/sp21.webp',
  '/socialproof/sp22.webp',
  '/socialproof/sp23.webp',
  '/socialproof/sp24.webp'
];

// Hero section data
const heroData: HeroData = {
  title: home.HOME_H1,
  subtitle: home.HOME_SUBTITLE,
  ogImage: home.HOME_OG_IMAGE_PATH,
  ctaText: home.HOME_HERO_BUTTON,
  ctaLink: "#best-sellers",
  features: [
    home.HOME_HERO_BENEFIT_1,
    home.HOME_HERO_BENEFIT_2,
    home.HOME_HERO_BENEFIT_3
  ],
  socialProof: {
    text: home.HOME_HERO_SOCIAL_PROOF,
    rating: 5,
    userPhotos: getRandomItems(allSocialProofImages, 5)
  }
};

// Define keywords for the page
const pageKeywords: string = [
  home.M_HOME_NAME,
  common.M_COUNTRY_NATIVE,
  www.PAGE_ORGANISATION_FULL_NAME
].join(', ');

// Filter and sort bestsellers based on criteria for specific locale
const bestsellers = products
  .filter(product => 
    product.PUBLISH_Y_N === "1" && 
    product.PRODUCT_IS_BESTSELLER === "1" &&
    product.M_SLUG === locale
  )
  .sort((a, b) => {
    // First sort by importance rank (descending)
    const rankDiff = parseInt(b.PRODUCT_IMPORTANCE_RANK) - parseInt(a.PRODUCT_IMPORTANCE_RANK);
    if (rankDiff !== 0) return rankDiff;
    // If ranks are equal, randomize
    return Math.random() - 0.5;
  });

// Get top 5 products for marquee
const marqueeItems = bestsellers
  .slice(0, 5)
  .map(product => ({
    url: getBaseUrl(`/${product.M_SLUG}/${product.PAGE_COLLECTION_1_LISTING_SLUG}/${product.PRODUCT_ASCII_SLUG}`),
    image: getBaseUrl(product.PRODUCT_IMAGE_PATH_L),
    alt: `${product.PAGE_COLLECTION_1_LISTING_SLUG_HELPER} â€” ${product.PRODUCT_NAME} | ${www.PAGE_ORGANISATION_FULL_NAME}`
  }));

// Get top 9 products for bestsellers section
const bestsellersSection = {
  title: home.HOME_H2_1,
  productCtaText: home.HOME_HERO_BUTTON,
  products: bestsellers
    .slice(0, 9)
    .map(product => ({
      title: `${product.PAGE_COLLECTION_1_LISTING_SLUG_HELPER} â€” ${product.PRODUCT_NAME}`,
      image: getBaseUrl(product.PRODUCT_IMAGE_PATH_L),
      alt: `${product.PAGE_COLLECTION_1_LISTING_SLUG_HELPER} â€” ${product.PRODUCT_NAME} | ${www.PAGE_ORGANISATION_FULL_NAME}`,
      url: getBaseUrl(`/${product.M_SLUG}/${product.PAGE_COLLECTION_1_LISTING_SLUG}/${product.PRODUCT_ASCII_SLUG}`)
    }))
};

// Features section data
const featuresSection = {
  title: home.HOME_H2_2,
  items: [
    {
      icon: "âš¡",
      title: home.HOME_FEATURE_NAME_1,
      description: home.HOME_FEATURE_LABEL_1
    },
    {
      icon: "ðŸ”„",
      title: home.HOME_FEATURE_NAME_2,
      description: home.HOME_FEATURE_LABEL_2
    },
    {
      icon: "ðŸ“¦",
      title: home.HOME_FEATURE_NAME_3,
      description: home.HOME_FEATURE_LABEL_3
    }
  ] as FeatureItem[] 
};

// Institutions section data
const institutionsSection = {
  title: home.HOME_H2_4,
  items: [
    home.INSTITUTION_1,
    home.INSTITUTION_2,
    home.INSTITUTION_3,
    home.INSTITUTION_4,
    home.INSTITUTION_5,
    home.INSTITUTION_6
  ]
};

// FAQ section data
const faqSection = {
  title: home.HOME_H2_5,
  subtitle: home.HOME_FAQ_TEXT,
  items: [
    { question: home.HOME_Q1, answer: home.HOME_A1 },
    { question: home.HOME_Q2, answer: home.HOME_A2 },
    { question: home.HOME_Q3, answer: home.HOME_A3 },
    { question: home.HOME_Q4, answer: home.HOME_A4 },
    { question: home.HOME_Q5, answer: home.HOME_A5 },
    { question: home.HOME_Q6, answer: home.HOME_A6 },
    { question: home.HOME_Q7, answer: home.HOME_A7 },
    { question: home.HOME_Q8, answer: home.HOME_A8 },
    { question: home.HOME_Q9, answer: home.HOME_A9 },
    { question: home.HOME_Q10, answer: home.HOME_A10 },
    { question: home.HOME_Q11, answer: home.HOME_A11 },
    { question: home.HOME_Q12, answer: home.HOME_A12 },
    { question: home.HOME_Q13, answer: home.HOME_A13 },
    { question: home.HOME_Q14, answer: home.HOME_A14 },
    { question: home.HOME_Q15, answer: home.HOME_A15 }
  ] as FaqItem[] // Type assertion
};

// Contact section data
const contactSection = { // Type assertion can be added
  title: home.HOME_H2_6,
  subtitle: home.HOME_CONTACT_SUBTITLE,
  formLabels: {
    fullName: common.M_FULLNAME_PLACEHOLDER,
    fullNamePlaceholder: common.M_FULLNAME_PLACEHOLDER,
    email: common.M_EMAIL_ADDRESS_LABEL,
    emailPlaceholder: common.M_EMAIL_PLACEHOLDER,
    message: common.M_MESSAGE_LABEL,
    messagePlaceholder: common.M_PARTNERSHIP_MESSAGE_PLACEHOLDER,
    terms: common.M_TERMS_REQUIRED,
    submitButton: common.M_SEND_BUTTON
  }
};

// Form alert messages for client-side script
const formAlertMessages: FormAlerts = { // Type assertion
  invalidEmail: common.M_EMAIL_INVALID,
  termsNotAccepted: common.M_TERMS_REQUIRED,
  submissionSuccess: common.M_CONFIRMATION_TEXT,
  submissionError: common.M_FORM_ERROR
};

// --- Schema Definition ---
// WebPage and Article Schema
const webpageSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": home.HOME_H1,
  "url": Astro.url.href,
  "description": home.HOME_META_SEO,
  "inLanguage": `${home.M_LANGUAGE_ISO}-${home.M_COUNTRY_CODE}`,
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": home.M_HOME_NAME,
        "item": Astro.url.href
      }
    ]
  },
  "mainEntity": {
    "@type": "Article",
    "headline": home.HOME_H1,
    "description": home.HOME_META_SEO,
    "image": getBaseUrl(home.HOME_OG_IMAGE_PATH),
    "author": {
      "@type": "Organization",
      "name": www.PAGE_ORGANISATION_FULL_NAME
    },
    "datePublished": `${home.HOME_DATE_PUBLISHED}T${home.HOME_HOUR_PUBLISHED}+02:00`,
    "dateModified": `${home.HOME_DATE_UPDATED}T${home.HOME_HOUR_UPDATED}+02:00`,
    "inLanguage": `${home.M_LANGUAGE_ISO}-${home.M_COUNTRY_CODE}`
  }
};

// FAQ Schema
const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqSection.items.map(item => ({
    "@type": "Question",
    "name": item.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": item.answer
    }
  }))
};

// Organization Schema 
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": www.PAGE_ORGANISATION_FULL_NAME,
  "url": getBaseUrl('/'),
  "foundingDate": www.PAGE_FOUNDING_DATE,
  "logo": getBaseUrl(www.PAGE_LOGO_IMAGE_PATH_1),
  "keywords": [
    www.PAGE_ORGANISATION_FULL_NAME,
    common.M_COUNTRY_NATIVE,
    common.PAGE_KEYWORD_1,
    common.PAGE_KEYWORD_2,
    common.PAGE_KEYWORD_3,
    common.PAGE_KEYWORD_4,
    common.PAGE_KEYWORD_5,
    common.PAGE_KEYWORD_6
  ].filter(Boolean),
  "description": common.PAGE_SLOGAN,
  "numberOfEmployees": {
    "@type": "QuantitativeValue",
    "minValue": "1",
    "maxValue": "9"
  },
  "slogan": common.PAGE_SLOGAN,
  "contactPoint": {
    "@type": "ContactPoint",
    "email": www.PAGE_INFO_EMAIL,
    "contactType": common.M_CUSTOMER_SUPPORT
  },
  "sameAs": [
    www.PAGE_INSTAGRAM_URL,
    www.PAGE_FACEBOOK_URL,
    www.PAGE_TWITTER_URL,
    www.PAGE_LINKEDIN_URL,
    www.PAGE_YOUTUBE_URL,
    www.PAGE_PINTEREST_URL,
    www.PAGE_BLUESKY_URL
  ].filter(Boolean),
  "areaServed": {
    "@type": "Country",
    "name": common.M_COUNTRY,
    "identifier": common.M_COUNTRY_CODE
  },
  "potentialAction": [
    {
      "@type": "ViewAction",
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/sitemap.xml')
    },
    {
      "@type": "ViewAction",
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`)
    },
    {
      "@type": "ViewAction",
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/llms.txt'),
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ],
  "mainEntityOfPage": [
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/sitemap.xml'),
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a structured list of pages available on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`),
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a full and structured list of localized pages for ${languageIso} (${languageIso}-${countryCode}) locale on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/llms.txt'),
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ]
};

// Combine all schemas
const schema: object[] | null = [webpageSchema, faqSchema, organizationSchema];

// --- Props for BaseLayout (to be used directly in the template below) ---
const pageTitle: string = home.HOME_H1;
const pageDescription: string | undefined = home.HOME_META_SEO;
const pageOgImage: string | undefined = home.HOME_OG_IMAGE_PATH;

// Build the language link map for the language picker
const languageLinksMap: Record<string, string> = {};
for (const locale of localeData.filter(l => l.M_LOCALE_PUBLISH_Y_N === "1")) {
  // For homepage, we just use the locale slug as the URL
  languageLinksMap[locale.M_SLUG] = `/${locale.M_SLUG}`;
}
---

<BaseLayout 
  languageIso={languageIso} 
  countryCode={countryCode} 
  contentOrientation={contentOrientation} 
  title={pageTitle} 
  description={pageDescription} 
  ogImage={pageOgImage} 
  keywords={pageKeywords} 
  schema={schema}
  languageLinksMap={languageLinksMap}
>
  <!-- Hero Section -->
  <section class="bg-black text-white py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl">
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold leading-tight mb-4">
          {heroData.title}
        </h1>
        <p class="text-xl md:text-2xl text-gray-300 mb-6 leading-relaxed">
          {heroData.subtitle}
        </p>
        
        <ul class="space-y-2 mb-6">
          {heroData.features.map(feature => (
            <li class="flex items-center gap-2">
              <span class="text-signal-green">âœ“</span>
              <span class="text-lg">{feature}</span>
            </li>
          ))}
        </ul>
        
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4 mb-8">
          <div class="flex -space-x-3 rtl:space-x-reverse mb-2 sm:mb-0">
            {heroData.socialProof.userPhotos.map(photo => (
              <img 
                src={photo} 
                alt="User Testimonial" 
                class="w-10 h-10 rounded-full border-2 border-black"
                width="50"
                height="50"
                loading="lazy"
                decoding="async"
              />
            ))}
          </div>
          <p class="text-lg text-signal-green">{heroData.socialProof.text}</p>
        </div>
        
        <a 
          href={heroData.ctaLink} 
          class="inline-block bg-signal-green text-black font-semibold ps-8 pe-8 py-3 hover:bg-signal-green hover:text-black transition-colors"
        >
          {heroData.ctaText}
        </a>
      </div>
    </div>

    <!-- Marquee Section -->
    <div class="overflow-x-hidden width-100 relative mt-12">
      <div class="pseo-marquee-container">
        <div class="pseo-marquee">
          <div class="pseo-marquee__group">
            {[...Array(2)].map(() => (
              <div class="flex gap-4">
                {marqueeItems.map(item => (
                  <a href={item.url}>
                    <img 
                      src={item.image} 
                      alt={item.alt} 
                      width="50" 
                      height="50" 
                      loading="lazy"
                      decoding="async"
                    />
                  </a>
                ))}
              </div>
            ))}
          </div>
          <div aria-hidden="true" class="pseo-marquee__group">
            {[...Array(2)].map(() => (
              <div class="flex gap-4">
                {marqueeItems.map(item => (
                  <a href={item.url}>
                    <img 
                      src={item.image} 
                      alt={item.alt}
                      width="50" 
                      height="50" 
                      loading="lazy"
                      decoding="async"
                    />
                  </a>
                ))}
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Bestsellers Section -->
  <section id="best-sellers" class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-black mb-12 text-center">{bestsellersSection.title}</h2>
      <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
        {bestsellersSection.products.map(product => (
          <div class="bg-white border border-gray-100 overflow-hidden group">
            <a href={product.url} class="block">
              <img 
                src={product.image} 
                alt={product.alt}
                class="w-full h-56 object-contain p-4"
                width="225"
                height="225"
                loading="lazy"
                decoding="async"
              />
              <div class="p-4 border-t border-gray-100">
                <h3 class="font-medium text-black group-hover:text-signal-green transition-colors mb-4">
                  {product.title}
                </h3>
                <span class="block w-full bg-black text-signal-green border border-signal-green py-2 ps-4 pe-4 hover:bg-signal-green hover:text-black transition-all text-center">
                  {bestsellersSection.productCtaText}
                </span>
              </div>
            </a>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Features Section -->
  <section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-black mb-12 text-center">{featuresSection.title}</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {featuresSection.items.map(feature => (
          <div class="text-center p-6 bg-white rounded-lg shadow-sm">
            <div class="text-4xl mb-4">{feature.icon}</div>
            <h3 class="text-xl font-semibold mb-2">{feature.title}</h3>
            <p class="text-gray-600">{feature.description}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Institutions Section -->
  <section class="py-16 bg-black">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-white mb-12 text-center">
        {institutionsSection.title}
      </h2>
      <div class="flex flex-wrap justify-center items-center gap-12">
        {institutionsSection.items.map(institution => (
          <div class="text-xl font-medium text-signal-green">
            {institution}
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-black mb-4 text-center">{faqSection.title}</h2>
      <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">{faqSection.subtitle}</p>
      <div class="max-w-3xl mx-auto space-y-4">
        {faqSection.items.map(item => (
          <details class="bg-gray-50 rounded-lg group">
            <summary class="p-4 cursor-pointer font-medium flex items-center justify-between">
              <span>{item.question}</span>
              <svg 
                class="w-5 h-5 transform transition-transform group-open:rotate-180" 
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </summary>
            <div class="p-4 pt-0 text-gray-600">
              {item.answer}
            </div>
          </details>
        ))}
      </div>
    </div>
  </section>

  <!-- Contact Section -->
  <section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-black mb-4 text-center">{contactSection.title}</h2>
      <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">
        {contactSection.subtitle}
      </p>

      <div class="max-w-2xl mx-auto">
        <form class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">{contactSection.formLabels.fullName}</label>
            <input 
              type="text" 
              placeholder={contactSection.formLabels.fullNamePlaceholder}
              class="w-full ps-4 pe-4 py-2 rounded-lg border border-gray-300 focus:border-signal-green focus:ring-1 focus:ring-signal-green" 
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">{contactSection.formLabels.email}</label>
            <input 
              type="email" 
              placeholder={contactSection.formLabels.emailPlaceholder}
              class="w-full ps-4 pe-4 py-2 rounded-lg border border-gray-300 focus:border-signal-green focus:ring-1 focus:ring-signal-green" 
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">{contactSection.formLabels.message}</label>
            <textarea 
              rows="4" 
              placeholder={contactSection.formLabels.messagePlaceholder}
              class="w-full ps-4 pe-4 py-2 rounded-lg border border-gray-300 focus:border-signal-green focus:ring-1 focus:ring-signal-green"
              required
            ></textarea>
          </div>
          <div class="flex items-center gap-2">
            <input type="checkbox" id="terms" required />
            <label for="terms" class="text-sm text-gray-600">
              {contactSection.formLabels.terms}
            </label>
          </div>
          <button 
            type="submit" 
            class="w-full bg-black text-signal-green border border-signal-green py-3 rounded-lg hover:bg-signal-green hover:text-black transition-all"
          >
            {contactSection.formLabels.submitButton}
          </button>
        </form>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
.pseo-marquee-container {
  --space: clamp(1rem, 2vw, 2rem);
  --gap: var(--space);
  --duration: 25s;
  position: relative;
  width: 100%;
  max-width: 100vw;
  overflow-x: hidden;
  padding: 20px 0;
  box-sizing: border-box;
}

.pseo-marquee {
  display: flex;
  overflow: hidden;
  user-select: none;
  gap: var(--gap);
  width: 100%;
  margin: 0;
  padding: 0;
  mask-image: linear-gradient(
    to right,
    hsl(0 0% 0% / 0),
    hsl(0 0% 0% / 1) 10%,
    hsl(0 0% 0% / 1) 90%,
    hsl(0 0% 0% / 0)
  );
  -webkit-mask-image: linear-gradient(
    to right,
    hsl(0 0% 0% / 0),
    hsl(0 0% 0% / 1) 10%,
    hsl(0 0% 0% / 1) 90%,
    hsl(0 0% 0% / 0)
  );
}

.pseo-marquee-container:hover .pseo-marquee__group {
  animation-play-state: paused;
}

.pseo-marquee__group {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-around;
  gap: var(--gap);
  min-width: 100%;
  animation: pseo-scroll var(--duration) linear infinite;
  will-change: transform;
  animation-play-state: running;
}

.pseo-marquee__group img {
  max-width: clamp(8rem, 20vw, 20rem);
  aspect-ratio: 1;
  object-fit: cover;
  border-radius: 1rem;
  width: 100%;
  height: auto;
  flex-shrink: 0;
}

@keyframes pseo-scroll {
  0%{
    transform: translateX(0);
  }
  100% {
    transform: translateX(calc(-100% - var(--gap)));
  }
}

@media (prefers-reduced-motion: reduce) {
  .pseo-marquee__group {
    animation-play-state: paused;
  }
}

details > summary {
  list-style: none;
}
details > summary::-webkit-details-marker {
  display: none;
}

/* CHANGE 16: Added RTL-specific styles for better text rendering */
[dir="rtl"] h1,
[dir="rtl"] h2,
[dir="rtl"] h3,
[dir="rtl"] h4,
[dir="rtl"] h5,
[dir="rtl"] h6,
[dir="rtl"] p,
[dir="rtl"] span,
[dir="rtl"] label {
  letter-spacing: 0;
}

/* CHANGE 17: Fix marquee animation direction for RTL */
[dir="rtl"] .pseo-marquee {
  mask-image: linear-gradient(
    to left,
    hsl(0 0% 0% / 0),
    hsl(0 0% 0% / 1) 10%,
    hsl(0 0% 0% / 1) 90%,
    hsl(0 0% 0% / 0)
  );
  -webkit-mask-image: linear-gradient(
    to left,
    hsl(0 0% 0% / 0),
    hsl(0 0% 0% / 1) 10%,
    hsl(0 0% 0% / 1) 90%,
    hsl(0 0% 0% / 0)
  );
}

[dir="rtl"] @keyframes pseo-scroll {
  0%{
    transform: translateX(0);
  }
  100% {
    transform: translateX(calc(100% + var(--gap)));
  }
}
</style>

<script define:vars={{ alerts: formAlertMessages }}>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('section.py-16.bg-gray-50 form');
  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const emailInput = form.querySelector('input[type="email"]');
      // Basic check, consider more robust validation
      if (emailInput && (!emailInput.value || !emailInput.value.includes('@'))) { 
        alert(alerts.invalidEmail); 
        return;
      }

      const termsCheckbox = form.querySelector('#terms');
      if (termsCheckbox && !termsCheckbox.checked) {
        alert(alerts.termsNotAccepted);
        return;
      }

      try {
        // Form submission logic here (e.g., send data to a server)
        // For now, we just show the success message
        console.log('Form data would be submitted here.');
        alert(alerts.submissionSuccess);
        form.reset();
      } catch (error) {
        console.error('Form submission error:', error);
        alert(alerts.submissionError);
      }
    });
  }
});
</script>
#####

And here's my CORRECTLY REFACTORED code:
######
---
import path from 'path';
import Database from 'better-sqlite3';
import BaseLayout from '../../layouts/BaseLayout.astro';

// --- Database Connection ---
const dbPath = path.join(process.cwd(), 'src/data/data.db');
const db = new Database(dbPath, { readonly: true });

// --- Interface Definitions (Unchanged) ---
interface HeroData {
  title: string;
  subtitle: string;
  ctaText: string;
  ctaLink: string;
  features: string[];
  socialProof: {
    text: string;
    rating: number; 
    userPhotos: string[];
  };
  ogImage?: string;
}

interface Product {
  title: string;
  image: string;
  url: string;
}

interface FeatureItem {
  icon: string;
  title: string;
  description: string;
}

interface FaqItem {
  question: string;
  answer: string;
}

interface MarqueeItem {
  url: string;
  image: string;
  alt: string;
}

interface FormAlerts {
  invalidEmail: string;
  termsNotAccepted: string;
  submissionSuccess: string;
  submissionError: string;
}

// Get the locale from the URL path
const locale = Astro.url.pathname.split('/')[1];

// --- Data Fetching from Database ---
// Fetch all required data in a single, efficient transaction.
const { home, common, www, bestsellers, publishedLocales } = db.transaction(() => {
    // Fetch homepage-specific content for the current locale
    const homeData = db.prepare('SELECT * FROM home WHERE M_SLUG = ?').get(locale);
    
    // Fetch common translations and settings for the current locale
    const commonData = db.prepare('SELECT * FROM common WHERE M_SLUG = ?').get(locale);
    
    // Fetch global site data from the 'www' table
    const wwwData = db.prepare('SELECT * FROM www LIMIT 1').get();
    
    // Fetch the top 9 bestsellers for the current locale, sorted by importance.
    // Casting PRODUCT_IMPORTANCE_RANK to an integer ensures correct numeric sorting.
    const bestsellerData = db.prepare(`
        SELECT * FROM product
        WHERE PUBLISH_Y_N = '1'
          AND PRODUCT_IS_BESTSELLER = '1'
          AND M_SLUG = ?
        ORDER BY CAST(PRODUCT_IMPORTANCE_RANK AS INTEGER) DESC
        LIMIT 9
    `).all(locale);

    // Fetch all published locales for the language switcher
    const localeData = db.prepare("SELECT M_SLUG FROM locale WHERE M_LOCALE_PUBLISH_Y_N = '1'").all();

    return { 
        home: homeData,
        common: commonData,
        www: wwwData,
        bestsellers: bestsellerData,
        publishedLocales: localeData
    };
})();

// --- Validation ---
// If essential data for the homepage (home or common) is not found, redirect to 404.
if (!home || !common) {
  return Astro.redirect('/404');
}

// --- Page Logic and Variable Definitions ---

// Helper functions for URL generation (unchanged).
const getAbsoluteUrl = (path: string) => {
    return new URL(`/${locale}${path}`, Astro.url.origin).toString();
};
const getBaseUrl = (path: string) => {
    return new URL(path, Astro.url.origin).toString();
};

// Language and orientation data
const languageIso: string = home.M_LANGUAGE_ISO;
const countryCode: string = home.M_COUNTRY_CODE;
const contentOrientation: string = common.M_CONTENT_ORIENTATION || 'ltr';

// --- Data for the Homepage ---

// Helper function for randomizing social proof images (unchanged).
const getRandomItems = <T,>(array: T[], count: number): T[] => {
  const shuffled = [...array].sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
};
const allSocialProofImages = [
  '/socialproof/sp1.webp', '/socialproof/sp2.webp', '/socialproof/sp3.webp',
  '/socialproof/sp4.webp', '/socialproof/sp5.webp', '/socialproof/sp6.webp',
  '/socialproof/sp7.webp', '/socialproof/sp8.webp', '/socialproof/sp9.webp',
  '/socialproof/sp10.webp', '/socialproof/sp11.webp', '/socialproof/sp12.webp',
  '/socialproof/sp13.webp', '/socialproof/sp14.webp', '/socialproof/sp15.webp',
  '/socialproof/sp16.webp', '/socialproof/sp17.webp', '/socialproof/sp18.webp',
  '/socialproof/sp19.webp', '/socialproof/sp20.webp', '/socialproof/sp21.webp',
  '/socialproof/sp22.webp', '/socialproof/sp23.webp', '/socialproof/sp24.webp'
];

// Hero section data
const heroData: HeroData = {
  title: home.HOME_H1,
  subtitle: home.HOME_SUBTITLE,
  ogImage: home.HOME_OG_IMAGE_PATH,
  ctaText: home.HOME_HERO_BUTTON,
  ctaLink: "#best-sellers",
  features: [
    home.HOME_HERO_BENEFIT_1,
    home.HOME_HERO_BENEFIT_2,
    home.HOME_HERO_BENEFIT_3
  ],
  socialProof: {
    text: home.HOME_HERO_SOCIAL_PROOF,
    rating: 5,
    userPhotos: getRandomItems(allSocialProofImages, 5)
  }
};

// Page keywords
const pageKeywords: string = [
  home.M_HOME_NAME,
  common.M_COUNTRY_NATIVE,
  www.PAGE_ORGANISATION_FULL_NAME
].join(', ');

// Use the pre-fetched and pre-sorted bestsellers array.
// Get top 5 products for marquee.
const marqueeItems = bestsellers
  .slice(0, 5)
  .map(product => ({
    url: getBaseUrl(`/${product.M_SLUG}/${product.PAGE_COLLECTION_1_LISTING_SLUG}/${product.PRODUCT_ASCII_SLUG}`),
    image: getBaseUrl(product.PRODUCT_IMAGE_PATH_L),
    alt: `${product.PAGE_COLLECTION_1_LISTING_SLUG_HELPER} â€” ${product.PRODUCT_NAME} | ${www.PAGE_ORGANISATION_FULL_NAME}`
  }));

// Get top 9 products for bestsellers section.
const bestsellersSection = {
  title: home.HOME_H2_1,
  productCtaText: home.HOME_HERO_BUTTON,
  products: bestsellers.map(product => ({
      title: `${product.PAGE_COLLECTION_1_LISTING_SLUG_HELPER} â€” ${product.PRODUCT_NAME}`,
      image: getBaseUrl(product.PRODUCT_IMAGE_PATH_L),
      alt: `${product.PAGE_COLLECTION_1_LISTING_SLUG_HELPER} â€” ${product.PRODUCT_NAME} | ${www.PAGE_ORGANISATION_FULL_NAME}`,
      url: getBaseUrl(`/${product.M_SLUG}/${product.PAGE_COLLECTION_1_LISTING_SLUG}/${product.PRODUCT_ASCII_SLUG}`)
    }))
};

// Features section data (unchanged).
const featuresSection = {
  title: home.HOME_H2_2,
  items: [
    { icon: "âš¡", title: home.HOME_FEATURE_NAME_1, description: home.HOME_FEATURE_LABEL_1 },
    { icon: "ðŸ”„", title: home.HOME_FEATURE_NAME_2, description: home.HOME_FEATURE_LABEL_2 },
    { icon: "ðŸ“¦", title: home.HOME_FEATURE_NAME_3, description: home.HOME_FEATURE_LABEL_3 }
  ] as FeatureItem[] 
};

// Institutions section data (unchanged).
const institutionsSection = {
  title: home.HOME_H2_4,
  items: [
    home.INSTITUTION_1, home.INSTITUTION_2, home.INSTITUTION_3,
    home.INSTITUTION_4, home.INSTITUTION_5, home.INSTITUTION_6
  ]
};

// FAQ section data (unchanged).
const faqSection = {
  title: home.HOME_H2_5,
  subtitle: home.HOME_FAQ_TEXT,
  items: [
    { question: home.HOME_Q1, answer: home.HOME_A1 }, { question: home.HOME_Q2, answer: home.HOME_A2 },
    { question: home.HOME_Q3, answer: home.HOME_A3 }, { question: home.HOME_Q4, answer: home.HOME_A4 },
    { question: home.HOME_Q5, answer: home.HOME_A5 }, { question: home.HOME_Q6, answer: home.HOME_A6 },
    { question: home.HOME_Q7, answer: home.HOME_A7 }, { question: home.HOME_Q8, answer: home.HOME_A8 },
    { question: home.HOME_Q9, answer: home.HOME_A9 }, { question: home.HOME_Q10, answer: home.HOME_A10 },
    { question: home.HOME_Q11, answer: home.HOME_A11 }, { question: home.HOME_Q12, answer: home.HOME_A12 },
    { question: home.HOME_Q13, answer: home.HOME_A13 }, { question: home.HOME_Q14, answer: home.HOME_A14 },
    { question: home.HOME_Q15, answer: home.HOME_A15 }
  ] as FaqItem[]
};

// Contact section data (unchanged).
const contactSection = {
  title: home.HOME_H2_6,
  subtitle: home.HOME_CONTACT_SUBTITLE,
  formLabels: {
    fullName: common.M_FULLNAME_PLACEHOLDER,
    fullNamePlaceholder: common.M_FULLNAME_PLACEHOLDER,
    email: common.M_EMAIL_ADDRESS_LABEL,
    emailPlaceholder: common.M_EMAIL_PLACEHOLDER,
    message: common.M_MESSAGE_LABEL,
    messagePlaceholder: common.M_PARTNERSHIP_MESSAGE_PLACEHOLDER,
    terms: common.M_TERMS_REQUIRED,
    submitButton: common.M_SEND_BUTTON
  }
};

// Form alert messages for client-side script (unchanged).
const formAlertMessages: FormAlerts = {
  invalidEmail: common.M_EMAIL_INVALID,
  termsNotAccepted: common.M_TERMS_REQUIRED,
  submissionSuccess: common.M_CONFIRMATION_TEXT,
  submissionError: common.M_FORM_ERROR
};

// --- Schema Definitions (Unchanged) ---
const webpageSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": home.HOME_H1,
  "url": Astro.url.href,
  "description": home.HOME_META_SEO,
  "inLanguage": `${home.M_LANGUAGE_ISO}-${home.M_COUNTRY_CODE}`,
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": home.M_HOME_NAME,
        "item": Astro.url.href
      }
    ]
  },
  "mainEntity": {
    "@type": "Article",
    "headline": home.HOME_H1,
    "description": home.HOME_META_SEO,
    "image": getBaseUrl(home.HOME_OG_IMAGE_PATH),
    "author": {
      "@type": "Organization",
      "name": www.PAGE_ORGANISATION_FULL_NAME
    },
    "datePublished": `${home.HOME_DATE_PUBLISHED}T${home.HOME_HOUR_PUBLISHED}+02:00`,
    "dateModified": `${home.HOME_DATE_UPDATED}T${home.HOME_HOUR_UPDATED}+02:00`,
    "inLanguage": `${home.M_LANGUAGE_ISO}-${home.M_COUNTRY_CODE}`
  }
};

const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqSection.items.map(item => ({
    "@type": "Question",
    "name": item.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": item.answer
    }
  }))
};

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": www.PAGE_ORGANISATION_FULL_NAME,
  "url": getBaseUrl('/'),
  "foundingDate": www.PAGE_FOUNDING_DATE,
  "logo": getBaseUrl(www.PAGE_LOGO_IMAGE_PATH_1),
  "keywords": [
    www.PAGE_ORGANISATION_FULL_NAME,
    common.M_COUNTRY_NATIVE,
    common.PAGE_KEYWORD_1,
    common.PAGE_KEYWORD_2,
    common.PAGE_KEYWORD_3,
    common.PAGE_KEYWORD_4,
    common.PAGE_KEYWORD_5,
    common.PAGE_KEYWORD_6
  ].filter(Boolean),
  "description": common.PAGE_SLOGAN,
  "numberOfEmployees": {
    "@type": "QuantitativeValue",
    "minValue": "1",
    "maxValue": "9"
  },
  "slogan": common.PAGE_SLOGAN,
  "contactPoint": {
    "@type": "ContactPoint",
    "email": www.PAGE_INFO_EMAIL,
    "contactType": common.M_CUSTOMER_SUPPORT
  },
  "sameAs": [
    www.PAGE_INSTAGRAM_URL,
    www.PAGE_FACEBOOK_URL,
    www.PAGE_TWITTER_URL,
    www.PAGE_LINKEDIN_URL,
    www.PAGE_YOUTUBE_URL,
    www.PAGE_PINTEREST_URL,
    www.PAGE_BLUESKY_URL
  ].filter(Boolean),
  "areaServed": {
    "@type": "Country",
    "name": common.M_COUNTRY,
    "identifier": common.M_COUNTRY_CODE
  },
  "potentialAction": [
    {
      "@type": "ViewAction",
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/sitemap.xml')
    },
    {
      "@type": "ViewAction",
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`)
    },
    {
      "@type": "ViewAction",
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "target": getBaseUrl('/llms.txt'),
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ],
  "mainEntityOfPage": [
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/sitemap.xml'),
      "name": `XML Sitemap for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a structured list of pages available on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl(`/sitemap-${languageIso}-${countryCode}.xml`),
      "name": `Localized XML Sitemap (${languageIso}-${countryCode}) for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `Provides a full and structured list of localized pages for ${languageIso} (${languageIso}-${countryCode}) locale on ${www.PAGE_ORGANISATION_FULL_NAME} for crawlers and AI agents.`
    },
    {
      "@type": "WebPage",
      "@id": getBaseUrl('/llms.txt'),
      "name": `LLM Guidance for ${www.PAGE_ORGANISATION_FULL_NAME}`,
      "description": `A text resource outlining key information about ${www.PAGE_ORGANISATION_FULL_NAME} offerings, company, products, services, and more for AI agents and AI crawlers.`
    }
  ]
};

const schema: object[] | null = [webpageSchema, faqSchema, organizationSchema];

// --- Final Props & Language Links ---
const pageTitle: string = home.HOME_H1;
const pageDescription: string | undefined = home.HOME_META_SEO;
const pageOgImage: string | undefined = home.HOME_OG_IMAGE_PATH;

// Build the language link map using the pre-fetched locales.
const languageLinksMap: Record<string, string> = {};
for (const l of publishedLocales) {
  languageLinksMap[l.M_SLUG] = `/${l.M_SLUG}`;
}
---

<BaseLayout 
  languageIso={languageIso} 
  countryCode={countryCode} 
  contentOrientation={contentOrientation} 
  title={pageTitle} 
  description={pageDescription} 
  ogImage={pageOgImage} 
  keywords={pageKeywords} 
  schema={schema}
  languageLinksMap={languageLinksMap}
>
  <!-- Hero Section -->
  <section class="bg-black text-white py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl">
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold leading-tight mb-4">
          {heroData.title}
        </h1>
        <p class="text-xl md:text-2xl text-gray-300 mb-6 leading-relaxed">
          {heroData.subtitle}
        </p>
        
        <ul class="space-y-2 mb-6">
          {heroData.features.map(feature => (
            <li class="flex items-center gap-2">
              <span class="text-signal-green">âœ“</span>
              <span class="text-lg">{feature}</span>
            </li>
          ))}
        </ul>
        
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4 mb-8">
          <div class="flex -space-x-3 rtl:space-x-reverse mb-2 sm:mb-0">
            {heroData.socialProof.userPhotos.map(photo => (
              <img 
                src={photo} 
                alt="User Testimonial" 
                class="w-10 h-10 rounded-full border-2 border-black"
                width="50"
                height="50"
                loading="lazy"
                decoding="async"
              />
            ))}
          </div>
          <p class="text-lg text-signal-green">{heroData.socialProof.text}</p>
        </div>
        
        <a 
          href={heroData.ctaLink} 
          class="inline-block bg-signal-green text-black font-semibold ps-8 pe-8 py-3 hover:bg-signal-green hover:text-black transition-colors"
        >
          {heroData.ctaText}
        </a>
      </div>
    </div>

    <!-- Marquee Section -->
    <div class="overflow-x-hidden width-100 relative mt-12">
      <div class="pseo-marquee-container">
        <div class="pseo-marquee">
          <div class="pseo-marquee__group">
            {[...Array(2)].map(() => (
              <div class="flex gap-4">
                {marqueeItems.map(item => (
                  <a href={item.url}>
                    <img 
                      src={item.image} 
                      alt={item.alt} 
                      width="50" 
                      height="50" 
                      loading="lazy"
                      decoding="async"
                    />
                  </a>
                ))}
              </div>
            ))}
          </div>
          <div aria-hidden="true" class="pseo-marquee__group">
            {[...Array(2)].map(() => (
              <div class="flex gap-4">
                {marqueeItems.map(item => (
                  <a href={item.url}>
                    <img 
                      src={item.image} 
                      alt={item.alt}
                      width="50" 
                      height="50" 
                      loading="lazy"
                      decoding="async"
                    />
                  </a>
                ))}
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Bestsellers Section -->
  <section id="best-sellers" class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-black mb-12 text-center">{bestsellersSection.title}</h2>
      <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
        {bestsellersSection.products.map(product => (
          <div class="bg-white border border-gray-100 overflow-hidden group">
            <a href={product.url} class="block">
              <img 
                src={product.image} 
                alt={product.alt}
                class="w-full h-56 object-contain p-4"
                width="225"
                height="225"
                loading="lazy"
                decoding="async"
              />
              <div class="p-4 border-t border-gray-100">
                <h3 class="font-medium text-black group-hover:text-signal-green transition-colors mb-4">
                  {product.title}
                </h3>
                <span class="block w-full bg-black text-signal-green border border-signal-green py-2 ps-4 pe-4 hover:bg-signal-green hover:text-black transition-all text-center">
                  {bestsellersSection.productCtaText}
                </span>
              </div>
            </a>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Features Section -->
  <section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-black mb-12 text-center">{featuresSection.title}</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {featuresSection.items.map(feature => (
          <div class="text-center p-6 bg-white rounded-lg shadow-sm">
            <div class="text-4xl mb-4">{feature.icon}</div>
            <h3 class="text-xl font-semibold mb-2">{feature.title}</h3>
            <p class="text-gray-600">{feature.description}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Institutions Section -->
  <section class="py-16 bg-black">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-white mb-12 text-center">
        {institutionsSection.title}
      </h2>
      <div class="flex flex-wrap justify-center items-center gap-12">
        {institutionsSection.items.map(institution => (
          <div class="text-xl font-medium text-signal-green">
            {institution}
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-black mb-4 text-center">{faqSection.title}</h2>
      <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">{faqSection.subtitle}</p>
      <div class="max-w-3xl mx-auto space-y-4">
        {faqSection.items.map(item => (
          <details class="bg-gray-50 rounded-lg group">
            <summary class="p-4 cursor-pointer font-medium flex items-center justify-between">
              <span>{item.question}</span>
              <svg 
                class="w-5 h-5 transform transition-transform group-open:rotate-180" 
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </summary>
            <div class="p-4 pt-0 text-gray-600">
              {item.answer}
            </div>
          </details>
        ))}
      </div>
    </div>
  </section>

  <!-- Contact Section -->
  <section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
      <h2 class="text-3xl font-bold text-black mb-4 text-center">{contactSection.title}</h2>
      <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">
        {contactSection.subtitle}
      </p>

      <div class="max-w-2xl mx-auto">
        <form class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">{contactSection.formLabels.fullName}</label>
            <input 
              type="text" 
              placeholder={contactSection.formLabels.fullNamePlaceholder}
              class="w-full ps-4 pe-4 py-2 rounded-lg border border-gray-300 focus:border-signal-green focus:ring-1 focus:ring-signal-green" 
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">{contactSection.formLabels.email}</label>
            <input 
              type="email" 
              placeholder={contactSection.formLabels.emailPlaceholder}
              class="w-full ps-4 pe-4 py-2 rounded-lg border border-gray-300 focus:border-signal-green focus:ring-1 focus:ring-signal-green" 
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">{contactSection.formLabels.message}</label>
            <textarea 
              rows="4" 
              placeholder={contactSection.formLabels.messagePlaceholder}
              class="w-full ps-4 pe-4 py-2 rounded-lg border border-gray-300 focus:border-signal-green focus:ring-1 focus:ring-signal-green"
              required
            ></textarea>
          </div>
          <div class="flex items-center gap-2">
            <input type="checkbox" id="terms" required />
            <label for="terms" class="text-sm text-gray-600">
              {contactSection.formLabels.terms}
            </label>
          </div>
          <button 
            type="submit" 
            class="w-full bg-black text-signal-green border border-signal-green py-3 rounded-lg hover:bg-signal-green hover:text-black transition-all"
          >
            {contactSection.formLabels.submitButton}
          </button>
        </form>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
.pseo-marquee-container {
  --space: clamp(1rem, 2vw, 2rem);
  --gap: var(--space);
  --duration: 25s;
  position: relative;
  width: 100%;
  max-width: 100vw;
  overflow-x: hidden;
  padding: 20px 0;
  box-sizing: border-box;
}

.pseo-marquee {
  display: flex;
  overflow: hidden;
  user-select: none;
  gap: var(--gap);
  width: 100%;
  margin: 0;
  padding: 0;
  mask-image: linear-gradient(
    to right,
    hsl(0 0% 0% / 0),
    hsl(0 0% 0% / 1) 10%,
    hsl(0 0% 0% / 1) 90%,
    hsl(0 0% 0% / 0)
  );
  -webkit-mask-image: linear-gradient(
    to right,
    hsl(0 0% 0% / 0),
    hsl(0 0% 0% / 1) 10%,
    hsl(0 0% 0% / 1) 90%,
    hsl(0 0% 0% / 0)
  );
}

.pseo-marquee-container:hover .pseo-marquee__group {
  animation-play-state: paused;
}

.pseo-marquee__group {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-around;
  gap: var(--gap);
  min-width: 100%;
  animation: pseo-scroll var(--duration) linear infinite;
  will-change: transform;
  animation-play-state: running;
}

.pseo-marquee__group img {
  max-width: clamp(8rem, 20vw, 20rem);
  aspect-ratio: 1;
  object-fit: cover;
  border-radius: 1rem;
  width: 100%;
  height: auto;
  flex-shrink: 0;
}

@keyframes pseo-scroll {
  0%{
    transform: translateX(0);
  }
  100% {
    transform: translateX(calc(-100% - var(--gap)));
  }
}

@media (prefers-reduced-motion: reduce) {
  .pseo-marquee__group {
    animation-play-state: paused;
  }
}

details > summary {
  list-style: none;
}
details > summary::-webkit-details-marker {
  display: none;
}

/* RTL-specific styles */
[dir="rtl"] h1,
[dir="rtl"] h2,
[dir="rtl"] h3,
[dir="rtl"] h4,
[dir="rtl"] h5,
[dir="rtl"] h6,
[dir="rtl"] p,
[dir="rtl"] span,
[dir="rtl"] label {
  letter-spacing: 0;
}

[dir="rtl"] .pseo-marquee {
  mask-image: linear-gradient(
    to left,
    hsl(0 0% 0% / 0),
    hsl(0 0% 0% / 1) 10%,
    hsl(0 0% 0% / 1) 90%,
    hsl(0 0% 0% / 0)
  );
  -webkit-mask-image: linear-gradient(
    to left,
    hsl(0 0% 0% / 0),
    hsl(0 0% 0% / 1) 10%,
    hsl(0 0% 0% / 1) 90%,
    hsl(0 0% 0% / 0)
  );
}

[dir="rtl"] @keyframes pseo-scroll {
  0%{
    transform: translateX(0);
  }
  100% {
    transform: translateX(calc(100% + var(--gap)));
  }
}
</style>

<script define:vars={{ alerts: formAlertMessages }}>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('section.py-16.bg-gray-50 form');
  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const emailInput = form.querySelector('input[type="email"]');
      if (emailInput && (!emailInput.value || !emailInput.value.includes('@'))) { 
        alert(alerts.invalidEmail); 
        return;
      }

      const termsCheckbox = form.querySelector('#terms');
      if (termsCheckbox && !termsCheckbox.checked) {
        alert(alerts.termsNotAccepted);
        return;
      }

      try {
        console.log('Form data would be submitted here.');
        alert(alerts.submissionSuccess);
        form.reset();
      } catch (error) {
        console.error('Form submission error:', error);
        alert(alerts.submissionError);
      }
    });
  }
});
</script>
######

Here's the json-to-db.mjs script so you see how tdata.db is built:
#######
import { readdir, readFile, rm } from 'fs/promises';
import path from 'path';
import Database from 'better-sqlite3';

// --- Configuration ---
const DATA_DIR = path.join(process.cwd(), 'src/data');
const DB_PATH = path.join(DATA_DIR, 'data.db');
const FILE_TO_EXCLUDE = 'site.webmanifest.json';

/**
 * Creates a SQLite database from JSON files in the src/data directory.
 * @param {import('astro').AstroLogger} logger - The Astro logger instance.
 */
export async function createDatabaseFromJson(logger) {
  logger.info('ðŸš€ Starting database creation from JSON files...');

  try {
    // 1. Clean up the old database file to ensure a fresh start.
    logger.info(`Removing old database if it exists: ${DB_PATH}`);
    await rm(DB_PATH, { force: true });

    // 2. Initialize a new SQLite database.
    const db = new Database(DB_PATH);
    logger.info('Database initialized.');

    // 3. Get all JSON files from the data directory, excluding the manifest.
    const allFiles = await readdir(DATA_DIR);
    const jsonFiles = allFiles.filter(
      file => file.endsWith('.json') && file !== FILE_TO_EXCLUDE
    );

    // 4. Process each JSON file and create a table for it.
    for (const fileName of jsonFiles) {
      const sourcePath = path.join(DATA_DIR, fileName);
      const tableName = path.basename(fileName, '.json');

      const fileContent = await readFile(sourcePath, 'utf-8');
      const data = JSON.parse(fileContent);

      // Skip if the JSON file is empty or not an array of objects.
      if (!Array.isArray(data) || data.length === 0) {
        logger.warn(`Skipping ${fileName}: No data to process.`);
        continue;
      }
      
      // Dynamically determine columns from the first object's keys.
      const columns = Object.keys(data[0]);
      if (columns.length === 0) {
          logger.warn(`Skipping ${tableName}: First object has no keys.`);
          continue;
      }

      // Create the table schema. Using TEXT is safest for dynamic data.
      // Backticks ` ` are used to safely handle column/table names that might be SQL keywords.
      const createTableStmt = `
        CREATE TABLE IF NOT EXISTS \`${tableName}\` (
          ${columns.map(col => `\`${col}\` TEXT`).join(',\n          ')}
        );
      `;
      db.exec(createTableStmt);

      // Prepare an efficient INSERT statement.
      const insert = db.prepare(
        `INSERT INTO \`${tableName}\` (${columns.map(c => `\`${c}\``).join(', ')}) 
         VALUES (${columns.map(() => '?').join(', ')})`
      );

      // Use a transaction for bulk inserts, which is significantly faster.
      const insertMany = db.transaction((rows) => {
        for (const row of rows) {
          // Ensure values are in the same order as columns.
          const values = columns.map(col => {
            const value = row[col];
            // SQLite can handle numbers, but stringifying objects/arrays is safer.
            if (typeof value === 'object' && value !== null) {
              return JSON.stringify(value);
            }
            return value;
          });
          insert.run(...values);
        }
      });
      
      insertMany(data);

      logger.info(`âœ… Created table \`${tableName}\` and inserted ${data.length} rows.`);
    }
    
    // 5. Close the database connection.
    db.close();
    logger.info('âœ¨ Database creation complete! `data.db` is ready in src/data/.');

  } catch (error) {
    logger.error('âŒ Error during database creation:', error);
    process.exit(1); // Exit with an error code
  }
}
#######

Now here's old way of me writing src\scripts\OG_eeat.mjs code:
########
import { readFileSync } from 'fs';
import { mkdir, rm } from 'fs/promises';
import path from 'path';
import { chromium } from 'playwright';
import sharp from 'sharp';
import pLimit from 'p-limit';

// --- CONFIGURATION ---
const CWD = process.cwd();
const PUBLIC_DIR = path.join(CWD, 'public');
const OUTPUT_DIR = path.join(PUBLIC_DIR, 'ogimages', 'ogeeat');
const CONCURRENCY = 10;

// --- FONT CONFIGURATION ---
// Maps language ISO codes to their specific Google Font URL and font-family stack.
const FONT_MAP = {
    ar: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap', family: "'Noto Sans Arabic', 'Tahoma', sans-serif" },
    he: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;700&display=swap', family: "'Noto Sans Hebrew', 'Arial Hebrew', sans-serif" },
    hi: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap', family: "'Noto Sans Devanagari', 'Arial Unicode MS', sans-serif" },
    ja: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap', family: "'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif" },
    ko: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap', family: "'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif" },
    ru: { url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap', family: "'Roboto', 'Arial', sans-serif" },
    be: { url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap', family: "'Roboto', 'Arial', sans-serif" },
    bg: { url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap', family: "'Roboto', 'Arial', sans-serif" },
    el: { url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap', family: "'Roboto', 'Arial', sans-serif" },
    th: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap', family: "'Noto Sans Thai', 'Thonburi', 'Tahoma', sans-serif" },
    bn: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&display=swap', family: "'Noto Sans Bengali', 'Arial Unicode MS', sans-serif" },
    hy: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Armenian:wght@400;700&display=swap', family: "'Noto Sans Armenian', 'Arial Unicode MS', sans-serif" },
    ka: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;700&display=swap', family: "'Noto Sans Georgian', 'Arial Unicode MS', sans-serif" },
    my: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;700&display=swap', family: "'Noto Sans Myanmar', 'Arial Unicode MS', sans-serif" },
    // Default font for Latin scripts and others not specified
    default: { url: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap', family: "'Inter', system-ui, sans-serif" }
};

import { 
  AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ, 
  CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG, 
  ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT, 
  HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV, 
  LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ, 
  OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL, 
  SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA 
} from 'country-flag-icons/string/3x2';

const flagMap = { AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ, CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG, ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT, HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV, LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ, OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL, SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA };

// --- HELPER FUNCTIONS ---
const readJsonFile = (filePath) => JSON.parse(readFileSync(path.join(CWD, filePath), 'utf-8'));
const readImageAsBase64 = (filePath) => readFileSync(path.join(CWD, filePath), 'base64');

// --- HTML TEMPLATE GENERATOR ---
const generateEeatHtmlTemplate = (data) => `
<!DOCTYPE html>
<html lang="${data.lang}" dir="${data.orientation}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EEAT OG Image</title>
    <style>
        @import url('${data.fontUrl}');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { width: 1200px; height: 630px; margin: 0; font-family: ${data.fontFamily}; background-color: ${data.bodyBgColor}; color: ${data.bodyTextColor}; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .logo { width: 350px; height: auto; margin: 1rem auto; flex-shrink: 0; }
        .text-container { width: 100%; padding: 20px 10px; background-color: ${data.headerBgColor}; text-align: center; font-size: 4rem; font-weight: 700; color: ${data.headerTextColor}; margin-bottom: 3.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-top: 1px solid #dcdcdc; border-bottom: 1px solid #dcdcdc; display: flex; align-items: center; justify-content: center; min-height: 150px; line-height: 1.1; }
        .features { list-style: none; display: flex; flex-direction: column; gap: 1rem; padding: 0 4rem; width: 100%; margin-top: auto; padding-bottom: 120px; }
        .feature { display: flex; align-items: center; gap: 0.75rem; font-size: 2.6rem; color: ${data.featureTextColor}; container-type: inline-size; }
        .feature-icon { width: clamp(1.5rem, 5cqi, 2.75rem); height: clamp(1.5rem, 5cqi, 2.75rem); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='35px' height='35px' viewBox='0 0 56 56'%3E%3Cpath fill='${encodeURIComponent(data.iconColor)}' d='M28 51.906c13.055 0 23.906-10.828 23.906-23.906c0-13.055-10.875-23.906-23.93-23.906C14.899 4.094 4.095 14.945 4.095 28c0 13.078 10.828 23.906 23.906 23.906m0-3.984C16.937 47.922 8.1 39.062 8.1 28c0-11.04 8.813-19.922 19.876-19.922c11.039 0 19.921 8.883 19.945 19.922c.023 11.063-8.883 19.922-19.922 19.922m-2.953-8.203c.773 0 1.406-.375 1.898-1.102l11.578-18.21c.282-.47.563-1.009.563-1.524c0-1.078-.938-1.735-1.922-1.735c-.633 0-1.219.352-1.64 1.055L24.93 35.148l-5.438-7.03c-.515-.704-1.078-.962-1.71-.962c-1.032 0-1.852.844-1.852 1.899c0 .515.21 1.008.539 1.453l6.562 8.11c.633.773 1.242 1.1 2.016 1.1'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-size: contain; flex-shrink: 0; }
        .feature-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .footer { position: absolute; bottom: 0; left: 0; right: 0; height: 70px; background-color: ${data.footerBgColor}; padding: 0 1rem; display: flex; justify-content: center; align-items: center; color: ${data.footerTextColor}; gap: 2rem; }
        .footer-item { display: flex; align-items: center; gap: 0.75rem; font-weight: 700; white-space: nowrap; }
        .footer-icon { width: 4.25rem; height: 4.25rem; fill: currentColor; flex-shrink: 0; }
        .footer-text { font-size: clamp(1.65rem, 4cqi, 3rem); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 1rem); }
        .flag-container { 
            position: absolute; 
            top: 1rem; 
            ${data.orientation === 'rtl' ? 'left: 1rem;' : 'right: 1rem;'}
            background: white; 
            padding: 0.75rem; 
            border-radius: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            width: 8rem; 
            height: 5.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .flag-container img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>
    <div class="flag-container"><img src="data:image/svg+xml;utf8,${encodeURIComponent(data.flagSvg)}" alt="Country flag"></div>
    <img src="data:image/png;base64,${data.logoBase64}" alt="Logo" class="logo">
    <div class="text-container">${data.title}</div>
    <ul class="features">
        <li class="feature"><span class="feature-icon"></span><div class="feature-text">${data.feature1}</div></li>
        <li class="feature"><span class="feature-icon"></span><div class="feature-text">${data.feature2}</div></li>
        <li class="feature"><span class="feature-icon"></span><div class="feature-text">${data.feature3}</div></li>
    </ul>
    <footer class="footer">
        <div class="footer-item">
            <svg class="footer-icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
            <span class="footer-text">${data.email}</span>
        </div>
    </footer>
</body>
</html>`;

async function generateImageForEeat(eeat, commonAssets, context) {
    const baseName = `${eeat.PAGE_ID}-${eeat.EEAT_IMAGE_NAME_ASCII}`;
    const imageName = baseName.replace(/\.webp$/i, '') + '.webp';
    const { brandingData, logoBase64 } = commonAssets;

    // Determine font and orientation based on locale
    const langIso = eeat.M_LANGUAGE_ISO || 'en'; // Fallback for safety
    const fontDetails = FONT_MAP[langIso] || FONT_MAP.default;
    const orientation = eeat.M_CONTENT_ORIENTATION || 'ltr';

    const dataForTemplate = {
        lang: langIso,
        orientation: orientation,
        fontUrl: fontDetails.url,
        fontFamily: fontDetails.family,
        title: eeat.EEAT_H1,
        feature1: eeat.PAGE_SOCIAL_SHARING_FEATURE_1,
        feature2: eeat.PAGE_SOCIAL_SHARING_FEATURE_2,
        feature3: eeat.PAGE_SOCIAL_SHARING_FEATURE_3,
        email: brandingData.PAGE_INFO_EMAIL,
        flagSvg: flagMap[eeat.M_COUNTRY_CODE] || '',
        logoBase64: logoBase64,
        bodyBgColor: brandingData.PAGE_COLOR_BACKGROUND,
        bodyTextColor: brandingData.PAGE_COLOR_PRIMARY,
        headerBgColor: brandingData.PAGE_COLOR_PRIMARY,
        headerTextColor: brandingData.PAGE_COLOR_SECONDARY,
        featureTextColor: brandingData.PAGE_COLOR_PRIMARY,
        footerBgColor: brandingData.PAGE_COLOR_PRIMARY,
        footerTextColor: brandingData.PAGE_COLOR_ACCENT,
        iconColor: brandingData.PAGE_COLOR_ACCENT_BRIGHT,
    };

    const htmlContent = generateEeatHtmlTemplate(dataForTemplate);
    const page = await context.newPage();
    
    try {
        await page.setViewportSize({ width: 1200, height: 630 });
        // Use 'networkidle' to ensure web fonts from Google are loaded before screenshotting
        await page.setContent(htmlContent, { waitUntil: 'networkidle' });
        const pngBuffer = await page.screenshot({ type: 'png' });
        const outputPath = path.join(OUTPUT_DIR, imageName);
        await sharp(pngBuffer).webp({ quality: 1 }).toFile(outputPath);
    } finally {
        await page.close();
    }
}

async function main() {
    console.log('ðŸš€ Starting EEAT page OG image generation...');
    let browser;
    try {
        console.log(`ðŸ§¹ Clearing destination directory: ${OUTPUT_DIR}`);
        await rm(OUTPUT_DIR, { recursive: true, force: true });
        await mkdir(OUTPUT_DIR, { recursive: true });

        const eeatData = readJsonFile('src/data/eeat.json').filter(p => p.PUBLISH_Y_N === "1");
        const wwwData = readJsonFile('src/data/www.json');
        
        const brandingData = wwwData[0];
        const logoPath = brandingData.PAGE_LOGO_IMAGE_PATH_5;

        if (!brandingData || !logoPath) {
            throw new Error('Could not find required branding or logo data in JSON files.');
        }

        const commonAssets = {
            brandingData,
            logoBase64: readImageAsBase64(logoPath)
        };

        browser = await chromium.launch();
        const context = await browser.newContext();

        const limit = pLimit(CONCURRENCY);
        const totalItems = eeatData.length;
        
        const tasks = eeatData.map((eeat) => 
            limit(() => generateImageForEeat(eeat, commonAssets, context))
        );
        const results = await Promise.allSettled(tasks);

        const successful = results.filter(r => r.status === 'fulfilled').length;
        const failed = results.filter(r => r.status === 'rejected');

        console.log('\nâœ¨ EEAT OG image generation complete!');
        console.log(`ðŸŸ¢ Success: ${successful}/${totalItems}`);
        if (failed.length > 0) {
            console.error(`ðŸ”´ Failed: ${failed.length}/${totalItems}`);
            failed.forEach((fail, index) => {
                console.error(`  - Failure ${index + 1}:`, fail.reason.message);
            });
            process.exitCode = 1;
        }
    } catch (error) {
        console.error('âŒ A critical error occurred during the process:', error);
        process.exit(1);
    } finally {
        if (browser) await browser.close();
    }
}

main();
########

And here's the NEW, CORRECTLY REFACTORED way of src\scripts\OG_eeat.mjs code:
#########
import { mkdir, rm, readFileSync } from 'fs/promises';
import path from 'path';
import Database from 'better-sqlite3';
import { chromium } from 'playwright';
import sharp from 'sharp';
import pLimit from 'p-limit';

// --- CONFIGURATION ---
const CWD = process.cwd();
const PUBLIC_DIR = path.join(CWD, 'public');
const DB_PATH = path.join(CWD, 'src/data/data.db');
const OUTPUT_DIR = path.join(PUBLIC_DIR, 'ogimages', 'ogeeat');
const CONCURRENCY = 10;

// --- FONT CONFIGURATION ---
// Maps language ISO codes to their specific Google Font URL and font-family stack.
const FONT_MAP = {
    ar: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap', family: "'Noto Sans Arabic', 'Tahoma', sans-serif" },
    he: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;700&display=swap', family: "'Noto Sans Hebrew', 'Arial Hebrew', sans-serif" },
    hi: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap', family: "'Noto Sans Devanagari', 'Arial Unicode MS', sans-serif" },
    ja: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap', family: "'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif" },
    ko: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap', family: "'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif" },
    ru: { url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap', family: "'Roboto', 'Arial', sans-serif" },
    be: { url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap', family: "'Roboto', 'Arial', sans-serif" },
    bg: { url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap', family: "'Roboto', 'Arial', sans-serif" },
    el: { url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap', family: "'Roboto', 'Arial', sans-serif" },
    th: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap', family: "'Noto Sans Thai', 'Thonburi', 'Tahoma', sans-serif" },
    bn: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&display=swap', family: "'Noto Sans Bengali', 'Arial Unicode MS', sans-serif" },
    hy: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Armenian:wght@400;700&display=swap', family: "'Noto Sans Armenian', 'Arial Unicode MS', sans-serif" },
    ka: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;700&display=swap', family: "'Noto Sans Georgian', 'Arial Unicode MS', sans-serif" },
    my: { url: 'https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;700&display=swap', family: "'Noto Sans Myanmar', 'Arial Unicode MS', sans-serif" },
    // Default font for Latin scripts and others not specified
    default: { url: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap', family: "'Inter', system-ui, sans-serif" }
};

import { 
  AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ, 
  CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG, 
  ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT, 
  HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV, 
  LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ, 
  OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL, 
  SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA 
} from 'country-flag-icons/string/3x2';

const flagMap = { AE, AL, AM, AO, AR, AT, AU, AZ, BA, BD, BE, BG, BH, BJ, BO, BR, BS, BW, BY, BZ, CA, CG, CH, CI, CL, CM, CO, CR, CU, CW, CY, CZ, DE, DJ, DK, DO, DZ, EC, EE, EG, ES, FI, FJ, FR, GA, GB, GE, GH, GI, GM, GN, GP, GR, GT, GU, GY, HK, HN, HR, HT, HU, ID, IE, IL, IN, IS, IT, JM, JO, JP, KE, KR, KW, KY, LB, LI, LS, LT, LU, LV, LY, MA, MC, MD, ME, MK, MM, MN, MR, MU, MW, MX, MY, MZ, NG, NI, NL, NO, NP, NZ, OM, PA, PE, PH, PK, PL, PR, PT, PY, QA, RO, RS, RU, SA, SB, SE, SG, SI, SK, SL, SM, SN, SR, SV, SZ, TD, TH, TN, TR, TT, UA, UG, US, UY, VE, VN, YT, ZA };

// --- HELPER FUNCTIONS ---
// Reads an image file and encodes it to Base64. (No JSON reader needed anymore).
const readImageAsBase64 = (filePath) => readFileSync(path.join(CWD, filePath), { encoding: 'base64' });

// --- HTML TEMPLATE GENERATOR ---
const generateEeatHtmlTemplate = (data) => `
<!DOCTYPE html>
<html lang="${data.lang}" dir="${data.orientation}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EEAT OG Image</title>
    <style>
        @import url('${data.fontUrl}');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { width: 1200px; height: 630px; margin: 0; font-family: ${data.fontFamily}; background-color: ${data.bodyBgColor}; color: ${data.bodyTextColor}; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .logo { width: 350px; height: auto; margin: 1rem auto; flex-shrink: 0; }
        .text-container { width: 100%; padding: 20px 10px; background-color: ${data.headerBgColor}; text-align: center; font-size: 4rem; font-weight: 700; color: ${data.headerTextColor}; margin-bottom: 3.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-top: 1px solid #dcdcdc; border-bottom: 1px solid #dcdcdc; display: flex; align-items: center; justify-content: center; min-height: 150px; line-height: 1.1; }
        .features { list-style: none; display: flex; flex-direction: column; gap: 1rem; padding: 0 4rem; width: 100%; margin-top: auto; padding-bottom: 120px; }
        .feature { display: flex; align-items: center; gap: 0.75rem; font-size: 2.6rem; color: ${data.featureTextColor}; container-type: inline-size; }
        .feature-icon { width: clamp(1.5rem, 5cqi, 2.75rem); height: clamp(1.5rem, 5cqi, 2.75rem); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='35px' height='35px' viewBox='0 0 56 56'%3E%3Cpath fill='${encodeURIComponent(data.iconColor)}' d='M28 51.906c13.055 0 23.906-10.828 23.906-23.906c0-13.055-10.875-23.906-23.93-23.906C14.899 4.094 4.095 14.945 4.095 28c0 13.078 10.828 23.906 23.906 23.906m0-3.984C16.937 47.922 8.1 39.062 8.1 28c0-11.04 8.813-19.922 19.876-19.922c11.039 0 19.921 8.883 19.945 19.922c.023 11.063-8.883 19.922-19.922 19.922m-2.953-8.203c.773 0 1.406-.375 1.898-1.102l11.578-18.21c.282-.47.563-1.009.563-1.524c0-1.078-.938-1.735-1.922-1.735c-.633 0-1.219.352-1.64 1.055L24.93 35.148l-5.438-7.03c-.515-.704-1.078-.962-1.71-.962c-1.032 0-1.852.844-1.852 1.899c0 .515.21 1.008.539 1.453l6.562 8.11c.633.773 1.242 1.1 2.016 1.1'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-size: contain; flex-shrink: 0; }
        .feature-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .footer { position: absolute; bottom: 0; left: 0; right: 0; height: 70px; background-color: ${data.footerBgColor}; padding: 0 1rem; display: flex; justify-content: center; align-items: center; color: ${data.footerTextColor}; gap: 2rem; }
        .footer-item { display: flex; align-items: center; gap: 0.75rem; font-weight: 700; white-space: nowrap; }
        .footer-icon { width: 4.25rem; height: 4.25rem; fill: currentColor; flex-shrink: 0; }
        .footer-text { font-size: clamp(1.65rem, 4cqi, 3rem); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 1rem); }
        .flag-container { 
            position: absolute; 
            top: 1rem; 
            ${data.orientation === 'rtl' ? 'left: 1rem;' : 'right: 1rem;'}
            background: white; 
            padding: 0.75rem; 
            border-radius: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            width: 8rem; 
            height: 5.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .flag-container img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>
    <div class="flag-container"><img src="data:image/svg+xml;utf8,${encodeURIComponent(data.flagSvg)}" alt="Country flag"></div>
    <img src="data:image/png;base64,${data.logoBase64}" alt="Logo" class="logo">
    <div class="text-container">${data.title}</div>
    <ul class="features">
        <li class="feature"><span class="feature-icon"></span><div class="feature-text">${data.feature1}</div></li>
        <li class="feature"><span class="feature-icon"></span><div class="feature-text">${data.feature2}</div></li>
        <li class="feature"><span class="feature-icon"></span><div class="feature-text">${data.feature3}</div></li>
    </ul>
    <footer class="footer">
        <div class="footer-item">
            <svg class="footer-icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
            <span class="footer-text">${data.email}</span>
        </div>
    </footer>
</body>
</html>`;

async function generateImageForEeat(eeat, commonAssets, context) {
    const baseName = `${eeat.PAGE_ID}-${eeat.EEAT_IMAGE_NAME_ASCII}`;
    const imageName = baseName.replace(/\.webp$/i, '') + '.webp';
    const { brandingData, logoBase64 } = commonAssets;

    // Determine font and orientation based on locale
    const langIso = eeat.M_LANGUAGE_ISO || 'en'; // Fallback for safety
    const fontDetails = FONT_MAP[langIso] || FONT_MAP.default;
    const orientation = eeat.M_CONTENT_ORIENTATION || 'ltr';

    const dataForTemplate = {
        lang: langIso,
        orientation: orientation,
        fontUrl: fontDetails.url,
        fontFamily: fontDetails.family,
        title: eeat.EEAT_H1,
        feature1: eeat.PAGE_SOCIAL_SHARING_FEATURE_1,
        feature2: eeat.PAGE_SOCIAL_SHARING_FEATURE_2,
        feature3: eeat.PAGE_SOCIAL_SHARING_FEATURE_3,
        email: brandingData.PAGE_INFO_EMAIL,
        flagSvg: flagMap[eeat.M_COUNTRY_CODE] || '',
        logoBase64: logoBase64,
        bodyBgColor: brandingData.PAGE_COLOR_BACKGROUND,
        bodyTextColor: brandingData.PAGE_COLOR_PRIMARY,
        headerBgColor: brandingData.PAGE_COLOR_PRIMARY,
        headerTextColor: brandingData.PAGE_COLOR_SECONDARY,
        featureTextColor: brandingData.PAGE_COLOR_PRIMARY,
        footerBgColor: brandingData.PAGE_COLOR_PRIMARY,
        footerTextColor: brandingData.PAGE_COLOR_ACCENT,
        iconColor: brandingData.PAGE_COLOR_ACCENT_BRIGHT,
    };

    const htmlContent = generateEeatHtmlTemplate(dataForTemplate);
    const page = await context.newPage();
    
    try {
        await page.setViewportSize({ width: 1200, height: 630 });
        // Use 'networkidle' to ensure web fonts from Google are loaded before screenshotting
        await page.setContent(htmlContent, { waitUntil: 'networkidle' });
        const pngBuffer = await page.screenshot({ type: 'png' });
        const outputPath = path.join(OUTPUT_DIR, imageName);
        await sharp(pngBuffer).webp({ quality: 1 }).toFile(outputPath);
    } finally {
        await page.close();
    }
}

async function main() {
    console.log('ðŸš€ Starting EEAT page OG image generation...');
    let browser;
    let db;
    try {
        console.log(`ðŸ§¹ Clearing destination directory: ${OUTPUT_DIR}`);
        await rm(OUTPUT_DIR, { recursive: true, force: true });
        await mkdir(OUTPUT_DIR, { recursive: true });

        // --- Data Fetching from Database ---
        db = new Database(DB_PATH, { readonly: true });
        
        const eeatData = db.prepare("SELECT * FROM eeat WHERE PUBLISH_Y_N = '1'").all();
        const brandingData = db.prepare("SELECT * FROM www LIMIT 1").get();
        // --- End of Data Fetching ---
        
        const logoPath = brandingData.PAGE_LOGO_IMAGE_PATH_5;

        if (!brandingData || !logoPath) {
            throw new Error('Could not find required branding or logo data in the database.');
        }

        const commonAssets = {
            brandingData,
            logoBase64: readImageAsBase64(logoPath)
        };

        browser = await chromium.launch();
        const context = await browser.newContext();

        const limit = pLimit(CONCURRENCY);
        const totalItems = eeatData.length;
        
        const tasks = eeatData.map((eeat) => 
            limit(() => generateImageForEeat(eeat, commonAssets, context))
        );
        const results = await Promise.allSettled(tasks);

        const successful = results.filter(r => r.status === 'fulfilled').length;
        const failed = results.filter(r => r.status === 'rejected');

        console.log('\nâœ¨ EEAT OG image generation complete!');
        console.log(`ðŸŸ¢ Success: ${successful}/${totalItems}`);
        if (failed.length > 0) {
            console.error(`ðŸ”´ Failed: ${failed.length}/${totalItems}`);
            failed.forEach((fail, index) => {
                console.error(`  - Failure ${index + 1}:`, fail.reason.message);
            });
            process.exitCode = 1;
        }
    } catch (error) {
        console.error('âŒ A critical error occurred during the process:', error);
        process.exit(1);
    } finally {
        if (browser) await browser.close();
        if (db) db.close(); // Ensure the database connection is closed.
    }
}

main();
#########

Here's my old src\scripts\generate-sitemaps.mjs:
##########
// src/scripts/generate-sitemaps.mjs

import { readFileSync } from 'fs';
import { writeFile } from 'fs/promises';
import path from 'path';

// --- Configuration ---
const SITE_URL = 'https://eusignal.netlify.app';
const PUBLIC_DIR = path.join(process.cwd(), 'public');

// --- Helper function to read JSON files ---
const readJsonFile = (filePath) => {
  const absolutePath = path.join(process.cwd(), filePath);
  const fileContent = readFileSync(absolutePath, 'utf-8');
  return JSON.parse(fileContent);
};

// --- Helper to format date ---
const formatLastMod = (dateStr, timeStr) => {
  if (!dateStr || !timeStr) {
    return new Date().toISOString();
  }
  return new Date(`${dateStr}T${timeStr}`).toISOString();
};

// --- Main Exported Function ---
// This function will be called by our Astro integration.
export async function generateSitemaps(logger) {
  logger.info('ðŸš€ Generating sitemaps...');
  try {
    // Read data at the time of execution
    const localesData = readJsonFile('src/data/locale.json');
    const homeData = readJsonFile('src/data/home.json');
    const eeatData = readJsonFile('src/data/eeat.json');
    const authorData = readJsonFile('src/data/author.json');
    const articleData = readJsonFile('src/data/article.json');
    const productData = readJsonFile('src/data/product.json');
    
    // --- Sitemap Generation Logic ---
    // FIX: The duplicate, empty declarations have been removed.
    
    const generateSitemapIndex = () => {
      const publishedLocales = localesData.filter(l => l.M_LOCALE_PUBLISH_Y_N === "1");
      const sitemapLinks = publishedLocales
        .map(locale => `<sitemap><loc>${SITE_URL}/sitemap-${locale.M_HREFLANG_CODE}.xml</loc><lastmod>${new Date().toISOString()}</lastmod></sitemap>`)
        .join('');
      return `<?xml version="1.0" encoding="UTF-8"?><sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">${sitemapLinks}</sitemapindex>`;
    };
    
    const generateLocaleSitemap = (localeCode) => {
      const urlEntries = [];
      homeData.filter(p => p.PAGE_LOCALE === localeCode).forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}`, lastmod: formatLastMod(p.DATE_UPDATED, p.HOME_HOUR_UPDATED), changefreq: 'weekly', priority: 1.0 }));
      eeatData.filter(p => p.PAGE_LOCALE === localeCode && p.PUBLISH_Y_N === "1").forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}/${p.EEAT_SLUG}`, lastmod: formatLastMod(p.EEAT_DATE_UPDATED, p.EEAT_HOUR_UPDATED), changefreq: 'yearly', priority: 0.4 }));
      authorData.filter(p => p.PAGE_LOCALE === localeCode && p.PUBLISH_Y_N === "1").forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}/${p.EEAT_URL_20}/${p.WWW_AUTHOR_SLUG}`, lastmod: formatLastMod(p.AUTHOR_DATE_UPDATED, p.AUTHOR_HOUR_UPDATED), changefreq: 'monthly', priority: 0.6 }));
      
      const publishedArticles = articleData.filter(p => p.PAGE_LOCALE === localeCode && p.PUBLISH_Y_N === "1");
      if (publishedArticles.length > 0) {
        publishedArticles.forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}/${p.PAGE_COLLECTION_2_LISTING_SLUG}/${p.ARTICLE_SLUG}`, lastmod: formatLastMod(p.ARTICLE_UPDATE_DATE, p.ARTICLE_HOUR_UPDATED), changefreq: 'monthly', priority: 0.8 }));
        const mostRecentArticle = publishedArticles.sort((a, b) => new Date(formatLastMod(b.ARTICLE_UPDATE_DATE, b.ARTICLE_HOUR_UPDATED)).getTime() - new Date(formatLastMod(a.ARTICLE_UPDATE_DATE, a.ARTICLE_HOUR_UPDATED)).getTime())[0];
        urlEntries.push({ loc: `${SITE_URL}/${publishedArticles[0].M_SLUG}/${publishedArticles[0].PAGE_COLLECTION_2_LISTING_SLUG}`, lastmod: formatLastMod(mostRecentArticle.ARTICLE_UPDATE_DATE, mostRecentArticle.ARTICLE_HOUR_UPDATED), changefreq: 'weekly', priority: 0.9 });
      }

      const publishedProducts = productData.filter(p => p.PAGE_LOCALE === localeCode && p.PUBLISH_Y_N === "1");
      if (publishedProducts.length > 0) {
        publishedProducts.forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}/${p.PAGE_COLLECTION_1_LISTING_SLUG}/${p.PRODUCT_ASCII_SLUG}`, lastmod: formatLastMod(p.PRODUCT_DATE_UPDATED, p.PRODUCT_HOUR_UPDATED), changefreq: 'monthly', priority: 0.9 }));
        const mostRecentProduct = publishedProducts.sort((a, b) => new Date(formatLastMod(b.PRODUCT_DATE_UPDATED, b.PRODUCT_HOUR_UPDATED)).getTime() - new Date(formatLastMod(a.PRODUCT_DATE_UPDATED, a.PRODUCT_HOUR_UPDATED)).getTime())[0];
        urlEntries.push({ loc: `${SITE_URL}/${publishedProducts[0].M_SLUG}/${publishedProducts[0].PAGE_COLLECTION_1_LISTING_SLUG}`, lastmod: formatLastMod(mostRecentProduct.PRODUCT_DATE_UPDATED, mostRecentProduct.PRODUCT_HOUR_UPDATED), changefreq: 'monthly', priority: 0.9 });
      }

      const urlset = urlEntries.map(entry => `<url><loc>${entry.loc}</loc><lastmod>${entry.lastmod}</lastmod><changefreq>${entry.changefreq}</changefreq><priority>${entry.priority.toFixed(1)}</priority></url>`).join('');
      return `<?xml version="1.0" encoding="UTF-8"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">${urlset}</urlset>`;
    };

    // --- Execution Logic ---
    const sitemapIndexXml = generateSitemapIndex();
    await writeFile(path.join(PUBLIC_DIR, 'sitemap.xml'), sitemapIndexXml);
    logger.info('âœ… Generated sitemap.xml');

    const publishedLocales = localesData.filter(l => l.M_LOCALE_PUBLISH_Y_N === "1");
    for (const locale of publishedLocales) {
      const localeCode = locale.M_HREFLANG_CODE;
      const localeSitemapXml = generateLocaleSitemap(localeCode);
      const fileName = `sitemap-${localeCode}.xml`;
      await writeFile(path.join(PUBLIC_DIR, fileName), localeSitemapXml);
      logger.info(`âœ… Generated ${fileName}`);
    }

    logger.info('âœ¨ Sitemap generation complete!');
  } catch (error) {
    logger.error('âŒ Error generating sitemaps:', error);
    process.exit(1);
  }
}
##########

And here's my correctly refactored src\scripts\generate-sitemaps.mjs:
###########
// src/scripts/generate-sitemaps.mjs

import { writeFile } from 'fs/promises';
import path from 'path';
import Database from 'better-sqlite3';

// --- Configuration ---
const SITE_URL = 'https://eusignal.netlify.app';
const CWD = process.cwd();
const PUBLIC_DIR = path.join(CWD, 'public');
const DB_PATH = path.join(CWD, 'src/data/data.db');

// --- Helper to format date ---
const formatLastMod = (dateStr, timeStr) => {
  if (!dateStr || !timeStr) {
    // Return a consistent recent timestamp if data is missing
    return new Date().toISOString();
  }
  // Ensure time string is in HH:MM:SS format
  const formattedTime = timeStr.length === 5 ? `${timeStr}:00` : timeStr;
  return new Date(`${dateStr}T${formattedTime}`).toISOString();
};

// --- Main Exported Function ---
export async function generateSitemaps(logger) {
  logger.info('ðŸš€ Generating sitemaps...');
  let db;
  try {
    // --- Database Connection and Data Fetching ---
    db = new Database(DB_PATH, { readonly: true });

    // Fetch all necessary data from the database in a single transaction for performance.
    const { 
        locales, 
        homeData, 
        eeatData, 
        authorData, 
        articleData, 
        productData 
    } = db.transaction(() => {
        const locales = db.prepare("SELECT M_HREFLANG_CODE FROM locale WHERE M_LOCALE_PUBLISH_Y_N = '1'").all();
        
        // Select only the columns needed for sitemaps to reduce memory usage.
        const home = db.prepare('SELECT PAGE_LOCALE, M_SLUG, HOME_DATE_UPDATED, HOME_HOUR_UPDATED FROM home').all();
        const eeat = db.prepare("SELECT PAGE_LOCALE, M_SLUG, EEAT_SLUG, EEAT_DATE_UPDATED, EEAT_HOUR_UPDATED FROM eeat WHERE PUBLISH_Y_N = '1'").all();
        const author = db.prepare("SELECT PAGE_LOCALE, M_SLUG, EEAT_URL_20, WWW_AUTHOR_SLUG, AUTHOR_DATE_UPDATED, AUTHOR_HOUR_UPDATED FROM author WHERE PUBLISH_Y_N = '1'").all();
        const article = db.prepare("SELECT PAGE_LOCALE, M_SLUG, PAGE_COLLECTION_2_LISTING_SLUG, ARTICLE_SLUG, ARTICLE_UPDATE_DATE, ARTICLE_HOUR_UPDATED FROM article WHERE PUBLISH_Y_N = '1'").all();
        const product = db.prepare("SELECT PAGE_LOCALE, M_SLUG, PAGE_COLLECTION_1_LISTING_SLUG, PRODUCT_ASCII_SLUG, PRODUCT_DATE_UPDATED, PRODUCT_HOUR_UPDATED FROM product WHERE PUBLISH_Y_N = '1'").all();

        return { locales, homeData: home, eeatData: eeat, authorData: author, articleData: article, productData: product };
    })();
    
    // --- Sitemap Generation Logic ---
    const generateSitemapIndex = () => {
      const sitemapLinks = locales
        .map(locale => `<sitemap><loc>${SITE_URL}/sitemap-${locale.M_HREFLANG_CODE}.xml</loc><lastmod>${new Date().toISOString()}</lastmod></sitemap>`)
        .join('');
      return `<?xml version="1.0" encoding="UTF-8"?><sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">${sitemapLinks}</sitemapindex>`;
    };
    
    const generateLocaleSitemap = (localeCode) => {
      const urlEntries = [];

      // Filter data for the current locale
      const localeHome = homeData.filter(p => p.PAGE_LOCALE === localeCode);
      const localeEeat = eeatData.filter(p => p.PAGE_LOCALE === localeCode);
      const localeAuthors = authorData.filter(p => p.PAGE_LOCALE === localeCode);
      const localeArticles = articleData.filter(p => p.PAGE_LOCALE === localeCode);
      const localeProducts = productData.filter(p => p.PAGE_LOCALE === localeCode);
      
      // Home page
      localeHome.forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}`, lastmod: formatLastMod(p.HOME_DATE_UPDATED, p.HOME_HOUR_UPDATED), changefreq: 'weekly', priority: 1.0 }));
      
      // EEAT pages
      localeEeat.forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}/${p.EEAT_SLUG}`, lastmod: formatLastMod(p.EEAT_DATE_UPDATED, p.EEAT_HOUR_UPDATED), changefreq: 'yearly', priority: 0.4 }));
      
      // Author pages
      localeAuthors.forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}/${p.EEAT_URL_20}/${p.WWW_AUTHOR_SLUG}`, lastmod: formatLastMod(p.AUTHOR_DATE_UPDATED, p.AUTHOR_HOUR_UPDATED), changefreq: 'monthly', priority: 0.6 }));
      
      // Article pages and listing
      if (localeArticles.length > 0) {
        localeArticles.forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}/${p.PAGE_COLLECTION_2_LISTING_SLUG}/${p.ARTICLE_SLUG}`, lastmod: formatLastMod(p.ARTICLE_UPDATE_DATE, p.ARTICLE_HOUR_UPDATED), changefreq: 'monthly', priority: 0.8 }));
        const mostRecentArticle = [...localeArticles].sort((a, b) => new Date(formatLastMod(b.ARTICLE_UPDATE_DATE, b.ARTICLE_HOUR_UPDATED)).getTime() - new Date(formatLastMod(a.ARTICLE_UPDATE_DATE, a.ARTICLE_HOUR_UPDATED)).getTime())[0];
        urlEntries.push({ loc: `${SITE_URL}/${localeArticles[0].M_SLUG}/${localeArticles[0].PAGE_COLLECTION_2_LISTING_SLUG}`, lastmod: formatLastMod(mostRecentArticle.ARTICLE_UPDATE_DATE, mostRecentArticle.ARTICLE_HOUR_UPDATED), changefreq: 'weekly', priority: 0.9 });
      }

      // Product pages and listing
      if (localeProducts.length > 0) {
        localeProducts.forEach(p => urlEntries.push({ loc: `${SITE_URL}/${p.M_SLUG}/${p.PAGE_COLLECTION_1_LISTING_SLUG}/${p.PRODUCT_ASCII_SLUG}`, lastmod: formatLastMod(p.PRODUCT_DATE_UPDATED, p.PRODUCT_HOUR_UPDATED), changefreq: 'monthly', priority: 0.9 }));
        const mostRecentProduct = [...localeProducts].sort((a, b) => new Date(formatLastMod(b.PRODUCT_DATE_UPDATED, b.PRODUCT_HOUR_UPDATED)).getTime() - new Date(formatLastMod(a.PRODUCT_DATE_UPDATED, a.PRODUCT_HOUR_UPDATED)).getTime())[0];
        urlEntries.push({ loc: `${SITE_URL}/${localeProducts[0].M_SLUG}/${localeProducts[0].PAGE_COLLECTION_1_LISTING_SLUG}`, lastmod: formatLastMod(mostRecentProduct.PRODUCT_DATE_UPDATED, mostRecentProduct.PRODUCT_HOUR_UPDATED), changefreq: 'monthly', priority: 0.9 });
      }

      const urlset = urlEntries.map(entry => `<url><loc>${entry.loc}</loc><lastmod>${entry.lastmod}</lastmod><changefreq>${entry.changefreq}</changefreq><priority>${entry.priority.toFixed(1)}</priority></url>`).join('');
      return `<?xml version="1.0" encoding="UTF-8"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">${urlset}</urlset>`;
    };

    // --- Execution Logic ---
    const sitemapIndexXml = generateSitemapIndex();
    await writeFile(path.join(PUBLIC_DIR, 'sitemap.xml'), sitemapIndexXml);
    logger.info('âœ… Generated sitemap.xml');

    for (const locale of locales) {
      const localeCode = locale.M_HREFLANG_CODE;
      const localeSitemapXml = generateLocaleSitemap(localeCode);
      const fileName = `sitemap-${localeCode}.xml`;
      await writeFile(path.join(PUBLIC_DIR, fileName), localeSitemapXml);
      logger.info(`âœ… Generated ${fileName}`);
    }

    logger.info('âœ¨ Sitemap generation complete!');
  } catch (error) {
    logger.error('âŒ Error generating sitemaps:', error);
    process.exit(1);
  } finally {
    // Ensure the database connection is always closed.
    if (db) {
      db.close();
    }
  }
}
###########

Take these 4 refactored examples as a CORRECT way of how to refactor other .astro and .mjs files!

Now my goal is to refactor my current .json import logic in all .astro and .mjs files in my project, to now source from the newly created src\data\data.db with EXACTLY SIMILAR, EFFECTIVE and EFFICIENT LOGIC.  Now, your goal is to completely rewrite me the observed .astro or .mjs file to adapt to this new logic and place the database, tables and rows references from the new data.db file, but MUCH MORE EFFICIENTLY - json files ate up the memory on my computer! The refactored code has to be as efficient as could be. You HAVE to keep all of the code logic, layout, design, keys used - everything, except modified so that now data is sourced in the same way, but from a data.db. So DO NOT change other areas of the code if it's not directly correlated to this json to db refactoring process!